<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="轻松入门学习rust, c rust c++">
    <meta name="description" content="个人笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>轻松入门学习rust | 我的个人博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">我的个人博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">我的个人博客</div>
        <div class="logo-desc">
            
            个人笔记
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">轻松入门学习rust</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/rust/">
                                <span class="chip bg-color">rust</span>
                            </a>
                        
                            <a href="/tags/%E7%BC%96%E7%A8%8B/">
                                <span class="chip bg-color">编程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                学习
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-24
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>2021年2月1日: <a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLfllocyHVgsRwLkTAhG0E-2QxCf-ozBkk">Youtube视频</a></p>
<p>2021年1月4日: 支持在线查看 <a target="_blank" rel="noopener" href="https://kumakichi.github.io/easy_rust_chs">点击阅读</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Rust是一种新的语言，已经有了很好的教科书。但是有时候它的教材很难，因为它的教材是给以英语为母语的人看的。现在很多公司和人学习Rust，如果有一本英语简单的书，他们可以学得更快。这本教材就是给这些公司和人用简单的英语来学习Rust的。</p>
<p>Rust是一门很新的语言，但已经非常流行。它之所以受欢迎，是因为它给你提供了C或C++的速度和控制力，但也给你提供了Python等其他较新语言的内存安全。它用一些新的想法来实现这一点，这些想法有时与其他语言不同。这意味着有一些新的东西需要学习，你不能只是 “边走边想”。Rust是一门语言，你必须思考一段时间才能理解。但如果你懂其他语言的话，它看起来还是很熟悉的，它是为了帮助你写好代码而生的。</p>
<h2 id="我是谁？"><a href="#我是谁？" class="headerlink" title="我是谁？"></a>我是谁？</h2><p>我是一个生活在韩国的加拿大人，我在写Easy Rust的同时，也在思考如何让这里的公司开始使用它。我希望其他不以英语为第一语言的国家也能使用它。</p>
<h2 id="简单英语学Rust"><a href="#简单英语学Rust" class="headerlink" title="简单英语学Rust"></a>简单英语学Rust</h2><p><em>简单英语学Rust</em>写于2020年7月至8月，长达400多页。如果你有任何问题，可以在这里或<a target="_blank" rel="noopener" href="https://www.linkedin.com/in/davemacleod">在LinkedIn上</a>或<a target="_blank" rel="noopener" href="https://twitter.com/mithridates">在Twitter上</a>联系我。如果你发现有什么不对的地方，或者要提出pull request，请继续。已经有超过20人帮助我们修复了代码中的错别字和问题，所以你也可以。我不是世界上最好的Rust专家，所以我总是喜欢听到新的想法，或者看看哪里可以让这本书变得更好。</p>
<ul>
<li><a href="#%E7%AC%AC1%E9%83%A8%E5%88%86---%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84Rust">第1部分 - 浏览器中的Rust</a><ul>
<li><a href="#rust-playground">Rust Playground</a></li>
<li><a href="#%E5%92%8C%EF%B8%8F">🚧 and ⚠️</a></li>
<li><a href="#%E6%B3%A8%E9%87%8A">注释</a></li>
<li><a href="#%E7%B1%BB%E5%9E%8B">类型</a><ul>
<li><a href="#%E5%8E%9F%E5%A7%8B%E7%B1%BB%E5%9E%8B">原始类型</a></li>
</ul>
</li>
<li><a href="#%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC">类型推导</a><ul>
<li><a href="#%E6%B5%AE%E7%82%B9%E6%95%B0">浮点数</a></li>
</ul>
</li>
<li><a href="#%E6%89%93%E5%8D%B0hello-world">打印hello, world!</a><ul>
<li><a href="#%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F%E5%92%8C%E4%BB%A3%E7%A0%81%E5%9D%97">声明变量和代码块</a></li>
</ul>
</li>
<li><a href="#%E6%98%BE%E7%A4%BA%E5%92%8C%E8%B0%83%E8%AF%95">显示和调试</a><ul>
<li><a href="#%E6%9C%80%E5%B0%8F%E5%92%8C%E6%9C%80%E5%A4%A7%E7%9A%84%E6%95%B0">最小和最大的数</a></li>
</ul>
</li>
<li><a href="#%E5%8F%AF%E5%8F%98%E6%80%A7">可变性</a><ul>
<li><a href="#%E9%81%AE%E8%94%BD">遮蔽</a></li>
</ul>
</li>
<li><a href="#%E6%A0%88%E5%A0%86%E5%92%8C%E6%8C%87%E9%92%88">栈，堆和指针</a></li>
<li><a href="#%E5%85%B3%E4%BA%8E%E6%89%93%E5%8D%B0%E7%9A%84%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF">关于打印的更多信息</a></li>
<li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2">字符串</a></li>
<li><a href="#const%E5%92%8Cstatic">const和static</a></li>
<li><a href="#%E5%85%B3%E4%BA%8E%E5%BC%95%E7%94%A8%E7%9A%84%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF">关于引用的更多信息</a></li>
<li><a href="#%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8">可变引用</a><ul>
<li><a href="#%E5%86%8D%E8%B0%88shadowing">再谈shadowing</a></li>
</ul>
</li>
<li><a href="#%E5%87%BD%E6%95%B0%E7%9A%84%E5%BC%95%E7%94%A8">函数的引用</a></li>
<li><a href="#%E6%8B%B7%E8%B4%9D%E7%B1%BB%E5%9E%8B">拷贝类型</a><ul>
<li><a href="#%E6%97%A0%E5%80%BC%E5%8F%98%E9%87%8F">无值变量</a></li>
</ul>
</li>
<li><a href="#%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B">集合类型</a><ul>
<li><a href="#%E6%95%B0%E7%BB%84">数组</a></li>
</ul>
</li>
<li><a href="#%E5%90%91%E9%87%8F">向量</a></li>
<li><a href="#%E5%85%83%E7%BB%84">元组</a></li>
<li><a href="#%E6%8E%A7%E5%88%B6%E6%B5%81">控制流</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E4%BD%93">结构体</a></li>
<li><a href="#%E6%9E%9A%E4%B8%BE">枚举</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%9E%9A%E4%B8%BE">使用多种类型的枚举</a></li>
</ul>
</li>
<li><a href="#%E5%BE%AA%E7%8E%AF">循环</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E7%BB%93%E6%9E%84%E5%92%8C%E6%9E%9A%E4%B8%BE">实现结构和枚举</a></li>
<li><a href="#%E8%A7%A3%E6%9E%84">解构</a></li>
<li><a href="#%E5%BC%95%E7%94%A8%E5%92%8C%E7%82%B9%E8%BF%90%E7%AE%97%E7%AC%A6">引用和点运算符</a></li>
<li><a href="#%E6%B3%9B%E5%9E%8B">泛型</a></li>
<li><a href="#%E9%80%89%E9%A1%B9%E5%92%8C%E7%BB%93%E6%9E%9C">选项和结果</a><ul>
<li><a href="#%E9%80%89%E9%A1%B9">选项</a></li>
<li><a href="#%E7%BB%93%E6%9E%9C">结果</a></li>
</ul>
</li>
<li><a href="#%E5%85%B6%E4%BB%96%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B">其他集合类型</a><ul>
<li><a href="#HashMap%E5%92%8CBTreeMap">HashMap和BTreeMap</a></li>
<li><a href="#hashset%E5%92%8Cbtreeset">HashSet和BTreeSet</a></li>
<li><a href="#%E4%BA%8C%E5%8F%89%E5%A0%86">二叉堆</a></li>
<li><a href="#vecdeque">VecDeque</a></li>
</ul>
</li>
<li><a href="#%E6%93%8D%E4%BD%9C%E7%AC%A6">?操作符</a><ul>
<li><a href="#when-panic-and-unwrap-are-good">When panic and unwrap are good</a></li>
</ul>
</li>
<li><a href="#trait">trait</a><ul>
<li><a href="#from-trait">From trait</a></li>
<li><a href="#%E5%9C%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C&str">在函数中使用字符串和&amp;str</a></li>
</ul>
</li>
<li><a href="#%E9%93%BE%E5%BC%8F%E6%96%B9%E6%B3%95">链式方法</a></li>
<li><a href="#%E8%BF%AD%E4%BB%A3%E5%99%A8">迭代器</a><ul>
<li><a href="#%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C">迭代器如何工作</a></li>
</ul>
</li>
<li><a href="#%E9%97%AD%E5%8C%85">闭包</a><ul>
<li><a href="#%E9%97%AD%E5%8C%85%E4%B8%AD%E7%9A%84_">闭包中的_</a></li>
<li><a href="#%E9%97%AD%E5%8C%85%E5%92%8C%E8%BF%AD%E4%BB%A3%E5%99%A8%E7%9A%84%E6%9C%89%E7%94%A8%E6%96%B9%E6%B3%95">闭包和迭代器的有用方法</a></li>
</ul>
</li>
<li><a href="#dbg%E5%AE%8F%E5%92%8Cinspect">dbg! 宏和.检查器</a></li>
<li><a href="#str%E7%9A%84%E7%B1%BB%E5%9E%8B">&amp;str的类型</a></li>
<li><a href="#%E7%94%9F%E5%91%BD%E6%9C%9F">生命期</a></li>
<li><a href="#%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7">内部可变性</a><ul>
<li><a href="#cell">Cell</a></li>
<li><a href="#refcell">RefCell</a></li>
<li><a href="#mutex">Mutex</a></li>
<li><a href="#rwlock">RwLock</a></li>
</ul>
</li>
<li><a href="#cow">Cow</a></li>
<li><a href="#%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D">类型别名</a><ul>
<li><a href="#%E5%9C%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E5%AF%BC%E5%85%A5%E5%92%8C%E9%87%8D%E5%91%BD%E5%90%8D">在函数中导入和重命名</a></li>
</ul>
</li>
<li><a href="#todo%E5%AE%8F">todo!宏</a></li>
<li><a href="#rc">Rc</a></li>
<li><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B">多线程</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E9%97%AD%E5%8C%85">函数中的闭包</a></li>
<li><a href="#impl-trait">impl Trait</a></li>
<li><a href="#arc">Arc</a></li>
<li><a href="#channels">Channels</a></li>
<li><a href="#%E9%98%85%E8%AF%BBRust%E6%96%87%E6%A1%A3">阅读Rust文档</a><ul>
<li><a href="#assert_eq">assert_eq! </a></li>
<li><a href="#%E6%90%9C%E7%B4%A2">搜索</a></li>
<li><a href="#src-%E6%8C%89%E9%92%AE">[src]按钮</a></li>
<li><a href="#trait%E4%BF%A1%E6%81%AF">trait信息</a></li>
</ul>
</li>
<li><a href="#%E5%B1%9E%E6%80%A7">属性</a></li>
<li><a href="#box">Box</a></li>
<li><a href="#box-around-traits">Box around traits</a></li>
<li><a href="#%E9%BB%98%E8%AE%A4%E5%80%BC%E5%92%8C%E6%9E%84%E5%BB%BA%E8%80%85%E6%A8%A1%E5%BC%8F">默认值和构建者模式</a></li>
<li><a href="#Deref%E5%92%8CDerefMut">Deref和DerefMut</a></li>
<li><a href="#Crate%E5%92%8C%E6%A8%A1%E5%9D%97">Crate和模块</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">测试</a><ul>
<li><a href="#%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%BC%80%E5%8F%91">测试驱动的开发</a></li>
</ul>
</li>
<li><a href="#%E5%A4%96%E9%83%A8crate">外部crate</a><ul>
<li><a href="#rand">rand</a></li>
<li><a href="#rayon">rayon</a></li>
<li><a href="#serde">serde</a></li>
<li><a href="#regex">regex</a></li>
<li><a href="#chrono">chrono</a></li>
</ul>
</li>
<li><a href="#%E6%A0%87%E5%87%86%E5%BA%93%E4%B9%8B%E6%97%85">标准库之旅</a><ul>
<li><a href="#%E6%95%B0%E7%BB%84-1">数组</a></li>
<li><a href="#char">char</a></li>
<li><a href="#integers">Integer</a></li>
<li><a href="#floats">Floats</a></li>
<li><a href="#bool">Bool</a></li>
<li><a href="#vec">Vec</a></li>
<li><a href="#string">String</a></li>
<li><a href="#OsString%E5%92%8CCString">OsString和CString</a></li>
<li><a href="#mem">Mem</a></li>
<li><a href="#prelude">Prelude</a></li>
<li><a href="#time">Time</a></li>
<li><a href="#%E5%85%B6%E4%BB%96%E5%AE%8F">其他宏</a></li>
<li><a href="#%E7%BC%96%E5%86%99%E5%AE%8F">编写宏</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E7%AC%AC2%E9%83%A8%E5%88%86---%E7%94%B5%E8%84%91%E4%B8%8A%E7%9A%84Rust">第2部分 - 电脑上的Rust</a><ul>
<li><a href="#cargo">cargo</a></li>
<li><a href="#%E6%8E%A5%E5%8F%97%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5">接受用户输入</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6">使用文件</a></li>
<li><a href="#cargo%E6%96%87%E6%A1%A3">cargo文档</a></li>
<li><a href="#%E7%BB%93%E6%9D%9F%E4%BA%86%E5%90%97%EF%BC%9F">结束了吗？</a></li>
</ul>
</li>
</ul>
<h1 id="第1部分-浏览器中的Rust"><a href="#第1部分-浏览器中的Rust" class="headerlink" title="第1部分 - 浏览器中的Rust"></a>第1部分 - 浏览器中的Rust</h1><p>本书有两个部分。第1部分，你将在浏览器中就能学到尽可能多的Rust知识。实际上你几乎可以在不安装Rust的情况下学到所有你需要知道的东西，所以第1部分非常长。最后是第二部分。它要短得多，是关于电脑上的Rust。在这里，你将学习到其他一切你需要知道的、只能在浏览器之外进行的事情。例如:处理文件、接受用户输入、图形和个人设置。希望在第一部分结束时，你会喜欢Rust，以至于你会安装它。如果你不喜欢，也没问题–第一部分教了你很多，你不会介意的。</p>
<h2 id="Rust-Playground"><a href="#Rust-Playground" class="headerlink" title="Rust Playground"></a>Rust Playground</h2><p>也许你还不想安装Rust，这也没关系。你可以去<a target="_blank" rel="noopener" href="https://play.rust-lang.org/">https://play.rust-lang.org/</a>，在不离开浏览器的情况下开始写Rust。你可以在那里写下你的代码，然后点击Run来查看结果。你可以在浏览器的Playground里面运行本书中的大部分示例。只有在接近结尾的时候，你才会看到无法在Playground运行的示例(比如打开文件)。</p>
<p>以下是使用Rust Playground时的一些提示。</p>
<ul>
<li><p>用”Run”来运行你的代码</p>
</li>
<li><p>如果你想让你的代码更快，就把Debug改为Release。Debug:编译速度更快，运行速度更慢，包含调试信息。Release:编译速度更慢，运行速度更快，删除调试信息。</p>
</li>
<li><p>点击Share，得到一个网址链接，你可以用它来分享你的代码。如果你需要帮助，可以用它来分享你的代码。点击分享后，你可以点击<code>Open a new thread in the Rust user forum</code>，马上向那里的人寻求帮助。</p>
</li>
<li><p>Rustfmt工具: Rustfmt会很好地格式化你的代码。</p>
</li>
<li><p>TOOLS: Rustfmt会很好地格式化你的代码。Clippy会给你额外的信息，告诉你如何让你的代码更好。</p>
</li>
<li><p>CONFIG: 在这里你可以把你的主题改成黑暗模式，这样你就可以在晚上工作了，还有很多其他配置。</p>
</li>
</ul>
<p>如果你想安装Rust，请到这里<a target="_blank" rel="noopener" href="https://www.rust-lang.org/tools/install">https://www.rust-lang.org/tools/install</a>，然后按照说明操作。通常你会使用<code>rustup</code>来安装和更新Rust。</p>
<h2 id="🚧和⚠️"><a href="#🚧和⚠️" class="headerlink" title="🚧和⚠️"></a>🚧和⚠️</h2><p>有时书中的代码例子不能用。如果一个例子不工作，它将会有一个🚧或⚠️在里面。🚧就像 “正在建设中”一样:它意味着代码不完整。Rust需要一个<code>fn main()</code>(一个主函数)来运行，但有时我们只是想看一些小的代码，所以它不会有<code>fn main()</code>。这些例子是正确的，但需要一个<code>fn main()</code>让你运行。而有些代码示例向你展示了一个问题，我们将解决这个问题。那些可能有一个<code>fn main()</code>，但会产生一个错误，所以它们会有一个⚠️。</p>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>注释是给程序员看的，而不是给电脑看的。写注释是为了帮助别人理解你的代码。 这也有利于帮助你以后理解你的代码。 (很多人写了很好的代码，但后来却忘记了他们为什么要写它。)在Rust中写注释，你通常使用 <code>//</code>．</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Rust programs start with fn main()</span>
    <span class="token comment">// You put the code inside a block. It starts with &#123; and ends with &#125;</span>
    <span class="token keyword">let</span> some_number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// We can write as much as we want here and the compiler won't look at it</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你这样做时，编译器不会看<code>//</code>右边的任何东西。</p>
<p>还有一种注释，你用<code>/*</code>开始写，<code>*/</code>结束写。这个写在你的代码中间很有用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_number<span class="token comment">/*: i16*/</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>对编译器来说，<code>let some_number/*: i16*/ = 100;</code>看起来像<code>let some_number = 100;</code>。</p>
<p><code>/* */</code>形式对于超过一行的非常长的注释也很有用。在这个例子中，你可以看到你需要为每一行写<code>//</code>。但是如果您输入 <code>/*</code>，它不会停止，直到您用 <code>*/</code> 完成它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">/* Let me tell you
    a little about this number.
    It's 100, which is my favourite number.
    It's called some_number but actually I think that... */</span>

    <span class="token keyword">let</span> some_number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// Let me tell you</span>
    <span class="token comment">// a little about this number.</span>
    <span class="token comment">// It's 100, which is my favourite number.</span>
    <span class="token comment">// It's called some_number but actually I think that...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h2><p>Rust有很多类型，让你可以处理数字、字符等。有些类型很简单，有些类型比较复杂，你甚至可以创建自己的类型。</p>
<h3 id="原始类型"><a href="#原始类型" class="headerlink" title="原始类型"></a>原始类型</h3><p>Rust有简单的类型，这些类型被称为<strong>原始类型</strong>(原始=非常基本)。我们将从整数和<code>char</code>(字符)开始。整数是没有小数点的整数。整数有两种类型。</p>
<ul>
<li>有符号的整数</li>
<li>无符号整数</li>
</ul>
<p>符号是指<code>+</code>(加号)和<code>-</code>(减号)，所以有符号的整数可以是正数，也可以是负数(如+8，-8)。但无符号整数只能是正数，因为它们没有符号。</p>
<p>有符号的整数是 <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code>, 和 <code>isize</code>。</p>
<p>无符号的整数是 <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code>, 和 <code>usize</code>。</p>
<p>i或u后面的数字表示该数字的位数，所以位数多的数字可以大一些。8位=一个字节，所以<code>i8</code>是一个字节，<code>i64</code>是8个字节，以此类推。尺寸较大的数字类型可以容纳更大的数字。例如，<code>u8</code>最多可以容纳255，但<code>u16</code>最多可以容纳65535。而<code>u128</code>最多可以容纳340282366920938463463374607431768211455。</p>
<p>那么什么是<code>isize</code>和<code>usize</code>呢？这表示你电脑的位数。(你的电脑上的位数叫做你电脑的<strong>架构</strong>)。所以32位计算机上的<code>isize</code>和<code>usize</code>就像<code>i32</code>和<code>u32</code>，64位计算机上的<code>isize</code>和<code>usize</code>就像<code>i64</code>和<code>u64</code>。</p>
<p>整数类型不同的原因有很多。其中一个原因是计算机性能:较小的字节数处理速度更快。例如，数字-10作为<code>i8</code>是<code>11110110</code>，但作为<code>i128</code>是<code>11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110110</code>。但这里还有一些其他用法。</p>
<p>Rust中的字符叫做<code>char</code>. 每一个<code>char</code>都有一个数字:字母<code>A</code>是数字65，而字符<code>友</code>(中文的 “朋友”)是数字21451。这个数字列表被称为 “Unicode”。Unicode对使用较多的字符使用较小的数字，如A到Z，或0到9的数字，或空格。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> first_letter <span class="token operator">=</span> <span class="token char string">'A'</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> space <span class="token operator">=</span> <span class="token char string">' '</span><span class="token punctuation">;</span> <span class="token comment">// A space inside ' ' is also a char</span>
    <span class="token keyword">let</span> other_language_char <span class="token operator">=</span> <span class="token char string">'Ꮔ'</span><span class="token punctuation">;</span> <span class="token comment">// Thanks to Unicode, other languages like Cherokee display just fine too</span>
    <span class="token keyword">let</span> cat_face <span class="token operator">=</span> '😺'<span class="token punctuation">;</span> <span class="token comment">// Emojis are chars too</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用最多的字符的数字小于256，它们可以装进<code>u8</code>。记住，<code>u8</code>是0加上255以内的所有数字，总共256个。这意味着 Rust 可以使用 <code>as</code> 将 <code>u8</code> 安全地 <strong>cast</strong>成 <code>char</code>。(“把 <code>u8</code> cast成 <code>char</code>“意味着 “把 <code>u8</code> 假装成 <code>char</code>“)</p>
<p>用 <code>as</code> cast是有用的，因为 Rust 是非常严格的。它总是需要知道类型。<br> 而不会让你同时使用两种不同的类型，即使它们都是整数。例如，这将无法工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// main() is where Rust programs start to run. Code goes inside &#123;&#125; (curly brackets)</span>

    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// We didn't write a type of integer,</span>
                         <span class="token comment">// so Rust chooses i32. Rust always</span>
                         <span class="token comment">// chooses i32 for integers if you don't</span>
                         <span class="token comment">// tell it to use a different type</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number <span class="token keyword">as</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>原因是这样的:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0604]: only &#96;u8&#96; can be cast as &#96;char&#96;, not &#96;i32&#96;
 --&gt; src\main.rs:3:20
  |
3 |     println!(&quot;&#123;&#125;&quot;, my_number as char);
  |                    ^^^^^^^^^^^^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>幸运的是，我们可以用<code>as</code>轻松解决这个问题。我们不能把<code>i32</code>转成<code>char</code>，但我们可以把<code>i32</code>转成<code>u8</code>，然后把<code>u8</code>转换成<code>char</code>。所以在一行中，我们使用 <code>as</code> 将 my_number 变为 <code>u8</code>，再将其变为 <code>char</code>。现在可以编译了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number <span class="token keyword">as</span> <span class="token keyword">u8</span> <span class="token keyword">as</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印的是<code>d</code>，因为那是100对应的<code>char</code>。</p>
<p>然而，更简单的方法是告诉 Rust <code>my_number</code> 是 <code>u8</code>。下面是你的做法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">//  change my_number to my_number: u8</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number <span class="token keyword">as</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这就是Rust中所有不同数字类型的两个原因。这里还有一个原因:<code>usize</code>是Rust用于<em>索引</em>的大小。(索引的意思是 “哪项是第一”，”哪项是第二”等等)<code>usize</code>是索引的最佳大小，因为:</p>
<ul>
<li>索引不能是负数，所以它需要是一个带u的数字</li>
<li>它应该是大的，因为有时你需要索引很多东西，但。</li>
<li>不可能是u64，因为32位电脑不能使用u64。</li>
</ul>
<p>所以Rust使用了<code>usize</code>，这样你的计算机就可以得到它能读到的最大的数字进行索引。</p>
<p>我们再来了解一下<code>char</code>。你看到<code>char</code>总是一个字符，并且使用<code>&#39;&#39;</code>而不是<code>&quot;&quot;</code>。</p>
<p>所有的字符都是4个字节。它们是4个字节，因为一个字符串中的一些字符是超过一个字节的。计算机上的基本字母一直是1个字节，后来的字符是2个字节，其他的是3个字节和4个字节。<code>char</code>需要4个字节，这样才能容纳任何一种字符。</p>
<p>我们可以用<code>.len()</code>来看一下。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .len() gives the size in bytes</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ß"</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token string">"国"</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token string">"𓅱"</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出来。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">1
2
3
4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，<code>a</code>是一个字节，德文的<code>ß</code>是两个字节，日文的<code>国</code>是三个字节，古埃及的<code>𓅱</code>是4个字节。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token string">"Hello!"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Slice is &#123;&#125; bytes."</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> slice2 <span class="token operator">=</span> <span class="token string">"안녕!"</span><span class="token punctuation">;</span> <span class="token comment">// Korean for "hi"</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Slice2 is &#123;&#125; bytes."</span><span class="token punctuation">,</span> slice2<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Slice is 6 bytes.
Slice2 is 7 bytes.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>slice</code>的长度是6个字符，6个字节，但<code>slice2</code>的长度是3个字符，7个字节。</p>
<p>如果<code>.len()</code>给出的是以字节为单位的大小，那么以字符为单位的大小呢？这些方法我们后面会学习，但你只要记住<code>.chars().count()</code>就可以了。<code>.chars().count()</code> 将你写的东西变成字符，然后计算有多少个字符。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> slice <span class="token operator">=</span> <span class="token string">"Hello!"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Slice is &#123;&#125; bytes and also &#123;&#125; characters."</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> slice<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> slice2 <span class="token operator">=</span> <span class="token string">"안녕!"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Slice2 is &#123;&#125; bytes but only &#123;&#125; characters."</span><span class="token punctuation">,</span> slice2<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> slice2<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出来了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Slice is 6 bytes and also 6 characters.
Slice2 is 7 bytes but only 3 characters.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="类型推导"><a href="#类型推导" class="headerlink" title="类型推导"></a>类型推导</h2><p>类型推导的意思是，如果你不告诉编译器类型，但它可以自己决定，它就会决定。编译器总是需要知道变量的类型，但你并不总是需要告诉它。实际上，通常你不需要告诉它。例如，对于<code>let my_number = 8</code>，<code>my_number</code>将是一个<code>i32</code>。这是因为如果你不告诉它，编译器会选择i32作为整数。但是如果你说<code>let my_number: u8 = 8</code>，它就会把<code>my_number</code>变成<code>u8</code>，因为你告诉它<code>u8</code>。</p>
<p>通常编译器都能猜到。但有时你需要告诉它，原因有两个。</p>
<ol>
<li>你正在做一些非常复杂的事情，而编译器不知道你想要的类型。</li>
<li>你想要一个不同的类型(例如，你想要一个<code>i128</code>，而不是<code>i32</code>)。</li>
</ol>
<p>要指定一个类型，请在变量名后添加一个冒号。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> small_number<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>对于数字，你可以在数字后面说类型。你不需要空格–只需要在数字后面直接输入。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> small_number <span class="token operator">=</span> <span class="token number">10u8</span><span class="token punctuation">;</span> <span class="token comment">// 10u8 = 10 of type u8</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果你想让数字便于阅读，也可以加上<code>_</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> small_number <span class="token operator">=</span> <span class="token number">10_u8</span><span class="token punctuation">;</span> <span class="token comment">// This is easier to read</span>
    <span class="token keyword">let</span> big_number <span class="token operator">=</span> <span class="token number">100_000_000_i32</span><span class="token punctuation">;</span> <span class="token comment">// 100 million is easy to read with _</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>_</code>不会改变数字。它只是为了让你方便阅读。而且你用多少个<code>_</code>都没有关系。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> 0________u8<span class="token punctuation">;</span>
    <span class="token keyword">let</span> number2 <span class="token operator">=</span> 1___6______2____4______i32<span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> number2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出的是<code>0, 1624</code>。</p>
<h3 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h3><p>浮点数是带有小数点的数字。5.5是一个浮点数，6是一个整数。5.0也是一个浮点数，甚至5.也是一个浮点数。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_float <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// Rust sees . and knows that it is a float</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但类型不叫<code>float</code>，叫<code>f32</code>和<code>f64</code>。这和整数一样:<code>f</code>后面的数字显示的是位数。如果你不写类型，Rust会选择<code>f64</code>。</p>
<p>当然，只有同一类型的浮点数可以一起使用。所以你不能把<code>f32</code>加到<code>f64</code>上。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_float<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">;</span> <span class="token comment">// This is an f64</span>
    <span class="token keyword">let</span> my_other_float<span class="token punctuation">:</span> <span class="token keyword">f32</span> <span class="token operator">=</span> <span class="token number">8.5</span><span class="token punctuation">;</span> <span class="token comment">// This is an f32</span>

    <span class="token keyword">let</span> third_float <span class="token operator">=</span> my_float <span class="token operator">+</span> my_other_float<span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你尝试运行这个时，Rust会说。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0308]: mismatched types
 --&gt; src\main.rs:5:34
  |
5 |     let third_float &#x3D; my_float + my_other_float;
  |                                  ^^^^^^^^^^^^^^ expected &#96;f64&#96;, found &#96;f32&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你使用错误的类型时，编译器会写 “expected (type), found (type)”。它这样读取你的代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_float<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">;</span> <span class="token comment">// The compiler sees an f64</span>
    <span class="token keyword">let</span> my_other_float<span class="token punctuation">:</span> <span class="token keyword">f32</span> <span class="token operator">=</span> <span class="token number">8.5</span><span class="token punctuation">;</span> <span class="token comment">// The compiler sees an f32. It is a different type.</span>
    <span class="token keyword">let</span> third_float <span class="token operator">=</span> my_float <span class="token operator">+</span> <span class="token comment">// You want to add my_float to something, so it must be an f64 plus another f64. Now it expects an f64...</span>
    <span class="token keyword">let</span> third_float <span class="token operator">=</span> my_float <span class="token operator">+</span> my_other_float<span class="token punctuation">;</span>  <span class="token comment">// ⚠️ but it found an f32. It can't add them.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，当你看到 “expected(type)，found(type)”时，你必须找到为什么编译器预期的是不同的类型。</p>
<p>当然，用简单的数字很容易解决。你可以用<code>as</code>把<code>f32</code>转成<code>f64</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_float<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_other_float<span class="token punctuation">:</span> <span class="token keyword">f32</span> <span class="token operator">=</span> <span class="token number">8.5</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> third_float <span class="token operator">=</span> my_float <span class="token operator">+</span> my_other_float <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span> <span class="token comment">// my_other_float as f64 = use my_other_float like an f64</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>或者更简单，去掉类型声明。(“声明一个类型”=”告诉Rust使用该类型”)Rust会选择可以加在一起的类型。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_float <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">;</span> <span class="token comment">// Rust will choose f64</span>
    <span class="token keyword">let</span> my_other_float <span class="token operator">=</span> <span class="token number">8.5</span><span class="token punctuation">;</span> <span class="token comment">// Here again it will choose f64</span>

    <span class="token keyword">let</span> third_float <span class="token operator">=</span> my_float <span class="token operator">+</span> my_other_float<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Rust编译器很聪明，如果你需要f32，就不会选择f64。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_float<span class="token punctuation">:</span> <span class="token keyword">f32</span> <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_other_float <span class="token operator">=</span> <span class="token number">8.5</span><span class="token punctuation">;</span> <span class="token comment">// Usually Rust would choose f64,</span>

    <span class="token keyword">let</span> third_float <span class="token operator">=</span> my_float <span class="token operator">+</span> my_other_float<span class="token punctuation">;</span> <span class="token comment">// but now it knows that you need to add it to an f32. So it chooses f32 for my_other_float too</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="打印hello-world"><a href="#打印hello-world" class="headerlink" title="打印hello, world!"></a>打印hello, world!</h2><p>当你启动一个新的Rust程序时，它总是有这样的代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><code>fn</code>的意思是函数。</p>
</li>
<li><p><code>main</code>是启动程序的函数。</p>
</li>
<li><p><code>()</code>表示我们没有给函数任何变量来启动。</p>
</li>
</ul>
<p><code>&#123;&#125;</code>被称为<strong>代码块</strong>。这是代码所在的空间。</p>
<p><code>println!</code>是一个<strong>宏</strong>，打印到控制台。一个<strong>宏</strong>就像一个函数，为你写代码。宏后面有一个<code>!</code>。我们以后会学习如何创建宏。现在，请记住，<code>!</code>表示它是一个宏。</p>
<p>为了学习<code>;</code>，我们将创建另一个函数。首先，在<code>main</code>中，我们将打印一个数字8。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, world number &#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>println!</code>中的<code>&#123;&#125;</code>的意思是 “把变量放在这里面”。这样就会打印出<code>Hello, world number 8!</code>。</p>
<p>我们可以像之前一样，放更多的东西进去。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, worlds number &#123;&#125; and &#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>Hello, worlds number 8 and 9!</code>。</p>
<p>现在我们来创建函数。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token number">8</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, world number &#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这也会打印出 <code>Hello, world number 8!</code>。当Rust查看<code>number()</code>时，它看到一个函数。这个函数:</p>
<ul>
<li>没有参数(因为它有<code>()</code>)</li>
<li>返回一个<code>i32</code>。<code>-&gt;</code>(称为 “瘦箭”)显示了函数返回的内容</li>
</ul>
<p>函数内部只有<code>8</code>。因为没有<code>;</code>，所以这就是它返回的值。如果它有一个<code>;</code>，它将不会返回任何东西(它会返回一个<code>()</code>)。如果它有 <code>;</code>，Rust 不会编译通过，因为需要返回的是 <code>i32</code>，而 <code>;</code> 返回 <code>()</code>，不是 <code>i32</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, world number &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-text" data-language="text"><code class="language-text">5 | fn number() -&gt; i32 &#123;
  |    ------      ^^^ expected &#96;i32&#96;, found &#96;()&#96;
  |    |
  |    implicitly returns &#96;()&#96; as its body has no tail or &#96;return&#96; expression
6 |     8;
  |      - help: consider removing this semicolon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这意味着 “你告诉我<code>number()</code>返回的是<code>i32</code>，但你加了一个<code>;</code>，所以它什么都不返回”。所以编译器建议去掉分号。</p>
<p>你也可以写<code>return 8;</code>，但在Rust中，正常情况下只需将<code>;</code>改为<code>return</code>即可。</p>
<p>当你想给一个函数赋予变量时，把它们放在<code>()</code>里面。你必须给它们起个名字，写上类型。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">multiply</span><span class="token punctuation">(</span>number_one<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> number_two<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Two i32s will enter the function. We will call them number_one and number_two.</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> number_one <span class="token operator">*</span> number_two<span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; times &#123;&#125; is &#123;&#125;"</span><span class="token punctuation">,</span> number_one<span class="token punctuation">,</span> number_two<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We can give the numbers directly</span>
    <span class="token keyword">let</span> some_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// Or we can declare two variables</span>
    <span class="token keyword">let</span> some_other_number <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">multiply</span><span class="token punctuation">(</span>some_number<span class="token punctuation">,</span> some_other_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// and put them in the function</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们也可以返回一个<code>i32</code>。只要把最后的分号去掉就可以了:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">multiply</span><span class="token punctuation">(</span>number_one<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> number_two<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> number_one <span class="token operator">*</span> number_two<span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; times &#123;&#125; is &#123;&#125;"</span><span class="token punctuation">,</span> number_one<span class="token punctuation">,</span> number_two<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token comment">// this is the i32 that we return</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> multiply_result <span class="token operator">=</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We used multiply() to print and to give the result to multiply_result</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="声明变量和代码块"><a href="#声明变量和代码块" class="headerlink" title="声明变量和代码块"></a>声明变量和代码块</h3><p>使用<code>let</code>声明一个变量(声明一个变量=告诉Rust创建一个变量)。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, number &#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>变量在代码块<code>&#123;&#125;</code>内开始和结束。在这个例子中，<code>my_number</code>在我们调用<code>println!</code>之前结束，因为它在自己的代码块里面。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// my_number starts here</span>
                           <span class="token comment">// my_number ends here!</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, number &#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️ there is no my_number and</span>
                                             <span class="token comment">// println!() can't find it</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以使用代码块来返回一个值。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> second_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        second_number <span class="token operator">+</span> <span class="token number">9</span> <span class="token comment">// No semicolon, so the code block returns 8 + 9.</span>
                          <span class="token comment">// It works just like a function</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"My number is: &#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果在代码块内部添加分号，它将返回 <code>()</code> (无)。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> second_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// declare second_number,</span>
        second_number <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// add 9 to second_number</span>
                           <span class="token comment">// but we didn't return it!</span>
                           <span class="token comment">// second_number dies now</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"My number is: &#123;:?&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// my_number is ()</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么为什么我们要写<code>&#123;:?&#125;</code>而不是<code>&#123;&#125;</code>呢？我们现在就来谈谈这个问题。</p>
<h2 id="显示和调试"><a href="#显示和调试" class="headerlink" title="显示和调试"></a>显示和调试</h2><p>Rust中简单的变量可以用<code>&#123;&#125;</code>里面的<code>println!</code>打印。但是有些变量不能，你需要<strong>debug print</strong>。Debug打印是给程序员打印的，因为它通常会显示更多的信息。Debug有时看起来并不漂亮，因为它有额外的信息来帮助你。</p>
<p>你怎么知道你是否需要<code>&#123;:?&#125;</code>而不是<code>&#123;&#125;</code>？编译器会告诉你。比如说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> doesnt_print <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"This will not print: &#123;&#125;"</span><span class="token punctuation">,</span> doesnt_print<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>当我们运行这个时，编译器会说。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: &#96;()&#96; doesn&#39;t implement &#96;std::fmt::Display&#96;
 --&gt; src\main.rs:3:41
  |
3 |     println!(&quot;This will not print: &#123;&#125;&quot;, doesnt_print);
  |                                         ^^^^^^^^^^^^ &#96;()&#96; cannot be formatted with the default formatter
  |
  &#x3D; help: the trait &#96;std::fmt::Display&#96; is not implemented for &#96;()&#96;
  &#x3D; note: in format strings you may be able to use &#96;&#123;:?&#125;&#96; (or &#123;:#?&#125; for pretty-print) instead
  &#x3D; note: required by &#96;std::fmt::Display::fmt&#96;
  &#x3D; note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>信息比较多，但重要的部分是 <code>you may be able to use &#123;:?&#125; (or &#123;:#?&#125; for pretty-print) instead</code>. 这意味着你可以试试<code>&#123;:?&#125;</code>，也可以试试<code>&#123;:#?&#125;</code> <code>&#123;:#?&#125;</code>叫做 “漂亮打印”。它和<code>&#123;:?&#125;</code>一样，但是在更多的行上打印出不同的格式。</p>
<p>所以Display就是用<code>&#123;&#125;</code>打印，Debug就是用<code>&#123;:?&#125;</code>打印。</p>
<p>还有一点:如果你不想要新的一行，你也可以使用<code>print!</code>而不用<code>ln</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"This will not print a new line"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">" so this will be on the same line"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印<code>This will not print a new line so this will be on the same line</code>。</p>
<h3 id="最小和最大的数"><a href="#最小和最大的数" class="headerlink" title="最小和最大的数"></a>最小和最大的数</h3><p>如果你想看最小和最大的数字，你可以用MIN和MAX。<code>std</code>的意思是 “标准库”，拥有Rust的所有主要函数等。我们将在以后学习标准库。但与此同时，你可以记住，这就是你如何获得一个类型的最小和最大的数字。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest i8 is &#123;&#125; and the biggest i8 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i8</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i8</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hint: printing std::i8::MIN means "print MIN inside of the i8 section in the standard library"</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest u8 is &#123;&#125; and the biggest u8 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u8</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u8</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest i16 is &#123;&#125; and the biggest i16 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i16</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i16</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest u16 is &#123;&#125; and the biggest u16 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u16</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u16</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest i32 is &#123;&#125; and the biggest i32 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i32</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i32</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest u32 is &#123;&#125; and the biggest u32 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest i64 is &#123;&#125; and the biggest i64 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i64</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i64</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest u64 is &#123;&#125; and the biggest u64 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest i128 is &#123;&#125; and the biggest i128 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i128</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">i128</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The smallest u128 is &#123;&#125; and the biggest u128 is &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u128</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u128</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将会打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The smallest i8 is -128 and the biggest i8 is 127.
The smallest u8 is 0 and the biggest u8 is 255.
The smallest i16 is -32768 and the biggest i16 is 32767.
The smallest u16 is 0 and the biggest u16 is 65535.
The smallest i32 is -2147483648 and the biggest i32 is 2147483647.
The smallest u32 is 0 and the biggest u32 is 4294967295.
The smallest i64 is -9223372036854775808 and the biggest i64 is 9223372036854775807.
The smallest u64 is 0 and the biggest u64 is 18446744073709551615.
The smallest i128 is -170141183460469231731687303715884105728 and the biggest i128 is 170141183460469231731687303715884105727.
The smallest u128 is 0 and the biggest u128 is 340282366920938463463374607431768211455.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="可变性"><a href="#可变性" class="headerlink" title="可变性"></a>可变性</h2><p>当你用<code>let</code>声明一个变量时，它是不可改变的(不能改变)。</p>
<p>这将无法工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    my_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说:<code>error[E0384]: cannot assign twice to immutable variable my_number</code>。这是因为如果你只写<code>let</code>，变量是不可变的。</p>
<p>但有时你想改变你的变量。要创建一个可以改变的变量，就在<code>let</code>后面加上<code>mut</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    my_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在没有问题了。</p>
<p>但是，你不能改变类型:甚至<code>mut</code>也不能让你这样做:这将无法工作。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_variable <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// it is now an i32. That can't be changed</span>
    my_variable <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>你会看到编译器发出的同样的 “预期”信息。<code>expected integer, found &amp;str</code>. <code>&amp;str</code>是一个字符串类型，我们很快就会知道。</p>
<h3 id="遮蔽"><a href="#遮蔽" class="headerlink" title="遮蔽"></a>遮蔽</h3><p>shadowing是指使用<code>let</code>声明一个与另一个变量同名的新变量。它看起来像可变性，但完全不同。shadowing看起来是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// This is an i32</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">9.2</span><span class="token punctuation">;</span> <span class="token comment">// This is an f64 with the same name. But it's not the first my_number - it is completely different!</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span> <span class="token comment">// Prints 9.2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里我们说我们用一个新的 “let绑定”对<code>my_number</code>进行了 “shadowing”。</p>
<p>那么第一个<code>my_number</code>是否被销毁了呢？没有，但是当我们调用<code>my_number</code>时，我们现在得到<code>my_number</code>的<code>f64</code>。因为它们在同一个作用域块中(同一个 <code>&#123;&#125;</code>)，我们不能再看到第一个 <code>my_number</code>。</p>
<p>但如果它们在不同的块中，我们可以同时看到两个。<br> 例如:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// This is an i32</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">9.2</span><span class="token punctuation">;</span> <span class="token comment">// This is an f64. It is not my_number - it is completely different!</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span> <span class="token comment">// Prints 9.2</span>
                                  <span class="token comment">// But the shadowed my_number only lives until here.</span>
                                  <span class="token comment">// The first my_number is still alive!</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此，当你对一个变量进行shadowing处理时，你不会破坏它。你<strong>屏蔽</strong>了它。</p>
<p>那么shadowing的好处是什么呢？当你需要经常改变一个变量的时候，shadowing是很好的。想象一下，你想用一个变量做很多简单的数学运算。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">times_two</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    number <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> final_number <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// x starts at 9</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">times_two</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// shadow with new x: 18</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span> <span class="token comment">// shadow with new x: 28</span>
        x <span class="token comment">// return x: final_number is now the value of x</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is now: &#123;&#125;"</span><span class="token punctuation">,</span> final_number<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果没有shadowing，你将不得不考虑不同的名称，尽管你并不关心x。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">times_two</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    number <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Pretending we are using Rust without shadowing</span>
    <span class="token keyword">let</span> final_number <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// x starts at 9</span>
        <span class="token keyword">let</span> x_twice <span class="token operator">=</span> <span class="token function">times_two</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// second name for x</span>
        <span class="token keyword">let</span> x_twice_and_y <span class="token operator">=</span> x_twice <span class="token operator">+</span> y<span class="token punctuation">;</span> <span class="token comment">// third name for x!</span>
        x_twice_and_y <span class="token comment">// too bad we didn't have shadowing - we could have just used x</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is now: &#123;&#125;"</span><span class="token punctuation">,</span> final_number<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一般来说，你在Rust中看到的shadowing就是这种情况。它发生在你想快速取用变量，对它做一些事情，然后再做其他事情的地方。而你通常将它用于那些你不太关心的快速变量。</p>
<h2 id="栈、堆和指针"><a href="#栈、堆和指针" class="headerlink" title="栈、堆和指针"></a>栈、堆和指针</h2><p>栈、堆和指针在Rust中非常重要。</p>
<p>栈和堆是计算机中保存内存的两个地方。重要的区别是:</p>
<p>栈的速度非常快, 但堆的速度就不那么快了. 它也不是超慢，但栈总是更快。但是你不能一直使用栈，因为:</p>
<ul>
<li>Rust需要在编译时知道一个变量的大小。所以像<code>i32</code>这样的简单变量就放在堆栈上，因为我们知道它们的确切大小。你总是知道<code>i32</code>要4字节，因为32位=4字节。所以<code>i32</code>总是可以放在栈上。</li>
<li>但有些类型在编译时不知道大小。但是栈需要知道确切的大小。那么你该怎么做呢？首先你把数据放在堆中，因为堆中可以有任何大小的数据。然后为了找到它，一个指针就会进入栈。这很好，因为我们总是知道指针的大小。所以，计算机就会先去栈，读取指针，然后跟着指针到数据所在的堆。</li>
</ul>
<p>指针听起来很复杂，但它们很容易。指针就像一本书的目录。想象一下这本书。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">MY BOOK

TABLE OF CONTENTS

Chapter                        Page
Chapter 1: My life              1
Chapter 2: My cat               15
Chapter 3: My job               23
Chapter 4: My family            30
Chapter 5: Future plans         43<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这就像五个指针。你可以阅读它们，找到它们所说的信息。”我的生活”这一章在哪里？在第1页(它<em>指向</em>第1页)。”我的工作”这一章在哪里？它在第23页。</p>
<p>在Rust中通常看到的指针叫做<strong>引用</strong>。这是重要的部分，要知道:一个引用指向另一个值的内存。引用意味着你<em>借</em>了这个值，但你并不拥有它。这和我们的书一样:目录并不拥有信息。章节才是信息的主人。在Rust中，引用文献的前面有一个<code>&amp;</code>。所以:</p>
<ul>
<li><code>let my_variable = 8</code>是一个普通的变量，但是:</li>
<li><code>let my_reference = &amp;my_variable</code>是一个引用。</li>
</ul>
<p>你把 <code>my_reference = &amp;my_variable</code> 读成这样: “my_reference是对my_variable的引用”. 或者:”my_reference是对my_variable的引用”。</p>
<p>这意味着<code>my_reference</code>只看<code>my_variable</code>的数据。<code>my_variable</code>仍然拥有它的数据。</p>
<p>你也可以有一个引用的引用，或者任何数量的引用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// This is an i32</span>
    <span class="token keyword">let</span> single_reference <span class="token operator">=</span> <span class="token operator">&amp;</span>my_number<span class="token punctuation">;</span> <span class="token comment">//  This is a &amp;i32</span>
    <span class="token keyword">let</span> double_reference <span class="token operator">=</span> <span class="token operator">&amp;</span>single_reference<span class="token punctuation">;</span> <span class="token comment">// This is a &amp;&amp;i32</span>
    <span class="token keyword">let</span> five_references <span class="token operator">=</span> <span class="token operator">&amp;&amp;</span><span class="token operator">&amp;&amp;</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">;</span> <span class="token comment">// This is a &amp;&amp;&amp;&amp;&amp;i32</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这些都是不同的类型，就像 “朋友的朋友”和 “朋友”不同一样。</p>
<h2 id="关于打印的更多信息"><a href="#关于打印的更多信息" class="headerlink" title="关于打印的更多信息"></a>关于打印的更多信息</h2><p>在Rust中，你几乎可以用任何你想要的方式打印东西。这里有一些关于打印的事情需要知道。</p>
<p>添加 <code>\n</code> 将会产生一个新行，而 <code>\t</code> 将会产生一个标签。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Note: this is print!, not println!</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"\t Start with a tab\nand move to a new line"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以打印了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">         Start with a tab
and move to a new line<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>&quot;&quot;</code>里面可以写过很多行都没有问题，但是要注意间距。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Note: After the first line you have to start on the far left.</span>
    <span class="token comment">// If you write directly under println!, it will add the spaces</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Inside quotes
you can write over
many lines
and it will print just fine."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"If you forget to write
    on the left side, the spaces
    will be added when you print."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印出来的。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Inside quotes
you can write over
many lines
and it will print just fine.
If you forget to write
    on the left side, the spaces
    will be added when you print.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你想打印<code>\n</code>这样的字符(称为 “转义字符”)，你可以多加一个<code>\</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here are two escape characters: \\n and \\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这样就可以打印了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Here are two escape characters: \n and \t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>有时你有太多的 <code>&quot;</code> 和转义字符，并希望 Rust 忽略所有的字符。要做到这一点，您可以在开头添加 <code>r#</code>，在结尾添加 <code>#</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"He said, \"You can find the file at c:\\files\\my_documents\\file.txt.\" Then I found the file."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We used \ five times here</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">r#"He said, "You can find the file at c:\files\my_documents\file.txt." Then I found the file."#</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印的是同样的东西，但使用 <code>r#</code> 使人类更容易阅读。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">He said, &quot;You can find the file at c:\files\my_documents\file.txt.&quot; Then I found the file.
He said, &quot;You can find the file at c:\files\my_documents\file.txt.&quot; Then I found the file.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果你需要用<code>#</code>在里面打印，那么你可以用<code>r##</code>开头，用<code>##</code>结尾。而如果你需要多个，可以在每边多加一个#。</p>
<p>下面是四个例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token string">"'Ice to see you,' he said."</span><span class="token punctuation">;</span> <span class="token comment">// single quotes</span>
    <span class="token keyword">let</span> quote_string <span class="token operator">=</span> <span class="token string">r#""Ice to see you," he said."#</span><span class="token punctuation">;</span> <span class="token comment">// double quotes</span>
    <span class="token keyword">let</span> hashtag_string <span class="token operator">=</span> <span class="token string">r##"The hashtag #IceToSeeYou had become very popular."##</span><span class="token punctuation">;</span> <span class="token comment">// Has one # so we need at least ##</span>
    <span class="token keyword">let</span> many_hashtags <span class="token operator">=</span> <span class="token string">r####""You don't have to type ### to use a hashtag. You can just use #.""####</span><span class="token punctuation">;</span> <span class="token comment">// Has three ### so we need at least ####</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;\n&#123;&#125;\n&#123;&#125;\n&#123;&#125;\n"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">,</span> quote_string<span class="token punctuation">,</span> hashtag_string<span class="token punctuation">,</span> many_hashtags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&#39;Ice to see you,&#39; he said.
&quot;Ice to see you,&quot; he said.
The hashtag #IceToSeeYou had become very popular.
&quot;You don&#39;t have to type ### to use a hashtag. You can just use #.&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>r#</code>还有另一个用途:使用它，你可以使用关键字(如<code>let</code>、<code>fn</code>等)作为变量名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> r#<span class="token keyword">let</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// The variable's name is let</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> r#<span class="token keyword">mut</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// This variable's name is mut</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>r#</code>之所以有这个功能，是因为旧版本的Rust的关键字比现在的Rust少。所以有了<code>r#</code>就可以避免以前不是关键字的变量名的错误。</p>
<p>又或者因为某些原因，你<em>确实</em>需要一个函数的名字，比如<code>return</code>。那么你可以这样写:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">r</span>#<span class="token keyword">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u8</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">8</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> r#<span class="token keyword">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出来的结果是:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Here is your number.
8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以你可能不需要它，但是如果你真的需要为一个变量使用一个关键字，那么你可以使用<code>r#</code>。</p>
<p>如果你想打印<code>&amp;str</code>或<code>char</code>的字节，你可以在字符串前写上<code>b</code>就可以了。这适用于所有ASCII字符。这些是所有的ASCII字符。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">☺☻♥♦♣♠♫☼►◄↕‼¶§▬↨↑↓→∟↔▲▼123456789:;&lt;&#x3D;&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_&#96;abcdefghijklmnopqrstuvwxyz&#123;|&#125;~<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以，当你打印这个</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token string">b"This will look like numbers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这就是结果:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[84, 104, 105, 115, 32, 119, 105, 108, 108, 32, 108, 111, 111, 107, 32, 108, 105, 107, 101, 32, 110, 117, 109, 98, 101, 114, 115]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>对于<code>char</code>来说，这叫做一个<em>字节</em>，对于<code>&amp;str</code>来说，这叫做一个<em>字节字符串</em>。</p>
<p>如果你需要的话，也可以把<code>b</code>和<code>r</code>放在一起。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token string">br##"I like to write "#"."##</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>[73, 32, 108, 105, 107, 101, 32, 116, 111, 32, 119, 114, 105, 116, 101, 32, 34, 35, 34, 46]</code>。</p>
<p>还有一个Unicode转义，可以让你在字符串中打印任何Unicode字符。<code>\u&#123;&#125;</code>. <code>&#123;&#125;</code>里面有一个十六进制数字可以打印。下面是一个简短的例子，说明如何获得Unicode数字，以及如何再次打印它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:X&#125;"</span><span class="token punctuation">,</span> <span class="token char string">'행'</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Cast char as u32 to get the hexadecimal value</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:X&#125;"</span><span class="token punctuation">,</span> <span class="token char string">'H'</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:X&#125;"</span><span class="token punctuation">,</span> <span class="token char string">'居'</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:X&#125;"</span><span class="token punctuation">,</span> <span class="token char string">'い'</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"\u&#123;D589&#125;, \u&#123;48&#125;, \u&#123;5C45&#125;, \u&#123;3044&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Try printing them with unicode escape \u</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>我们知道，<code>println!</code>可以和<code>&#123;&#125;</code>(用于显示)或<code>&#123;:?&#125;</code>(用于调试)一起打印，再加上<code>&#123;:#?&#125;</code>就可以进行漂亮的打印。但是还有很多其他的打印方式。</p>
<p>例如，如果你有一个引用，你可以用<code>&#123;:p&#125;</code>来打印<em>指针地址</em>。指针地址指的是电脑内存中的位置。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> number_ref <span class="token operator">=</span> <span class="token operator">&amp;</span>number<span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:p&#125;"</span><span class="token punctuation">,</span> number_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这可以打印<code>0xe2bc0ffcfc</code>或其他地址。每次可能都不一样，这取决于你的计算机存储的位置。</p>
<p>或者你可以打印二进制、十六进制和八进制。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token number">555</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Binary: &#123;:b&#125;, hexadecimal: &#123;:x&#125;, octal: &#123;:o&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> number<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出<code>Binary: 1000101011, hexadecimal: 22b, octal: 1053</code>。</p>
<p>或者你可以添加数字来改变顺序。第一个变量将在索引0中，下一个在索引1中，以此类推。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> father_name <span class="token operator">=</span> <span class="token string">"Vlad"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> son_name <span class="token operator">=</span> <span class="token string">"Adrian Fahrenheit"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> family_name <span class="token operator">=</span> <span class="token string">"Țepeș"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"This is &#123;1&#125; &#123;2&#125;, son of &#123;0&#125; &#123;2&#125;."</span><span class="token punctuation">,</span> father_name<span class="token punctuation">,</span> son_name<span class="token punctuation">,</span> family_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>father_name</code>在0位，<code>son_name</code>在1位，<code>family_name</code>在2位。所以它打印的是<code>This is Adrian Fahrenheit Țepeș, son of Vlad Țepeș</code>。</p>
<p>也许你有一个非常复杂的字符串要打印，<code>&#123;&#125;</code>大括号内有太多的变量。或者你需要不止一次的打印一个变量。那么在<code>&#123;&#125;</code>中添加名称就会有帮助。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"&#123;city1&#125; is in &#123;country&#125; and &#123;city2&#125; is also in &#123;country&#125;,
but &#123;city3&#125; is not in &#123;country&#125;."</span><span class="token punctuation">,</span>
        city1 <span class="token operator">=</span> <span class="token string">"Seoul"</span><span class="token punctuation">,</span>
        city2 <span class="token operator">=</span> <span class="token string">"Busan"</span><span class="token punctuation">,</span>
        city3 <span class="token operator">=</span> <span class="token string">"Tokyo"</span><span class="token punctuation">,</span>
        country <span class="token operator">=</span> <span class="token string">"Korea"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以打印了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Seoul is in Korea and Busan is also in Korea,
but Tokyo is not in Korea.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>如果你想使用Rust，在Rust中也可以进行非常复杂的打印。下面是如何做到这一点。</p>
<p>{variable:padding alignment minimum.maximum}</p>
<p>要理解这一点，请看</p>
<ol>
<li>你想要一个变量名吗？先写出来，就像我们上面写{country}一样。<br>(如果你想做更多的事情，就在后面加一个<code>:</code>)</li>
<li>你想要一个填充字符吗？例如，55加上三个 “填充零”就像00055。</li>
<li>padding的对齐方式(左/中/右)？</li>
<li>你想要一个最小长度吗？(写一个数字就可以了) </li>
<li>你想要一个最大长度吗？(写一个数字，前面有一个<code>.</code>)</li>
</ol>
<p>例如，我想写 “a”，左边有五个ㅎ，右边有五个ㅎ。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> letter <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:ㅎ^11&#125;"</span><span class="token punctuation">,</span> letter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出来的结果是<code>ㅎㅎㅎㅎㅎaㅎㅎㅎㅎㅎ</code>。我们看看1)到5)的这个情况，就能明白编译器是怎么读的。</p>
<ul>
<li>你要不要变量名？<code>&#123;:ㅎ^11&#125;</code>没有变量名。<code>:</code>之前没有任何内容。</li>
<li>你需要一个填充字符吗？<code>&#123;:ㅎ^11&#125;</code> 是的:ㅎ”在<code>:</code>后面，有一个<code>^</code>。<code>&lt;</code>表示填充字符在左边，<code>&gt;</code>表示在右边，<code>^</code>表示在中间。</li>
<li>要不要设置最小长度？<code>&#123;:ㅎ^11&#125;</code>是:后面有一个11。</li>
<li>你想要一个最大长度吗？<code>&#123;:ㅎ^11&#125;</code> 不是:前面没有<code>.</code>的数字。</li>
</ul>
<p>下面是多种类型的格式化的例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token string">"TODAY'S NEWS"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^30&#125;"</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// no variable name, pad with -, put in centre, 30 characters long</span>
    <span class="token keyword">let</span> bar <span class="token operator">=</span> <span class="token string">"|"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;: &lt;15&#125;&#123;: >15&#125;"</span><span class="token punctuation">,</span> bar<span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// no variable name, pad with space, 15 characters each, one to the left, one to the right</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">"SEOUL"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token string">"TOKYO"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;city1:-&lt;15&#125;&#123;city2:->15&#125;"</span><span class="token punctuation">,</span> city1 <span class="token operator">=</span> a<span class="token punctuation">,</span> city2 <span class="token operator">=</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// variable names city1 and city2, pad with -, one to the left, one to the right</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印出来了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">---------TODAY&#39;S NEWS---------
|                            |
SEOUL--------------------TOKYO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>Rust有两种主要类型的字符串。<code>String</code>和<code>&amp;str</code>. 有什么区别呢？</p>
<ul>
<li><code>&amp;str</code>是一个简单的字符串。当你写<code>let my_variable = &quot;Hello, world!&quot;</code>时，你会创建一个<code>&amp;str</code>。<code>&amp;str</code>是非常快的。</li>
<li><code>String</code>是一个更复杂的字符串。它比较慢，但它有更多的功能。<code>String</code>是一个指针，数据在堆上。</li>
</ul>
<p>另外注意，<code>&amp;str</code>前面有<code>&amp;</code>，因为你需要一个引用来使用<code>str</code>。这是因为我们上面看到的原因:堆需要知道大小。所以我们给它一个<code>&amp;</code>，它知道大小，然后它就高兴了。另外，因为你用一个<code>&amp;</code>与一个<code>str</code>交互，你并不拥有它。但是一个<code>String</code>是一个<em>拥有</em>的类型。我们很快就会知道为什么这一点很重要。</p>
<p><code>&amp;str</code>和<code>String</code>都是UTF-8。例如，你可以写</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">"서태지"</span><span class="token punctuation">;</span> <span class="token comment">// This is a Korean name. No problem, because a &amp;str is UTF-8.</span>
    <span class="token keyword">let</span> other_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Adrian Fahrenheit Țepeș"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ț and ș are no problem in UTF-8.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以在<code>String::from(&quot;Adrian Fahrenheit Țepeș&quot;)</code>中看到，很容易从<code>&amp;str</code>中做出一个<code>String</code>。这两种类型虽然不同，但联系非常紧密。</p>
<p>你甚至可以写表情符号，这要感谢UTF-8。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">"😂"</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"My name is actually &#123;&#125;"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在你的电脑上，会打印<code>My name is actually 😂</code>，除非你的命令行不能打印。那么它会显示<code>My name is actually �</code>。但Rust对emojis或其他Unicode没有问题。</p>
<p>我们再来看看<code>str</code>使用<code>&amp;</code>的原因，以确保我们理解。</p>
<ul>
<li><code>str</code>是一个动态大小的类型(动态大小=大小可以不同)。比如 “서태지”和 “Adrian Fahrenheit Țepeș”这两个名字的大小是不一样的。</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"A String is always &#123;:?&#125; bytes. It is Sized."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// std::mem::size_of::&lt;Type>() gives you the size in bytes of a type</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"And an i8 is always &#123;:?&#125; bytes. It is Sized."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i8</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"And an f64 is always &#123;:?&#125; bytes. It is Sized."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"But a &amp;str? It can be anything. '서태지' is &#123;:?&#125; bytes. It is not Sized."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of_val</span><span class="token punctuation">(</span><span class="token string">"서태지"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// std::mem::size_of_val() gives you the size in bytes of a variable</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"And 'Adrian Fahrenheit Țepeș' is &#123;:?&#125; bytes. It is not Sized."</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of_val</span><span class="token punctuation">(</span><span class="token string">"Adrian Fahrenheit Țepeș"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">A String is always 24 bytes. It is Sized.
And an i8 is always 1 bytes. It is Sized.
And an f64 is always 8 bytes. It is Sized.
But a &amp;str? It can be anything. &#39;서태지&#39; is 9 bytes. It is not Sized.
And &#39;Adrian Fahrenheit Țepeș&#39; is 25 bytes. It is not Sized.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就是为什么我们需要一个 &amp;，因为 <code>&amp;</code> 是一个指针，而 Rust 知道指针的大小。所以指针会放在栈中。如果我们写<code>str</code>，Rust就不知道该怎么做了，因为它不知道指针的大小。</p>
<p>有很多方法可以写出<code>String</code>。下面是一些。</p>
<ul>
<li><code>String::from(&quot;This is the string text&quot;);</code> 这是String的一个方法，它接受文本并创建一个String.</li>
<li><code>&quot;This is the string text&quot;.to_string()</code>. 这是&amp;str的一个方法，使其成为一个String。</li>
<li><code>format!</code> 宏。<br>这和<code>println!</code>一样，只是它创建了一个字符串，而不是打印。所以你可以这样做:</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_name <span class="token operator">=</span> <span class="token string">"Billybrobby"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_country <span class="token operator">=</span> <span class="token string">"USA"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_home <span class="token operator">=</span> <span class="token string">"Korea"</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> together <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span>
        <span class="token string">"I am &#123;&#125; and I come from &#123;&#125; but I live in &#123;&#125;."</span><span class="token punctuation">,</span>
        my_name<span class="token punctuation">,</span> my_country<span class="token punctuation">,</span> my_home
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们有了一个一起命名的字符串，但还没有打印出来。</p>
<p>还有一种创建String的方法叫做<code>.into()</code>，但它有点不同，因为<code>.into()</code>并不只是用来创建<code>String</code>。有些类型可以很容易地使用<code>From</code>和<code>.into()</code>转换为另一种类型，并从另一种类型转换出来。而如果你有<code>From</code>，那么你也有<code>.into()</code>。<code>From</code> 更加清晰，因为你已经知道了类型:你知道 <code>String::from(&quot;Some str&quot;)</code> 是一个来自 <code>&amp;str</code> 的 <code>String</code>。但是对于<code>.into()</code>，有时候编译器并不知道。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token string">"Try to make this a String"</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Rust不知道你要的是什么类型，因为很多类型都可以从一个<code>&amp;str</code>做出来。它说:”我可以把一个&amp;str做成很多东西。你想要哪一种？”</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0282]: type annotations needed
 --&gt; src\main.rs:2:9
  |
2 |     let my_string &#x3D; &quot;Try to make this a String&quot;.into();
  |         ^^^^^^^^^ consider giving &#96;my_string&#96; a type<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以你可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token string">"Try to make this a String"</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>现在你得到了一个字符串。</p>
<h2 id="const和static"><a href="#const和static" class="headerlink" title="const和static"></a>const和static</h2><p>有两种类型不用<code>let</code>来声明: <code>const</code>和<code>static</code>。另外，Rust不会使用类型推导:你需要为它们写类型。这些都是针对不会改变的变量(<code>const</code>的意思是常量), 不同的是:</p>
<ul>
<li><code>const</code>是一个不会改变的值</li>
<li><code>static</code>是一个不会改变的值，并且有一个固定的内存位置</li>
</ul>
<p>所以它们几乎是一样的。Rust程序员几乎总是使用<code>const</code>。</p>
<p>一般用全大写字母作为名字，而且通常在<code>main</code>之外，这样它们就可以在整个程序中生存。</p>
<p>两个例子是 <code>const NUMBER_OF_MONTHS: u32 = 12;</code> 和 <code>static SEASONS: [&amp;str; 4] = [&quot;Spring&quot;, &quot;Summer&quot;, &quot;Fall&quot;, &quot;Winter&quot;];</code></p>
<h2 id="关于引用的更多信息"><a href="#关于引用的更多信息" class="headerlink" title="关于引用的更多信息"></a>关于引用的更多信息</h2><p>引用在Rust中非常重要。Rust使用引用来确保所有的内存访问是安全的。我们知道，我们使用<code>&amp;</code>来创建一个引用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ref_one <span class="token operator">=</span> <span class="token operator">&amp;</span>country<span class="token punctuation">;</span>
    <span class="token keyword">let</span> ref_two <span class="token operator">=</span> <span class="token operator">&amp;</span>country<span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> ref_one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就会打印出<code>Austria</code>。</p>
<p>在代码中，<code>country</code>是一个<code>String</code>。然后我们创建了两个<code>country</code>的引用。它们的类型是<code>&amp;String</code>，你说这是一个 “字符串的引用”。我们可以创建三个引用或者一百个对 <code>country</code> 的引用，这都没有问题。</p>
<p>但这是一个问题。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> country_ref <span class="token operator">=</span> <span class="token operator">&amp;</span>country<span class="token punctuation">;</span>
    country_ref <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token function">return_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>return_str()</code>函数创建了一个String，然后它创建了一个对String的引用。然后它试图返回引用。但是<code>country</code>这个String只活在函数里面，然后它就死了。一旦一个变量消失了，计算机就会清理内存，并将其用于其他用途。所以在函数结束后，<code>country_ref</code>引用的是已经消失的内存，这是不对的。Rust防止我们在这里犯内存的错误。</p>
<p>这就是我们上面讲到的 “拥有”类型的重要部分。因为你拥有一个<code>String</code>，你可以把它传给别人。但是如果 <code>&amp;String</code> 的 <code>String</code> 死了，那么 <code>&amp;String</code> 就会死掉，所以你不能把它的 “所有权”传给别人。</p>
<h2 id="可变引用"><a href="#可变引用" class="headerlink" title="可变引用"></a>可变引用</h2><p>如果您想使用一个引用来改变数据，您可以使用一个可变引用。对于可变引用，您可以写 <code>&amp;mut</code> 而不是 <code>&amp;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// don't forget to write mut here!</span>
    <span class="token keyword">let</span> num_ref <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> my_number<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么这两种类型是什么呢？<code>my_number</code>是<code>i32</code>，<code>num_ref</code>是<code>&amp;mut i32</code>(我们说是 “可变引用<code>i32</code>“)。</p>
<p>所以我们用它来给my_number加10。但是你不能写<code>num_ref += 10</code>，因为<code>num_ref</code>不是<code>i32</code>的值，它是一个<code>&amp;i32</code>。其实这个值就在<code>i32</code>里面。为了达到值所在的地方，我们用<code>*</code>。<code>*</code>的意思是 “我不要引用，我要引用对应的值”。换句话说，一个<code>*</code>与<code>&amp;</code>是相反的。另外，一个<code>*</code>抹去了一个<code>&amp;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> num_ref <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> my_number<span class="token punctuation">;</span>
    <span class="token operator">*</span>num_ref <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// Use * to change the i32 value.</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> second_number <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> triple_reference <span class="token operator">=</span> <span class="token operator">&amp;&amp;</span><span class="token operator">&amp;</span>second_number<span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Second_number = triple_reference? &#123;&#125;"</span><span class="token punctuation">,</span> second_number <span class="token operator">==</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>triple_reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">18
Second_number &#x3D; triple_reference? true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>因为使用<code>&amp;</code>叫做 “引用”，所以使用<code>*</code>叫做 “<strong>de</strong>referencing”。</p>
<p>Rust有两个规则，分别是可变引用和不可变引用。它们非常重要，但也很容易记住，因为它们很有意义。</p>
<ul>
<li><strong>规则1</strong>。如果你只有不可变引用，你可以有任意多的引用。1个也行，3个也行，1000个也行。1个也行，3个也行，1000个也行，没问题。</li>
<li><strong>规则2</strong>: 如果你有一个可变引用，你只能有一个。另外，你不能同时使用一个不可变引用<strong>和</strong>一个可变引用。</li>
</ul>
<p>这是因为可变引用可以改变数据。如果你在其他引用读取数据时改变数据，你可能会遇到问题。</p>
<p>一个很好的理解方式是思考一个Powerpoint演示。</p>
<p>情况一是关于<strong>只有一个可变引用</strong></p>
<p>情境一 一个员工正在编写一个Powerpoint演示文稿，他希望他的经理能帮助他。他希望他的经理能帮助他。该员工将自己的登录信息提供给经理，并请他帮忙进行编辑。现在，经理对该员工的演示文稿有了一个 “可变引用”。经理可以做任何他想做的修改，然后把电脑还给他。这很好，因为没有人在看这个演示文稿。</p>
<p>情况二是关于<strong>只有不可变引用</strong></p>
<p>情况二 该员工要给100个人做演示。现在这100个人都可以看到该员工的数据。<br> 他们都有一个 “不可改变的引用”，即员工的介绍。这很好，因为他们可以看到它，但没有人可以改变数据。</p>
<p>情况三是<strong>有问题的情况</strong></p>
<p>情况三 员工把他的登录信息给了经理 他的经理现在有了一个 “可变引用”。然后员工去给100个人做演示，但是经理还是可以登录。这是不对的，因为经理可以登录，可以做任何事情。也许他的经理会登录电脑，然后开始给他的母亲打一封邮件! 现在这100人不得不看着经理给他母亲写邮件，而不是演示。这不是他们期望看到的。</p>
<p>下面是一个可变借用与不可变借用的例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> number_ref <span class="token operator">=</span> <span class="token operator">&amp;</span>number<span class="token punctuation">;</span>
    <span class="token keyword">let</span> number_change <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> number<span class="token punctuation">;</span>
    <span class="token operator">*</span>number_change <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> number_ref<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器打印了一个有用的信息来告诉我们问题所在。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0502]: cannot borrow &#96;number&#96; as mutable because it is also borrowed as immutable
 --&gt; src\main.rs:4:25
  |
3 |     let number_ref &#x3D; &amp;number;
  |                      ------- immutable borrow occurs here
4 |     let number_change &#x3D; &amp;mut number;
  |                         ^^^^^^^^^^^ mutable borrow occurs here
5 |     *number_change +&#x3D; 10;
6 |     println!(&quot;&#123;&#125;&quot;, number_ref);
  |                    ---------- immutable borrow later used here<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然而，这段代码可以工作。为什么会这样？</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> number_change <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> number<span class="token punctuation">;</span> <span class="token comment">// create a mutable reference</span>
    <span class="token operator">*</span>number_change <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// use mutable reference to add 10</span>
    <span class="token keyword">let</span> number_ref <span class="token operator">=</span> <span class="token operator">&amp;</span>number<span class="token punctuation">;</span> <span class="token comment">// create an immutable reference</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> number_ref<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// print the immutable reference</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印出<code>20</code>没有问题。它能工作是因为编译器足够聪明，能够理解我们的代码。它知道我们使用了<code>number_change</code>来改变<code>number</code>，但没有再使用它。所以这里没有问题。我们并没有将不可变和可变引用一起使用。</p>
<p>早期在Rust中，这种代码实际上会产生错误，但现在的编译器更聪明了。它不仅能理解我们输入的内容，还能理解我们如何使用所有的东西。</p>
<h3 id="再谈shadowing"><a href="#再谈shadowing" class="headerlink" title="再谈shadowing"></a>再谈shadowing</h3><p>还记得我们说过，shadowing不会<strong>破坏</strong>一个值，而是<strong>阻挡</strong>它吗？现在我们可以用引用来看看这个问题。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> country_ref <span class="token operator">=</span> <span class="token operator">&amp;</span>country<span class="token punctuation">;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> country_ref<span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是打印<code>Austria, 8</code>还是<code>8, 8</code>？它打印的是<code>Austria, 8</code>。首先我们声明一个<code>String</code>，叫做<code>country</code>。然后我们给这个字符串创建一个引用<code>country_ref</code>。然后我们用8来shadowing国家，这是一个<code>i32</code>。但是第一个<code>country</code>并没有被销毁，所以<code>country_ref</code>仍然写着 “Austria”，而不是 “8”。下面是同样的代码，并加了一些注释来说明它的工作原理。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now we have a String called country</span>
    <span class="token keyword">let</span> country_ref <span class="token operator">=</span> <span class="token operator">&amp;</span>country<span class="token punctuation">;</span> <span class="token comment">// country_ref is a reference to this data. It's not going to change</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// Now we have a variable called country that is an i8. But it has no relation to the other one, or to country_ref</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> country_ref<span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// country_ref still refers to the data of String::from("Austria") that we gave it.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="函数的引用"><a href="#函数的引用" class="headerlink" title="函数的引用"></a>函数的引用</h2><p>引用对函数非常有用。Rust中关于值的规则是:一个值只能有一个所有者。</p>
<p>这段代码将无法工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">print_country</span><span class="token punctuation">(</span>country_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> country_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We print "Austria"</span>
    <span class="token function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️ That was fun, let's do it again!</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它不能工作，因为<code>country</code>被破坏了。下面是如何操作的。</p>
<ul>
<li>第一步，我们创建<code>String</code>，称为<code>country</code>。<code>country</code>是所有者。</li>
<li>第二步:我们把<code>country</code>给<code>print_country</code>。<code>print_country</code>没有<code>-&gt;</code>，所以它不返回任何东西。<code>print_country</code>完成后，我们的<code>String</code>现在已经死了。</li>
<li>第三步:我们尝试把<code>country</code>给<code>print_country</code>，但我们已经这样做了。我们已经没有<code>country</code>可以给了。</li>
</ul>
<p>我们可以让<code>print_country</code>给<code>String</code>回来，但是有点尴尬。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">print_country</span><span class="token punctuation">(</span>country_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> country_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    country_name <span class="token comment">// return it here</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we have to use let here now to get the String back</span>
    <span class="token function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在打印出来了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Austria
Austria<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>更好的解决方法是增加<code>&amp;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">print_country</span><span class="token punctuation">(</span>country_name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> country_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We print "Austria"</span>
    <span class="token function">print_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// That was fun, let's do it again!</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在 <code>print_country()</code> 是一个函数，它接受 <code>String</code> 的引用: <code>&amp;String</code>。另外，我们给country一个引用，写作<code>&amp;country</code>。这表示 “你可以看它，但我要保留它”。</p>
<p>现在让我们用一个可变引用来做类似的事情。下面是一个使用可变变量的函数的例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">add_hungary</span><span class="token punctuation">(</span>country_name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// first we say that the function takes a mutable reference</span>
    country_name<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"-Hungary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push_str() adds a &amp;str to a String</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Now it says: &#123;&#125;"</span><span class="token punctuation">,</span> country_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add_hungary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we also need to give it a mutable reference.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此打印<code>Now it says: Austria-Hungary</code>。</p>
<p>所以得出结论:</p>
<ul>
<li><code>fn function_name(variable: String)</code>接收了<code>String</code>，并拥有它。如果它不返回任何东西，那么这个变量就会在函数里面死亡。</li>
<li><code>fn function_name(variable: &amp;String)</code> 借用 <code>String</code> 并可以查看它</li>
<li><code>fn function_name(variable: &amp;mut String)</code>借用<code>String</code>，可以更改。</li>
</ul>
<p>下面是一个看起来像可变引用的例子，但它是不同的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Austria"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// country is not mutable, but we are going to print Austria-Hungary. How?</span>
    <span class="token function">adds_hungary</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">adds_hungary</span><span class="token punctuation">(</span><span class="token keyword">mut</span> country<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Here's how: adds_hungary takes the String and declares it mutable!</span>
    country<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"-Hungary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这怎么可能呢？因为<code>mut country</code>不是引用。<code>adds_hungary</code>现在拥有<code>country</code>。(记住，它占用的是<code>String</code>而不是<code>&amp;String</code>)。当你调用<code>adds_hungary</code>的那一刻，它就完全成了country的主人。<code>country</code>与<code>String::from(&quot;Austria&quot;)</code>没有关系了。所以，<code>adds_hungary</code>可以把<code>country</code>当作可变的，这样做是完全安全的。</p>
<p>还记得我们上面的员工Powerpoint和经理的情况吗？在这种情况下，就好比员工只是把自己的整台电脑交给了经理。员工不会再碰它，所以经理可以对它做任何他想做的事情。</p>
<h2 id="拷贝类型"><a href="#拷贝类型" class="headerlink" title="拷贝类型"></a>拷贝类型</h2><p>Rust中的一些类型非常简单。它们被称为<strong>拷贝类型</strong>。这些简单的类型都在栈中，编译器知道它们的大小。这意味着它们非常容易复制，所以当你把它发送到一个函数时，编译器总是会复制。它总是复制，因为它们是如此的小而简单，没有理由不复制。所以你不需要担心这些类型的所有权问题。</p>
<p>这些简单的类型包括:整数、浮点数、布尔函数(<code>true</code>和<code>false</code>)和<code>char</code>。</p>
<p>如何知道一个类型是否<strong>实现</strong>复制？(实现 = 能够使用)你可以查看文档。例如，这里是 char 的文档:</p>
<p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/primitive.char.html">https://doc.rust-lang.org/std/primitive.char.html</a></p>
<p>在左边你可以看到<strong>Trait Implementations</strong>。例如你可以看到<strong>Copy</strong>, <strong>Debug</strong>, 和 <strong>Display</strong>。所以你知道，当你把一个<code>char</code>:</p>
<ul>
<li>当你把它发送到一个函数(<strong>Copy</strong>)时，它就被复制了。</li>
<li>可以用<code>&#123;&#125;</code>打印(<strong>Display</strong>)</li>
<li>可以用<code>&#123;:?&#125;</code>打印(<strong>Debug</strong>)</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_number</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// There is no -> so it's not returning anything</span>
                             <span class="token comment">// If number was not copy type, it would take it</span>
                             <span class="token comment">// and we couldn't use it again</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token function">prints_number</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prints 8. prints_number gets a copy of my_number</span>
    <span class="token function">prints_number</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prints 8 again.</span>
                              <span class="token comment">// No problem, because my_number is copy type!</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是如果你看一下String的文档，它不是拷贝类型。</p>
<p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/string/struct.String.html">https://doc.rust-lang.org/std/string/struct.String.html</a></p>
<p>在左边的<strong>Trait Implementations</strong>中，你可以按字母顺序查找。A、B、C……C中没有<strong>Copy</strong>，但是有<strong>Clone</strong>。<strong>Clone</strong>和<strong>Copy</strong>类似，但通常需要更多的内存。另外，你必须用<code>.clone()</code>来调用它–它不会自己克隆。</p>
<p>在这个例子中，<code>prints_country()</code>打印的是国家名称，一个<code>String</code>。我们想打印两次，但我们不能。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_country</span><span class="token punctuation">(</span>country_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> country_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Kiribati"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但现在我们明白了这个信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0382]: use of moved value: &#96;country&#96;
 --&gt; src\main.rs:4:20
  |
2 |     let country &#x3D; String::from(&quot;Kiribati&quot;);
  |         ------- move occurs because &#96;country&#96; has type &#96;std::string::String&#96;, which does not implement the &#96;Copy&#96; trait
3 |     prints_country(country);
  |                    ------- value moved here
4 |     prints_country(country);
  |                    ^^^^^^^ value used here after move<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重要的部分是<code>which does not implement the Copy trait</code>。但是在文档中我们看到String实现了<code>Clone</code>的特性。所以我们可以在代码中添加<code>.clone()</code>。这样就创建了一个克隆，然后我们将克隆发送到函数中。现在 <code>country</code> 还活着，所以我们可以使用它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_country</span><span class="token punctuation">(</span>country_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> country_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> country <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Kiribati"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_country</span><span class="token punctuation">(</span>country<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make a clone and give it to the function. Only the clone goes in, and country is still alive</span>
    <span class="token function">prints_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，如果<code>String</code>非常大，<code>.clone()</code>就会占用很多内存。一个<code>String</code>可以是一整本书的长度，我们每次调用<code>.clone()</code>都会复制这本书。所以，如果可以的话，使用<code>&amp;</code>来做引用是比较快的。例如，这段代码将<code>&amp;str</code>推送到<code>String</code>上，然后每次在函数中使用时都会进行克隆。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">get_length</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Takes ownership of a String</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's &#123;&#125; words long."</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">split_whitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// splits to count the number of words</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">50</span> <span class="token punctuation">&#123;</span>
        my_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"Here are some more words "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push the words on</span>
        <span class="token function">get_length</span><span class="token punctuation">(</span>my_string<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// gives it a clone every time</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它的打印。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">It&#39;s 5 words long.
It&#39;s 10 words long.
...
It&#39;s 250 words long.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就是50个克隆。这里是用引用代替更好:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">get_length</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's &#123;&#125; words long."</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">split_whitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">50</span> <span class="token punctuation">&#123;</span>
        my_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"Here are some more words "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">get_length</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不是50个克隆，而是0个。</p>
<h3 id="无值变量"><a href="#无值变量" class="headerlink" title="无值变量"></a>无值变量</h3><p>一个没有值的变量叫做 “未初始化”变量。未初始化的意思是 “还没有开始”。它们很简单:只需写上<code>let</code>和变量名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_variable<span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但是你还不能使用它，如果任何东西都没有被初始化，Rust就不会编译。</p>
<p>但有时它们会很有用。一个很好的例子是当:</p>
<ul>
<li>你有一个代码块，而你的变量值就在里面，并且</li>
<li>变量需要活在代码块之外。</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">loop_then_return</span><span class="token punctuation">(</span><span class="token keyword">mut</span> counter<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        counter <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> counter <span class="token operator">%</span> <span class="token number">50</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    counter
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number<span class="token punctuation">;</span>

    <span class="token punctuation">&#123;</span>
        <span class="token comment">// Pretend we need to have this code block</span>
        <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Pretend there is code here to make a number</span>
            <span class="token comment">// Lots of code, and finally:</span>
            <span class="token number">57</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        my_number <span class="token operator">=</span> <span class="token function">loop_then_return</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>100</code>。</p>
<p>你可以看到 <code>my_number</code> 是在 <code>main()</code> 函数中声明的，所以它一直活到最后。但是它的值是在循环里面得到的。然而，这个值和<code>my_number</code>一样长，因为<code>my_number</code>有这个值。而如果你在块里面写了<code>let my_number = loop_then_return(number)</code>，它就会马上死掉。</p>
<p>如果你简化代码，对想象是有帮助的。<code>loop_then_return(number)</code>给出的结果是100，所以我们删除它，改写<code>100</code>。另外，现在我们不需要 <code>number</code>，所以我们也删除它。现在它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number<span class="token punctuation">;</span>
    <span class="token punctuation">&#123;</span>
        my_number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以说<code>let my_number = &#123; 100 &#125;;</code>差不多。</p>
<p>另外注意，<code>my_number</code>不是<code>mut</code>。我们在给它50之前并没有给它一个值，所以它的值一直没有改变。最后，<code>my_number</code>的真正代码只是让<code>my_number = 100;</code>。</p>
<h2 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h2><p>Rust有很多类型用于创建集合。当你需要在一个地方有多个值时，就可以使用集合。例如，你可以在一个变量中包含你所在国家的所有城市的信息。我们先从数组开始，数组的速度最快，但功能也最少。它们在这方面有点像<code>&amp;str</code>。</p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>数组是方括号内的数据。<code>[]</code>. 数组:</p>
<ul>
<li>不能改变其大小。</li>
<li>必须只包含相同的类型。</li>
</ul>
<p>但是，它们的速度非常快。</p>
<p>数组的类型是:<code>[type; number]</code>。例如，<code>[&quot;One&quot;, &quot;Two&quot;]</code>的类型是<code>[&amp;str; 2]</code>。这意味着，即使这两个数组也有不同的类型。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> array1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"One"</span><span class="token punctuation">,</span> <span class="token string">"Two"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// This one is type [&amp;str; 2]</span>
    <span class="token keyword">let</span> array2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"One"</span><span class="token punctuation">,</span> <span class="token string">"Two"</span><span class="token punctuation">,</span> <span class="token string">"Five"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// But this one is type [&amp;str; 3]. Different type!</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里有一个很好的提示:要想知道一个变量的类型，你可以通过给编译器下坏指令来 “询问”它。比如说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> seasons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Spring"</span><span class="token punctuation">,</span> <span class="token string">"Summer"</span><span class="token punctuation">,</span> <span class="token string">"Autumn"</span><span class="token punctuation">,</span> <span class="token string">"Winter"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> seasons2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Spring"</span><span class="token punctuation">,</span> <span class="token string">"Summer"</span><span class="token punctuation">,</span> <span class="token string">"Fall"</span><span class="token punctuation">,</span> <span class="token string">"Autumn"</span><span class="token punctuation">,</span> <span class="token string">"Winter"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    seasons<span class="token punctuation">.</span><span class="token function">ddd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
    seasons2<span class="token punctuation">.</span><span class="token function">thd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️ as well</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说:”什么？seasons没有<code>.ddd()</code>的方法，seasons2也没有<code>.thd()</code>的方法！！”你可以看到:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0599]: no method named &#96;ddd&#96; found for array &#96;[&amp;str; 4]&#96; in the current scope
 --&gt; src\main.rs:4:13
  |
4 |     seasons.ddd(); &#x2F;&#x2F; 
  |             ^^^ method not found in &#96;[&amp;str; 4]&#96;

error[E0599]: no method named &#96;thd&#96; found for array &#96;[&amp;str; 5]&#96; in the current scope
 --&gt; src\main.rs:5:14
  |
5 |     seasons2.thd(); &#x2F;&#x2F; 
  |              ^^^ method not found in &#96;[&amp;str; 5]&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以它告诉你<code>method not found in `[&amp;str; 4]`</code>，这就是类型。</p>
<p>如果你想要一个数值都一样的数组，你可以这样声明。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就打印出了<code>[&quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;, &quot;a&quot;]</code>。</p>
<p>这个方法经常用来创建缓冲区。例如，<code>let mut buffer = [0; 640]</code>创建一个640个零的数组。然后我们可以将零改为其他数字，以便添加数据。</p>
<p>你可以用[]来索引(获取)数组中的条目。第一个条目是[0]，第二个是[1]，以此类推。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_numbers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 10</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以得到一个数组的一个片断(一块)。首先你需要一个&amp;，因为编译器不知道大小。然后你可以使用<code>..</code>来显示范围。</p>
<p>例如，让我们使用这个数组。<code>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code>.</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> array_of_ten <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> three_to_five <span class="token operator">=</span> <span class="token operator">&amp;</span>array_of_ten<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> start_at_two <span class="token operator">=</span> <span class="token operator">&amp;</span>array_of_ten<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> end_at_five <span class="token operator">=</span> <span class="token operator">&amp;</span>array_of_ten<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> everything <span class="token operator">=</span> <span class="token operator">&amp;</span>array_of_ten<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Three to five: &#123;:?&#125;, start at two: &#123;:?&#125;, end at five: &#123;:?&#125;, everything: &#123;:?&#125;"</span><span class="token punctuation">,</span> three_to_five<span class="token punctuation">,</span> start_at_two<span class="token punctuation">,</span> end_at_five<span class="token punctuation">,</span> everything<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>记住这一点。</p>
<ul>
<li>索引号从0开始(不是1)</li>
<li>指数范围是<strong>排他的</strong>(不包括最后一个数字)。</li>
</ul>
<p>所以<code>[0..2]</code>是指第一个指数和第二个指数(0和1)。或者你也可以称它为 “零点和第一”指数。它没有第三项，也就是索引2。</p>
<p>你也可以有一个<strong>包容的</strong>范围，这意味着它也包括最后一个数字。要做到这一点。<br> 添加<code>=</code>，写成<code>..=</code>，而不是<code>..</code>。所以，如果你想要第一项、第二项和第三项，可以写成<code>[0..=2]</code>，而不是<code>[0..2]</code>。</p>
<h2 id="向量"><a href="#向量" class="headerlink" title="向量"></a>向量</h2><p>就像我们有<code>&amp;str</code>和<code>String</code>一样，我们有数组和向量。数组的功能少了就快，向量的功能多了就慢。(当然，Rust的速度一直都是非常快的，所以向量并不慢，只是比数组慢<em>一点</em>)。类型写成<code>Vec</code>，你也可以直接叫它 “vec”。</p>
<p>向量的声明主要有两种方式。一种是像<code>String</code>一样使用<code>new</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> name1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Windy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> name2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Gomesy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If we run the program now, the compiler will give an error.</span>
    <span class="token comment">// It doesn't know the type of vec.</span>

    my_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it knows: it's Vec&lt;String></span>
    my_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到<code>Vec</code>里面总是有其他东西，这就是<code>&lt;&gt;</code>(角括号)的作用。<code>Vec&lt;String&gt;</code>是一个有一个或多个<code>String</code>的向量。你还可以在里面有更多的类型。比如说</p>
<ul>
<li><code>Vec&lt;(i32, i32)&gt;</code> 这是一个 <code>Vec</code> 其中每个元素是一个元组。<code>(i32, i32)</code>.</li>
<li><code>Vec&lt;Vec&lt;String&gt;&gt;</code>这是一个<code>Vec</code>，其中有<code>Vec</code>的<code>Strings</code>。比如说你想把你喜欢的书保存为<code>Vec&lt;String&gt;</code>。然后你再用另一本书来做，就会得到另一个<code>Vec&lt;String&gt;</code>。为了保存这两本书，你会把它们放入另一个<code>Vec</code>中，这就是<code>Vec&lt;Vec&lt;String&gt;&gt;</code>。</li>
</ul>
<p>与其使用 <code>.push()</code> 让 Rust 决定类型，不如直接声明类型。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The compiler knows the type</span>
                                              <span class="token comment">// so there is no error.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，向量中的元素必须具有相同的类型。</p>
<p>另一个创建向量的简单方法是使用 <code>vec!</code> 宏。它看起来像一个数组声明，但前面有 <code>vec!</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>类型是<code>Vec&lt;i32&gt;</code>。你称它为 “i32的Vec”。而<code>Vec&lt;String&gt;</code>是 “String的Vec”。<code>Vec&lt;Vec&lt;String&gt;&gt;</code>是 “String的Vec的Vec”。</p>
<p>你也可以对一个向量进行分片，就像在数组中一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> vec_of_ten <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Everything is the same as above except we added vec!.</span>
    <span class="token keyword">let</span> three_to_five <span class="token operator">=</span> <span class="token operator">&amp;</span>vec_of_ten<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> start_at_two <span class="token operator">=</span> <span class="token operator">&amp;</span>vec_of_ten<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> end_at_five <span class="token operator">=</span> <span class="token operator">&amp;</span>vec_of_ten<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> everything <span class="token operator">=</span> <span class="token operator">&amp;</span>vec_of_ten<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Three to five: &#123;:?&#125;,
start at two: &#123;:?&#125;
end at five: &#123;:?&#125;
everything: &#123;:?&#125;"</span><span class="token punctuation">,</span> three_to_five<span class="token punctuation">,</span> start_at_two<span class="token punctuation">,</span> end_at_five<span class="token punctuation">,</span> everything<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为Vector比数组慢，我们可以用一些方法让它更快。一个vec有一个<strong>容量</strong>，也就是给向量的空间。当你在向量上推送一个新的元素时，它会越来越接近容量。然后，如果你超过了容量，它将使其容量翻倍，并将元素复制到新的空间。这就是所谓的重新分配。我们将使用一种名为<code>.capacity()</code>的方法来查看向量的容量，在我们向它添加元素时。</p>
<p>例如，我们将使用名为<code>.capacity()</code>的方法来观察一个向量的容量。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 elements: prints 0</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one character</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 element: prints 4. Vecs with 1 item always start with capacity 4</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4 elements: still prints 4.</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8. We have 5 elements, but it doubled 4 to 8 to make space</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">0
4
4
8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这个向量有两次重分配: 0到4，4到8。我们可以让它更快:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Give it capacity 8</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one character</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 8.</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more</span>
    num_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add one more // Now we have 5 elements</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Still 8</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个向量有0个重分配，这是比较好的。所以如果你认为你知道你需要多少元素，你可以使用<code>Vec::with_capacity()</code>来使它更快。</p>
<p>你记得你可以用<code>.into()</code>把<code>&amp;str</code>变成<code>String</code>。你也可以用它把一个数组变成<code>Vec</code>。你必须告诉 <code>.into()</code> 你想要一个 <code>Vec</code>，但你不必选择 <code>Vec</code> 的类型。如果你不想选择，你可以写<code>Vec&lt;_&gt;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_vec2<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Vec&lt;_> means "choose the Vec type for me"</span>
                                             <span class="token comment">// Rust will choose Vec&lt;i32></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h2><p>Rust中的元组使用<code>()</code>。我们已经见过很多空元组了，因为函数中的<em>nothing</em>实际上意味着一个空元组。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">fn do_something() &#123;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其实是它的简写:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">fn do_something() -&gt; () &#123;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个函数什么也得不到(一个空元组)，也不返回什么(一个空元组)。所以我们已经经常使用元组了。当你在一个函数中不返回任何东西时，你实际上返回的是一个空元组。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">just_prints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Adding ; means we return an empty tuple</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是元组可以容纳很多东西，也可以容纳不同的类型。元组里面的元素也是用数字0、1、2等来做索引的，但要访问它们，你要用<code>.</code>而不是<code>[]</code>。让我们把一大堆类型放到一个元组中。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> random_tuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Here is a name"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token char string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token char string">'b'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">7.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"Inside the tuple is: First item: &#123;:?&#125;
Second item: &#123;:?&#125;
Third item: &#123;:?&#125;
Fourth item: &#123;:?&#125;
Fifth item: &#123;:?&#125;
Sixth item: &#123;:?&#125;"</span><span class="token punctuation">,</span>
        random_tuple<span class="token number">.0</span><span class="token punctuation">,</span>
        random_tuple<span class="token number">.1</span><span class="token punctuation">,</span>
        random_tuple<span class="token number">.2</span><span class="token punctuation">,</span>
        random_tuple<span class="token number">.3</span><span class="token punctuation">,</span>
        random_tuple<span class="token number">.4</span><span class="token punctuation">,</span>
        random_tuple<span class="token number">.5</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Inside the tuple is: First item: &quot;Here is a name&quot;
Second item: 8
Third item: [&#39;a&#39;]
Fourth item: &#39;b&#39;
Fifth item: [8, 9, 10]
Sixth item: 7.7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个元组的类型是 <code>(&amp;str, i32, Vec&lt;char&gt;, char, [i32; 3], f64)</code>。</p>
<p>你可以使用一个元组来创建多个变量。看看这段代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> str_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>str_vec</code>里面有三个元素。如果我们想把它们拉出来呢？这时我们可以使用元组。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> str_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str_vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str_vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str_vec<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// call them a, b, and c</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出<code>&quot;two&quot;</code>，也就是<code>b</code>。这就是所谓的<em>解构</em>。这是因为首先变量是在结构体里面的，但是我们又做了<code>a</code>、<code>b</code>、<code>c</code>这些不是在结构体里面的变量。</p>
<p>如果你需要解构，但又不想要所有的变量，你可以使用<code>_</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> str_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> variable<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str_vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str_vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str_vec<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在它只创建了一个叫<code>variable</code>的变量，但没有为其他值做变量。</p>
<p>还有很多集合类型，还有很多使用数组、vec和tuple的方法。我们也将学习更多关于它们的知识，但首先我们将学习控制流。</p>
<h2 id="控制流"><a href="#控制流" class="headerlink" title="控制流"></a>控制流</h2><p>控制流的意思是告诉你的代码在不同的情况下该怎么做。最简单的控制流是<code>if</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> my_number <span class="token operator">==</span> <span class="token number">7</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's seven"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外注意，你用的是<code>==</code>而不是<code>=</code>。<code>==</code>是用来比较的，<code>=</code>是用来<em>赋值</em>的(给一个值)。另外注意，我们写的是<code>if my_number == 7</code>而不是<code>if (my_number == 7)</code>。在Rust中，你不需要用<code>if</code>的括号。</p>
<p><code>else if</code>和<code>else</code>给你更多的控制:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> my_number <span class="token operator">==</span> <span class="token number">7</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's seven"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> my_number <span class="token operator">==</span> <span class="token number">6</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's six"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's a different number"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印出<code>It&#39;s a different number</code>，因为它不等于7或6。</p>
<p>您可以使用 <code>&amp;&amp;</code>(和)和 <code>||</code>(或)添加更多条件。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> my_number <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> my_number <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> <span class="token comment">// % 2 means the number that remains after diving by two</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's a positive odd number"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> my_number <span class="token operator">==</span> <span class="token number">6</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's six"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's a different number"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印出的是<code>It&#39;s a positive odd number</code>，因为当你把它除以2时，你有一个1的余数，它大于0。</p>
<p>你可以看到，过多的<code>if</code>、<code>else</code>和<code>else if</code>会很难读。在这种情况下，你可以使用<code>match</code>来代替，它看起来更干净。但是您必须为每一个可能的结果进行匹配。例如，这将无法工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> my_number <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"it's zero"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">1</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"it's one"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">2</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"it's two"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ⚠️</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0004]: non-exhaustive patterns: &#96;3u8..&#x3D;std::u8::MAX&#96; not covered
 --&gt; src\main.rs:3:11
  |
3 |     match my_number &#123;
  |           ^^^^^^^^^ pattern &#96;3u8..&#x3D;std::u8::MAX&#96; not covered<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就意味着 “你告诉我0到2，但<code>u8</code>可以到255。那3呢？那4呢？5呢？” 以此类推。所以你可以加上<code>_</code>，意思是 “其他任何东西”。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number<span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> my_number <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"it's zero"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">1</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"it's one"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">2</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"it's two"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's some other number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那打印<code>It&#39;s some other number</code>。</p>
<p>记住匹配的规则:</p>
<ul>
<li>你写下<code>match</code>，然后创建一个<code>&#123;&#125;</code>的代码块。</li>
<li>在左边写上<em>模式</em>，用<code>=&gt;</code>胖箭头说明匹配时该怎么做。</li>
<li>每一行称为一个 “arm”。</li>
<li>在arm之间放一个逗号(不是分号)。</li>
</ul>
<p>你可以用匹配来声明一个值。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> second_number <span class="token operator">=</span> <span class="token keyword">match</span> my_number <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">5</span> <span class="token operator">=></span> <span class="token number">10</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>second_number</code>将是10。你看到最后的分号了吗？那是因为，在match结束后，我们实际上告诉了编译器这个信息:<code>let second_number = 10;</code></p>
<p>你也可以在更复杂的事情上进行匹配。你用一个元组来做。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> sky <span class="token operator">=</span> <span class="token string">"cloudy"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> temperature <span class="token operator">=</span> <span class="token string">"warm"</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> <span class="token punctuation">(</span>sky<span class="token punctuation">,</span> temperature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">(</span><span class="token string">"cloudy"</span><span class="token punctuation">,</span> <span class="token string">"cold"</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's dark and unpleasant today"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"clear"</span><span class="token punctuation">,</span> <span class="token string">"warm"</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's a nice day"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"cloudy"</span><span class="token punctuation">,</span> <span class="token string">"warm"</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's dark but not bad"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not sure what the weather is."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印了<code>It&#39;s dark but not bad</code>，因为它与<code>sky</code>和<code>temperature</code>的 “多云”和 “温暖”相匹配。</p>
<p>你甚至可以把<code>if</code>放在<code>match</code>里面。这就是所谓的 “match guard”。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> married <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> <span class="token punctuation">(</span>children<span class="token punctuation">,</span> married<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">(</span>children<span class="token punctuation">,</span> married<span class="token punctuation">)</span> <span class="token keyword">if</span> married <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not married with &#123;&#125; children"</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>children<span class="token punctuation">,</span> married<span class="token punctuation">)</span> <span class="token keyword">if</span> children <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> married <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Married but no children"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Married? &#123;&#125;. Number of children: &#123;&#125;."</span><span class="token punctuation">,</span> married<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印<code>Married? true. Number of children: 5.</code></p>
<p>在一次匹配中，你可以随意使用 _ 。在这个关于颜色的匹配中，我们有三个颜色，但一次只能选中一个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">match_colours</span><span class="token punctuation">(</span>rbg<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> rbg <span class="token punctuation">&#123;</span>
        <span class="token punctuation">(</span>r<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">if</span> r <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not much red"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>_<span class="token punctuation">,</span> b<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">if</span> b <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not much blue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token keyword">if</span> g <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not much green"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Each colour has at least 10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> third <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">match_colours</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">match_colours</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">match_colours</span><span class="token punctuation">(</span>third<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Not much blue
Each colour has at least 10
Not much green<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这也说明了<code>match</code>语句的作用，因为在第一个例子中，它只打印了<code>Not much blue</code>。但是<code>first</code>也没有多少绿色。<code>match</code>语句总是在找到一个匹配项时停止，而不检查其他的。这就是一个很好的例子，代码编译得很好，但不是你想要的代码。</p>
<p>你可以创建一个非常大的 <code>match</code> 语句来解决这个问题，但是使用 <code>for</code> 循环可能更好。我们将很快讨论循环。</p>
<p>匹配必须返回相同的类型。所以你不能这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> some_variable <span class="token operator">=</span> <span class="token keyword">match</span> my_number <span class="token punctuation">&#123;</span>
        <span class="token number">10</span> <span class="token operator">=></span> <span class="token number">8</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token string">"Not ten"</span><span class="token punctuation">,</span> <span class="token comment">// ⚠️</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器告诉你:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0308]: &#96;match&#96; arms have incompatible types
  --&gt; src\main.rs:17:14
   |
15 |       let some_variable &#x3D; match my_number &#123;
   |  _________________________-
16 | |         10 &#x3D;&gt; 8,
   | |               - this is found to be of type &#96;&#123;integer&#125;&#96;
17 | |         _ &#x3D;&gt; &quot;Not ten&quot;,
   | |              ^^^^^^^^^ expected integer, found &#96;&amp;str&#96;
18 | |     &#125;;
   | |_____- &#96;match&#96; arms have incompatible types<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样也不行，原因同上。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_variable <span class="token operator">=</span> <span class="token keyword">if</span> my_number <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span> <span class="token number">8</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token string">"something else "</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但是这样就可以了，因为不是<code>match</code>，所以你每次都有不同的<code>let</code>语句。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> my_number <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> some_variable <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> some_variable <span class="token operator">=</span> <span class="token string">"Something else"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你也可以使用 <code>@</code> 给 <code>match</code> 表达式的值起一个名字，然后你就可以使用它。在这个例子中，我们在一个函数中匹配一个 <code>i32</code> 输入。如果是4或13，我们要在<code>println!</code>语句中使用这个数字。否则，我们不需要使用它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">match_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> input <span class="token punctuation">&#123;</span>
    number <span class="token operator">@</span> <span class="token number">4</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is an unlucky number in China (sounds close to 死)!"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
    number <span class="token operator">@</span> <span class="token number">13</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is unlucky in North America, lucky in Italy! In bocca al lupo!"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
    _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Looks like a normal number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">match_number</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">match_number</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">match_number</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Looks like a normal number
13 is unlucky in North America, lucky in Italy! In bocca al lupo!
4 is an unlucky number in China (sounds close to 死)!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><p>有了结构体，你可以创建自己的类型。在 Rust 中，你会一直使用结构体，因为它们非常方便。结构体是用关键字 <code>struct</code> 创建的。结构体的名称应该用UpperCamelCase(每个字用大写字母，不要用空格)。如果你用全小写的结构，编译器会告诉你。</p>
<p>有三种类型的结构。一种是 “单元结构”。单元的意思是 “没有任何东西”。对于一个单元结构，你只需要写名字和一个分号。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">FileDirectory</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>接下来是一个元组结构，或者说是一个未命名结构。之所以是 “未命名”，是因为你只需要写类型，而不是字段名。当你需要一个简单的结构，并且不需要记住名字时，元组结构是很好的选择。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Colour</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_colour <span class="token operator">=</span> <span class="token class-name">Colour</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make a colour out of RGB (red, green, blue)</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The second part of the colour is: &#123;&#125;"</span><span class="token punctuation">,</span> my_colour<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这时打印出<code>The second part of the colour is: 0</code>。</p>
<p>第三种类型是命名结构。这可能是最常见的结构。在这个结构中，你在一个 <code>&#123;&#125;</code> 代码块中声明字段名和类型。请注意，在命名结构后面不要写分号，因为后面有一整个代码块。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Colour</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Declare the same Colour tuple struct</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SizeAndColour</span> <span class="token punctuation">&#123;</span>
    size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    colour<span class="token punctuation">:</span> <span class="token class-name">Colour</span><span class="token punctuation">,</span> <span class="token comment">// And we put it in our new named struct</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_colour <span class="token operator">=</span> <span class="token class-name">Colour</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> size_and_colour <span class="token operator">=</span> <span class="token class-name">SizeAndColour</span> <span class="token punctuation">&#123;</span>
        size<span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
        colour<span class="token punctuation">:</span> my_colour
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在一个命名结构中，你也可以用逗号来分隔字段。对于最后一个字段，你可以加一个逗号或不加–这取决于你。<code>SizeAndColour</code> 在 <code>colour</code> 后面有一个逗号。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Colour</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Declare the same Colour tuple struct</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SizeAndColour</span> <span class="token punctuation">&#123;</span>
    size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    colour<span class="token punctuation">:</span> <span class="token class-name">Colour</span><span class="token punctuation">,</span> <span class="token comment">// And we put it in our new named struct</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但你不需要它。但总是放一个逗号可能是个好主意，因为有时你会改变字段的顺序。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Colour</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Declare the same Colour tuple struct</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SizeAndColour</span> <span class="token punctuation">&#123;</span>
    size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    colour<span class="token punctuation">:</span> <span class="token class-name">Colour</span> <span class="token comment">// No comma here</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们决定改变顺序…</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">SizeAndColour</span> <span class="token punctuation">&#123;</span>
    colour<span class="token punctuation">:</span> <span class="token class-name">Colour</span> <span class="token comment">// ⚠️ Whoops! Now this doesn't have a comma.</span>
    size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但无论哪种方式都不是很重要，所以你可以选择是否使用逗号。</p>
<p>我们创建一个<code>Country</code>结构来举例说明。<code>Country</code>结构有<code>population</code>、<code>capital</code>和<code>leader_name</code>三个字段。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Country</span> <span class="token punctuation">&#123;</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    capital<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    leader_name<span class="token punctuation">:</span> <span class="token class-name">String</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> population <span class="token operator">=</span> <span class="token number">500_000</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> capital <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Elista"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> leader_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Batu Khasikov"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> kalmykia <span class="token operator">=</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span>
        population<span class="token punctuation">:</span> population<span class="token punctuation">,</span>
        capital<span class="token punctuation">:</span> capital<span class="token punctuation">,</span>
        leader_name<span class="token punctuation">:</span> leader_name<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你有没有注意到，我们把同样的东西写了两次？我们写了<code>population: population</code>、<code>capital: capital</code>和<code>leader_name: leader_name</code>。实际上，你不需要这样做:如果字段名和变量名是一样的，你就不用写两次。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Country</span> <span class="token punctuation">&#123;</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    capital<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    leader_name<span class="token punctuation">:</span> <span class="token class-name">String</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> population <span class="token operator">=</span> <span class="token number">500_000</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> capital <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Elista"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> leader_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Batu Khasikov"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> kalmykia <span class="token operator">=</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span>
        population<span class="token punctuation">,</span>
        capital<span class="token punctuation">,</span>
        leader_name<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p><code>enum</code>是enumerations的简称。它们看起来与结构体非常相似，但又有所不同。这就是区别:</p>
<ul>
<li>当你想要一个东西<strong>和</strong>另一个东西时，使用<code>struct</code>.</li>
<li>当你想要一个东西<strong>或</strong>另一个东西时，请使用 <code>enum</code>。</li>
</ul>
<p>所以，结构体是用于<strong>多个事物</strong>在一起，而枚举则是用于<strong>多个选择</strong>在一起。</p>
<p>要声明一个枚举，请写<code>enum</code>，并使用一个包含选项的代码块，用逗号分隔。就像 <code>struct</code> 一样，最后一部分可以有逗号，也可以没有。我们将创建一个名为 <code>ThingsInTheSky</code> 的枚举。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">ThingsInTheSky</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Sun</span><span class="token punctuation">,</span>
    <span class="token class-name">Stars</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是一个枚举，因为你可以看到太阳，<strong>或</strong>星星:你必须选择一个。这些叫做<strong>变体</strong>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// create the enum with two choices</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">ThingsInTheSky</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Sun</span><span class="token punctuation">,</span>
    <span class="token class-name">Stars</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// With this function we can use an i32 to create ThingsInTheSky.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">create_skystate</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">ThingsInTheSky</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> time <span class="token punctuation">&#123;</span>
        <span class="token number">6</span><span class="token punctuation">..=</span><span class="token number">18</span> <span class="token operator">=></span> <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Sun</span><span class="token punctuation">,</span> <span class="token comment">// Between 6 and 18 hours we can see the sun</span>
        _ <span class="token operator">=></span> <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Stars</span><span class="token punctuation">,</span> <span class="token comment">// Otherwise, we can see stars</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// With this function we can match against the two choices in ThingsInTheSky.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">check_skystate</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">ThingsInTheSky</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> state <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Sun</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I can see the sun!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Stars</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I can see the stars!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// it's 8 o'clock</span>
    <span class="token keyword">let</span> skystate <span class="token operator">=</span> <span class="token function">create_skystate</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// create_skystate returns a ThingsInTheSky</span>
    <span class="token function">check_skystate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>skystate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Give it a reference so it can read the variable skystate</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出<code>I can see the sun!</code>。</p>
<p>你也可以将数据添加到一个枚举中。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">ThingsInTheSky</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Sun</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Now each variant has a string</span>
    <span class="token class-name">Stars</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">create_skystate</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">ThingsInTheSky</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> time <span class="token punctuation">&#123;</span>
        <span class="token number">6</span><span class="token punctuation">..=</span><span class="token number">18</span> <span class="token operator">=></span> <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Sun</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I can see the sun!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Write the strings here</span>
        _ <span class="token operator">=></span> <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Stars</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I can see the stars!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">check_skystate</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">ThingsInTheSky</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> state <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Sun</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Give the string the name description so we can use it</span>
        <span class="token class-name">ThingsInTheSky</span><span class="token punctuation">::</span><span class="token class-name">Stars</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Or you can name it n. Or anything else - it doesn't matter</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// it's 8 o'clock</span>
    <span class="token keyword">let</span> skystate <span class="token operator">=</span> <span class="token function">create_skystate</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// create_skystate returns a ThingsInTheSky</span>
    <span class="token function">check_skystate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>skystate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Give it a reference so it can read the variable skystate</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出来的结果是一样的:<code>I can see the sun!</code>。</p>
<p>你也可以 “导入”一个枚举，这样你就不用打那么多字了。下面是一个例子，我们每次在心情上匹配时都要输入 <code>Mood::</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Mood</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Happy</span><span class="token punctuation">,</span>
    <span class="token class-name">Sleepy</span><span class="token punctuation">,</span>
    <span class="token class-name">NotBad</span><span class="token punctuation">,</span>
    <span class="token class-name">Angry</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">match_mood</span><span class="token punctuation">(</span>mood<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Mood</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> happiness_level <span class="token operator">=</span> <span class="token keyword">match</span> mood <span class="token punctuation">&#123;</span>
        <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Happy</span> <span class="token operator">=></span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// Here we type Mood:: every time</span>
        <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Sleepy</span> <span class="token operator">=></span> <span class="token number">6</span><span class="token punctuation">,</span>
        <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">NotBad</span> <span class="token operator">=></span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Angry</span> <span class="token operator">=></span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    happiness_level
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mood <span class="token operator">=</span> <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">NotBad</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> happiness_level <span class="token operator">=</span> <span class="token function">match_mood</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mood<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Out of 1 to 10, my happiness is &#123;&#125;"</span><span class="token punctuation">,</span> happiness_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印的是<code>Out of 1 to 10, my happiness is 7</code>。让我们导入，这样我们就可以少打点字了。要导入所有的东西，写<code>*</code>。注意:它和<code>*</code>的解引用键是一样的，但完全不同。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Mood</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Happy</span><span class="token punctuation">,</span>
    <span class="token class-name">Sleepy</span><span class="token punctuation">,</span>
    <span class="token class-name">NotBad</span><span class="token punctuation">,</span>
    <span class="token class-name">Angry</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">match_mood</span><span class="token punctuation">(</span>mood<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Mood</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span> <span class="token comment">// We imported everything in Mood. Now we can just write Happy, Sleepy, etc.</span>
    <span class="token keyword">let</span> happiness_level <span class="token operator">=</span> <span class="token keyword">match</span> mood <span class="token punctuation">&#123;</span>
        <span class="token class-name">Happy</span> <span class="token operator">=></span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// We don't have to write Mood:: anymore</span>
        <span class="token class-name">Sleepy</span> <span class="token operator">=></span> <span class="token number">6</span><span class="token punctuation">,</span>
        <span class="token class-name">NotBad</span> <span class="token operator">=></span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token class-name">Angry</span> <span class="token operator">=></span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    happiness_level
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mood <span class="token operator">=</span> <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Happy</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> happiness_level <span class="token operator">=</span> <span class="token function">match_mood</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mood<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Out of 1 to 10, my happiness is &#123;&#125;"</span><span class="token punctuation">,</span> happiness_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><code>enum</code> 的部分也可以变成一个整数。这是因为 Rust 给 <code>enum</code> 的每个arm提供了一个以 0 开头的数字，供它自己使用。如果你的枚举中没有任何其他数据，你可以用它来做一些事情。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Season</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Spring</span><span class="token punctuation">,</span> <span class="token comment">// If this was Spring(String) or something it wouldn't work</span>
    <span class="token class-name">Summer</span><span class="token punctuation">,</span>
    <span class="token class-name">Autumn</span><span class="token punctuation">,</span>
    <span class="token class-name">Winter</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">Season</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> four_seasons <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Spring</span><span class="token punctuation">,</span> <span class="token class-name">Summer</span><span class="token punctuation">,</span> <span class="token class-name">Autumn</span><span class="token punctuation">,</span> <span class="token class-name">Winter</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> season <span class="token keyword">in</span> four_seasons <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> season <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">0
1
2
3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>不过如果你想的话，你可以给它一个不同的数字–Rust并不在意，可以用同样的方式来使用它。只需在你想要的变体上加一个 <code>=</code> 和你的数字。你不必给所有的都分配一个数字。但如果你不这样做，Rust就会从前一个arm加1来赋值给当前arm。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Star</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">BrownDwarf</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token class-name">RedDwarf</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">,</span>
    <span class="token class-name">YellowStar</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token class-name">RedGiant</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token class-name">DeadStar</span><span class="token punctuation">,</span> <span class="token comment">// Think about this one. What number will it have?</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">Star</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> starvec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">BrownDwarf</span><span class="token punctuation">,</span> <span class="token class-name">RedDwarf</span><span class="token punctuation">,</span> <span class="token class-name">YellowStar</span><span class="token punctuation">,</span> <span class="token class-name">RedGiant</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> star <span class="token keyword">in</span> starvec <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> star <span class="token keyword">as</span> <span class="token keyword">u32</span> <span class="token punctuation">&#123;</span>
            size <span class="token keyword">if</span> size <span class="token operator">&lt;=</span> <span class="token number">80</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not the biggest star."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Remember: size doesn't mean anything. It's just a name we chose so we can print it</span>
            size <span class="token keyword">if</span> size <span class="token operator">>=</span> <span class="token number">80</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"This is a good-sized star."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"That star is pretty big!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"What about DeadStar? It's the number &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token class-name">DeadStar</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Not the biggest star.
Not the biggest star.
This is a good-sized star.
This is a good-sized star.
What about DeadStar? It&#39;s the number 1001.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>DeadStar</code>本来是4号，但现在是1001。</p>
<h3 id="使用多种类型的枚举"><a href="#使用多种类型的枚举" class="headerlink" title="使用多种类型的枚举"></a>使用多种类型的枚举</h3><p>你知道<code>Vec</code>、数组等中的元素都需要相同的类型(只有tuple不同)。但其实你可以用一个枚举来放不同的类型。想象一下，我们想有一个<code>Vec</code>，有<code>u32</code>或<code>i32</code>。当然，你可以创建一个<code>Vec&lt;(u32, i32)&gt;</code>(一个带有<code>(u32, i32)</code>元组的vec)，但是我们每次只想要一个。所以这里可以使用一个枚举。下面是一个简单的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Number</span> <span class="token punctuation">&#123;</span>
    <span class="token constant">U32</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">I32</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以有两个变体:<code>U32</code>变体里面有<code>u32</code>，<code>I32</code>变体里面有<code>i32</code>。<code>U32</code>和<code>I32</code>只是我们起的名字。它们可能是<code>UThirtyTwo</code>或<code>IThirtyTwo</code>或其他任何东西。</p>
<p>现在，如果我们把它们放到 <code>Vec</code> 中，我们就会有一个 <code>Vec&lt;Number&gt;</code>，编译器很高兴，因为都是同一个类型。编译器并不在乎我们有 <code>u32</code> 或 <code>i32</code>，因为它们都在一个叫做 <code>Number</code> 的单一类型里面。因为它是一个枚举，你必须选择一个，这就是我们想要的。我们将使用<code>.is_positive()</code>方法来挑选。如果是 <code>true</code>，那么我们将选择 <code>U32</code>，如果是 <code>false</code>，那么我们将选择 <code>I32</code>。</p>
<p>现在的代码是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Number</span> <span class="token punctuation">&#123;</span>
    <span class="token constant">U32</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">I32</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">get_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Number</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token keyword">match</span> input<span class="token punctuation">.</span><span class="token function">is_positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token boolean">true</span> <span class="token operator">=></span> <span class="token class-name">Number</span><span class="token punctuation">::</span><span class="token constant">U32</span><span class="token punctuation">(</span>input <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// change it to u32 if it's positive</span>
        <span class="token boolean">false</span> <span class="token operator">=></span> <span class="token class-name">Number</span><span class="token punctuation">::</span><span class="token constant">I32</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// otherwise just give the number because it's already i32</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    number
<span class="token punctuation">&#125;</span>


<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token function">get_number</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_number</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> my_vec <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> item <span class="token punctuation">&#123;</span>
            <span class="token class-name">Number</span><span class="token punctuation">::</span><span class="token constant">U32</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's a u32 with the value &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Number</span><span class="token punctuation">::</span><span class="token constant">I32</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's an i32 with the value &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出了我们想看到的东西。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">It&#39;s an i32 with the value -800
It&#39;s a u32 with the value 8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><p>有了循环，你可以告诉 Rust 继续某事，直到你想让它停止。您使用 <code>loop</code> 来启动一个不会停止的循环，除非您告诉它何时<code>break</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// This program will never stop</span>
    <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，我们要告诉编译器什么时候能停止:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// set a counter to 0</span>
    <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        counter <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// increase the counter by 1</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The counter is now: &#123;&#125;"</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">&#123;</span> <span class="token comment">// stop when counter == 5</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The counter is now: 1
The counter is now: 2
The counter is now: 3
The counter is now: 4
The counter is now: 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你在一个循环里面有一个循环，你可以给它们命名。有了名字，你可以告诉 Rust 要从哪个循环中 <code>break</code> 出来。使用 <code>&#39;</code> (称为 “tick”) 和 <code>:</code> 来给它命名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Now entering the first loop."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token lifetime-annotation symbol">'first_loop</span><span class="token punctuation">:</span> <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Give the first loop a name</span>
        counter <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The counter is now: &#123;&#125;"</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> counter <span class="token operator">></span> <span class="token number">9</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Starts a second loop inside this loop</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Now entering the second loop."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token lifetime-annotation symbol">'second_loop</span><span class="token punctuation">:</span> <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// now we are inside 'second_loop</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The second counter is now: &#123;&#125;"</span><span class="token punctuation">,</span> counter2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                counter2 <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> counter2 <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span> <span class="token lifetime-annotation symbol">'first_loop</span><span class="token punctuation">;</span> <span class="token comment">// Break out of 'first_loop so we can exit the program</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Now entering the first loop.
The counter is now: 1
The counter is now: 2
The counter is now: 3
The counter is now: 4
The counter is now: 5
The counter is now: 6
The counter is now: 7
The counter is now: 8
The counter is now: 9
The counter is now: 10
Now entering the second loop.
The second counter is now: 0
The second counter is now: 1
The second counter is now: 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>while</code>循环是指在某件事情还在<code>true</code>时继续的循环。每一次循环，Rust 都会检查它是否仍然是 <code>true</code>。如果变成<code>false</code>，Rust会停止循环。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> counter <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">&#123;</span>
        counter <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The counter is now: &#123;&#125;"</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>for</code>循环可以让你告诉Rust每次要做什么。但是在 <code>for</code> 循环中，循环会在一定次数后停止。<code>for</code>循环经常使用<strong>范围</strong>。你使用 <code>..</code> 和 <code>..=</code> 来创建一个范围。</p>
<ul>
<li><code>..</code>创建一个<strong>排他的</strong>范围:<code>0..3</code>创建了<code>0, 1, 2</code>.</li>
<li><code>..=</code>创建一个<strong>包含的</strong>范围: <code>0..=3</code>创建<code>0, 1, 2</code>。<code>0..=3</code> = <code>0, 1, 2, 3</code>.</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The next number is: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The number is: 0
The number is: 1
The number is: 2
The next number is: 0
The next number is: 1
The next number is: 2
The next number is: 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同时注意到，<code>number</code>成为0..3的变量名。我们可以把它叫做 <code>n</code>，或者 <code>ntod_het___hno_f</code>，或者任何名字。然后，我们可以在<code>println!</code>中使用这个名字。</p>
<p>如果你不需要变量名，就用<code>_</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Printing the same thing three times"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Printing the same thing three times
Printing the same thing three times
Printing the same thing three times<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因为我们每次都没有给它任何数字来打印。</p>
<p>而实际上，如果你给了一个变量名却不用，Rust会告诉你:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Printing the same thing three times"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印的内容和上面一样。程序编译正常，但Rust会提醒你没有使用<code>number</code>:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">warning: unused variable: &#96;number&#96;
 --&gt; src\main.rs:2:9
  |
2 |     for number in 0..3 &#123;
  |         ^^^^^^ help: if this is intentional, prefix it with an underscore: &#96;_number&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Rust 建议写 <code>_number</code> 而不是 <code>_</code>。在变量名前加上 <code>_</code> 意味着 “也许我以后会用到它”。但是只用<code>_</code>意味着 “我根本不关心这个变量”。所以，如果你以后会使用它们，并且不想让编译器告诉你，你可以在变量名前面加上<code>_</code>。</p>
<p>你也可以用<code>break</code>来返回一个值。<br> 你把值写在 <code>break</code> 之后，并使用 <code>;</code>。下面是一个用 <code>loop</code> 和一个断点给出 <code>my_number</code> 值的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        counter <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> counter <span class="token operator">%</span> <span class="token number">53</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span> counter<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这时打印出<code>56</code>。<code>break counter;</code>的意思是 “中断并返回计数器的值”。而且因为整个块以<code>let</code>开始，所以<code>my_number</code>得到值。</p>
<p>现在我们知道了如何使用循环，这里有一个更好的解决方案来解决我们之前的颜色 “匹配”问题。这是一个更好的解决方案，因为我们要比较所有的东西，而 “for”循环会查看每一项。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">match_colours</span><span class="token punctuation">(</span>rbg<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Comparing a colour with &#123;&#125; red, &#123;&#125; blue, and &#123;&#125; green:"</span><span class="token punctuation">,</span> rbg<span class="token number">.0</span><span class="token punctuation">,</span> rbg<span class="token number">.1</span><span class="token punctuation">,</span> rbg<span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">(</span>rbg<span class="token number">.0</span><span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>rbg<span class="token number">.1</span><span class="token punctuation">,</span> <span class="token string">"blue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>rbg<span class="token number">.2</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Put the colours in a vec. Inside are tuples with the colour names</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> all_have_at_least_10 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Start with true. We will set it to false if one colour is less than 10</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> new_vec <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> item<span class="token number">.0</span> <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
            all_have_at_least_10 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Now it's false</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Not much &#123;&#125;."</span><span class="token punctuation">,</span> item<span class="token number">.1</span><span class="token punctuation">)</span> <span class="token comment">// And we print the colour name.</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> all_have_at_least_10 <span class="token punctuation">&#123;</span> <span class="token comment">// Check if it's still true, and print if true</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Each colour has at least 10."</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Add one more line</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> first <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> second <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> third <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">match_colours</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">match_colours</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">match_colours</span><span class="token punctuation">(</span>third<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Comparing a colour with 200 red, 0 blue, and 0 green:
Not much blue.
Not much green.

Comparing a colour with 50 red, 50 blue, and 50 green:
Each colour has at least 10.

Comparing a colour with 200 red, 50 blue, and 0 green:
Not much green.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="实现结构体和枚举"><a href="#实现结构体和枚举" class="headerlink" title="实现结构体和枚举"></a>实现结构体和枚举</h2><p>在这里你可以开始赋予你的结构体和枚举一些真正的力量。要调用 <code>struct</code> 或 <code>enum</code> 上的函数，请使用 <code>impl</code> 块。这些函数被称为<strong>方法</strong>。<code>impl</code>块中有两种方法。</p>
<ul>
<li>常规方法:这些方法取 <strong>self</strong> (或 <strong>&amp;self</strong> 或 <strong>&amp;mut self</strong> )。常规方法使用<code>.</code>(句号)。<code>.clone()</code>是常规方法的一个例子。</li>
<li>关联方法(或 “静态”方法):这些方法不用self。关联的意思是 “相关于”。它们的写法不同，使用 <code>::</code>。<code>String::from()</code>是一个关联方法，<code>Vec::new()</code>也是。你通常看到关联方法用于创建新变量。</li>
</ul>
<p>在我们的例子中，我们将创建Animal并打印它们。</p>
<p>对于新的<code>struct</code>或<code>enum</code>，如果你想使用<code>&#123;:?&#125;</code>来打印，你需要给它<strong>Debug</strong>，所以我们将这样做:如果你在结构体或枚举上面写了<code>#[derive(Debug)]</code>，那么你就可以用<code>&#123;:?&#125;</code>来打印。这些带有<code>#[]</code>的信息被称为<strong>属性</strong>。你有时可以用它们来告诉编译器给你的结构体一个能力，比如<code>Debug</code>。属性有很多，我们以后会学习它们。但是<code>derive</code>可能是最常见的，你经常在结构体和枚举上面看到它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Animal</span> <span class="token punctuation">&#123;</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    animal_type<span class="token punctuation">:</span> <span class="token class-name">AnimalType</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">AnimalType</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Cat</span><span class="token punctuation">,</span>
    <span class="token class-name">Dog</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Self means Animal.</span>
        <span class="token comment">//You can also write Animal instead of Self</span>

        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// When we write Animal::new(), we always get a cat that is 10 years old</span>
            age<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            animal_type<span class="token punctuation">:</span> <span class="token class-name">AnimalType</span><span class="token punctuation">::</span><span class="token class-name">Cat</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">change_to_dog</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// because we are inside Animal, &amp;mut self means &amp;mut Animal</span>
                                  <span class="token comment">// use .change_to_dog() to change the cat to a dog</span>
                                  <span class="token comment">// with &amp;mut self we can change it</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Changing animal to dog!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>animal_type <span class="token operator">=</span> <span class="token class-name">AnimalType</span><span class="token punctuation">::</span><span class="token class-name">Dog</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">change_to_cat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// use .change_to_cat() to change the dog to a cat</span>
        <span class="token comment">// with &amp;mut self we can change it</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Changing animal to cat!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>animal_type <span class="token operator">=</span> <span class="token class-name">AnimalType</span><span class="token punctuation">::</span><span class="token class-name">Cat</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">check_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// we want to read self</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>animal_type <span class="token punctuation">&#123;</span>
            <span class="token class-name">AnimalType</span><span class="token punctuation">::</span><span class="token class-name">Dog</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The animal is a dog"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">AnimalType</span><span class="token punctuation">::</span><span class="token class-name">Cat</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The animal is a cat"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_animal <span class="token operator">=</span> <span class="token class-name">Animal</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Associated method to create a new animal</span>
                                        <span class="token comment">// It is a cat, 10 years old</span>
    new_animal<span class="token punctuation">.</span><span class="token function">check_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_animal<span class="token punctuation">.</span><span class="token function">change_to_dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_animal<span class="token punctuation">.</span><span class="token function">check_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_animal<span class="token punctuation">.</span><span class="token function">change_to_cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_animal<span class="token punctuation">.</span><span class="token function">check_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The animal is a cat
Changing animal to dog!
The animal is a dog
Changing animal to cat!
The animal is a cat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>记住，Self(类型Self)和self(变量self)是缩写。(缩写=简写方式)</p>
<p>所以，在我们的代码中，Self = Animal。另外，<code>fn change_to_dog(&amp;mut self)</code>的意思是<code>fn change_to_dog(&amp;mut Animal)</code>。</p>
<p>下面再举一个小例子。这次我们将在<code>enum</code>上使用<code>impl</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Mood</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Good</span><span class="token punctuation">,</span>
    <span class="token class-name">Bad</span><span class="token punctuation">,</span>
    <span class="token class-name">Sleepy</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Mood</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Good</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Feeling good!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Bad</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Eh, not feeling so good"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Sleepy</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Need sleep NOW"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mood <span class="token operator">=</span> <span class="token class-name">Mood</span><span class="token punctuation">::</span><span class="token class-name">Sleepy</span><span class="token punctuation">;</span>
    my_mood<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打印出<code>Need sleep NOW</code>。</p>
<h2 id="解构"><a href="#解构" class="headerlink" title="解构"></a>解构</h2><p>我们再来看一些解构。你可以通过使用<code>let</code>倒过来从一个结构体或枚举中获取值。我们了解到这是<code>destructuring</code>，因为你得到的变量不是结构体的一部分。现在你分别得到了值。首先是一个简单的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Person</span> <span class="token punctuation">&#123;</span> <span class="token comment">// make a simple struct for a person</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    real_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    happiness<span class="token punctuation">:</span> <span class="token keyword">bool</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> papa_doc <span class="token operator">=</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span> <span class="token comment">// create variable papa_doc</span>
        name<span class="token punctuation">:</span> <span class="token string">"Papa Doc"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        real_name<span class="token punctuation">:</span> <span class="token string">"Clarence"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
        happiness<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span> <span class="token comment">// destructure papa_doc</span>
        name<span class="token punctuation">:</span> a<span class="token punctuation">,</span>
        real_name<span class="token punctuation">:</span> b<span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> c<span class="token punctuation">,</span>
        happiness<span class="token punctuation">:</span> d
    <span class="token punctuation">&#125;</span> <span class="token operator">=</span> papa_doc<span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"They call him &#123;&#125; but his real name is &#123;&#125;. He is &#123;&#125; cm tall and is he happy? &#123;&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:<code>They call him Papa Doc but his real name is Clarence. He is 170 cm tall and is he happy? false</code></p>
<p>你可以看到，这是倒过来的。首先我们说<code>let papa_doc = Person &#123; fields &#125;</code>来创建结构。然后我们说 <code>let Person &#123; fields &#125; = papa_doc</code> 来解构它。</p>
<p>你不必写<code>name: a</code>–你可以直接写<code>name</code>。但这里我们写 <code>name = a</code> 是因为我们想使用一个名字为 <code>a</code> 的变量。</p>
<p>现在再举一个更大的例子。在这个例子中，我们有一个 <code>City</code> 结构。我们给它一个<code>new</code>函数来创建它。然后我们有一个 <code>process_city_values</code> 函数来处理这些值。在函数中，我们只是创建了一个 <code>Vec</code>，但你可以想象，我们可以在解构它之后做更多的事情。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    name_before<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> name_before<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">,</span>
            name_before<span class="token punctuation">,</span>
            population<span class="token punctuation">,</span>
            date_founded<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">process_city_values</span><span class="token punctuation">(</span>city<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">City</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">,</span>
        name_before<span class="token punctuation">,</span>
        population<span class="token punctuation">,</span>
        date_founded<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span> <span class="token operator">=</span> city<span class="token punctuation">;</span>
        <span class="token comment">// now we have the values to use separately</span>
    <span class="token keyword">let</span> two_names <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>name<span class="token punctuation">,</span> name_before<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The city's two names are &#123;:?&#125;"</span><span class="token punctuation">,</span> two_names<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> tallinn <span class="token operator">=</span> <span class="token class-name">City</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Tallinn"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Reval"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">426_538</span><span class="token punctuation">,</span> <span class="token number">1219</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">process_city_values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tallinn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出<code>The city&#39;s two names are [&quot;Tallinn&quot;, &quot;Reval&quot;]</code>。</p>
<h2 id="引用和点运算符"><a href="#引用和点运算符" class="headerlink" title="引用和点运算符"></a>引用和点运算符</h2><p>我们了解到，当你有一个引用时，你需要使用<code>*</code>来获取值。引用是一种不同的类型，所以这是无法运行的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> reference <span class="token operator">=</span> <span class="token operator">&amp;</span>my_number<span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_number <span class="token operator">==</span> reference<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器打印。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: can&#39;t compare &#96;&#123;integer&#125;&#96; with &#96;&amp;&#123;integer&#125;&#96;
 --&gt; src\main.rs:5:30
  |
5 |     println!(&quot;&#123;&#125;&quot;, my_number &#x3D;&#x3D; reference);
  |                              ^^ no implementation for &#96;&#123;integer&#125; &#x3D;&#x3D; &amp;&#123;integer&#125;&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我们把第5行改成<code>println!(&quot;&#123;&#125;&quot;, my_number == *reference);</code>，现在打印的是<code>true</code>，因为现在是<code>i32</code> == <code>i32</code>，而不是<code>i32</code> == <code>&amp;i32</code>。这就是所谓的解引用。</p>
<p>但是当你使用一个方法时，Rust会为你解除引用。方法中的 <code>.</code> 被称为点运算符，它可以免费进行递归。</p>
<p>首先，让我们创建一个有一个 <code>u8</code> 字段的结构。然后，我们将对它进行引用，并尝试进行比较。它将无法工作。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Item</span> <span class="token punctuation">&#123;</span>
    number<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token class-name">Item</span> <span class="token punctuation">&#123;</span>
        number<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> reference_number <span class="token operator">=</span> <span class="token operator">&amp;</span>item<span class="token punctuation">.</span>number<span class="token punctuation">;</span> <span class="token comment">// reference number type is &amp;u8</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> reference_number <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️ &amp;u8 and u8 cannot be compared</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了让它工作，我们需要取消定义。<code>println!(&quot;&#123;&#125;&quot;, *reference_number == 8);</code>.</p>
<p>但如果使用点运算符，我们不需要<code>*</code>。例如</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Item</span> <span class="token punctuation">&#123;</span>
    number<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token class-name">Item</span> <span class="token punctuation">&#123;</span>
        number<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> reference_item <span class="token operator">=</span> <span class="token operator">&amp;</span>item<span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> reference_item<span class="token punctuation">.</span>number <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we don't need to write *reference_item.number</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在让我们为 <code>Item</code> 创建一个方法，将 <code>number</code> 与另一个数字进行比较。我们不需要在任何地方使用 <code>*</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Item</span> <span class="token punctuation">&#123;</span>
    number<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Item</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">compare_number</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other_number<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// takes a reference to self</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Are &#123;&#125; and &#123;&#125; equal? &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>number<span class="token punctuation">,</span> other_number<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>number <span class="token operator">==</span> other_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We don't need to write *self.number</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token class-name">Item</span> <span class="token punctuation">&#123;</span>
        number<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> reference_item <span class="token operator">=</span> <span class="token operator">&amp;</span>item<span class="token punctuation">;</span> <span class="token comment">// This is type &amp;Item</span>
    <span class="token keyword">let</span> reference_item_two <span class="token operator">=</span> <span class="token operator">&amp;</span>reference_item<span class="token punctuation">;</span> <span class="token comment">// This is type &amp;&amp;Item</span>

    item<span class="token punctuation">.</span><span class="token function">compare_number</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// the method works</span>
    reference_item<span class="token punctuation">.</span><span class="token function">compare_number</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// it works here too</span>
    reference_item_two<span class="token punctuation">.</span><span class="token function">compare_number</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// and here</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以只要记住:当你使用<code>.</code>运算符时，你不需要担心<code>*</code>。</p>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>在函数中，你要写出采取什么类型作为输入。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_number</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    number
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token function">return_number</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是如果你想用的不仅仅是<code>i32</code>呢？你可以用泛型来解决。Generics的意思是 “也许是一种类型，也许是另一种类型”。</p>
<p>对于泛型，你可以使用角括号，里面加上类型，像这样。<code>&lt;T&gt;</code> 这意味着 “任何类型你都可以放入函数中” 通常情况下，generics使用一个大写字母的类型(T、U、V等)，尽管你不必只使用一个字母。</p>
<p>这就是你如何改变函数使其通用的方法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_number</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    number
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token function">return_number</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重要的部分是函数名后的<code>&lt;T&gt;</code>。如果没有这个，Rust会认为T是一个具体的(具体的=不是通用的)类型。<br> 如<code>String</code>或<code>i8</code>。</p>
<p>如果我们写出一个类型名，这就更容易理解了。看看我们把 <code>T</code> 改成 <code>MyType</code> 会发生什么。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_number</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">MyType</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">MyType</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ⚠️</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    number
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>大家可以看到，<code>MyType</code>是具体的，不是通用的。所以我们需要写这个，所以现在就可以了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_number</span><span class="token operator">&lt;</span><span class="token class-name">MyType</span><span class="token operator">></span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">MyType</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">MyType</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    number
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token function">return_number</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以单字母<code>T</code>是人的眼睛，但函数名后面的部分是编译器的 “眼睛”。没有了它，就不通用了。</p>
<p>现在我们再回到类型<code>T</code>，因为Rust代码通常使用<code>T</code>。</p>
<p>你会记得Rust中有些类型是<strong>Copy</strong>，有些是<strong>Clone</strong>，有些是<strong>Display</strong>，有些是<strong>Debug</strong>，等等。用<strong>Debug</strong>，我们可以用<code>&#123;:?&#125;</code>来打印。所以现在大家可以看到，我们如果要打印<code>T</code>就有问题了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">print_number</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number: &#123;:?&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print_number</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>print_number</code>需要<strong>Debug</strong>打印<code>number</code>，但是<code>T</code>与<code>Debug</code>是一个类型吗？也许不是。也许它没有<code>#[derive(Debug)]</code>，谁知道呢？编译器也不知道，所以它给出了一个错误。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: &#96;T&#96; doesn&#39;t implement &#96;std::fmt::Debug&#96;
  --&gt; src\main.rs:29:43
   |
29 |     println!(&quot;Here is your number: &#123;:?&#125;&quot;, number);
   |                                           ^^^^^^ &#96;T&#96; cannot be formatted using &#96;&#123;:?&#125;&#96; because it doesn&#39;t implement &#96;std::fmt::Debug&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>T没有实现<strong>Debug</strong>。那么我们是否要为T实现Debug呢？不，因为我们不知道T是什么。但是我们可以告诉函数。”别担心，因为任何T类型的函数都会有Debug”</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span><span class="token punctuation">;</span> <span class="token comment">// Debug is located at std::fmt::Debug. So now we can just write 'Debug'.</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_number</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Debug</span><span class="token operator">></span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// &lt;T: Debug> is the important part</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your number: &#123;:?&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print_number</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在编译器知道:”好的，这个类型T要有Debug”。现在代码工作了，因为<code>i32</code>有Debug。现在我们可以给它很多类型。<code>String</code>, <code>&amp;str</code>, 等等，因为它们都有Debug.</p>
<p>现在我们可以创建一个结构，并用#[derive(Debug)]给它Debug，所以现在我们也可以打印它。我们的函数可以取<code>i32</code>，Animal结构等。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Animal</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_item</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Debug</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your item: &#123;:?&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> charlie <span class="token operator">=</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Charlie"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token number">55</span><span class="token punctuation">;</span>

    <span class="token function">print_item</span><span class="token punctuation">(</span>charlie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_item</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Here is your item: Animal &#123; name: &quot;Charlie&quot;, age: 1 &#125;
Here is your item: 55<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>有时候，我们在一个通用函数中需要不止一个类型。我们必须写出每个类型的名称，并考虑如何使用它。在这个例子中，我们想要两个类型。首先我们要打印一个类型为T的语句。用<code>&#123;&#125;</code>打印比较好，所以我们会要求用<code>Display</code>来打印<code>T</code>。</p>
<p>其次是类型U，<code>num_1</code>和<code>num_2</code>这两个变量的类型为U(U是某种数字)。我们想要比较它们，所以我们需要<code>PartialOrd</code>。这个特性让我们可以使用<code>&lt;</code>、<code>&gt;</code>、<code>==</code>等。我们也想打印它们，所以我们也需要<code>Display</code>来打印<code>U</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cmp<span class="token punctuation">::</span></span><span class="token class-name">PartialOrd</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">compare_and_display</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token punctuation">:</span> <span class="token class-name">Display</span> <span class="token operator">+</span> <span class="token class-name">PartialOrd</span><span class="token operator">></span><span class="token punctuation">(</span>statement<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> num_1<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">,</span> num_2<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;! Is &#123;&#125; greater than &#123;&#125;? &#123;&#125;"</span><span class="token punctuation">,</span> statement<span class="token punctuation">,</span> num_1<span class="token punctuation">,</span> num_2<span class="token punctuation">,</span> num_1 <span class="token operator">></span> num_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">compare_and_display</span><span class="token punctuation">(</span><span class="token string">"Listen up!"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出了<code>Listen up!! Is 9 greater than 8? true</code>。</p>
<p>所以<code>fn compare_and_display&lt;T: Display, U: Display + PartialOrd&gt;(statement: T, num_1: U, num_2: U)</code>说。</p>
<ul>
<li>函数名称是<code>compare_and_display</code>,</li>
<li>第一个类型是T，它是通用的。它必须是一个可以用{}打印的类型。</li>
<li>下一个类型是U，它是通用的。它必须是一个可以用{}打印的类型。另外，它必须是一个可以比较的类型(使用 <code>&gt;</code>、<code>&lt;</code> 和 <code>==</code>)。</li>
</ul>
<p>现在我们可以给<code>compare_and_display</code>不同的类型。<code>statement</code>可以是一个<code>String</code>，一个<code>&amp;str</code>，任何有Display的类型。</p>
<p>为了让通用函数更容易读懂，我们也可以这样写，在代码块之前就写上<code>where</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cmp<span class="token punctuation">::</span></span><span class="token class-name">PartialOrd</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">compare_and_display</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token operator">></span><span class="token punctuation">(</span>statement<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> num_1<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">,</span> num_2<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">)</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token punctuation">,</span>
    <span class="token class-name">U</span><span class="token punctuation">:</span> <span class="token class-name">Display</span> <span class="token operator">+</span> <span class="token class-name">PartialOrd</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;! Is &#123;&#125; greater than &#123;&#125;? &#123;&#125;"</span><span class="token punctuation">,</span> statement<span class="token punctuation">,</span> num_1<span class="token punctuation">,</span> num_2<span class="token punctuation">,</span> num_1 <span class="token operator">></span> num_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">compare_and_display</span><span class="token punctuation">(</span><span class="token string">"Listen up!"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你有很多通用类型时，使用<code>where</code>是一个好主意。</p>
<p>还要注意。</p>
<ul>
<li>如果你有一个类型T和另一个类型T，它们必须是相同的。</li>
<li>如果你有一个类型T和另一个类型U，它们可以是不同的。但它们也可以是相同的。</li>
</ul>
<p>比如说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">say_two</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>statement_1<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> statement_2<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Type T needs Display, type U needs Display</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I have two things to say: &#123;&#125; and &#123;&#125;"</span><span class="token punctuation">,</span> statement_1<span class="token punctuation">,</span> statement_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">say_two</span><span class="token punctuation">(</span><span class="token string">"Hello there!"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I hate sand."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Type T is a &amp;str, but type U is a String.</span>
    <span class="token function">say_two</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Where is Padme?"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Is she all right?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Both types are String.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">I have two things to say: Hello there! and I hate sand.
I have two things to say: Where is Padme? and Is she all right?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="选项和结果"><a href="#选项和结果" class="headerlink" title="选项和结果"></a>选项和结果</h2><p>我们现在理解了枚举和泛型，所以我们可以理解<code>Option</code>和<code>Result</code>。Rust使用这两个枚举来使代码更安全。</p>
<p>我们将从<code>Option</code>开始。</p>
<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><p>当你有一个可能存在，也可能不存在的值时，你就用<code>Option</code>。当一个值存在的时候就是<code>Some(value)</code>，不存在的时候就是<code>None</code>，下面是一个坏代码的例子，可以用<code>Option</code>来改进。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">    <span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">take_fifth</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    value<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token function">take_fifth</span><span class="token punctuation">(</span>new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当我们运行这段代码时，它崩溃。以下是信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">thread &#39;main&#39; panicked at &#39;index out of bounds: the len is 2 but the index is 4&#39;, src\main.rs:34:5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>崩溃的意思是，程序在问题发生之前就停止了。Rust看到函数想要做一些不可能的事情，就会停止。它 “解开堆栈”(从堆栈中取值)，并告诉你 “对不起，我不能这样做”。</p>
<p>所以现在我们将返回类型从<code>i32</code>改为<code>Option&lt;i32&gt;</code>。这意味着 “如果有的话给我一个<code>Some(i32)</code>，如果没有的话给我一个<code>None</code>“。我们说<code>i32</code>是 “包”在一个<code>Option</code>里面，也就是说它在一个<code>Option</code>里面。你必须做一些事情才能把这个值弄出来。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">take_fifth</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> value<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">&#123;</span> <span class="token comment">// .len() gives the length of the vec.</span>
                         <span class="token comment">// It must be at least 5.</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bigger_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;, &#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">take_fifth</span><span class="token punctuation">(</span>new_vec<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">take_fifth</span><span class="token punctuation">(</span>bigger_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印的是<code>None, Some(5)</code>。这下好了，因为现在我们再也不崩溃了。但是我们如何得到5的值呢？</p>
<p>我们可以用 <code>.unwrap()</code> 在一个选项中获取值，但要小心 <code>.unwrap()</code>。这就像拆礼物一样:也许里面有好东西，也许里面有一条愤怒的蛇。只有在你确定的情况下，你才会想要<code>.unwrap()</code>。如果你拆开一个<code>None</code>的值，程序就会崩溃。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">take_fifth</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> value<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bigger_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;, &#123;:?&#125;"</span><span class="token punctuation">,</span>
        <span class="token function">take_fifth</span><span class="token punctuation">(</span>new_vec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// this one is None. .unwrap() will panic!</span>
        <span class="token function">take_fifth</span><span class="token punctuation">(</span>bigger_vec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>消息是: “thread ‘main’ panicked at ‘called <code>Option::unwrap()</code> on a <code>None</code> value’, src\main.rs:14:9”.</p>
<p>但我们不需要使用<code>.unwrap()</code>。我们可以使用<code>match</code>。那么我们就可以把我们有<code>Some</code>的值打印出来，如果有<code>None</code>的值就不要碰。比如说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">take_fifth</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> value<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">handle_option</span><span class="token punctuation">(</span>my_option<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> item <span class="token keyword">in</span> my_option <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> item <span class="token punctuation">&#123;</span>
      <span class="token class-name">Some</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Found a &#123;&#125;!"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Found a None!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bigger_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> option_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make a new vec to hold our options</span>
                                     <span class="token comment">// The vec is type: Vec&lt;Option&lt;i32>>. That means a vec of Option&lt;i32>.</span>

    option_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">take_fifth</span><span class="token punctuation">(</span>new_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This pushes "None" into the vec</span>
    option_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">take_fifth</span><span class="token punctuation">(</span>bigger_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This pushes "Some(5)" into the vec</span>

    <span class="token function">handle_option</span><span class="token punctuation">(</span>option_vec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// handle_option looks at every option in the vec.</span>
                               <span class="token comment">// It prints the value if it is Some. It doesn't touch it if it is None.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Found a None!
Found a 5!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>因为我们知道泛型，所以我们能够读懂<code>Option</code>的代码。它看起来是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>要记住的重要一点是:有了<code>Some</code>，你就有了一个类型为<code>T</code>的值(任何类型)。还要注意的是，<code>enum</code>名字后面的角括号围绕着<code>T</code>是告诉编译器它是通用的。它没有<code>Display</code>这样的trait或任何东西来限制它，所以它可以是任何东西。但是对于<code>None</code>，你什么都没有。</p>
<p>所以在<code>match</code>语句中，对于Option，你不能说。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value is &#123;&#125;"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token class-name">None</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value is &#123;&#125;"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因为<code>None</code>只是<code>None</code>。</p>
<p>当然，还有更简单的方法来使用Option。在这段代码中，我们将使用一个叫做 <code>.is_some()</code> 的方法来告诉我们是否是 <code>Some</code>。(是的，还有一个叫做<code>.is_none()</code>的方法。)在这个更简单的方法中，我们不需要<code>handle_option()</code>了。我们也不需要选项的vec了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">take_fifth</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> value<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bigger_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> vec_of_vecs <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>new_vec<span class="token punctuation">,</span> bigger_vec<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> vec <span class="token keyword">in</span> vec_of_vecs <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> inside_number <span class="token operator">=</span> <span class="token function">take_fifth</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> inside_number<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// .is_some() returns true if we get Some, false if we get None</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"We got: &#123;&#125;"</span><span class="token punctuation">,</span> inside_number<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// now it is safe to use .unwrap() because we already checked</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"We got nothing."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">We got nothing.
We got: 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>结果和Option类似，但这里的区别是。</p>
<ul>
<li>选项大约是<code>Some</code>或<code>None</code>(有值或无值)。</li>
<li>结果大约是<code>Ok</code>或<code>Err</code>(还好的结果，或错误的结果)。</li>
</ul>
<p>所以，<code>Option</code>是如果你在想:”也许会有，也许不会有。”也许会有一些东西，也许不会有。” 但<code>Result</code>是如果你在想: “也许会失败”</p>
<p>比较一下，这里是选项和结果的签名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">E</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以Result在 <code>Ok</code> 里面有一个值，在 <code>Err</code> 里面有一个值。这是因为错误通常(应该有)有信息在里面。</p>
<p><code>Result&lt;T, E&gt;</code>的意思是你要想好<code>Ok</code>要返回什么，<code>Err</code>要返回什么。其实，你可以决定任何事情。甚至这个也可以。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">check_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">check_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>check_error</code>说 “如果得到<code>Ok</code>就返回<code>()</code>，如果得到<code>Err</code>就返回<code>()</code>“。然后我们用<code>()</code>返回<code>Ok</code>。</p>
<p>编译器给了我们一个有趣的警告。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">warning: unused &#96;std::result::Result&#96; that must be used
 --&gt; src\main.rs:6:5
  |
6 |     check_error();
  |     ^^^^^^^^^^^^^^
  |
  &#x3D; note: &#96;#[warn(unused_must_use)]&#96; on by default
  &#x3D; note: this &#96;Result&#96; may be an &#96;Err&#96; variant, which should be handled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是真的:我们只返回了<code>Result</code>，但它可能是一个<code>Err</code>。所以让我们稍微处理一下这个错误，尽管我们仍然没有真正做任何事情。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">give_result</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> input <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token function">give_result</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's okay, guys"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's an error, guys"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打印出<code>It&#39;s an error, guys</code>。所以我们只是处理了第一个错误。</p>
<p>记住，轻松检查的四种方法是<code>.is_some()</code>、<code>is_none()</code>、<code>is_ok()</code>和<code>is_err()</code>。</p>
<p>有时，一个带有Result的函数会用<code>String</code>来表示<code>Err</code>的值。这不是最好的方法，但比我们目前所做的要好一些。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">check_if_five</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> number <span class="token punctuation">&#123;</span>
        <span class="token number">5</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"Sorry, the number wasn't five."</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// This is our error message</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> result_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create a new vec for the results</span>

    <span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token number">2</span><span class="token punctuation">..</span><span class="token number">7</span> <span class="token punctuation">&#123;</span>
        result_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">check_if_five</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push each result into the vec</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> result_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们的Vec打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[Err(&quot;Sorry, the number wasn\&#39;t five.&quot;), Err(&quot;Sorry, the number wasn\&#39;t five.&quot;), Err(&quot;Sorry, the number wasn\&#39;t five.&quot;), Ok(5),
Err(&quot;Sorry, the number wasn\&#39;t five.&quot;)]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>就像Option一样，在<code>Err</code>上用<code>.unwrap()</code>就会崩溃。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">    <span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> error_value<span class="token punctuation">:</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"There was an error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create a Result that is already an Err</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> error_value<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Unwrap it</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序崩溃，打印。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">thread &#39;main&#39; panicked at &#39;called &#96;Result::unwrap()&#96; on an &#96;Err&#96; value: &quot;There was an error&quot;&#39;, src\main.rs:30:20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这些信息可以帮助你修正你的代码。<code>src\main.rs:30:20</code>的意思是 “在目录src的main.rs内，第30行和第20列”。所以你可以去那里查看你的代码并修复问题。</p>
<p>你也可以创建自己的错误类型。标准库中的结果函数和其他人的代码通常都会这样做:例如，标准库中的这个函数。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_utf8</span><span class="token punctuation">(</span>vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">FromUtf8Error</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这个函数接收一个字节向量(<code>u8</code>)，并尝试创建一个<code>String</code>，所以结果的成功情况是<code>String</code>，错误情况是<code>FromUtf8Error</code>。你可以给你的错误类型起任何你想要的名字。</p>
<p>使用 <code>match</code> 与 <code>Option</code> 和 <code>Result</code> 有时需要很多代码。例如，<code>.get()</code> 方法在 <code>Vec</code> 上返回 <code>Option</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> get_one <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 to get the first number</span>
    <span class="token keyword">let</span> get_two <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns None</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> get_one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> get_two<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此打印</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Some(2)
None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以现在我们可以匹配得到数值。让我们使用0到10的范围，看看是否符合<code>my_vec</code>中的数字。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">match</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是好的，但是我们对<code>None</code>不做任何处理，因为我们不关心。这里我们可以用<code>if let</code>把代码变小。<code>if let</code>的意思是 “符合就做，不符合就不做”。<code>if let</code>是指对所有的东西都不关心匹配的时候。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>重要的是要记住</strong>。<code>if let Some(number) = my_vec.get(index)</code>的意思是 “如果你从<code>my_vec.get(index)</code>得到<code>Some(number)</code>“。</p>
<p>另外注意:它使用的是一个<code>=</code>。它不是一个布尔值。</p>
<p><code>while let</code>就像<code>if let</code>的一个while循环。想象一下，我们有这样的气象站数据。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[&quot;Berlin&quot;, &quot;cloudy&quot;, &quot;5&quot;, &quot;-7&quot;, &quot;78&quot;]
[&quot;Athens&quot;, &quot;sunny&quot;, &quot;not humid&quot;, &quot;20&quot;, &quot;10&quot;, &quot;50&quot;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们想得到数字，但不想得到文字。对于数字，我们可以使用一个叫做 <code>parse::&lt;i32&gt;()</code> 的方法。<code>parse()</code>是方法，<code>::&lt;i32&gt;</code>是类型。它将尝试把 <code>&amp;str</code> 变成 <code>i32</code>，如果可以的话就把它给我们。它返回一个 <code>Result</code>，因为它可能无法工作(比如你想让它解析 “Billybrobby”–那不是一个数字)。</p>
<p>我们还将使用 <code>.pop()</code>。这将从向量中取出最后一项。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> weather_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Berlin"</span><span class="token punctuation">,</span> <span class="token string">"cloudy"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"-7"</span><span class="token punctuation">,</span> <span class="token string">"78"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Athens"</span><span class="token punctuation">,</span> <span class="token string">"sunny"</span><span class="token punctuation">,</span> <span class="token string">"not humid"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">,</span> <span class="token string">"50"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token keyword">mut</span> city <span class="token keyword">in</span> weather_vec <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"For the city of &#123;&#125;:"</span><span class="token punctuation">,</span> city<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// In our data, every first item is the city name</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>information<span class="token punctuation">)</span> <span class="token operator">=</span> city<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// This means: keep going until you can't pop anymore</span>
            <span class="token comment">// When the vector reaches 0 items, it will return None</span>
            <span class="token comment">// and it will stop.</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span> information<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Try to parse the variable we called information</span>
                <span class="token comment">// This returns a result. If it's Ok(number), it will print it</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>  <span class="token comment">// We don't write anything here because we do nothing if we get an error. Throw them all away</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">For the city of Berlin:
The number is: 78
The number is: -7
The number is: 5
For the city of Athens:
The number is: 50
The number is: 10
The number is: 20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="其他集合类型"><a href="#其他集合类型" class="headerlink" title="其他集合类型"></a>其他集合类型</h2><p>Rust还有很多集合类型。你可以在标准库中的 <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/beta/std/collections/">https://doc.rust-lang.org/beta/std/collections/</a> 看到它们。那个页面对为什么要使用一种类型有很好的解释，所以如果你不知道你想要什么类型，就去那里。这些集合都在标准库的<code>std::collections</code>里面。使用它们的最好方法是使用 <code>use</code> 语句。<br> 就像我们的<code>enums</code>一样。我们将从<code>HashMap</code>开始，这是很常见的。</p>
<h3 id="HashMap和BTreeMap"><a href="#HashMap和BTreeMap" class="headerlink" title="HashMap和BTreeMap"></a>HashMap和BTreeMap</h3><p>HashMap是由<em>keys</em>和<em>values</em>组成的集合。你使用键来查找与键匹配的值。你可以只用<code>HashMap::new()</code>创建一个新的<code>HashMap</code>，并使用<code>.insert(key, value)</code>来插入元素。</p>
<p><code>HashMap</code>是没有顺序的，所以如果你把<code>HashMap</code>中的每一个键都打印在一起，可能会打印出不同的结果。我们可以在一个例子中看到这一点。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span> <span class="token comment">// This is so we can just write HashMap instead of std::collections::HashMap every time</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// This will have the year and the population for the year</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> tallinn <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Tallinn"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        population<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// So far the HashMap is empty</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    tallinn<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1372</span><span class="token punctuation">,</span> <span class="token number">3_250</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// insert three dates</span>
    tallinn<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1851</span><span class="token punctuation">,</span> <span class="token number">24_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tallinn<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">437_619</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span> <span class="token punctuation">(</span>year<span class="token punctuation">,</span> population<span class="token punctuation">)</span> <span class="token keyword">in</span> tallinn<span class="token punctuation">.</span>population <span class="token punctuation">&#123;</span> <span class="token comment">// The HashMap is HashMap&lt;u32, u32> so it returns a two items each time</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"In the year &#123;&#125; the city of &#123;&#125; had a population of &#123;&#125;."</span><span class="token punctuation">,</span> year<span class="token punctuation">,</span> tallinn<span class="token punctuation">.</span>name<span class="token punctuation">,</span> population<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">In the year 1372 the city of Tallinn had a population of 3250.
In the year 2020 the city of Tallinn had a population of 437619.
In the year 1851 the city of Tallinn had a population of 24000.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>或者可能会打印。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">In the year 1851 the city of Tallinn had a population of 24000.
In the year 2020 the city of Tallinn had a population of 437619.
In the year 1372 the city of Tallinn had a population of 3250.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，它不按顺序排列。</p>
<p>如果你想要一个可以排序的<code>HashMap</code>，你可以用<code>BTreeMap</code>。其实它们之间是非常相似的，所以我们可以快速的把我们的<code>HashMap</code>改成<code>BTreeMap</code>来看看。大家可以看到，这几乎是一样的代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">BTreeMap</span><span class="token punctuation">;</span> <span class="token comment">// Just change HashMap to BTreeMap</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// Just change HashMap to BTreeMap</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> tallinn <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Tallinn"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        population<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Just change HashMap to BTreeMap</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    tallinn<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1372</span><span class="token punctuation">,</span> <span class="token number">3_250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tallinn<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1851</span><span class="token punctuation">,</span> <span class="token number">24_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tallinn<span class="token punctuation">.</span>population<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">437_619</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>year<span class="token punctuation">,</span> population<span class="token punctuation">)</span> <span class="token keyword">in</span> tallinn<span class="token punctuation">.</span>population <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"In the year &#123;&#125; the city of &#123;&#125; had a population of &#123;&#125;."</span><span class="token punctuation">,</span> year<span class="token punctuation">,</span> tallinn<span class="token punctuation">.</span>name<span class="token punctuation">,</span> population<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在会一直打印。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">In the year 1372 the city of Tallinn had a population of 3250.
In the year 1851 the city of Tallinn had a population of 24000.
In the year 2020 the city of Tallinn had a population of 437619.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>现在我们再来看看<code>HashMap</code>。</p>
<p>只要把键放在<code>[]</code>的方括号里，就可以得到<code>HashMap</code>的值。在接下来的这个例子中，我们将带出<code>Bielefeld</code>这个键的值，也就是<code>Germany</code>。但是要注意，因为如果没有键，程序会崩溃。比如你写了<code>println!(&quot;&#123;:?&#125;&quot;, city_hashmap[&quot;Bielefeldd&quot;]);</code>，那么就会崩溃，因为<code>Bielefeldd</code>不存在。</p>
<p>如果你不确定会有一个键，你可以使用<code>.get()</code>，它返回一个<code>Option</code>。如果它存在，将是<code>Some(value)</code>，如果不存在，你将得到<code>None</code>，而不是使程序崩溃。这就是为什么 <code>.get()</code> 是从 <code>HashMap</code> 中获取一个值的比较安全的方法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> canadian_cities <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Calgary"</span><span class="token punctuation">,</span> <span class="token string">"Vancouver"</span><span class="token punctuation">,</span> <span class="token string">"Gimli"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> german_cities <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Karlsruhe"</span><span class="token punctuation">,</span> <span class="token string">"Bad Doberan"</span><span class="token punctuation">,</span> <span class="token string">"Bielefeld"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> city_hashmap <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> city <span class="token keyword">in</span> canadian_cities <span class="token punctuation">&#123;</span>
        city_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> <span class="token string">"Canada"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> city <span class="token keyword">in</span> german_cities <span class="token punctuation">&#123;</span>
        city_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> <span class="token string">"Germany"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> city_hashmap<span class="token punctuation">[</span><span class="token string">"Bielefeld"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> city_hashmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Bielefeld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> city_hashmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Bielefeldd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&quot;Germany&quot;
Some(&quot;Germany&quot;)
None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这是因为<em>Bielefeld</em>存在，但<em>Bielefeldd</em>不存在。</p>
<p>如果<code>HashMap</code>已经有一个键，当你试图把它放进去时，它将覆盖它的值。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> book_hashmap <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    book_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"L'Allemagne Moderne"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    book_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Le Petit Prince"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    book_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"섀도우 오브 유어 스마일"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    book_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Eye of the World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> book_hashmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>Some(&quot;Eye of the World&quot;)</code>，因为它是你最后使用 <code>.insert()</code> 的条目。</p>
<p>检查一个条目是否存在是很容易的，因为你可以用 <code>.get()</code> 检查，它给出了 <code>Option</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> book_hashmap <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    book_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"L'Allemagne Moderne"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> book_hashmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// is_none() returns a bool: true if it's None, false if it's Some</span>
        book_hashmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Le Petit Prince"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> book_hashmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印<code>Some(&quot;L\&#39;Allemagne Moderne&quot;)</code>是因为已经有了key为<code>1</code>的，所以我们没有插入<code>Le Petit Prince</code>。</p>
<p><code>HashMap</code>有一个非常有趣的方法，叫做<code>.entry()</code>，你一定要试试。有了它，你可以在没有键的情况下，用如<code>.or_insert()</code>这类方法来插入值。有趣的是，它还给出了一个可变引用，所以如果你想的话，你可以改变它。首先是一个例子，我们只是在每次插入书名到<code>HashMap</code>时插入一个<code>true</code>。</p>
<p>让我们假设我们有一个图书馆，并希望跟踪我们的书籍。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> book_collection <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"L'Allemagne Moderne"</span><span class="token punctuation">,</span> <span class="token string">"Le Petit Prince"</span><span class="token punctuation">,</span> <span class="token string">"Eye of the World"</span><span class="token punctuation">,</span> <span class="token string">"Eye of the World"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Eye of the World appears twice</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> book_hashmap <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> book <span class="token keyword">in</span> book_collection <span class="token punctuation">&#123;</span>
        book_hashmap<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or_insert</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>book<span class="token punctuation">,</span> true_or_false<span class="token punctuation">)</span> <span class="token keyword">in</span> book_hashmap <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Do we have &#123;&#125;? &#123;&#125;"</span><span class="token punctuation">,</span> book<span class="token punctuation">,</span> true_or_false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Do we have Eye of the World? true
Do we have Le Petit Prince? true
Do we have L&#39;Allemagne Moderne? true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但这并不是我们想要的。也许最好是数一下书的数量，这样我们就知道<em>世界之眼</em> 有两本。首先让我们看看<code>.entry()</code>做了什么，以及<code>.or_insert()</code>做了什么。<code>.entry()</code>其实是返回了一个名为<code>Entry</code>的<code>enum</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token class-name">K</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Entry</span><span class="token operator">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token operator">></span> <span class="token comment">// 🚧</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/collections/hash_map/enum.Entry.html">Entry文档页</a>。下面是其代码的简单版本。<code>K</code>表示key，<code>V</code>表示value。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span>hash_map<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">Entry</span><span class="token operator">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Occupied</span><span class="token punctuation">(</span><span class="token class-name">OccupiedEntry</span><span class="token operator">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Vacant</span><span class="token punctuation">(</span><span class="token class-name">VacantEntry</span><span class="token operator">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后当我们调用<code>.or_insert()</code>时，它就会查看枚举，并决定该怎么做。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">or_insert</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token class-name">V</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">V</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 🚧</span>
    <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Occupied</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">=></span> entry<span class="token punctuation">.</span><span class="token function">into_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Vacant</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">=></span> entry<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有趣的是，它返回一个<code>mut</code>的引用。<code>&amp;mut V</code>. 这意味着你可以使用<code>let</code>将其附加到一个变量上，并改变变量来改变<code>HashMap</code>中的值。所以对于每本书，如果没有条目，我们就会插入一个0。而如果有的话，我们将在引用上使用<code>+= 1</code>来增加数字。现在它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> book_collection <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"L'Allemagne Moderne"</span><span class="token punctuation">,</span> <span class="token string">"Le Petit Prince"</span><span class="token punctuation">,</span> <span class="token string">"Eye of the World"</span><span class="token punctuation">,</span> <span class="token string">"Eye of the World"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> book_hashmap <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> book <span class="token keyword">in</span> book_collection <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> return_value <span class="token operator">=</span> book_hashmap<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or_insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return_value is a mutable reference. If nothing is there, it will be 0</span>
        <span class="token operator">*</span>return_value <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Now return_value is at least 1. And if there was another book, it will go up by 1</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>book<span class="token punctuation">,</span> number<span class="token punctuation">)</span> <span class="token keyword">in</span> book_hashmap <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> book<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>重要的部分是<code>let return_value = book_hashmap.entry(book).or_insert(0);</code>。如果去掉 <code>let</code>，你会得到 <code>book_hashmap.entry(book).or_insert(0)</code>。如果没有<code>let</code>，它什么也不做:它插入了0，没有获取指向0的可变引用。所以我们把它绑定到<code>return_value</code>上，这样我们就可以保留0。然后我们把值增加1，这样<code>HashMap</code>中的每本书都至少有1。然后当<code>.entry()</code>再看<em>世界之眼</em>时，它不会插入任何东西，但它给我们一个可变的1。然后我们把它增加到2，所以它才会打印出这样的结果。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">L&#39;Allemagne Moderne, 1
Le Petit Prince, 1
Eye of the World, 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>你也可以用<code>.or_insert()</code>做一些事情，比如插入一个vec，然后推入数据。让我们假设我们问街上的男人和女人他们对一个政治家的看法。他们给出的评分从0到10。然后我们要把这些数字放在一起，看看这个政治家是更受男人欢迎还是女人欢迎。它可以是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span> <span class="token comment">// This is the raw data</span>
        <span class="token punctuation">(</span><span class="token string">"male"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"female"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"male"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"female"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"female"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"male"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> survey_hash <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> data <span class="token punctuation">&#123;</span> <span class="token comment">// This gives a tuple of (&amp;str, i32)</span>
        survey_hash<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>item<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or_insert</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This pushes the number into the Vec inside</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>male_or_female<span class="token punctuation">,</span> numbers<span class="token punctuation">)</span> <span class="token keyword">in</span> survey_hash <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;: &#123;:?&#125;"</span><span class="token punctuation">,</span> male_or_female<span class="token punctuation">,</span> numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&quot;female&quot;, [5, 6, 5]
&quot;male&quot;, [9, 0, 10]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>重要的一行是:<code>survey_hash.entry(item.0).or_insert(Vec::new()).push(item.1);</code>，所以如果它看到 “女”，就会检查<code>HashMap</code>中是否已经有 “女”。如果没有，它就会插入一个<code>Vec::new()</code>，然后把数字推入。如果它看到 “女性”已经在<code>HashMap</code>中，它将不会插入一个新的Vec，而只是将数字推入其中。</p>
<h3 id="HashSet和BTreeSet"><a href="#HashSet和BTreeSet" class="headerlink" title="HashSet和BTreeSet"></a>HashSet和BTreeSet</h3><p><code>HashSet</code>实际上是一个只有key的<code>HashMap</code>。在<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/collections/struct.HashSet.html">HashSet的页面</a>上面有解释。</p>
<p><code>A hash set implemented as a HashMap where the value is ().</code> 所以这是一个<code>HashMap</code>，有键，没有值。</p>
<p>如果你只是想知道一个键是否存在，或者不存在，你经常会使用<code>HashSet</code>。</p>
<p>想象一下，你有100个随机数，每个数字在1和100之间。如果你这样做，有些数字会出现不止一次，而有些数字根本不会出现。如果你把它们放到<code>HashSet</code>中，那么你就会有一个所有出现的数字的列表。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashSet</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> many_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span>
        <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span>
        <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span>
        <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> number_hashset <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> number <span class="token keyword">in</span> many_numbers <span class="token punctuation">&#123;</span>
        number_hashset<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> hashset_length <span class="token operator">=</span> number_hashset<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The length tells us how many numbers are in it</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"There are &#123;&#125; unique numbers, so we are missing &#123;&#125;."</span><span class="token punctuation">,</span> hashset_length<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">-</span> hashset_length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Let's see what numbers we are missing</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> missing_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">100</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> number_hashset<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>number<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// If .get() returns None,</span>
            missing_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"It does not contain: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> number <span class="token keyword">in</span> missing_vec <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">There are 66 unique numbers, so we are missing 34.
It does not contain: 1 2 4 6 7 9 12 21 23 27 30 31 39 40 45 47 48 50 52 53 62 65 69 70 72 75 77 78 83 85 88 97 98 99<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>BTreeSet</code>与<code>HashSet</code>相似，就像<code>BTreeMap</code>与<code>HashMap</code>相似一样。如果我们把<code>HashSet</code>中的每一项都打印出来，就不知道顺序是什么了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">for</span> entry <span class="token keyword">in</span> number_hashset <span class="token punctuation">&#123;</span> <span class="token comment">// 🚧</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>也许它能打印出这个。<code>67 28 42 25 95 59 87 11 5 81 64 34 8 15 13 86 10 89 63 93 49 41 46 57 60 29 17 22 74 43 32 38 36 76 71 18 14 84 61 16 35 90 56 54 91 19 94 44 3 0 68 80 51 92 24 20 82 26 58 33 55 96 37 66 79 73</code>. 但它几乎不会再以同样的方式打印。</p>
<p>在这里也一样，如果你决定需要订购的话，很容易把你的<code>HashSet</code>改成<code>BTreeSet</code>。在我们的代码中，我们只需要做两处改动，就可以从<code>HashSet</code>切换到<code>BTreeSet</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">BTreeSet</span><span class="token punctuation">;</span> <span class="token comment">// Change HashSet to BTreeSet</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> many_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span>
        <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span>
        <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span>
        <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> number_btreeset <span class="token operator">=</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Change HashSet to BTreeSet</span>

    <span class="token keyword">for</span> number <span class="token keyword">in</span> many_numbers <span class="token punctuation">&#123;</span>
        number_btreeset<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> entry <span class="token keyword">in</span> number_btreeset <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在会按顺序打印。<code>0 3 5 8 10 11 13 14 15 16 17 18 19 20 22 24 25 26 28 29 32 33 34 35 36 37 38 41 42 43 44 46 49 51 54 55 56 57 58 59 60 61 63 64 66 67 68 71 73 74 76 79 80 81 82 84 86 87 89 90 91 92 93 94 95 96</code>.</p>
<h3 id="二叉堆"><a href="#二叉堆" class="headerlink" title="二叉堆"></a>二叉堆</h3><p><code>BinaryHeap</code>是一种有趣的集合类型，因为它大部分是无序的，但也有一点秩序。它把最大的元素放在前面，但其他元素是按任何顺序排列的。</p>
<p>我们将用另一个元素列表来举例，但这次数据少些。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">BinaryHeap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">show_remainder</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BinaryHeap</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token comment">// This function shows the remainder in the BinaryHeap. Actually an iterator would be</span>
                                                         <span class="token comment">// faster than a function - we will learn them later.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> remainder_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> number <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
        remainder_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">*</span>number<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    remainder_vec
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> many_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// These numbers are in order</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_heap <span class="token operator">=</span> <span class="token class-name">BinaryHeap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> number <span class="token keyword">in</span> many_numbers <span class="token punctuation">&#123;</span>
        my_heap<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span> my_heap<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// .pop() returns Some(number) if a number is there, None if not. It pops from the front</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Popped off &#123;&#125;. Remaining numbers are: &#123;:?&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> <span class="token function">show_remainder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_heap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Popped off 30. Remaining numbers are: [25, 15, 20, 0, 10, 5]
Popped off 25. Remaining numbers are: [20, 15, 5, 0, 10]
Popped off 20. Remaining numbers are: [15, 10, 5, 0]
Popped off 15. Remaining numbers are: [10, 0, 5]
Popped off 10. Remaining numbers are: [5, 0]
Popped off 5. Remaining numbers are: [0]
Popped off 0. Remaining numbers are: []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，0指数的数字总是最大的。25, 20, 15, 10, 5, 然后是0.</p>
<p>使用<code>BinaryHeap&lt;(u8, &amp;str)&gt;</code>的一个好方法是用于一个事情的集合。这里我们创建一个<code>BinaryHeap&lt;(u8, &amp;str)&gt;</code>，其中<code>u8</code>是任务重要性的数字。<code>&amp;str</code>是对要做的事情的描述。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">BinaryHeap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> jobs <span class="token operator">=</span> <span class="token class-name">BinaryHeap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add jobs to do throughout the day</span>
    jobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"Write back to email from the CEO"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">"Finish the report today"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"Watch some YouTube"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token string">"Tell your team members thanks for always working hard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"Plan who to hire next for the team"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token operator">=</span> jobs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You need to: &#123;&#125;"</span><span class="token punctuation">,</span> job<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将一直打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You need to: Write back to email from the CEO
You need to: Finish the report today
You need to: Tell your team members thanks for always working hard
You need to: Plan who to hire next for the team
You need to: Watch some YouTube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="VecDeque"><a href="#VecDeque" class="headerlink" title="VecDeque"></a>VecDeque</h3><p><code>VecDeque</code>就是一个<code>Vec</code>，既能从前面弹出item，又能从后面弹出item。Rust有<code>VecDeque</code>是因为<code>Vec</code>很适合从后面(最后一个物品)弹出，但从前面弹出就不那么好了。当你在<code>.pop()</code>上使用<code>Vec</code>的时候，它只是把右边最后一个item取下来，其他的都不会动。但是如果你把它从其他部分取下来，右边的所有物品都会向左移动一个位置。你可以在<code>.remove()</code>的描述中看到这一点。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Removes and returns the element at position index within the vector, shifting all elements after it to the left.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以如果你这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>它将删除 <code>9</code>。索引1中的<code>8</code>将移到索引0，索引2中的<code>7</code>将移到索引1，以此类推。想象一下，一个大停车场，每当有一辆车离开时，右边所有的车都要移过来。</p>
<p>比如说，这对计算机来说是一个<em>很大</em>的工作量。事实上，如果你在playground上运行它，它可能会因为工作太多而直接放弃。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">600_000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">600000</span> <span class="token punctuation">&#123;</span>
        my_vec<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是60万个零的<code>Vec</code>。每次你用<code>remove(0)</code>，它就会把每个零向左移动一个空格。然后它就会做60万次。</p>
<p>用<code>VecDeque</code>就不用担心这个问题了。它通常比<code>Vec</code>慢一点，但如果你要在两端都做事情，那么它就快多了。你可以直接用<code>VecDeque::from</code>与<code>Vec</code>来创建一个。那么我们上面的代码就是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">VecDeque</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">600000</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">600000</span> <span class="token punctuation">&#123;</span>
        my_vec<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pop_front is like .pop but for the front</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在速度快了很多，在playground上，它在一秒内完成，而不是放弃。</p>
<p>在接下来的这个例子中，我们在一个<code>Vec</code>上做一些事。我们创建一个<code>VecDeque</code>，用<code>.push_front()</code>把它们放在前面，所以我们添加的第一个元素会在右边。但是我们推送的每一个元素都是一个<code>(&amp;str, bool)</code>:<code>&amp;str</code>是描述, <code>false</code>表示还没有完成。我们用<code>done()</code>函数从后面弹出一个元素，但是我们不想删除它。相反，我们把<code>false</code>改成<code>true</code>，然后把它推到前面，这样我们就可以保留它。</p>
<p>它看起来是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">VecDeque</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">check_remaining</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">VecDeque</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Each item is a (&amp;str, bool)</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> item<span class="token number">.1</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You must: &#123;&#125;"</span><span class="token punctuation">,</span> item<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">done</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">VecDeque</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> task_done <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pop off the back</span>
    task_done<span class="token number">.1</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                            <span class="token comment">// now it's done - mark as true</span>
    input<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>task_done<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// put it at the front now</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vecdeque <span class="token operator">=</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> things_to_do <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"send email to customer"</span><span class="token punctuation">,</span> <span class="token string">"add new product to list"</span><span class="token punctuation">,</span> <span class="token string">"phone Loki back"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> thing <span class="token keyword">in</span> things_to_do <span class="token punctuation">&#123;</span>
        my_vecdeque<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thing<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">done</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> my_vecdeque<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> my_vecdeque<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">check_remaining</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_vecdeque<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> task <span class="token keyword">in</span> my_vecdeque <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125; "</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You must: phone Loki back
(&quot;add new product to list&quot;, true) (&quot;send email to customer&quot;, true) (&quot;phone Loki back&quot;, false)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="操作符"><a href="#操作符" class="headerlink" title="?操作符"></a>?操作符</h2><p>有一种更短的方法来处理<code>Result</code>(和<code>Option</code>)，它比<code>match</code>和<code>if let</code>更短。它叫做 “问号运算符”，就是<code>?</code>。在返回结果的函数后，可以加上<code>?</code>。这样就会:</p>
<ul>
<li>返回<code>Result</code>里面的内容，如果是<code>Ok</code>。</li>
<li>如果是<code>Err</code>，则将错误传回。</li>
</ul>
<p>换句话说，它几乎为你做了所有的事情。</p>
<p>我们可以用 <code>.parse()</code> 再试一次。我们将编写一个名为 <code>parse_str</code> 的函数，试图将 <code>&amp;str</code> 变成 <code>i32</code>。它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>num<span class="token punctuation">::</span></span><span class="token class-name">ParseIntError</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">parse_str</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> parsed_number <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// Here is the question mark</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>parsed_number<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数接收一个 <code>&amp;str</code>。如果是 <code>Ok</code>，则给出一个 <code>i32</code>，包裹在 <code>Ok</code> 中。如果是 <code>Err</code>，则返回 <code>ParseIntError</code>。然后我们尝试解析这个数字，并加上<code>?</code>。也就是 “检查是否错误，如果没问题就给出Result里面的内容”。如果有问题，就会返回错误并结束。但如果没问题，就会进入下一行。下一行是<code>Ok()</code>里面的数字。我们需要用<code>Ok</code>来包装，因为返回的是<code>Result&lt;i32, ParseIntError&gt;</code>，而不是<code>i32</code>。</p>
<p>现在，我们可以试试我们的函数。让我们看看它对<code>&amp;str</code>的vec有什么作用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">parse_str</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>num<span class="token punctuation">::</span></span><span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> parsed_number <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>parsed_number<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> str_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Seven"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9.0"</span><span class="token punctuation">,</span> <span class="token string">"nice"</span><span class="token punctuation">,</span> <span class="token string">"6060"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> str_vec <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> parsed <span class="token operator">=</span> <span class="token function">parse_str</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Err(ParseIntError &#123; kind: InvalidDigit &#125;)
Ok(8)
Err(ParseIntError &#123; kind: InvalidDigit &#125;)
Err(ParseIntError &#123; kind: InvalidDigit &#125;)
Ok(6060)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们是怎么找到<code>std::num::ParseIntError</code>的呢？一个简单的方法就是再 “问”一下编译器。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> failure <span class="token operator">=</span> <span class="token string">"Not a number"</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    failure<span class="token punctuation">.</span><span class="token function">rbrbrb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️ Compiler: "What is rbrbrb()???"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器不懂，说。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0599]: no method named &#96;rbrbrb&#96; found for enum &#96;std::result::Result&lt;i32, std::num::ParseIntError&gt;&#96; in the current scope
 --&gt; src\main.rs:3:13
  |
3 |     failure.rbrbrb();
  |             ^^^^^^ method not found in &#96;std::result::Result&lt;i32, std::num::ParseIntError&gt;&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以<code>std::result::Result&lt;i32, std::num::ParseIntError&gt;</code>就是我们需要的签名。</p>
<p>我们不需要写 <code>std::result::Result</code>，因为 <code>Result</code> 总是 “在范围内”(在范围内 = 准备好使用)。Rust对我们经常使用的所有类型都是这样做的，所以我们不必写<code>std::result::Result</code>、<code>std::collections::Vec</code>等。</p>
<p>我们现在还没有处理文件这样的东西，所以?操作符看起来还不是太有用。但这里有一个无用但快速的例子，说明你如何在单行上使用它。与其用 <code>.parse()</code> 创建一个 <code>i32</code>，不如做更多。我们将创建一个 <code>u16</code>，然后把它变成 <code>String</code>，再变成 <code>u32</code>，然后再变成 <code>String</code>，最后变成 <code>i32</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>num<span class="token punctuation">::</span></span><span class="token class-name">ParseIntError</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">parse_str</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> parsed_number <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// Add a ? each time to check and pass it on</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>parsed_number<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> str_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Seven"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9.0"</span><span class="token punctuation">,</span> <span class="token string">"nice"</span><span class="token punctuation">,</span> <span class="token string">"6060"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> str_vec <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> parsed <span class="token operator">=</span> <span class="token function">parse_str</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印出同样的东西，但这次我们在一行中处理了三个<code>Result</code>。稍后我们将对文件进行处理，因为它们总是返回<code>Result</code>，因为很多事情都可能出错。</p>
<p>想象一下:你想打开一个文件，向它写入，然后关闭它。首先你需要成功找到这个文件(这就是一个<code>Result</code>)。然后你需要成功地写入它(那是一个<code>Result</code>)。对于<code>?</code>，你可以在一行上完成。</p>
<h3 id="When-panic-and-unwrap-are-good"><a href="#When-panic-and-unwrap-are-good" class="headerlink" title="When panic and unwrap are good"></a>When panic and unwrap are good</h3><p>Rust有一个<code>panic!</code>的宏，你可以用它来让它崩溃。它使用起来很方便。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Time to panic!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>运行程序时，会显示信息<code>&quot;Time to panic!&quot;</code>。<code>thread &#39;main&#39; panicked at &#39;Time to panic!&#39;, src\main.rs:2:3</code></p>
<p>你会记得<code>src\main.rs</code>是目录和文件名，<code>2:3</code>是行名和列名。有了这些信息，你就可以找到代码并修复它。</p>
<p><code>panic!</code>是一个很好用的宏，以确保你知道什么时候有变化。例如，这个叫做<code>prints_three_things</code>的函数总是从一个向量中打印出索引[0]、[1]和[2]。这没关系，因为我们总是给它一个有三个元素的向量。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_three_things</span><span class="token punctuation">(</span>vector<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">prints_three_things</span><span class="token punctuation">(</span>my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印出<code>8, 9, 10</code>，一切正常。</p>
<p>但试想一下，后来我们写的代码越来越多，忘记了<code>my_vec</code>只能有三个元素。现在<code>my_vec</code>在这部分有六个元素。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_three_things</span><span class="token punctuation">(</span>vector<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Now my_vec has six things</span>
  <span class="token function">prints_three_things</span><span class="token punctuation">(</span>my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不会发生错误，因为[0]和[1]和[2]都在这个较长的<code>Vec</code>里面。但如果只能有三个元素呢？我们就不会知道有问题了，因为程序不会崩溃。我们应该这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_three_things</span><span class="token punctuation">(</span>vector<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> vector<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"my_vec must always have three items"</span><span class="token punctuation">)</span> <span class="token comment">// will panic if the length is not 3</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">prints_three_things</span><span class="token punctuation">(</span>my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们知道，如果向量有6个元素，它应该要崩溃:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">    <span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">prints_three_things</span><span class="token punctuation">(</span>vector<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> vector<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"my_vec must always have three items"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vector<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">prints_three_things</span><span class="token punctuation">(</span>my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样我们就得到了<code>thread &#39;main&#39; panicked at &#39;my_vec must always have three items&#39;, src\main.rs:8:9</code>。多亏了<code>panic!</code>，我们现在记得<code>my_vec</code>应该只有三个元素。所以<code>panic!</code>是一个很好的宏，可以在你的代码中创建提醒。</p>
<p>还有三个与<code>panic!</code>类似的宏，你在测试中经常使用。它们分别是 <code>assert!</code>, <code>assert_eq!</code>, 和 <code>assert_ne!</code>.</p>
<p>下面是它们的意思。</p>
<ul>
<li><code>assert!()</code>: 如果<code>()</code>里面的部分不是真的, 程序就会崩溃.</li>
<li><code>assert_eq!()</code>:<code>()</code>里面的两个元素必须相等。</li>
<li><code>assert_ne!()</code>:<code>()</code>里面的两个元素必须不相等。(<em>ne</em>表示不相等)</li>
</ul>
<p>一些例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_name <span class="token operator">=</span> <span class="token string">"Loki Laufeyson"</span><span class="token punctuation">;</span>

    <span class="token macro property">assert!</span><span class="token punctuation">(</span>my_name <span class="token operator">==</span> <span class="token string">"Loki Laufeyson"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_name<span class="token punctuation">,</span> <span class="token string">"Loki Laufeyson"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span>my_name<span class="token punctuation">,</span> <span class="token string">"Mithridates"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这不会有任何作用，因为三个断言宏都没有问题。(这就是我们想要的)</p>
<p>如果你愿意，还可以加个提示信息。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_name <span class="token operator">=</span> <span class="token string">"Loki Laufeyson"</span><span class="token punctuation">;</span>

    <span class="token macro property">assert!</span><span class="token punctuation">(</span>
        my_name <span class="token operator">==</span> <span class="token string">"Loki Laufeyson"</span><span class="token punctuation">,</span>
        <span class="token string">"&#123;&#125; should be Loki Laufeyson"</span><span class="token punctuation">,</span>
        my_name
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>
        my_name<span class="token punctuation">,</span> <span class="token string">"Loki Laufeyson"</span><span class="token punctuation">,</span>
        <span class="token string">"&#123;&#125; and Loki Laufeyson should be equal"</span><span class="token punctuation">,</span>
        my_name
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span>
        my_name<span class="token punctuation">,</span> <span class="token string">"Mithridates"</span><span class="token punctuation">,</span>
        <span class="token string">"You entered &#123;&#125;. Input must not equal Mithridates"</span><span class="token punctuation">,</span>
        my_name
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这些信息只有在程序崩溃时才会显示。所以如果你运行这个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_name <span class="token operator">=</span> <span class="token string">"Mithridates"</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span>
        my_name<span class="token punctuation">,</span> <span class="token string">"Mithridates"</span><span class="token punctuation">,</span>
        <span class="token string">"You enter &#123;&#125;. Input must not equal Mithridates"</span><span class="token punctuation">,</span>
        my_name
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它将显示:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">thread &#39;main&#39; panicked at &#39;assertion failed: &#96;(left !&#x3D; right)&#96;
  left: &#96;&quot;Mithridates&quot;&#96;,
 right: &#96;&quot;Mithridates&quot;&#96;: You entered Mithridates. Input must not equal Mithridates&#39;, src\main.rs:4:5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>所以它说 “你说左！=右，但左==右”。而且它显示我们的信息说<code>You entered Mithridates. Input must not equal Mithridates</code>。</p>
<p>当你在写程序的时候，想让它在出现问题的时候崩溃，<code>unwrap</code>是个好注意。后面，当你的代码写完后，把<code>unwrap</code>改成其他不会崩溃的东西就好了。</p>
<p>你也可以用<code>expect</code>，它和<code>unwrap</code>一样，但是更好一些，因为它支持用户自定义信息。教科书通常会给出这样的建议:”如果你经常使用<code>.unwrap()</code>, 至少也要用<code>.expect()</code>来获得更好的错误信息.”</p>
<p>这样会崩溃的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">get_fourth</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> fourth <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>fourth
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fourth <span class="token operator">=</span> <span class="token function">get_fourth</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>错误信息是<code>thread &#39;main&#39; panicked at &#39;called Option::unwrap() on a None value&#39;, src\main.rs:7:18</code>。</p>
<p>现在我们用<code>expect</code>来写自己的信息。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">get_fourth</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> fourth <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Input vector needs at least 4 items"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>fourth
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fourth <span class="token operator">=</span> <span class="token function">get_fourth</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>又崩溃了，但错误比较多。<code>thread &#39;main&#39; panicked at &#39;Input vector needs at least 4 items&#39;, src\main.rs:7:18</code>. <code>.expect()</code>因为这个原因比<code>.unwrap()</code>要好一点，但是在<code>None</code>上还是会慌。现在这里是一个不好的做法的例子，一个函数试图解包两次。它需要一个<code>Vec&lt;Option&lt;i32&gt;&gt;</code>，所以可能每个部分都会有一个<code>Some&lt;i32&gt;</code>，也可能有一个<code>None</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">try_two_unwraps</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Index 0 is: &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Index 1 is: &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> vector <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// This vector has a None, so it will panic</span>
    <span class="token function">try_two_unwraps</span><span class="token punctuation">(</span>vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>消息是:<code>thread &#39;main&#39; panicked at &#39;called `Option::unwrap()` on a `None` value&#39;, src\main.rs:2:32</code>。我们不检查行号，就不知道是第一个<code>.unwrap()</code>还是第二个<code>.unwrap()</code>。最好是检查长度，也不要解包。不过有了<code>.expect()</code>至少会好<em>一点</em>。下面是<code>.expect()</code>的情况。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">try_two_unwraps</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Index 0 is: &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"The first unwrap had a None!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Index 1 is: &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"The second unwrap had a None!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> vector <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">try_two_unwraps</span><span class="token punctuation">(</span>vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，这是好一点的。<code>thread &#39;main&#39; panicked at &#39;The first unwrap had a None!&#39;, src\main.rs:2:32</code>. 我们也有行号，所以我们可以找到它。</p>
<p>如果你想一直有一个你想选择的值，也可以用<code>unwrap_or</code>。如果你这样做，它永远不会崩溃。就是这样的。</p>
<ul>
<li>1)好，因为你的程序不会崩溃，但</li>
<li>2)如果你想让程序在出现问题时崩溃，也许不好。</li>
</ul>
<p>但通常我们都不希望自己的程序崩溃，所以<code>unwrap_or</code>是个不错的方法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fourth <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If .get doesn't work, we will make the value &amp;0.</span>
                                              <span class="token comment">// .get returns a reference, so we need &amp;0 and not 0</span>
                                              <span class="token comment">// You can write "let *fourth" with a * if you want fourth to be</span>
                                              <span class="token comment">// a 0 and not a &amp;0, but here we just print so it doesn't matter</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> fourth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>0</code>，因为 <code>.unwrap_or(&amp;0)</code> 给出了一个 0，即使它是 <code>None</code>。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>我们以前见过trait:<code>Debug</code>、<code>Copy</code>、<code>Clone</code>都是trait。要给一个类型一个trait，就必须实现它。因为<code>Debug</code>和其他的trait都很常见，所以我们有自动实现的属性。这就是当你写下<code>#[derive(Debug)]</code>所发生的事情:你自动实现了<code>Debug</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyStruct</span> <span class="token punctuation">&#123;</span>
    number<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是其他的特性就比较困难了，所以需要用<code>impl</code>手动实现。例如，<code>Add</code>(在<code>std::ops::Add</code>处找到)是用来累加两个东西的。但是Rust并不知道你到底要怎么累加，所以你必须告诉它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">ThingsToAdd</span> <span class="token punctuation">&#123;</span>
    first_thing<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    second_thing<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以累加<code>first_thing</code>和<code>second_thing</code>，但我们需要提供更多信息。也许我们想要一个<code>f32</code>，所以像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>second_thing <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first_thing <span class="token keyword">as</span> <span class="token keyword">f32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但也许我们想要一个整数，所以像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>second_thing <span class="token keyword">as</span> <span class="token keyword">u32</span> <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first_thing<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>或者我们想把<code>self.first_thing</code>放在<code>self.second_thing</code>旁边，说我们要这样加。所以如果我们把55加到33.4，我们要看到的是5533.4，而不是88.4。</p>
<p>所以首先我们看一下如何创建一个trait。关于<code>trait</code>，要记住的重要一点是，它们是关于行为的。要创建一个trait，写下单词<code>trait</code>，然后创建一些函数。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Animal</span> <span class="token punctuation">&#123;</span> <span class="token comment">// A simple struct - an Animal only has a name</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">Dog</span> <span class="token punctuation">&#123;</span> <span class="token comment">// The dog trait gives some functionality</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">bark</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// It can bark</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Woof woof!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// and it can run</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The dog is running!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Dog</span> <span class="token keyword">for</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Now Animal has the trait Dog</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> rover <span class="token operator">=</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Rover"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    rover<span class="token punctuation">.</span><span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now Animal can use bark()</span>
    rover<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// and it can use run()</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个是可以的，但是我们不想打印 “狗在跑”。如果你想的话，你可以改变<code>trait</code>给你的方法，但你必须有相同的签名。这意味着它需要接受同样的东西，并返回同样的东西。例如，我们可以改变 <code>.run()</code> 的方法，但我们必须遵循签名。签名说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The dog is running!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>fn run(&amp;self)</code>的意思是 “fn <code>run()</code>以<code>&amp;self</code>为参数，不返回任何内容”。所以你不能这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ⚠️</span>
    <span class="token number">5</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Rust会说。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&#x3D; note: expected fn pointer &#96;fn(&amp;Animal)&#96;
           found fn pointer &#96;fn(&amp;Animal) -&gt; i32&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但我们可以做到这一点。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Animal</span> <span class="token punctuation">&#123;</span> <span class="token comment">// A simple struct - an Animal only has a name</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">Dog</span> <span class="token punctuation">&#123;</span> <span class="token comment">// The dog trait gives some functionality</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">bark</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// It can bark</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Woof woof!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// and it can run</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The dog is running!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Dog</span> <span class="token keyword">for</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is running!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> rover <span class="token operator">=</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Rover"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    rover<span class="token punctuation">.</span><span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now Animal can use bark()</span>
    rover<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// and it can use run()</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在它打印的是 <code>Rover is running!</code>。这是好的，因为我们返回的是 <code>()</code>，或者说什么都没有，这就是trait所说的。</p>
<p>当你写一个trait的时候，你可以直接写函数签名，但如果你这样做，用户将不得不写函数实现。我们来试试。现在我们把<code>bark()</code>和<code>run()</code>改成只说<code>fn bark(&amp;self);</code>和<code>fn run(&amp;self);</code>。这不是一个完整的函数实现，所以必须由用户来写。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Animal</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">Dog</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">bark</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bark() says it needs a &amp;self and returns nothing</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// run() says it needs a &amp;self and returns nothing.</span>
                   <span class="token comment">// So now we have to write them ourselves.</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Dog</span> <span class="token keyword">for</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">bark</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, stop barking!!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is running!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> rover <span class="token operator">=</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Rover"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    rover<span class="token punctuation">.</span><span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rover<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，当你创建一个trait时，你必须思考:”我应该写哪些功能？而用户应该写哪些函数？” 如果你认为用户每次使用函数的方式应该是一样的，那么就把函数写出来。如果你认为用户会以不同的方式使用，那就写出函数签名即可。</p>
<p>所以，让我们尝试为我们的struct实现Display特性。首先我们将创建一个简单的结构体:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Cat</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> mr_mantle <span class="token operator">=</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Reggie Mantle"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们要打印<code>mr_mantle</code>。调试很容易得出。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Cat</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> mr_mantle <span class="token operator">=</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Reggie Mantle"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Mr. Mantle is a &#123;:?&#125;"</span><span class="token punctuation">,</span> mr_mantle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但Debug打印不是最漂亮的方式，因为它看起来是这样的:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Mr. Mantle is a Cat &#123; name: &quot;Reggie Mantle&quot;, age: 4 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因此，如果我们想要更好的打印，就需要实现<code>Display</code>为<code>Cat</code>。在<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/fmt/trait.Display.html">https://doc.rust-lang.org/std/fmt/trait.Display.html</a>上我们可以看到Display的信息，还有一个例子。它说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Position</span> <span class="token punctuation">&#123;</span>
    longitude<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    latitude<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Position</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"(&#123;&#125;, &#123;&#125;)"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>longitude<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>latitude<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有些部分我们还不明白，比如<code>&lt;&#39;_&gt;</code>和<code>f</code>在做什么。但我们理解<code>Position</code>结构体:它只是两个<code>f32</code>。我们也明白，<code>self.longitude</code>和<code>self.latitude</code>是结构体中的字段。所以，也许我们的结构体就可以用这个代码，用<code>self.name</code>和<code>self.age</code>。另外，<code>write!</code>看起来很像<code>println!</code>，所以很熟悉。所以我们这样写。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Cat</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; is a cat who is &#123;&#125; years old."</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>让我们添加一个<code>fn main()</code>。现在我们的代码是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Cat</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
      <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; is a cat who is &#123;&#125; years old."</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> mr_mantle <span class="token operator">=</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Reggie Mantle"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> mr_mantle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>成功了! 现在，当我们使用<code>&#123;&#125;</code>打印时，我们得到<code>Reggie Mantle is a cat who is 4 years old.</code>。这看起来好多了。</p>
<p>顺便说一下，如果你实现了<code>Display</code>，那么你就可以免费得到<code>ToString</code>的特性。这是因为你使用<code>format!</code>宏来实现<code>.fmt()</code>函数，这让你可以用<code>.to_string()</code>来创建一个<code>String</code>。所以我们可以做这样的事情，我们把<code>reggie_mantle</code>传给一个想要<code>String</code>的函数，或者其他任何东西。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Cat</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; is a cat who is &#123;&#125; years old."</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_cats</span><span class="token punctuation">(</span>pet<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> pet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> mr_mantle <span class="token operator">=</span> <span class="token class-name">Cat</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Reggie Mantle"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token function">print_cats</span><span class="token punctuation">(</span>mr_mantle<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Turn him into a String here</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Mr. Mantle's String is &#123;&#125; letters long."</span><span class="token punctuation">,</span> mr_mantle<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Turn him into chars and count them</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Reggie Mantle is a cat who is 4 years old.
Mr. Mantle&#39;s String is 42 letters long.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>




<p>关于trait，要记住的是，它们是关于某些东西的行为。你的<code>struct</code>是如何行动的？它能做什么？这就是trait的作用。如果你想想我们到目前为止所看到的一些trait，它们都是关于行为的:<code>Copy</code>是一个类型可以做的事情。<code>Display</code>也是一个类型能做的事情。<code>ToString</code>是另一个trait，它也是一个类型可以做的事情:它可以变化成一个<code>String</code>。在我们的 <code>Dog</code> trait中，<em>Dog</em>这个词并不意味着你能做的事情，但它给出了一些让它做事情的方法。<br> 你也可以为 <code>struct Poodle</code> 或 <code>struct Beagle</code> 实现它，它们都会得到 <code>Dog</code> 方法。</p>
<p>让我们再看一个与单纯行为联系更紧密的例子。我们将想象一个有一些简单角色的幻想游戏。一个是<code>Monster</code>，另外两个是<code>Wizard</code>和<code>Ranger</code>。<code>Monster</code>只是有<code>health</code>，所以我们可以攻击它，其他两个还没有什么。但是我们做了两个trait。一个叫<code>FightClose</code>，让你近身作战。另一个是<code>FightFromDistance</code>，让你在远处战斗。只有<code>Ranger</code>可以使用<code>FightFromDistance</code>。下面是它的样子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Monster</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Wizard</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ranger</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">FightClose</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_sword</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your sword. Your opponent now has &#123;&#125; health left."</span><span class="token punctuation">,</span>
            opponent<span class="token punctuation">.</span>health
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_hand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your hand. Your opponent now has &#123;&#125; health left."</span><span class="token punctuation">,</span>
            opponent<span class="token punctuation">.</span>health
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightClose</span> <span class="token keyword">for</span> <span class="token class-name">Wizard</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightClose</span> <span class="token keyword">for</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">FightFromDistance</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_bow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
            opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span>
                <span class="token string">"You attack with your bow. Your opponent now has &#123;&#125; health left."</span><span class="token punctuation">,</span>
                opponent<span class="token punctuation">.</span>health
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_rock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
            opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your rock. Your opponent now has &#123;&#125; health left."</span><span class="token punctuation">,</span>
            opponent<span class="token punctuation">.</span>health
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightFromDistance</span> <span class="token keyword">for</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> radagast <span class="token operator">=</span> <span class="token class-name">Wizard</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> aragorn <span class="token operator">=</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> uruk_hai <span class="token operator">=</span> <span class="token class-name">Monster</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">40</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    radagast<span class="token punctuation">.</span><span class="token function">attack_with_sword</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aragorn<span class="token punctuation">.</span><span class="token function">attack_with_bow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You attack with your sword. Your opponent now has 30 health left.
You attack with your bow. Your opponent now has 20 health left.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们在trait里面一直传递<code>self</code>，但是我们现在不能用它做什么。那是因为 Rust 不知道什么类型会使用它。它可能是一个 <code>Wizard</code>，也可能是一个 <code>Ranger</code>，也可能是一个叫做 <code>Toefocfgetobjtnode</code> 的新结构，或者其他任何东西。为了让<code>self</code>具有一定的功能，我们可以在trait中添加必要的trait。比如说，如果我们想用<code>&#123;:?&#125;</code>打印，那么我们就需要<code>Debug</code>。你只要把它写在<code>:</code>(冒号)后面，就可以把它添加到trait中。现在我们的代码是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Monster</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span> <span class="token comment">// Now Wizard has Debug</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Wizard</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token comment">// Now Wizard has health</span>
<span class="token punctuation">&#125;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span> <span class="token comment">// So does Ranger</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ranger</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token comment">// So does Ranger</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">FightClose</span><span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Now a type needs Debug to use FightClose</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_sword</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your sword. Your opponent now has &#123;&#125; health left. You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token comment">// We can now print self with &#123;:?&#125; because we have Debug</span>
            opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_hand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your hand. Your opponent now has &#123;&#125; health left.  You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span>
            opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightClose</span> <span class="token keyword">for</span> <span class="token class-name">Wizard</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightClose</span> <span class="token keyword">for</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">FightFromDistance</span><span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span> <span class="token punctuation">&#123;</span> <span class="token comment">// We could also do trait FightFromDistance: FightClose because FightClose needs Debug</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_bow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
            opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span>
                <span class="token string">"You attack with your bow. Your opponent now has &#123;&#125; health left.  You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span>
                opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> <span class="token keyword">self</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">attack_with_rock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
            opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your rock. Your opponent now has &#123;&#125; health left.  You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span>
            opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> <span class="token keyword">self</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightFromDistance</span> <span class="token keyword">for</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> radagast <span class="token operator">=</span> <span class="token class-name">Wizard</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> aragorn <span class="token operator">=</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">80</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> uruk_hai <span class="token operator">=</span> <span class="token class-name">Monster</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">40</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    radagast<span class="token punctuation">.</span><span class="token function">attack_with_sword</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aragorn<span class="token punctuation">.</span><span class="token function">attack_with_bow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You attack with your sword. Your opponent now has 30 health left. You are now at: Wizard &#123; health: 60 &#125;
You attack with your bow. Your opponent now has 20 health left.  You are now at: Ranger &#123; health: 80 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在真实的游戏中，可能最好为每个类型重写这个，因为<code>You are now at: Wizard &#123; health: 60 &#125;</code>看起来有点可笑。这也是为什么trait里面的方法通常很简单，因为你不知道什么类型会使用它。例如，你不能写出 <code>self.0 += 10</code> 这样的东西。但是这个例子表明，我们可以在我们正在写的trait里面使用其他的trait。当我们这样做的时候，我们会得到一些我们可以使用的方法。</p>
<p>另外一种使用trait的方式是使用所谓的<code>trait bounds</code>。意思是 “通过一个trait进行限制”。trait限制很简单，因为一个trait实际上不需要任何方法，或者说根本不需要任何东西。让我们用类似但不同的东西重写我们的代码。这次我们的trait没有任何方法，但我们有其他需要trait使用的函数。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span><span class="token punctuation">;</span>  <span class="token comment">// So we don't have to write std::fmt::Debug every time now</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Monster</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Wizard</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Ranger</span> <span class="token punctuation">&#123;</span>
    health<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">trait</span> <span class="token class-name">Magic</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// No methods for any of these traits. They are just trait bounds</span>
<span class="token keyword">trait</span> <span class="token class-name">FightClose</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">trait</span> <span class="token class-name">FightFromDistance</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">FightClose</span> <span class="token keyword">for</span> <span class="token class-name">Ranger</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Each type gets FightClose,</span>
<span class="token keyword">impl</span> <span class="token class-name">FightClose</span> <span class="token keyword">for</span> <span class="token class-name">Wizard</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">FightFromDistance</span> <span class="token keyword">for</span> <span class="token class-name">Ranger</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// but only Ranger gets FightFromDistance</span>
<span class="token keyword">impl</span> <span class="token class-name">Magic</span> <span class="token keyword">for</span> <span class="token class-name">Wizard</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">// and only Wizard gets Magic</span>

<span class="token keyword">fn</span> <span class="token function-definition function">attack_with_bow</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">FightFromDistance</span> <span class="token operator">+</span> <span class="token class-name">Debug</span><span class="token operator">></span><span class="token punctuation">(</span>character<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>
        opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"You attack with your bow. Your opponent now has &#123;&#125; health left.  You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span>
            opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> character
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">attack_with_sword</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">FightClose</span> <span class="token operator">+</span> <span class="token class-name">Debug</span><span class="token operator">></span><span class="token punctuation">(</span>character<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"You attack with your sword. Your opponent now has &#123;&#125; health left. You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span>
        opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> character
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">fireball</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Magic</span> <span class="token operator">+</span> <span class="token class-name">Debug</span><span class="token operator">></span><span class="token punctuation">(</span>character<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">,</span> opponent<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Monster</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> <span class="token number">15</span> <span class="token punctuation">&#123;</span>
        opponent<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You raise your hands and cast a fireball! Your opponent now has &#123;&#125; health left. You are now at: &#123;:?&#125;"</span><span class="token punctuation">,</span>
    opponent<span class="token punctuation">.</span>health<span class="token punctuation">,</span> character<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> radagast <span class="token operator">=</span> <span class="token class-name">Wizard</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> aragorn <span class="token operator">=</span> <span class="token class-name">Ranger</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">80</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> uruk_hai <span class="token operator">=</span> <span class="token class-name">Monster</span> <span class="token punctuation">&#123;</span> health<span class="token punctuation">:</span> <span class="token number">40</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token function">attack_with_sword</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>radagast<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">attack_with_bow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aragorn<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireball</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>radagast<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> uruk_hai<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印出来的东西几乎是一样的。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You attack with your sword. Your opponent now has 30 health left. You are now at: Wizard &#123; health: 60 &#125;
You attack with your bow. Your opponent now has 20 health left.  You are now at: Ranger &#123; health: 80 &#125;
You raise your hands and cast a fireball! Your opponent now has 0 health left. You are now at: Wizard &#123; health: 60 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>所以你可以看到，当你使用traits时，有很多方法可以做同样的事情。这一切都取决于什么对你正在编写的程序最有意义。</p>
<p>现在让我们来看看如何实现一些在Rust中使用的主要trait。</p>
<h3 id="From-trait"><a href="#From-trait" class="headerlink" title="From trait"></a>From trait</h3><p><em>From</em>是一个非常方便的trait，你知道这一点，因为你已经看到了很多。使用<em>From</em>，你可以从一个<code>&amp;str</code>创建一个<code>String</code>，你也可以用许多其他类型创建多种类型。例如，Vec使用<em>From</em>来创建以下类型:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">From&lt;&amp;&#39;_ [T]&gt;
From&lt;&amp;&#39;_ mut [T]&gt;
From&lt;&amp;&#39;_ str&gt;
From&lt;&amp;&#39;a Vec&lt;T&gt;&gt;
From&lt;[T; N]&gt;
From&lt;BinaryHeap&lt;T&gt;&gt;
From&lt;Box&lt;[T]&gt;&gt;
From&lt;CString&gt;
From&lt;Cow&lt;&#39;a, [T]&gt;&gt;
From&lt;String&gt;
From&lt;Vec&lt;NonZeroU8&gt;&gt;
From&lt;Vec&lt;T&gt;&gt;
From&lt;VecDeque&lt;T&gt;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里有很多<code>Vec::from()</code>我们还没有用过。我们来做几个，看看会怎么样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span> <span class="token comment">// We will make a generic function to print them so we want Display</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Take any Vec&lt;T> if type T has Display</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> array_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Try from an array</span>
    <span class="token function">print_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>array_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> str_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"What kind of vec will I be?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// An array from a &amp;str? This will be interesting</span>
    <span class="token function">print_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> string_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"What kind of vec will a String be?"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Also from a String</span>
    <span class="token function">print_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>string_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印的内容如下。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">8 9 10
87 104 97 116 32 107 105 110 100 32 111 102 32 118 101 99 32 119 105 108 108 32 73 32 98 101 63
87 104 97 116 32 107 105 110 100 32 111 102 32 118 101 99 32 119 105 108 108 32 97 32 83 116 114 105 110 103 32 98 101 63<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果从类型上看，第二个和第三个向量是<code>Vec&lt;u8&gt;</code>，也就是<code>&amp;str</code>和<code>String</code>的字节。所以你可以看到<code>From</code>是非常灵活的，用的也很多。我们用自己的类型来试试。</p>
<p>我们将创建两个结构体，然后为其中一个结构体实现<code>From</code>。一个结构体将是<code>City</code>，另一个结构体将是<code>Country</code>。我们希望能够做到这一点。<code>let country_name = Country::from(vector_of_cities)</code>.</p>
<p>它看起来是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span> <span class="token comment">// So we can print City</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span> <span class="token comment">// just a new function</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            population<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span> <span class="token comment">// Country also needs to be printed</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Country</span> <span class="token punctuation">&#123;</span>
    cities<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">City</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// Our cities go in here</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">City</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Note: we don't have to write From&lt;City>, we can also do</span>
                                   <span class="token comment">// From&lt;Vec&lt;City>>. So we can also implement on a type that</span>
                                   <span class="token comment">// we didn't create</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">from</span><span class="token punctuation">(</span>cities<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">City</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span> cities <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">print_cities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// function to print the cities in Country</span>
        <span class="token keyword">for</span> city <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>cities <span class="token punctuation">&#123;</span>
            <span class="token comment">// &amp; because Vec&lt;City> isn't Copy</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125; has a population of &#123;:?&#125;."</span><span class="token punctuation">,</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span> city<span class="token punctuation">.</span>population<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> helsinki <span class="token operator">=</span> <span class="token class-name">City</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Helsinki"</span><span class="token punctuation">,</span> <span class="token number">631_695</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> turku <span class="token operator">=</span> <span class="token class-name">City</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Turku"</span><span class="token punctuation">,</span> <span class="token number">186_756</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> finland_cities <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>helsinki<span class="token punctuation">,</span> turku<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// This is the Vec&lt;City></span>
    <span class="token keyword">let</span> finland <span class="token operator">=</span> <span class="token class-name">Country</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>finland_cities<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// So now we can use From</span>

    finland<span class="token punctuation">.</span><span class="token function">print_cities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&quot;Helsinki&quot; has a population of 631695.
&quot;Turku&quot; has a population of 186756.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>你可以看到，<code>From</code>很容易从你没有创建的类型中实现，比如<code>Vec</code>、<code>i32</code>等等。这里还有一个例子，我们创建一个有两个向量的向量。第一个向量存放偶数，第二个向量存放奇数。对于<code>From</code>，你可以给它一个<code>i32</code>的向量，它会把它变成<code>Vec&lt;Vec&lt;i32&gt;&gt;</code>:一个容纳<code>i32</code>的向量。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>convert<span class="token punctuation">::</span></span><span class="token class-name">From</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">EvenOddVec</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">EvenOddVec</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">from</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> even_odd_vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// A vec with two empty vecs inside</span>
                                                                    <span class="token comment">// This is the return value but first we must fill it</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> item <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
                even_odd_vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                even_odd_vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">Self</span><span class="token punctuation">(</span>even_odd_vec<span class="token punctuation">)</span> <span class="token comment">// Now it is done so we return it as Self (Self = EvenOddVec)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> bunch_of_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">222</span><span class="token punctuation">,</span> <span class="token number">9787</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token class-name">EvenOddVec</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>bunch_of_numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Even numbers: &#123;:?&#125;\nOdd numbers: &#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_vec<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Even numbers: [8, 222, 0, 8]
Odd numbers: [7, -1, 3, 9787, -47, 77, 55, 7]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>像 <code>EvenOddVec</code> 这样的类型可能最好是通用 <code>T</code>，这样我们就可以使用许多数字类型。如果你想练习的话，你可以试着把这个例子做成通用的。</p>
<h3 id="在函数中使用字符串和-amp-str"><a href="#在函数中使用字符串和-amp-str" class="headerlink" title="在函数中使用字符串和&amp;str"></a>在函数中使用字符串和&amp;str</h3><p>有时你想让一个函数可以同时接受 <code>String</code> 和 <code>&amp;str</code>。你可以通过泛型和 <code>AsRef</code> 特性来实现这一点。<code>AsRef</code> 用于从一个类型向另一个类型提供引用。如果你看看 <code>String</code> 的文档，你可以看到它对许多类型都有 <code>AsRef</code>。</p>
<p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/string/struct.String.html">https://doc.rust-lang.org/std/string/struct.String.html</a></p>
<p>下面是它们的一些函数签名。</p>
<p><code>AsRef&lt;str&gt;</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">impl</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token keyword">str</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">String</span>

<span class="token keyword">fn</span> <span class="token function-definition function">as_ref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>AsRef&lt;[u8]&gt;</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">impl</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">String</span>

<span class="token keyword">fn</span> <span class="token function-definition function">as_ref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>AsRef&lt;OsStr&gt;</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">impl</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">OsStr</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">String</span>

<span class="token keyword">fn</span> <span class="token function-definition function">as_ref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token class-name">OsStr</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，它需要<code>&amp;self</code>，并给出另一个类型的引用。这意味着，如果你有一个通用类型T，你可以说它需要<code>AsRef&lt;str&gt;</code>。如果你这样做，它将能够使用一个<code>&amp;str</code>和一个<code>String</code>。</p>
<p>我们先说说泛型函数。这个还不能用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">print_it</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token string">"Please print me"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Rust说<code>error[E0277]: T doesn&#39;t implement std::fmt::Display</code>。所以我们会要求T实现Display。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_it</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token string">"Please print me"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在可以用了，打印出<code>Please print me</code>。这是好的，但T仍然可以是多种类型。<br>可以是<code>i8</code>，也可以是<code>f32</code>，或者其他任何实现了<code>Display</code>的类型。我们加上<code>AsRef&lt;str&gt;</code>，现在T需要<code>AsRef&lt;str&gt;</code>和<code>Display</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_it</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token keyword">str</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token string">"Please print me"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token string">"Also, please print me"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// print_it(7); &lt;- This will not print</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在，它不会接受<code>i8</code>这样的类型。</p>
<p>不要忘了，当函数变长时，你可以用<code>where</code>来写不同的函数。如果我们加上Debug，那么就会变成<code>fn print_it&lt;T: AsRef&lt;str&gt; + Display + Debug&gt;(input: T)</code>，这一行就很长了。所以我们可以这样写。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Debug</span><span class="token punctuation">,</span> <span class="token class-name">Display</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// add Debug</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_it</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token comment">// Now this line is easy to read</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token keyword">str</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token class-name">Debug</span> <span class="token operator">+</span> <span class="token class-name">Display</span><span class="token punctuation">,</span> <span class="token comment">// and these traits are easy to read</span>
<span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token string">"Please print me"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token string">"Also, please print me"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="链式方法"><a href="#链式方法" class="headerlink" title="链式方法"></a>链式方法</h2><p>Rust是一种系统编程语言，就像C和C++一样，它的代码可以写成独立的命令，单独成行，但它也有函数式风格。两种风格都可以，但函数式通常比较短。下面以非函数式(称为 “命令式”)为例，让<code>Vec</code>从1到10。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> counter <span class="token operator">&lt;</span> <span class="token number">11</span> <span class="token punctuation">&#123;</span>
        new_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印<code>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code>。</p>
<p>而这里是函数式风格的例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Or you can write it like this:</span>
    <span class="token comment">// let new_vec: Vec&lt;i32> = (1..=10).collect();</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>.collect()</code>可以为很多类型做集合，所以我们要告诉它类型。</p>
<p>用函数式可以链接方法。”链接方法”的意思是把很多方法放在一个语句中。下面是一个很多方法链在一起的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就创建了一个<code>[3, 4, 5, 6]</code>的Vec。这一行的信息量很大，所以把每个方法放在新的一行上会有帮助。让我们这样做，以使其更容易阅读。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> my_vec
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// "iterate" over the items (iterate = work with each item inside it). into_iter() gives us owned values, not references</span>
        <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// skip over three items: 0, 1, and 2</span>
        <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// take the next four: 3, 4, 5, and 6</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// put them in a new Vec&lt;i32></span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你了解闭包和迭代器时，你可以最好地使用这种函数式。所以我们接下来将学习它们。</p>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>迭代器是一个构造，它可以给你集合中的元素，一次一个。实际上，我们已经使用了很多迭代器:<code>for</code>循环给你一个迭代器。当你想在其他时候使用迭代器时，你必须选择什么样的迭代器:</p>
<ul>
<li><code>.iter()</code> 引用的迭代器</li>
<li><code>.iter_mut()</code> 可变引用的迭代器</li>
<li><code>.into_iter()</code> 值的迭代器(不是引用)</li>
</ul>
<p><code>for</code>循环其实只是一个使用<code>.iter_mut()</code>的迭代器。这就是为什么你在使用它的时候可以改变值的原因。</p>
<p>我们可以这样使用迭代器。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> vector1 <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// we will use .iter() and .into_iter() on this one</span>
    <span class="token keyword">let</span> vector1_a <span class="token operator">=</span> vector1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> vector1_b <span class="token operator">=</span> vector1<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> vector2 <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// we will use .iter_mut() on this one</span>
    vector2<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>x <span class="token operator">+=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> vector1_a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> vector2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> vector1_b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[2, 3, 4]
[110, 120, 130]
[10, 20, 30]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>前两个我们用了一个叫<code>.map()</code>的方法。这个方法可以让你对每一个元素做一些事情，然后把它传递下去。最后我们用的是一个叫<code>.for_each()</code>的方法。这个方法只是让你对每一个元素做一些事情。<code>.iter_mut()</code>加上<code>for_each()</code>基本上就是一个<code>for</code>的循环。在每一个方法里面，我们可以给每一个元素起一个名字(我们刚才叫它 <code>x</code>)，然后用它来改变它。这些被称为闭包，我们将在下一节学习它们。</p>
<p>让我们再来看看它们，一次一个。</p>
<p>首先我们用<code>.iter()</code>对<code>vector1</code>进行引用。我们给每个元素都加了1，并使其成为一个新的Vec。<code>vector1</code>还活着，因为我们只用了引用:我们没有按值取。现在我们有 <code>vector1</code>，还有一个新的 Vec 叫 <code>vector1_a</code>。因为<code>.map()</code>只是传递了它，所以我们需要使用<code>.collect()</code>把它变成一个<code>Vec</code>。</p>
<p>然后我们用<code>into_iter</code>从<code>vector1</code>中按值得到一个迭代器。这样就破坏了<code>vector1</code>，因为这就是<code>into_iter()</code>的作用。所以我们做了<code>vector1_b</code>之后，就不能再使用<code>vector1</code>了。</p>
<p>最后我们在<code>vector2</code>上使用<code>.iter_mut()</code>。它是可变的，所以我们不需要使用<code>.collect()</code>来创建一个新的Vec。相反，我们用可变引用改变同一Vec中的值。所以<code>vector2</code>仍然存在。因为我们不需要一个新的Vec，我们使用<code>for_each</code>:它就像一个<code>for</code>循环。</p>
<h3 id="迭代器如何工作"><a href="#迭代器如何工作" class="headerlink" title="迭代器如何工作"></a>迭代器如何工作</h3><p>迭代器的工作原理是使用一个叫做 <code>.next()</code> 的方法，它给出一个 <code>Option</code>。当你使用迭代器时，Rust会一遍又一遍地调用<code>next()</code>。如果得到 <code>Some</code>，它就会继续前进。如果得到 <code>None</code>，它就停止。</p>
<p>你还记得 <code>assert_eq!</code> 宏吗？在文档中，你经常看到它。这里它展示了迭代器的工作原理。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token char string">'a'</span><span class="token punctuation">,</span> <span class="token char string">'b'</span><span class="token punctuation">,</span> <span class="token char string">'거'</span><span class="token punctuation">,</span> <span class="token char string">'柳'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Just a regular Vec</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec_iter <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is an Iterator type now, but we haven't called it yet</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_vec_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Call the first item with .next()</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_vec_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token char string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Call the next</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_vec_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token char string">'거'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Again</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_vec_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token char string">'柳'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Again</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_vec_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Nothing is left: just None</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>my_vec_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// You can keep calling .next() but it will always be None</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为自己的struct或enum实现<code>Iterator</code>并不难。首先我们创建一个书库，想一想。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span> <span class="token comment">// we want to print it with &#123;:?&#125;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Library</span> <span class="token punctuation">&#123;</span>
    library_type<span class="token punctuation">:</span> <span class="token class-name">LibraryType</span><span class="token punctuation">,</span> <span class="token comment">// this is our enum</span>
    books<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// list of books</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">LibraryType</span> <span class="token punctuation">&#123;</span> <span class="token comment">// libraries can be city libraries or country libraries</span>
    <span class="token class-name">City</span><span class="token punctuation">,</span>
    <span class="token class-name">Country</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Library</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">add_book</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> book<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// we use add_book to add new books</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we take a &amp;str and turn it into a String, then add it to the Vec</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span> <span class="token comment">// this creates a new Library</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            library_type<span class="token punctuation">:</span> <span class="token class-name">LibraryType</span><span class="token punctuation">::</span><span class="token class-name">City</span><span class="token punctuation">,</span> <span class="token comment">// most are in the city so we'll choose City</span>
                                             <span class="token comment">// most of the time</span>
            books<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_library <span class="token operator">=</span> <span class="token class-name">Library</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make a new library</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"The Doom of the Darksword"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add some books</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"Demian - die Geschichte einer Jugend"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"구운몽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"吾輩は猫である"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_library<span class="token punctuation">.</span>books<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we can print our list of books</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这很好用。现在我们想为库实现<code>Iterator</code>，这样我们就可以在<code>for</code>循环中使用它。现在如果我们尝试 <code>for</code> 循环，它就无法工作。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">for</span> item <span class="token keyword">in</span> my_library <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>它说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: &#96;Library&#96; is not an iterator
  --&gt; src\main.rs:47:16
   |
47 |    for item in my_library &#123;
   |                ^^^^^^^^^^ &#96;Library&#96; is not an iterator
   |
   &#x3D; help: the trait &#96;std::iter::Iterator&#96; is not implemented for &#96;Library&#96;
   &#x3D; note: required by &#96;std::iter::IntoIterator::into_iter&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是我们可以用<code>impl Iterator for Library</code>把库做成迭代器。<code>Iterator</code>trait的信息在标准库中。<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/iter/trait.Iterator.html">https://doc.rust-lang.org/std/iter/trait.Iterator.html</a></p>
<p>在页面的左上方写着:<code>Associated Types: Item</code>和<code>Required Methods: next</code>。”关联类型”的意思是 “一起使用的类型”。我们的关联类型将是<code>String</code>，因为我们希望迭代器给我们提供String。</p>
<p>在页面中，它有一个看起来像这样的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// an iterator which alternates between Some and None</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Alternate</span> <span class="token punctuation">&#123;</span>
    state<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">Alternate</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// if it's even, Some(i32), else None</span>
        <span class="token keyword">if</span> val <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">None</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到<code>impl Iterator for Alternate</code>下面写着<code>type Item = i32</code>。这就是关联类型。我们的迭代器将针对我们的书籍列表，这是一个<code>Vec&lt;String&gt;</code>。当我们调用next的时候。<br> 它将给我们一个<code>String</code>。所以我们就写<code>type Item = String;</code>。这就是关联项。</p>
<p>为了实现 <code>Iterator</code>，你需要写 <code>fn next()</code> 函数。这是你决定迭代器应该做什么的地方。对于我们的 <code>Library</code>，我们首先希望它给我们最后一本书。所以我们将<code>match</code>与<code>.pop()</code>一起，如果是<code>Some</code>的话，就把最后一项去掉。我们还想为每个元素打印 “is found!”。现在它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Library</span> <span class="token punctuation">&#123;</span>
    library_type<span class="token punctuation">:</span> <span class="token class-name">LibraryType</span><span class="token punctuation">,</span>
    books<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug, Clone)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">LibraryType</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">City</span><span class="token punctuation">,</span>
    <span class="token class-name">Country</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Library</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">add_book</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> book<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            library_type<span class="token punctuation">:</span> <span class="token class-name">LibraryType</span><span class="token punctuation">::</span><span class="token class-name">City</span><span class="token punctuation">,</span>
            <span class="token comment">// most of the time</span>
            books<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">Library</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Some</span><span class="token punctuation">(</span>book <span class="token operator">+</span> <span class="token string">" is found!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Rust allows String + &amp;str</span>
            <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_library <span class="token operator">=</span> <span class="token class-name">Library</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"The Doom of the Darksword"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"Demian - die Geschichte einer Jugend"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"구운몽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_library<span class="token punctuation">.</span><span class="token function">add_book</span><span class="token punctuation">(</span><span class="token string">"吾輩は猫である"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> my_library<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// we can use a for loop now. Give it a clone so Library won't be destroyed</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">吾輩は猫である is found!
구운몽 is found!
Demian - die Geschichte einer Jugend is found!
The Doom of the Darksword is found!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>闭包就像快速函数，不需要名字。有时它们被称为lambda。Closures很容易辨识，因为它们使用<code>||</code>而不是<code>()</code>。它们在 Rust 中非常常见，一旦你学会了使用它们，你就会爱不释手。</p>
<p>你可以将一个闭包绑定到一个变量上，然后当你使用它时，它看起来就像一个函数一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"This is a closure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这个闭包什么都不需要:<code>||</code>，并打印一条信息。<code>This is a closure</code>.</p>
<p>在<code>||</code>之间我们可以添加输入变量和类型，就像在<code>()</code>里面添加函数一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">5
10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>当闭包变得更复杂时，你可以添加一个代码块。那就可以随心所欲的长。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> number <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> other_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The two numbers are &#123;&#125; and &#123;&#125;."</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> other_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// This closure can be as long as we want, just like a function.</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是闭包是特殊的，因为它可以接受闭包之外的变量，即使你只写<code>||</code>。所以你可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number_one <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> number_two <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> number_one <span class="token operator">+</span> number_two<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这就打印出了<code>16</code>。你不需要在 <code>||</code> 中放入任何东西，因为它可以直接取 <code>number_one</code> 和 <code>number_two</code> 并添加它们。</p>
<p>顺便说一下，这就是<strong>closure</strong>这个名字的由来，因为它们会取变量并将它们 “包围”在里面。如果你想很正确的说。</p>
<ul>
<li>一个<code>||</code>如果不把变量从外面包围起来 那就是一个 “匿名函数”. 匿名的意思是 “没有名字”。它的工作原理更像一个普通函数。</li>
<li><code>||</code> 从外部包围变量的函数是 “closure”。它把周围的变量 “封闭”起来使用。</li>
</ul>
<p>但是人们经常会把所有的<code>||</code>函数都叫做闭包，所以你不用担心名字的问题。我们只对任何带有<code>||</code>的函数说 “closure”，但请记住，它可能意味着一个 “匿名函数”。</p>
<p>为什么要知道这两者的区别呢？因为匿名函数其实和有名字的函数做的机器代码是一样的。它们给人的感觉是 “高层抽象”，所以有时候大家会觉得机器代码会很复杂。但是Rust用它做出来的机器码和普通函数一样快。</p>
<p>所以我们再来看看闭包能做的一些事情。你也可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number_one <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> number_two <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> number_one <span class="token operator">+</span> number_two <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个闭包取<code>number_one</code>和<code>number_two</code>。我们还给了它一个新的变量 <code>x</code>，并说 <code>x</code> 是 5.然后它把这三个加在一起打印 <code>21</code>。</p>
<p>通常在Rust中，你会在一个方法里面看到闭包，因为里面有一个闭包是非常方便的。我们在上一节的 <code>.map()</code> 和 <code>.for_each()</code> 中看到了闭包。在那一节中，我们写了 <code>|x|</code> 来引入迭代器中的下一个元素，这就是一个闭包。</p>
<p>下面再举一个例子:我们知道，如果<code>unwrap</code>不起作用，可以用<code>unwrap_or</code>方法给出一个值。之前我们写的是:<code>let fourth = my_vec.get(3).unwrap_or(&amp;0);</code>。但是还有一个<code>unwrap_or_else</code>方法，里面有一个闭包。所以你可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fourth <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// try to unwrap. If it doesn't work,</span>
        <span class="token keyword">if</span> my_vec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>               <span class="token comment">// see if my_vec has something at index [0]</span>
            <span class="token operator">&amp;</span>my_vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                             <span class="token comment">// Give the number at index 0 if there is something</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">&amp;</span><span class="token number">0</span> <span class="token comment">// otherwise give a &amp;0</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> fourth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，结尾可以很简单。例如，你可以只写<code>let fourth = my_vec.get(3).unwrap_or_else(|| &amp;0);</code>。你不需要总是因为有一个闭包就使用<code>&#123;&#125;</code>并写出复杂的代码。只要你把<code>||</code>放进去，编译器就知道你放了你需要的闭包。</p>
<p>最常用的闭包方法可能是<code>.map()</code>。我们再来看看它。下面是一种使用方法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> num_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> double_vec <span class="token operator">=</span> num_vec        <span class="token comment">// take num_vec</span>
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token comment">// iterate over it</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>number<span class="token closure-punctuation punctuation">|</span></span> number <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">// for each item, multiply by two</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// then make a new Vec from this</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> double_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另一个很好的例子是在<code>.enumerate()</code>之后使用<code>.for_each()</code>。<code>.enumerate()</code>方法给出一个带有索引号和元素的迭代器。例如:<code>[10, 9, 8]</code>变成<code>(0, 10), (1, 9), (2, 8)</code>。这里每个项的类型是<code>(usize, i32)</code>。所以你可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> num_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    num_vec
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">// iterate over num_vec</span>
        <span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// get (index, number)</span>
        <span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Index number &#123;&#125; has number &#123;&#125;"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do something for each one</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Index number 0 has number 10
Index number 1 has number 9
Index number 2 has number 8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在这种情况下，我们用<code>for_each</code>代替<code>map</code>。<code>map</code>是用于对<strong>每个元素做一些事情，并将其传递出去，而<code>for_each</code>是当你看到每个元素</strong>时做一些事情。另外，<code>map</code>不做任何事情，除非你使用<code>collect</code>这样的方法。</p>
<p>其实，这就是迭代器的有趣之处。如果你尝试<code>map</code>而不使用<code>collect</code>这样的方法，编译器会告诉你，它什么也不做。它不会崩溃，但编译器会告诉你，你什么都没做。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> num_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    num_vec
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Index number &#123;&#125; has number &#123;&#125;"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">warning: unused &#96;std::iter::Map&#96; that must be used
 --&gt; src\main.rs:4:5
  |
4 | &#x2F;     num_vec
5 | |         .iter()
6 | |         .enumerate()
7 | |         .map(|(index, number)| println!(&quot;Index number &#123;&#125; has number &#123;&#125;&quot;, index, number));
  | |_________________________________________________________________________________________^
  |
  &#x3D; note: &#96;#[warn(unused_must_use)]&#96; on by default
  &#x3D; note: iterators are lazy and do nothing unless consumed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是一个<strong>警告</strong>，所以这不是一个错误:程序运行正常。但是为什么num_vec没有任何作用呢？我们可以看看类型就知道了。</p>
<ul>
<li><p><code>let num_vec = vec![10, 9, 8];</code> 现在是一个<code>Vec&lt;i32&gt;</code>。</p>
</li>
<li><p><code>.iter()</code> 现在是一个 <code>Iter&lt;i32&gt;</code>。所以它是一个迭代器，其元素为 <code>i32</code>。</p>
</li>
<li><p><code>.enumerate()</code>现在是一个<code>Enumerate&lt;Iter&lt;i32&gt;&gt;</code>型。所以它是<code>Enumerate</code>型的<code>Iter</code>型的<code>i32</code>s。</p>
</li>
<li><p><code>.map()</code>现在是一个<code>Map&lt;Enumerate&lt;Iter&lt;i32&gt;&gt;&gt;</code>的类型。所以它是一个类型<code>Map</code>的类型<code>Enumerate</code>的类型<code>Iter</code>的类型<code>i32</code>s。</p>
</li>
</ul>
<p>我们所做的只是做了一个越来越复杂的结构。所以这个<code>Map&lt;Enumerate&lt;Iter&lt;i32&gt;&gt;&gt;</code>是一个准备好了的结构，但只有当我们告诉它要做什么的时候，它才会去做。Rust这样做是因为它需要快速。它不想这样做:</p>
<ul>
<li>遍历Vec中所有的<code>i32</code></li>
<li>然后从迭代器中枚举出所有的<code>i32</code></li>
<li>然后将所有列举的<code>i32</code>映射过来</li>
</ul>
<p>Rust 只想做一次计算，所以它创建结构并等待。然后，如果我们说<code>.collect::&lt;Vec&lt;i32&gt;&gt;()</code>，它知道该怎么做，并开始移动。这就是<code>iterators are lazy and do nothing unless consumed</code>的意思。迭代器在你 “消耗”它们(用完它们)之前不会做任何事情。</p>
<p>你甚至可以用<code>.collect()</code>创建像<code>HashMap</code>这样复杂的东西，所以它非常强大。下面是一个如何将两个向量放入<code>HashMap</code>的例子。首先我们把两个向量做出来，然后我们会对它们使用<code>.into_iter()</code>来得到一个值的迭代器。然后我们使用<code>.zip()</code>方法。这个方法将两个迭代器连接在一起，就像拉链一样。最后，我们使用<code>.collect()</code>来创建<code>HashMap</code>。</p>
<p>下面是代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// a Vec&lt;i32></span>
    <span class="token keyword">let</span> some_words <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"zero"</span><span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token string">"four"</span><span class="token punctuation">,</span> <span class="token string">"five"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// a Vec&lt;&amp;str></span>

    <span class="token keyword">let</span> number_word_hashmap <span class="token operator">=</span> some_numbers
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token comment">// now it is an iter</span>
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>some_words<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// inside .zip() we put in the other iter. Now they are together.</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">HashMap</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> _<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"For key &#123;&#125; we get &#123;&#125;."</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> number_word_hashmap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">For key 2 we get two.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>你可以看到，我们写了 <code>&lt;HashMap&lt;_, _&gt;&gt;</code>，因为这足以让 Rust 决定 <code>HashMap&lt;i32, &amp;str&gt;</code> 的类型。如果你想写 <code>.collect::&lt;HashMap&lt;i32, &amp;str&gt;&gt;();</code>也行，也可以这样写:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// a Vec&lt;i32></span>
    <span class="token keyword">let</span> some_words <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"zero"</span><span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">,</span> <span class="token string">"four"</span><span class="token punctuation">,</span> <span class="token string">"five"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// a Vec&lt;&amp;str></span>
    <span class="token keyword">let</span> number_word_hashmap<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> _<span class="token operator">></span> <span class="token operator">=</span> some_numbers  <span class="token comment">// Because we tell it the type here...</span>
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>some_words<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we don't have to tell it here</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还有一种方法，就像<code>.enumerate()</code>的<code>char</code>。<code>char_indices()</code>. (Indices的意思是 “索引”)。你用它的方法是一样的。假设我们有一个由3位数组成的大字符串。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> numbers_together <span class="token operator">=</span> <span class="token string">"140399923481800622623218009598281"</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> number<span class="token punctuation">)</span> <span class="token keyword">in</span> numbers_together<span class="token punctuation">.</span><span class="token function">char_indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> <span class="token punctuation">(</span>index <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">1</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// just print the number if there is a remainder</span>
            _ <span class="token operator">=></span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;\t"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// otherwise print the number with a tab space</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打印<code>140     399     923     481     800     622     623     218     009     598    281</code>。</p>
<h3 id="闭包中的"><a href="#闭包中的" class="headerlink" title="闭包中的|_|"></a>闭包中的|_|</h3><p>有时你会在一个闭包中看到 <code>|_|</code>。这意味着这个闭包需要一个参数(比如 <code>x</code>)，但你不想使用它。所以 <code>|_|</code> 意味着 “好吧，这个闭包需要一个参数，但我不会给它一个名字，因为我不关心它”。</p>
<p>下面是一个错误的例子，当你不这样做的时候。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"We didn't use the variables at all"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Rust说</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0593]: closure is expected to take 1 argument, but it takes 0 arguments
  --&gt; src\main.rs:28:36
   |
28 |     println!(&quot;&#123;:?&#125;&quot;, my_vec.iter().for_each(|| println!(&quot;We didn&#39;t use the variables at all&quot;)));
   |                                    ^^^^^^^^ -- takes 0 arguments
   |                                    |
   |                                    expected closure that takes 1 argument<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器其实给你一些帮助。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">help: consider changing the closure to take and ignore the expected argument
   |
28 |     println!(&quot;&#123;:?&#125;&quot;, my_vec.iter().for_each(|_| println!(&quot;We didn&#39;t use the variables at all&quot;)));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这是很好的建议。如果你把<code>||</code>改成<code>|_|</code>就可以了。</p>
<h3 id="闭包和迭代器的有用方法"><a href="#闭包和迭代器的有用方法" class="headerlink" title="闭包和迭代器的有用方法"></a>闭包和迭代器的有用方法</h3><p>一旦你熟悉了闭包，Rust就会成为一种非常有趣的语言。有了闭包，你可以将方法互相<em>链接</em>起来，用很少的代码做很多事情。下面是一些我们还没有见过的闭包和使用闭包的方法。</p>
<p><code>.filter()</code>: 这可以让你在迭代器中保留你想保留的元素。让我们过滤一年中的月份。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> months <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"January"</span><span class="token punctuation">,</span> <span class="token string">"February"</span><span class="token punctuation">,</span> <span class="token string">"March"</span><span class="token punctuation">,</span> <span class="token string">"April"</span><span class="token punctuation">,</span> <span class="token string">"May"</span><span class="token punctuation">,</span> <span class="token string">"June"</span><span class="token punctuation">,</span> <span class="token string">"July"</span><span class="token punctuation">,</span> <span class="token string">"August"</span><span class="token punctuation">,</span> <span class="token string">"September"</span><span class="token punctuation">,</span> <span class="token string">"October"</span><span class="token punctuation">,</span> <span class="token string">"November"</span><span class="token punctuation">,</span> <span class="token string">"December"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> filtered_months <span class="token operator">=</span> months
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment">// make an iter</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>month<span class="token closure-punctuation punctuation">|</span></span> month<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span>     <span class="token comment">// We don't want months more than 5 bytes in length.</span>
                                             <span class="token comment">// We know that each letter is one byte so .len() is fine</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>month<span class="token closure-punctuation punctuation">|</span></span> month<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"u"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Also we only like months with the letter u</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> filtered_months<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印<code>[&quot;June&quot;, &quot;July&quot;]</code>。</p>
<p><code>.filter_map()</code>. 这个叫做<code>filter_map()</code>，因为它做了<code>.filter()</code>和<code>.map()</code>。闭包必须返回一个 <code>Option&lt;T&gt;</code>，然后对每个<code>Option</code>, 如果是 <code>Some</code>, <code>filter_map()</code>将取出它的值。所以比如说你<code>.filter_map()</code>一个<code>vec![Some(2), None, Some(3)]</code>，它就会返回<code>[2, 3]</code>。</p>
<p>我们将用一个<code>Company</code>结构体来写一个例子。每个公司都有一个<code>name</code>，所以这个字段是<code>String</code>，但是CEO可能最近已经辞职了。所以<code>ceo</code>字段是<code>Option&lt;String&gt;</code>。我们会<code>.filter_map()</code>过一些公司，只保留CEO名字。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Company</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    ceo<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Company</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ceo<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> ceo <span class="token operator">=</span> <span class="token keyword">match</span> ceo <span class="token punctuation">&#123;</span>
            <span class="token string">""</span> <span class="token operator">=></span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            name <span class="token operator">=></span> <span class="token class-name">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// ceo is decided, so now we return Self</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ceo<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">get_ceo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>ceo<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Just returns a clone of the CEO (struct is not Copy)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> company_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Umbrella Corporation"</span><span class="token punctuation">,</span> <span class="token string">"Unknown"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Ovintiv"</span><span class="token punctuation">,</span> <span class="token string">"Doug Suttles"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"The Red-Headed League"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Stark Enterprises"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> all_the_ceos <span class="token operator">=</span> company_vec
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>company<span class="token closure-punctuation punctuation">|</span></span> company<span class="token punctuation">.</span><span class="token function">get_ceo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// filter_map needs Option&lt;T></span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> all_the_ceos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出了<code>[&quot;Unknown&quot;, &quot;Doug Suttles&quot;]</code>。</p>
<p>既然 <code>.filter_map()</code> 需要 <code>Option</code>，那么 <code>Result</code> 呢？没问题:有一个叫做 <code>.ok()</code> 的方法，可以把 <code>Result</code> 变成 <code>Option</code>。之所以叫<code>.ok()</code>，是因为它能发送的只是<code>Ok</code>的结果(<code>Err</code>的信息没有了)。你记得<code>Option</code>是<code>Option&lt;T&gt;</code>，而<code>Result</code>是<code>Result&lt;T, E&gt;</code>，同时有<code>Ok</code>和<code>Err</code>的信息。所以当你使用<code>.ok()</code>时，任何<code>Err</code>的信息都会丢失，变成<code>None</code>。</p>
<p>使用 <code>.parse()</code> 是一个很简单的例子，我们尝试解析一些用户输入。<code>.parse()</code>在这里接受一个<code>&amp;str</code>，并试图把它变成一个<code>f32</code>。它返回一个 <code>Result</code>，但我们使用的是 <code>filter_map()</code>，所以我们只需抛出错误。<code>Err</code>的任何内容都会变成<code>None</code>，并被<code>.filter_map()</code>过滤掉。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> user_input <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"8.9"</span><span class="token punctuation">,</span> <span class="token string">"Nine point nine five"</span><span class="token punctuation">,</span> <span class="token string">"8.0"</span><span class="token punctuation">,</span> <span class="token string">"7.6"</span><span class="token punctuation">,</span> <span class="token string">"eleventy-twelve"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> actual_numbers <span class="token operator">=</span> user_input
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>input<span class="token closure-punctuation punctuation">|</span></span> input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> actual_numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将打印: <code>[8.9, 8.0, 7.6]</code>。</p>
<p>与<code>.ok()</code>相对的是<code>.ok_or()</code>和<code>ok_or_else()</code>。这样就把<code>Option</code>变成了<code>Result</code>。之所以叫<code>.ok_or()</code>，是因为<code>Result</code>给出了一个<code>Ok</code><strong>或</strong><code>Err</code>，所以你必须让它知道<code>Err</code>的值是多少。这是因为<code>None</code>中的<code>Option</code>没有任何信息。另外，你现在可以看到，这些方法名称中的<em>else</em>部分意味着它有一个闭包。</p>
<p>我们可以把我们的<code>Option</code>从<code>Company</code>结构中取出来，然后这样把它变成一个<code>Result</code>。对于长期的错误处理，最好是创建自己的错误类型。<br> 但是现在我们只是给它一个错误信息，所以它就变成了<code>Result&lt;String, &amp;str&gt;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// Everything before main() is exactly the same</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Company</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    ceo<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Company</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ceo<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> ceo <span class="token operator">=</span> <span class="token keyword">match</span> ceo <span class="token punctuation">&#123;</span>
            <span class="token string">""</span> <span class="token operator">=></span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            name <span class="token operator">=></span> <span class="token class-name">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ceo<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">get_ceo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>ceo<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> company_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Umbrella Corporation"</span><span class="token punctuation">,</span> <span class="token string">"Unknown"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Ovintiv"</span><span class="token punctuation">,</span> <span class="token string">"Doug Suttles"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"The Red-Headed League"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Stark Enterprises"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> results_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Pretend we need to gather error results too</span>

    company_vec
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>company<span class="token closure-punctuation punctuation">|</span></span> results_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>company<span class="token punctuation">.</span><span class="token function">get_ceo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"No CEO found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> results_vec <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这行是最大的变化:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>company<span class="token closure-punctuation punctuation">|</span></span> results_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>company<span class="token punctuation">.</span><span class="token function">get_ceo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"No CEO found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>它的意思是:”每家公司，用<code>get_ceo()</code>. 如果你得到了，那就把<code>Ok</code>里面的数值传给你。如果没有，就在<code>Err</code>里面传递 “没有找到CEO”。然后把这个推到vec里。”</p>
<p>所以当我们打印<code>results_vec</code>的时候，就会得到这样的结果。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Ok(&quot;Unknown&quot;)
Ok(&quot;Doug Suttles&quot;)
Err(&quot;No CEO found&quot;)
Err(&quot;No CEO found&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在我们有了所有四个条目。现在让我们使用 <code>.ok_or_else()</code>，这样我们就可以使用一个闭包，并得到一个更好的错误信息。现在我们有空间使用<code>format!</code>来创建一个<code>String</code>，并将公司名称放在其中。然后我们返回<code>String</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// Everything before main() is exactly the same</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Company</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    ceo<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Company</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ceo<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> ceo <span class="token operator">=</span> <span class="token keyword">match</span> ceo <span class="token punctuation">&#123;</span>
            <span class="token string">""</span> <span class="token operator">=></span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            name <span class="token operator">=></span> <span class="token class-name">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ceo<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">get_ceo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>ceo<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> company_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Umbrella Corporation"</span><span class="token punctuation">,</span> <span class="token string">"Unknown"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Ovintiv"</span><span class="token punctuation">,</span> <span class="token string">"Doug Suttles"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"The Red-Headed League"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Company</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Stark Enterprises"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> results_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    company_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>company<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        results_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>company<span class="token punctuation">.</span><span class="token function">get_ceo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> err_message <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"No CEO found for &#123;&#125;"</span><span class="token punctuation">,</span> company<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            err_message
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> results_vec <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样一来，我们就有了。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Ok(&quot;Unknown&quot;)
Ok(&quot;Doug Suttles&quot;)
Err(&quot;No CEO found for The Red-Headed League&quot;)
Err(&quot;No CEO found for Stark Enterprises&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p><code>.and_then()</code>是一个有用的方法，它接收一个<code>Option</code>，然后让你对它的值做一些事情，并把它传递出去。所以它的输入是一个 <code>Option</code>，输出也是一个 <code>Option</code>。这有点像一个安全的 “解包，然后做一些事情，然后再包”。</p>
<p>一个简单的例子是，我们使用 <code>.get()</code> 从一个 vec 中得到一个数字，因为它返回一个 <code>Option</code>。现在我们可以把它传给 <code>and_then()</code>，如果它是 <code>Some</code>，我们可以对它做一些数学运算。如果是<code>None</code>，那么<code>None</code>就会被传递过去。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// just a vec with numbers</span>

    <span class="token keyword">let</span> number_to_add <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>       <span class="token comment">// use this in the math later</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> empty_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// results go in here</span>


    <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">&#123;</span>
        empty_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            new_vec
               <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>number<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Some</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>number<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Some</span><span class="token punctuation">(</span>number <span class="token operator">+</span> number_to_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> empty_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出了<code>[Some(14), Some(15), Some(6), None, None]</code>。你可以看到<code>None</code>并没有被过滤掉，只是传递了。</p>
<p><code>.and()</code>有点像<code>Option</code>的<code>bool</code>。你可以匹配很多个<code>Option</code>，如果它们都是<code>Some</code>，那么它会给出最后一个。而如果其中一个是<code>None</code>，那么就会给出<code>None</code>。</p>
<p>首先这里有一个<code>bool</code>的例子来帮助想象。你可以看到，如果你用的是<code>&amp;&amp;</code>(和)，哪怕是一个<code>false</code>，也会让一切<code>false</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> one <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> two <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> three <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> four <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> one <span class="token operator">&amp;&amp;</span> three<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints true</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> one <span class="token operator">&amp;&amp;</span> two <span class="token operator">&amp;&amp;</span> three <span class="token operator">&amp;&amp;</span> four<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在这里的<code>.and()</code>也是一样的。想象一下，我们做了五次操作，并把结果放在一个Vec&lt;Option&lt;&amp;str&gt;&gt;中。如果我们得到一个值，我们就把<code>Some(&quot;success!&quot;)</code>推到Vec中。然后我们再做两次这样的操作。之后我们用<code>.and()</code>每次只显示得到<code>Some</code>的索引。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> first_try <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> second_try <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> third_try <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"success!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>first_try<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> first_try<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>second_try<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>third_try<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">None
None
Some(&quot;success!&quot;)
Some(&quot;success!&quot;)
None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一个(索引0)是<code>None</code>，因为在<code>second_try</code>中有一个<code>None</code>为索引0。第二个是<code>None</code>，因为在<code>first_try</code>中有一个<code>None</code>。其次是<code>Some(&quot;success!&quot;)</code>，因为<code>first_try</code>、<code>second try</code>、<code>third_try</code>中没有<code>None</code>。</p>
<p><code>.any()</code>和<code>.all()</code>在迭代器中非常容易使用。它们根据你的输入返回一个<code>bool</code>。在这个例子中，我们做了一个非常大的vec(大约20000个元素)，包含了从<code>&#39;a&#39;</code>到<code>&#39;働&#39;</code>的所有字符。然后我们创建一个函数来检查是否有字符在其中。</p>
<p>接下来我们创建一个更小的vec，问它是否都是字母(用<code>.is_alphabetic()</code>方法)。然后我们问它是不是所有的字符都小于韩文字符<code>&#39;행&#39;</code>。</p>
<p>还要注意放一个参照物，因为<code>.iter()</code>给了一个参照物，你需要一个<code>&amp;</code>和另一个<code>&amp;</code>进行比较。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">in_char_vec</span><span class="token punctuation">(</span>char_vec<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">,</span> check<span class="token punctuation">:</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Is &#123;&#125; inside? &#123;&#125;"</span><span class="token punctuation">,</span> check<span class="token punctuation">,</span> char_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span><span class="token keyword">char</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">char</span> <span class="token operator">==</span> check<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> char_vec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">..</span><span class="token char string">'働'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">in_char_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>char_vec<span class="token punctuation">,</span> <span class="token char string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">in_char_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>char_vec<span class="token punctuation">,</span> <span class="token char string">'뷁'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">in_char_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>char_vec<span class="token punctuation">,</span> <span class="token char string">'鑿'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> smaller_vec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token char string">'A'</span><span class="token punctuation">..</span><span class="token char string">'z'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"All alphabetic? &#123;&#125;"</span><span class="token punctuation">,</span> smaller_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>x<span class="token closure-punctuation punctuation">|</span></span> x<span class="token punctuation">.</span><span class="token function">is_alphabetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"All less than the character 행? &#123;&#125;"</span><span class="token punctuation">,</span> smaller_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">&lt;</span> <span class="token char string">'행'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Is i inside? true
Is 뷁 inside? false
Is 鑿 inside? false
All alphabetic? false
All less than the character 행? true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>顺便说一下，<code>.any()</code>只检查到一个匹配的元素，然后就停止了。如果它已经找到了一个匹配项，它不会检查所有的元素。如果您要在 <code>Vec</code> 上使用 <code>.any()</code>，最好把可能匹配的元素推到前面。或者你可以在 <code>.iter()</code> 之后使用 <code>.rev()</code> 来反向迭代。这里有一个这样的vec。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> big_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">;</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    big_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这个<code>Vec</code>有1000个<code>6</code>，后面还有一个<code>5</code>。我们假设我们要用<code>.any()</code>来看看它是否包含5。首先让我们确定<code>.rev()</code>是有效的。记住，一个<code>Iterator</code>总是有<code>.next()</code>，让你每次都检查它的工作。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> big_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">;</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    big_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> iterator <span class="token operator">=</span> big_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它的打印。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Some(5)
Some(6)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们是对的:有一个<code>Some(5)</code>，然后1000个<code>Some(6)</code>开始。所以我们可以这样写。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> big_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">;</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    big_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> big_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>number<span class="token closure-punctuation punctuation">|</span></span> number <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而且因为是<code>.rev()</code>，所以它只调用<code>.next()</code>一次就停止了。如果我们不用<code>.rev()</code>，那么它将调用<code>.next()</code> 1001次才停止。这段代码显示了它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> big_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">;</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    big_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Start counting</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> big_iter <span class="token operator">=</span> big_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make it an Iterator</span>

    <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        counter <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> big_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Keep calling .next() until we get Some(5)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Final counter is: &#123;&#125;"</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>Final counter is: 1001</code>，所以我们知道它必须调用 <code>.next()</code> 1001 次才能找到 5。</p>
<p><code>.find()</code> 告诉你一个迭代器是否有东西，而 <code>.position()</code> 告诉你它在哪里。<code>.find()</code>与<code>.any()</code>不同，因为它返回一个<code>Option</code>，里面有值(或<code>None</code>)。同时，<code>.position()</code>也是一个带有位置号的<code>Option</code>，或<code>None</code>。换句话说</p>
<ul>
<li><code>.find()</code>: “我尽量帮你拿”</li>
<li><code>.position()</code>:”我帮你找找看在哪里”</li>
</ul>
<p>下面是一个简单的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> num_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>number<span class="token closure-punctuation punctuation">|</span></span> number <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// find takes a reference, so we give it &amp;number</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>number<span class="token closure-punctuation punctuation">|</span></span> number <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>number<span class="token closure-punctuation punctuation">|</span></span> number <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> num_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token operator">&amp;</span>number<span class="token closure-punctuation punctuation">|</span></span> number <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Some(30) &#x2F;&#x2F; This is the number itself
None &#x2F;&#x2F; No number inside times 2 &#x3D;&#x3D; 30
Some(2) &#x2F;&#x2F; This is the position
None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用 <code>.cycle()</code> 你可以创建一个永远循环的迭代器。这种类型的迭代器与 <code>.zip()</code> 很好地结合在一起，可以创建新的东西，就像这个例子，它创建了一个 <code>Vec&lt;(i32, &amp;str)&gt;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> even_odd <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"even"</span><span class="token punctuation">,</span> <span class="token string">"odd"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> even_odd_vec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">6</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>even_odd<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> even_odd_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，即使<code>.cycle()</code>可能永远不会结束，但当把它们压缩在一起时，另一个迭代器只运行了6次。<br> 也就是说，<code>.cycle()</code>所做的迭代器不会再被<code>.next()</code>调用，所以六次之后就完成了。输出的结果是</p>
<pre class="line-numbers language-none"><code class="language-none">[(0, &quot;even&quot;), (1, &quot;odd&quot;), (2, &quot;even&quot;), (3, &quot;odd&quot;), (4, &quot;even&quot;), (5, &quot;odd&quot;)]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>类似的事情也可以用一个没有结尾的范围来完成。如果你写<code>0..</code>，那么你就创建了一个永不停止的范围。你可以很容易地使用这个方法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> ten_chars <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> skip_then_ten_chars <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1300</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> ten_chars<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> skip_then_ten_chars<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>两者都是打印十个字符，但第二个跳过1300位，打印的是亚美尼亚语的十个字母。</p>
<pre class="line-numbers language-none"><code class="language-none">[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;]
[&#39;յ&#39;, &#39;ն&#39;, &#39;շ&#39;, &#39;ո&#39;, &#39;չ&#39;, &#39;պ&#39;, &#39;ջ&#39;, &#39;ռ&#39;, &#39;ս&#39;, &#39;վ&#39;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>另一种流行的方法叫做<code>.fold()</code>。这个方法经常用于将迭代器中的元素加在一起，但你也可以做更多的事情。它与<code>.for_each()</code>有些类似。在 <code>.fold()</code> 中，你首先添加一个起始值 (如果你是把元素加在一起，那么就是 0)，然后是一个逗号，然后是闭包。结尾给你两个元素:到目前为止的总数，和下一个元素。首先这里有一个简单的例子，显示<code>.fold()</code>将元素加在一起。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> some_numbers
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>total_so_far<span class="token punctuation">,</span> next_number<span class="token closure-punctuation punctuation">|</span></span> total_so_far <span class="token operator">+</span> next_number<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，在第1步中，它从0开始，再加上下一个数字:9。</p>
<ul>
<li>第1步，从0开始，加上下一个数字9</li>
<li>然后把9加上6: 15。</li>
<li>然后把15加上9: 24。</li>
<li>然后取24，再加上10: 34。</li>
<li>最后取34，再加上11: 45。所以它的打印结果是<code>45</code>.</li>
</ul>
<p>但是你不需要只用它来添加东西。下面是一个例子，我们在每一个字符上加一个’-‘，就会变成<code>String</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> a_string <span class="token operator">=</span> <span class="token string">"I don't have any dashes in me."</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>
        a_string
            <span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Now it's an iterator</span>
            <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> string_so_far<span class="token punctuation">,</span> next_char<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Start with a String "-". Bring it in as mutable each time along with the next char</span>
                string_so_far<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>next_char<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Push the char on, then '-'</span>
                string_so_far<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                string_so_far<span class="token punctuation">&#125;</span> <span class="token comment">// Don't forget to pass it on to the next loop</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">-I- -d-o-n-&#39;-t- -h-a-v-e- -a-n-y- -d-a-s-h-e-s- -i-n- -m-e-.-<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>还有很多其他方便的方法，比如</p>
<ul>
<li><code>.take_while()</code>，只要得到<code>true</code>，就会带入一个迭代器(例如<code>take while x &gt; 5</code>)</li>
<li><code>.cloned()</code>，它在迭代器内做了一个克隆。这将一个引用变成了一个值。</li>
<li><code>.by_ref()</code>，它使迭代器取一个引用。这很好的保证了你使用<code>Vec</code>或类似的方法来创建迭代器后可以使用它。</li>
<li>许多其他的<code>_while</code>方法:<code>.skip_while()</code>、<code>.map_while()</code>等等。</li>
<li><code>.sum()</code>:就是把所有的东西加在一起。</li>
</ul>
<p><code>.chunks()</code>和<code>.windows()</code>是将矢量切割成你想要的尺寸的两种方法。你把你想要的尺寸放在括号里。比如说你有一个有10个元素的矢量，你想要一个3的尺寸，它的工作原理是这样的。</p>
<ul>
<li><p><code>.chunks()</code>会给你4个切片: [0, 1, 2], 然后是[3, 4, 5], 然后是[6, 7, 8], 最后是[9]. 所以它会尝试用三个元素创建一个切片，但如果它没有三个元素，那么它就不会崩溃。它只会给你剩下的东西。</p>
</li>
<li><p><code>.windows()</code>会先给你一个[0, 1, 2]的切片。然后它将移过一片，给你[1, 2, 3]。它将一直这样做，直到最后到达3的最后一片，然后停止。</p>
</li>
</ul>
<p>所以让我们在一个简单的数字向量上使用它们。它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> num_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> chunk <span class="token keyword">in</span> num_vec<span class="token punctuation">.</span><span class="token function">chunks</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> window <span class="token keyword">in</span> num_vec<span class="token punctuation">.</span><span class="token function">windows</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[1, 2, 3]
[4, 5, 6]
[7, 8, 9]
[0]

[1, 2, 3]
[2, 3, 4]
[3, 4, 5]
[4, 5, 6]
[5, 6, 7]
[6, 7, 8]
[7, 8, 9]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>顺便说一下，如果你什么都不给它，<code>.chunks()</code>会崩溃。你可以为一个只有一项的向量写<code>.chunks(1000)</code>，但你不能为任何长度为0的东西写<code>.chunks()</code>。 如果你点击[src]，你可以在函数中看到这一点，因为它说<code>assert!(chunk_size != 0);</code>。</p>
<p><code>.match_indices()</code> 让你把 <code>String</code> 或 <code>&amp;str</code> 里面所有符合你的输入的东西都提取出来，并给你索引。它与 <code>.enumerate()</code> 类似，因为它返回一个包含两个元素的元组。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token string">"Rule number 1: No fighting. Rule number 2: Go to bed at 8 pm. Rule number 3: Wake up at 6 am."</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rule_locations <span class="token operator">=</span> rules<span class="token punctuation">.</span><span class="token function">match_indices</span><span class="token punctuation">(</span><span class="token string">"Rule"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is Vec&lt;usize, &amp;str> but we just tell Rust to do it</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> rule_locations<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[(0, &quot;Rule&quot;), (28, &quot;Rule&quot;), (62, &quot;Rule&quot;)]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><code>.peekable()</code> 让你创建一个迭代器，在那里你可以看到 (窥视) 下一个元素。它就像调用 <code>.next()</code> (它给出了一个 <code>Option</code>)，除了迭代器不会移动，所以你可以随意使用它。实际上，你可以把peekable看成是 “可停止”的，因为你可以想停多久就停多久。下面是一个例子，我们对每个元素都使用<code>.peek()</code>三次。我们可以永远使用<code>.peek()</code>，直到我们使用<code>.next()</code>移动到下一个元素。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> just_numbers <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> number_iter <span class="token operator">=</span> just_numbers<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peekable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This actually creates a type of iterator called Peekable</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I love the number &#123;&#125;"</span><span class="token punctuation">,</span> number_iter<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I really love the number &#123;&#125;"</span><span class="token punctuation">,</span> number_iter<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is such a nice number"</span><span class="token punctuation">,</span> number_iter<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        number_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">I love the number 1
I really love the number 1
1 is such a nice number
I love the number 5
I really love the number 5
5 is such a nice number
I love the number 100
I really love the number 100
100 is such a nice number<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面是另一个例子，我们使用<code>.peek()</code>对一个元素进行匹配。使用完后，我们调用<code>.next()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> locations <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">"Nevis"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"Taber"</span><span class="token punctuation">,</span> <span class="token number">8428</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"Markerville"</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">"Cardston"</span><span class="token punctuation">,</span> <span class="token number">3585</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> location_iter <span class="token operator">=</span> locations<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peekable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> location_iter<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> location_iter<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token operator">*</span>number <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// .peek() gives us a reference so we need *</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Found a hamlet: &#123;&#125; with &#123;&#125; people"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> number<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Found a town: &#123;&#125; with &#123;&#125; people"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">break</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        location_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Found a hamlet: Nevis with 25 people
Found a town: Taber with 8428 people
Found a hamlet: Markerville with 45 people
Found a town: Cardston with 3585 people<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后，这里有一个例子，我们也使用<code>.match_indices()</code>。在这个例子中，我们根据<code>&amp;str</code>中的空格数，将名字放入<code>struct</code>中。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Names</span> <span class="token punctuation">&#123;</span>
    one_word<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    two_words<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    three_words<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> vec_of_names <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token string">"Caesar"</span><span class="token punctuation">,</span>
        <span class="token string">"Frodo Baggins"</span><span class="token punctuation">,</span>
        <span class="token string">"Bilbo Baggins"</span><span class="token punctuation">,</span>
        <span class="token string">"Jean-Luc Picard"</span><span class="token punctuation">,</span>
        <span class="token string">"Data"</span><span class="token punctuation">,</span>
        <span class="token string">"Rand Al'Thor"</span><span class="token punctuation">,</span>
        <span class="token string">"Paul Atreides"</span><span class="token punctuation">,</span>
        <span class="token string">"Barack Hussein Obama"</span><span class="token punctuation">,</span>
        <span class="token string">"Bill Jefferson Clinton"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter_of_names <span class="token operator">=</span> vec_of_names<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peekable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> all_names <span class="token operator">=</span> <span class="token class-name">Names</span> <span class="token punctuation">&#123;</span> <span class="token comment">// start an empty Names struct</span>
        one_word<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        two_words<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        three_words<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> iter_of_names<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> next_item <span class="token operator">=</span> iter_of_names<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We can use .unwrap() because we know it is Some</span>
        <span class="token keyword">match</span> next_item<span class="token punctuation">.</span><span class="token function">match_indices</span><span class="token punctuation">(</span><span class="token char string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Create a quick vec using .match_indices and check the length</span>
            <span class="token number">0</span> <span class="token operator">=></span> all_names<span class="token punctuation">.</span>one_word<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>next_item<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">1</span> <span class="token operator">=></span> all_names<span class="token punctuation">.</span>two_words<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>next_item<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=></span> all_names<span class="token punctuation">.</span>three_words<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>next_item<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> all_names<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Names &#123; one_word: [&quot;Caesar&quot;, &quot;Data&quot;], two_words: [&quot;Frodo Baggins&quot;, &quot;Bilbo Baggins&quot;, &quot;Jean-Luc Picard&quot;, &quot;Rand Al\&#39;Thor&quot;, &quot;Paul Atreides&quot;], three_words:
[&quot;Barack Hussein Obama&quot;, &quot;Bill Jefferson Clinton&quot;] &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<h2 id="dbg！宏和-inspect"><a href="#dbg！宏和-inspect" class="headerlink" title="dbg！宏和.inspect"></a>dbg！宏和.inspect</h2><p><code>dbg!</code>是一个非常有用的宏，可以快速打印信息。它是 <code>println!</code> 的一个很好的替代品，因为它的输入速度更快，提供的信息更多。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token macro property">dbg!</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以打印出<code>[src\main.rs:4] my_number = 8</code>。</p>
<p>但实际上，你可以把<code>dbg!</code>放在其他很多地方，甚至可以把代码包在里面。比如看这段代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_number <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    my_number <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> double_vec <span class="token operator">=</span> new_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这段代码创建了一个新的可变数字，并改变了它。然后创建一个vec，并使用<code>iter</code>和<code>map</code>以及<code>collect</code>创建一个新的vec。在这段代码中，我们几乎可以把<code>dbg!</code>放在任何地方。<code>dbg!</code>问编译器。”此刻你在做什么？”然后告诉你。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_number <span class="token operator">=</span> <span class="token macro property">dbg!</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">dbg!</span><span class="token punctuation">(</span>my_number <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">dbg!</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> double_vec <span class="token operator">=</span> <span class="token macro property">dbg!</span><span class="token punctuation">(</span>new_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">dbg!</span><span class="token punctuation">(</span>double_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src\main.rs:3] 9 &#x3D; 9<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>和。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src\main.rs:4] my_number +&#x3D; 10 &#x3D; ()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>和。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src\main.rs:6] vec![8, 9, 10] &#x3D; [
    8,
    9,
    10,
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而这个，甚至可以显示出表达式的值。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src\main.rs:8] new_vec.iter().map(|x| x * 2).collect::&lt;Vec&lt;i32&gt;&gt;() &#x3D; [
    16,
    18,
    20,
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>和。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src\main.rs:10] double_vec &#x3D; [
    16,
    18,
    20,
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><code>.inspect</code> 与 <code>dbg!</code> 有点类似，但你在迭代器中使用它就像 <code>map</code>。它给了你迭代项，你可以打印它或者做任何你想做的事情。例如，我们再看看我们的 <code>double_vec</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> double_vec <span class="token operator">=</span> new_vec
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们想知道更多关于代码的信息。所以我们在两个地方添加<code>inspect()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> double_vec <span class="token operator">=</span> new_vec
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>first_item<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The item is: &#123;&#125;"</span><span class="token punctuation">,</span> first_item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>next_item<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Then it is: &#123;&#125;"</span><span class="token punctuation">,</span> next_item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The item is: 8
Then it is: 16
The item is: 9
Then it is: 18
The item is: 10
Then it is: 20<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而且因为<code>.inspect</code>采取的是封闭式，所以我们可以随意写。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> double_vec <span class="token operator">=</span> new_vec
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>first_item<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The item is: &#123;&#125;"</span><span class="token punctuation">,</span> first_item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> <span class="token operator">*</span><span class="token operator">*</span>first_item <span class="token operator">%</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span> <span class="token comment">// first item is a &amp;&amp;i32 so we use **</span>
                <span class="token number">0</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It is even."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It is odd."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"In binary it is &#123;:b&#125;."</span><span class="token punctuation">,</span> first_item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The item is: 8
It is even.
In binary it is 1000.
The item is: 9
It is odd.
In binary it is 1001.
The item is: 10
It is even.
In binary it is 1010.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="amp-str的类型"><a href="#amp-str的类型" class="headerlink" title="&amp;str的类型"></a>&amp;str的类型</h2><p><code>&amp;str</code>的类型不止一种。我们有。</p>
<ul>
<li>字符串: 当你写<code>let my_str = &quot;I am a &amp;str&quot;</code>的时候，你就会产生这些字符。它们在整个程序中持续存在，因为它们是直接写进二进制中的，它们的类型是 <code>&amp;&#39;static str</code>。<code>&#39;</code>的意思是它的生命期，字符串字元有一个叫<code>static</code>的生命期。</li>
<li>借用str。这是常规的 <code>&amp;str</code> 形式，没有 <code>static</code> 生命期。如果你创建了一个<code>String</code>，并得到了它的引用，当你需要它时，Rust会把它转换为<code>&amp;str</code>。比如说</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_str</span><span class="token punctuation">(</span>my_str<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// it can use &amp;String like a &amp;str</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am a string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we give prints_str a &amp;String</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么什么是lifetime呢？我们现在就来了解一下。</p>
<h2 id="生命期"><a href="#生命期" class="headerlink" title="生命期"></a>生命期</h2><p>生命期的意思是 “变量的生命期有多长”。你只需要考虑引用的生命期。这是因为引用的生命期不能比它们来自的对象更长。例如，这个函数就不能用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">returns_reference</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am a string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>my_string <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>问题是<code>my_string</code>只存在于<code>returns_reference</code>中。我们试图返回 <code>&amp;my_string</code>，但是 <code>&amp;my_string</code> 不能没有 <code>my_string</code>。所以编译器说不行。</p>
<p>这个代码也不行。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">returns_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am a string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token string">"I am a str"</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_str <span class="token operator">=</span> <span class="token function">returns_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但几乎是成功的。编译器说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0106]: missing lifetime specifier
 --&gt; src\main.rs:6:21
  |
6 | fn returns_str() -&gt; &amp;str &#123;
  |                     ^ expected named lifetime parameter
  |
  &#x3D; help: this function&#39;s return type contains a borrowed value, but there is no value for it to be borrowed from
help: consider using the &#96;&#39;static&#96; lifetime
  |
6 | fn returns_str() -&gt; &amp;&#39;static str &#123;
  |                     ^^^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>missing lifetime specifier</code>的意思是，我们需要加一个<code>&#39;</code>的生命期。然后说它<code>contains a borrowed value, but there is no value for it to be borrowed from</code>。也就是说，<code>I am a str</code>不是借来的。它写<code>&amp;&#39;static str</code>就说<code>consider using the &#39;static lifetime</code>。所以它认为我们应该尝试说这是一个字符串的文字。</p>
<p>现在它工作了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">returns_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am a string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token string">"I am a str"</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_str <span class="token operator">=</span> <span class="token function">returns_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是因为我们返回了一个 <code>&amp;str</code>，生命期为 <code>static</code>。同时，<code>my_string</code>只能以<code>String</code>的形式返回:我们不能返回对它的引用，因为它将在下一行死亡。</p>
<p>所以现在<code>fn returns_str() -&gt; &amp;&#39;static str</code>告诉Rust， “别担心，我们只会返回一个字符串字面量”. 字符串字面量在整个程序中都是有效的，所以Rust很高兴。你会注意到，这与泛型类似。当我们告诉编译器类似 <code>&lt;T: Display&gt;</code> 的东西时，我们承诺我们将只使用实现了 <code>Display</code> 的输入。生命期也类似:我们并没有改变任何变量的生命期。我们只是告诉编译器输入的生命期是多少。</p>
<p>但是<code>&#39;static</code>并不是唯一的生命期。实际上，每个变量都有一个生命期，但通常我们不必写出来。编译器很聪明，一般都能自己算出来。只有在编译器不知道的时候，我们才需要写出生命期。</p>
<p>下面是另一个生命期的例子。想象一下，我们想创建一个<code>City</code>结构，并给它一个<code>&amp;str</code>的名字。我们可能想这样做，因为这样做的性能比用<code>String</code>快。所以我们这样写，但还不能用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// ⚠️</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_city <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Ichinomiya"</span><span class="token punctuation">,</span>
        date_founded<span class="token punctuation">:</span> <span class="token number">1921</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0106]: missing lifetime specifier
 --&gt; src\main.rs:3:11
  |
3 |     name: &amp;str,
  |           ^ expected named lifetime parameter
  |
help: consider introducing a named lifetime parameter
  |
2 | struct City&lt;&#39;a&gt; &#123;
3 |     name: &amp;&#39;a str,
  |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Rust 需要 <code>&amp;str</code> 的生命期，因为 <code>&amp;str</code> 是一个引用。如果<code>name</code>指向的值被丢弃了会怎样？那就不安全了。</p>
<p><code>&#39;static</code>呢，能用吗？我们以前用过。我们试试吧。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// change &amp;str to &amp;'static str</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_city <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Ichinomiya"</span><span class="token punctuation">,</span>
        date_founded<span class="token punctuation">:</span> <span class="token number">1921</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; was founded in &#123;&#125;"</span><span class="token punctuation">,</span> my_city<span class="token punctuation">.</span>name<span class="token punctuation">,</span> my_city<span class="token punctuation">.</span>date_founded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>好的，这就可以了。也许这就是你想要的结构。但是，请注意，我们只能接受 “字符串字面量”，所以不能接受对其他东西的引用。所以这将无法工作。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// must live for the whole program</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> city_names <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Ichinomiya"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Kurume"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// city_names does not live for the whole program</span>

    <span class="token keyword">let</span> my_city <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token operator">&amp;</span>city_names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// ⚠️ This is a &amp;str, but not a &amp;'static str. It is a reference to a value inside city_names</span>
        date_founded<span class="token punctuation">:</span> <span class="token number">1921</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; was founded in &#123;&#125;"</span><span class="token punctuation">,</span> my_city<span class="token punctuation">.</span>name<span class="token punctuation">,</span> my_city<span class="token punctuation">.</span>date_founded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0597]: &#96;city_names&#96; does not live long enough
  --&gt; src\main.rs:12:16
   |
12 |         name: &amp;city_names[0],
   |                ^^^^^^^^^^
   |                |
   |                borrowed value does not live long enough
   |                requires that &#96;city_names&#96; is borrowed for &#96;&#39;static&#96;
...
18 | &#125;
   | - &#96;city_names&#96; dropped here while still borrowed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这一点很重要，因为我们给它的引用其实已经够长寿了。但是我们承诺只给它一个<code>&amp;&#39;static str</code>，这就是问题所在。</p>
<p>所以现在我们就试试之前编译器的建议。它说尝试写<code>struct City&lt;&#39;a&gt;</code>和<code>name: &amp;&#39;a str</code>。这就意味着，只有当<code>name</code>活到<code>City</code>一样寿命的情况下，它才会接受<code>name</code>的引用。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token comment">// City has lifetime 'a</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// and name also has lifetime 'a.</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> city_names <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Ichinomiya"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Kurume"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> my_city <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token operator">&amp;</span>city_names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        date_founded<span class="token punctuation">:</span> <span class="token number">1921</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; was founded in &#123;&#125;"</span><span class="token punctuation">,</span> my_city<span class="token punctuation">.</span>name<span class="token punctuation">,</span> my_city<span class="token punctuation">.</span>date_founded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外记住，如果你愿意，你可以写任何东西来代替<code>&#39;a</code>。这也和泛型类似，我们写<code>T</code>和<code>U</code>，但实际上可以写任何东西。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'city</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token comment">// The lifetime is now called 'city</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'city</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// and name has the 'city lifetime</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以一般都会写<code>&#39;a, &#39;b, &#39;c</code>等，因为这样写起来比较快，也是常用的写法。但如果你想的话，你可以随时更改。有一个很好的建议是，如果代码非常复杂，把生命期改成一个 “人类可读”的名字可以帮助你阅读代码。</p>
<p>我们再来看看与trait的比较，对于泛型。比如说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">prints</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"T is &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你写<code>T: Display</code>的时候，它的意思是 “只有当T有Display时，才取T”。<br>而不是说: “我把Display给T”.</p>
<p>对于生命期也是如此。当你在这里写 ‘a:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    date_founded<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>意思是 “如果<code>name</code>的生命期至少与<code>City</code>一样长，才接受<code>name</code>的输入”。<br>它的意思不是说: “我会让<code>name</code>的输入与<code>City</code>一样长寿”。</p>
<p>现在我们可以了解一下之前看到的<code>&lt;&#39;_&gt;</code>。这被称为 “匿名生命期”，是使用引用的一个指标。例如，当你在实现结构时，Rust会向你建议。这里有一个几乎可以工作的结构，但还没有。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">    <span class="token comment">// ⚠️</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points <span class="token operator">-=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; has &#123;&#125; hit points left!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我们对<code>struct</code>做了我们需要做的事情:首先我们说<code>name</code>来自于一个<code>&amp;str</code>。这就意味着我们需要lifetime，所以我们给了它<code>&lt;&#39;a&gt;</code>。然后我们必须对<code>struct</code>做同样的处理，以证明它们至少和这个生命期一样长。但是Rust却告诉我们要这样做:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0726]: implicit elided lifetime not allowed here
 --&gt; src\main.rs:6:6
  |
6 | impl Adventurer &#123;
  |      ^^^^^^^^^^- help: indicate the anonymous lifetime: &#96;&lt;&#39;_&gt;&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它想让我们加上那个匿名的生命期，以表明有一个引用被使用。所以如果我们这样写，它就会很高兴。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points <span class="token operator">-=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; has &#123;&#125; hit points left!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个生命期是为了让你不必总是写诸如<code>impl&lt;&#39;a&gt; Adventurer&lt;&#39;a&gt;</code>这样的东西，因为结构已经显示了生命期。</p>
<p>在Rust中，生命期是很困难的，但这里有一些技巧可以避免对它们太过紧张。</p>
<ul>
<li>你可以继续使用自有类型，使用克隆等，如果你想暂时避免它们。</li>
<li>很多时候，当编译器想要lifetime的时候，你只要在这里和那里写上&lt;’a&gt;就可以了。这只是一种 “别担心，我不会给你任何不够长寿的东西”的说法。</li>
<li>你可以每次只探索一下生命期。写一些拥有值的代码，然后把一个代码变成一个引用。编译器会开始抱怨，但也会给出一些建议。如果它变得太复杂，你可以撤销它，下次再试。</li>
</ul>
<p>让我们用我们的代码来做这个，看看编译器怎么说。首先我们回去把生命期拿出来，同时实现<code>Display</code>。<code>Display</code>就打印<code>Adventurer</code>的名字。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points <span class="token operator">-=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; has &#123;&#125; hit points left!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; has &#123;&#125; hit points."</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一个抱怨就是这个:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0106]: missing lifetime specifier
 --&gt; src\main.rs:2:11
  |
2 |     name: &amp;str,
  |           ^ expected named lifetime parameter
  |
help: consider introducing a named lifetime parameter
  |
1 | struct Adventurer&lt;&#39;a&gt; &#123;
2 |     name: &amp;&#39;a str,
  |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它建议怎么做:在Adventurer后面加上<code>&lt;&#39;a&gt;</code>，以及<code>&amp;&#39;a str</code>。所以我们就这么做。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points <span class="token operator">-=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; has &#123;&#125; hit points left!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; has &#123;&#125; hit points."</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在它对这些部分很满意，但对<code>impl</code>块感到奇怪。它希望我们提到它在使用引用。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0726]: implicit elided lifetime not allowed here
 --&gt; src\main.rs:6:6
  |
6 | impl Adventurer &#123;
  |      ^^^^^^^^^^- help: indicate the anonymous lifetime: &#96;&lt;&#39;_&gt;&#96;

error[E0726]: implicit elided lifetime not allowed here
  --&gt; src\main.rs:12:28
   |
12 | impl std::fmt::Display for Adventurer &#123;
   |                            ^^^^^^^^^^- help: indicate the anonymous lifetime: &#96;&lt;&#39;_&gt;&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>好了，我们将这些写进去……现在它工作了！现在我们可以创建一个<code>Adventurer</code>，然后用它做一些事情:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points <span class="token operator">-=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; has &#123;&#125; hit points left!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Adventurer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; has &#123;&#125; hit points."</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hit_points<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> billy <span class="token operator">=</span> <span class="token class-name">Adventurer</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">,</span>
        hit_points<span class="token punctuation">:</span> <span class="token number">100_000</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> billy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    billy<span class="token punctuation">.</span><span class="token function">take_damage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Billy has 100000 hit points.
Billy has 99980 hit points left!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以你可以看到，lifetimes往往只是编译器想要确定。而且它通常很聪明，几乎可以猜到你想要的生命期，只需要你告诉它，它就可以确定了。</p>
<h2 id="内部可变性"><a href="#内部可变性" class="headerlink" title="内部可变性"></a>内部可变性</h2><h3 id="Cell"><a href="#Cell" class="headerlink" title="Cell"></a>Cell</h3><p><strong>内部可变性</strong>的意思是在内部有一点可变性。还记得在Rust中，你需要用<code>mut</code>来改变一个变量吗？也有一些方法可以不用<code>mut</code>这个词来改变它们。这是因为Rust有一些方法可以让你安全地在一个不可变的结构里面改变值。每一种方法都遵循一些规则，确保改变值仍然是安全的。</p>
<p>首先，让我们看一个简单的例子，我们会想要这样做:想象一下，一个叫<code>PhoneModel</code>的结构体有很多字段:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">PhoneModel</span> <span class="token punctuation">&#123;</span>
    company_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    model_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    screen_size<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    memory<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    date_issued<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    on_sale<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> super_phone_3000 <span class="token operator">=</span> <span class="token class-name">PhoneModel</span> <span class="token punctuation">&#123;</span>
        company_name<span class="token punctuation">:</span> <span class="token string">"YY Electronics"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        model_name<span class="token punctuation">:</span> <span class="token string">"Super Phone 3000"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        screen_size<span class="token punctuation">:</span> <span class="token number">7.5</span><span class="token punctuation">,</span>
        memory<span class="token punctuation">:</span> <span class="token number">4_000_000</span><span class="token punctuation">,</span>
        date_issued<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">,</span>
        on_sale<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>PhoneModel</code>中的字段最好是不可变的，因为我们不希望数据改变。比如说<code>date_issued</code>和<code>screen_size</code>永远不会变。</p>
<p>但是里面有一个字段叫<code>on_sale</code>。一个手机型号先是会有销售(<code>true</code>)，但是后来公司会停止销售。我们能不能只让这一个字段可变？因为我们不想写<code>let mut super_phone_3000</code>。如果我们这样做，那么每个字段都会变得可变。</p>
<p>Rust有很多方法可以让一些不可变的东西里面有一些安全的可变性，最简单的方法叫做<code>Cell</code>。首先我们使用<code>use std::cell::Cell</code>，这样我们就可以每次只写<code>Cell</code>而不是<code>std::cell::Cell</code>。</p>
<p>然后我们把<code>on_sale: bool</code>改成<code>on_sale: Cell&lt;bool&gt;</code>。现在它不是一个bool:它是一个<code>Cell</code>，容纳了一个<code>bool</code>。</p>
<p><code>Cell</code>有一个叫做<code>.set()</code>的方法，在这里你可以改变值。我们用<code>.set()</code>把<code>on_sale: true</code>改为<code>on_sale: Cell::new(true)</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">Cell</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">PhoneModel</span> <span class="token punctuation">&#123;</span>
    company_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    model_name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    screen_size<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    memory<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    date_issued<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    on_sale<span class="token punctuation">:</span> <span class="token class-name">Cell</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> super_phone_3000 <span class="token operator">=</span> <span class="token class-name">PhoneModel</span> <span class="token punctuation">&#123;</span>
        company_name<span class="token punctuation">:</span> <span class="token string">"YY Electronics"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        model_name<span class="token punctuation">:</span> <span class="token string">"Super Phone 3000"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        screen_size<span class="token punctuation">:</span> <span class="token number">7.5</span><span class="token punctuation">,</span>
        memory<span class="token punctuation">:</span> <span class="token number">4_000_000</span><span class="token punctuation">,</span>
        date_issued<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">,</span>
        on_sale<span class="token punctuation">:</span> <span class="token class-name">Cell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 10 years later, super_phone_3000 is not on sale anymore</span>
    super_phone_3000<span class="token punctuation">.</span>on_sale<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Cell</code> 适用于所有类型，但对简单的 Copy 类型效果最好，因为它给出的是值，而不是引用。<code>Cell</code>有一个叫做<code>get()</code>的方法，它只对Copy类型有效。</p>
<p>另一个可以使用的类型是 <code>RefCell</code>。</p>
<h3 id="RefCell"><a href="#RefCell" class="headerlink" title="RefCell"></a>RefCell</h3><p><code>RefCell</code>是另一种无需声明<code>mut</code>而改变值的方法。它的意思是 “引用单元格”，就像 <code>Cell</code>，但使用引用而不是副本。</p>
<p>我们将创建一个 <code>User</code> 结构。到目前为止，你可以看到它与 <code>Cell</code> 类似。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">User</span> <span class="token punctuation">&#123;</span>
    id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    year_registered<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    active<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">// Many other fields</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> user_1 <span class="token operator">=</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        year_registered<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> <span class="token string">"User 1"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        active<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> user_1<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以打印出<code>RefCell &#123; value: true &#125;</code>。</p>
<p><code>RefCell</code>的方法有很多。其中两种是<code>.borrow()</code>和<code>.borrow_mut()</code>。使用这些方法，你可以做与<code>&amp;</code>和<code>&amp;mut</code>相同的事情。规则都是一样的:</p>
<ul>
<li>多个不可变借用可以</li>
<li>一个可变的借用可以</li>
<li>但mutable和immutable借用在一起是不行的</li>
</ul>
<p>所以改变<code>RefCell</code>中的值是非常容易的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
user_1<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> user_1<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>而且还有很多其他的方法，比如<code>replace_with</code>使用的是闭包。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token number">2020</span><span class="token punctuation">;</span>

user_1
    <span class="token punctuation">.</span>active
    <span class="token punctuation">.</span><span class="token function">replace_with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">if</span> date <span class="token operator">&lt;</span> <span class="token number">2000</span> <span class="token punctuation">&#123;</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> user_1<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>但是你要小心使用<code>RefCell</code>，因为它是在运行时而不是编译时检查借用。运行时是指程序实际运行的时候(编译后)。所以这将会被编译，即使它是错误的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">User</span> <span class="token punctuation">&#123;</span>
    id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    year_registered<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    active<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">// Many other fields</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> user_1 <span class="token operator">=</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        year_registered<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> <span class="token string">"User 1"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        active<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> borrow_one <span class="token operator">=</span> user_1<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// first mutable borrow - okay</span>
    <span class="token keyword">let</span> borrow_two <span class="token operator">=</span> user_1<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// second mutable borrow - not okay</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但如果你运行它，它就会立即崩溃。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">thread &#39;main&#39; panicked at &#39;already borrowed: BorrowMutError&#39;, C:\Users\mithr\.rustup\toolchains\stable-x86_64-pc-windows-msvc\lib&#x2F;rustlib&#x2F;src&#x2F;rust\src\libcore\cell.rs:877:9
note: run with &#96;RUST_BACKTRACE&#x3D;1&#96; environment variable to display a backtrace
error: process didn&#39;t exit successfully: &#96;target\debug\rust_book.exe&#96; (exit code: 101)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>already borrowed: BorrowMutError</code>是重要的部分。所以当你使用<code>RefCell</code>时，好编译<strong>并</strong>运行检查。</p>
<h3 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h3><p><code>Mutex</code>是另一种改变数值的方法，不需要声明<code>mut</code>。Mutex的意思是<code>mutual exclusion</code>，也就是 “一次只能改一个”。这就是为什么<code>Mutex</code>是安全的，因为它每次只让一个进程改变它。为了做到这一点，它使用了<code>.lock()</code>。<code>Lock</code>就像从里面锁上一扇门。你进入一个房间，锁上门，现在你可以在房间里面改变东西。别人不能进来阻止你，因为你把门锁上了。</p>
<p><code>Mutex</code>通过例子更容易理解:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// A new Mutex&lt;i32>. We don't need to say mut</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mutex_changer is a MutexGuard</span>
                                                     <span class="token comment">// It has to be mut because we will change it</span>
                                                     <span class="token comment">// Now it has access to the Mutex</span>
                                                     <span class="token comment">// Let's print my_mutex to see:</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This prints "Mutex &#123; data: &lt;locked> &#125;"</span>
                                <span class="token comment">// So we can't access the data with my_mutex now,</span>
                                <span class="token comment">// only with mutex_changer</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> mutex_changer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This prints 5. Let's change it to 6.</span>

    <span class="token operator">*</span>mutex_changer <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// mutex_changer is a MutexGuard&lt;i32> so we use * to change the i32</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> mutex_changer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it says 6</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是<code>mutex_changer</code>做完后还是有锁。我们该如何阻止它呢？<code>Mutex</code>在<code>MutexGuard</code>超出范围时就会被解锁。”超出范围”表示该代码块已经完成。比如说:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>mutex_changer <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token comment">// mutex_changer goes out of scope - now it is gone. It is not locked anymore</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it says: Mutex &#123; data: 6 &#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你不想使用不同的<code>&#123;&#125;</code>代码块，你可以使用<code>std::mem::drop(mutex_changer)</code>。<code>std::mem::drop</code>的意思是 “让这个超出范围”。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>mutex_changer <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">drop</span><span class="token punctuation">(</span>mutex_changer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// drop mutex_changer - it is gone now</span>
                                   <span class="token comment">// and my_mutex is unlocked</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it says: Mutex &#123; data: 6 &#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你必须小心使用 <code>Mutex</code>，因为如果另一个变量试图 <code>lock</code>它，它会等待。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mutex_changer has the lock</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> other_mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// other_mutex_changer wants the lock</span>
                                                            <span class="token comment">// the program is waiting</span>
                                                            <span class="token comment">// and waiting</span>
                                                            <span class="token comment">// and will wait forever.</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"This will never print..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还有一种方法是<code>try_lock()</code>。然后它会试一次，如果没能锁上就会放弃。<code>try_lock().unwrap()</code>就不要做了，因为如果不成功它就会崩溃。<code>if let</code>或<code>match</code>比较好。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> other_mutex_changer <span class="token operator">=</span> my_mutex<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// try to get the lock</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> other_mutex_changer <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The MutexGuard has: &#123;&#125;"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Didn't get the lock"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外，你不需要创建一个变量来改变<code>Mutex</code>。你可以直接这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>*my_mutex.lock().unwrap() = 6;</code>的意思是 “解锁my_mutex并使其成为6”。没有任何变量来保存它，所以你不需要调用 <code>std::mem::drop</code>。如果你愿意，你可以做100次–这并不重要。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_mutex <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">100</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">*</span>my_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// locks and unlocks 100 times</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="RwLock"><a href="#RwLock" class="headerlink" title="RwLock"></a>RwLock</h3><p><code>RwLock</code>的意思是 “读写锁”。它像<code>Mutex</code>，但也像<code>RefCell</code>。你用<code>.write().unwrap()</code>代替<code>.lock().unwrap()</code>来改变它。但你也可以用<code>.read().unwrap()</code>来获得读权限。它和<code>RefCell</code>一样，遵循这些规则:</p>
<ul>
<li>很多<code>.read()</code>变量可以</li>
<li>一个<code>.write()</code>变量可以</li>
<li>但多个<code>.write()</code>或<code>.read()</code>与<code>.write()</code>一起是不行的</li>
</ul>
<p>如果在无法访问的情况下尝试<code>.write()</code>，程序将永远运行。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">RwLock</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_rwlock <span class="token operator">=</span> <span class="token class-name">RwLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> read1 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one .read() is fine</span>
    <span class="token keyword">let</span> read2 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// two .read()s is also fine</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;, &#123;:?&#125;"</span><span class="token punctuation">,</span> read1<span class="token punctuation">,</span> read2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> write1 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// uh oh, now the program will wait forever</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我们用<code>std::mem::drop</code>，就像用<code>Mutex</code>一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">RwLock</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span>drop<span class="token punctuation">;</span> <span class="token comment">// We will use drop() many times</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_rwlock <span class="token operator">=</span> <span class="token class-name">RwLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> read1 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> read2 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;, &#123;:?&#125;"</span><span class="token punctuation">,</span> read1<span class="token punctuation">,</span> read2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">drop</span><span class="token punctuation">(</span>read1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">drop</span><span class="token punctuation">(</span>read2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we dropped both, so we can use .write() now</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> write1 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>write1 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">drop</span><span class="token punctuation">(</span>write1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而且你也可以使用<code>try_read()</code>和<code>try_write()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">RwLock</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_rwlock <span class="token operator">=</span> <span class="token class-name">RwLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> read1 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> read2 <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">mut</span> number<span class="token punctuation">)</span> <span class="token operator">=</span> my_rwlock<span class="token punctuation">.</span><span class="token function">try_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">*</span>number <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Now the number is &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Couldn't get write access, sorry!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Cow"><a href="#Cow" class="headerlink" title="Cow"></a>Cow</h2><p>Cow是一个非常方便的枚举。它的意思是 “写时克隆”，如果你不需要<code>String</code>，可以返回一个<code>&amp;str</code>，如果你需要，可以返回一个<code>String</code>。(它也可以对数组与Vec等做同样的处理)。</p>
<p>为了理解它，我们看一下签名。它说</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Cow</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">></span>
<span class="token keyword">where</span>
    <span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'a</span> <span class="token operator">+</span> <span class="token class-name">ToOwned</span> <span class="token operator">+</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span>
    <span class="token class-name">Borrowed</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Owned</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token class-name">B</span> <span class="token keyword">as</span> <span class="token class-name">ToOwned</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Owned</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你马上就知道，<code>&#39;a</code>意味着它可以和引用一起工作。<code>ToOwned</code>的特性意味着它是一个可以变成拥有类型的类型。例如，<code>str</code>通常是一个引用(<code>&amp;str</code>)，你可以把它变成一个拥有的<code>String</code>。</p>
<p>接下来是<code>?Sized</code>。这意味着 “也许是Sized，但也许不是”。Rust中几乎每个类型都是Sized的，但像<code>str</code>这样的类型却不是。这就是为什么我们需要一个 <code>&amp;</code> 来代替 <code>str</code>，因为编译器不知道大小。所以，如果你想要一个可以使用 <code>str</code> 这样的trait，你可以添加 <code>?Sized.</code></p>
<p>接下来是<code>enum</code>的变种。它们是 <code>Borrowed</code> 和 <code>Owned</code>。</p>
<p>想象一下，你有一个返回 <code>Cow&lt;&#39;static, str&gt;</code> 的函数。如果你告诉函数返回<code>&quot;My message&quot;.into()</code>，它就会查看类型:”My message”是<code>str</code>. 这是一个<code>Borrowed</code>的类型，所以它选择<code>Borrowed(&amp;&#39;a B)</code>。所以它就变成了<code>Cow::Borrowed(&amp;&#39;static str)</code>。</p>
<p>而如果你给它一个<code>format!(&quot;&#123;&#125;&quot;, &quot;My message&quot;).into()</code>，那么它就会查看类型。这次是一个<code>String</code>，因为<code>format!</code>创建了<code>String</code>。所以这次会选择 “Owned”。</p>
<p>下面是一个测试<code>Cow</code>的例子。我们将把一个数字放入一个函数中，返回一个<code>Cow&lt;&#39;static, str&gt;</code>。根据这个数字，它会创建一个<code>&amp;str</code>或<code>String</code>。然后它使用<code>.into()</code>将其变成<code>Cow</code>。这样做的时候，它就会选择<code>Cow::Borrowed</code>或者<code>Cow::Owned</code>。那我们就匹配一下，看看它选的是哪一个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>borrow<span class="token punctuation">::</span></span><span class="token class-name">Cow</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">modulo_3</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Cow</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span> <span class="token keyword">str</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> input <span class="token operator">%</span> <span class="token number">3</span> <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token string">"Remainder is 0"</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">1</span> <span class="token operator">=></span> <span class="token string">"Remainder is 1"</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        remainder <span class="token operator">=></span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Remainder is &#123;&#125;"</span><span class="token punctuation">,</span> remainder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> number <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">6</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> <span class="token function">modulo_3</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Borrowed</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; went in. The Cow is borrowed with this message: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Cow</span><span class="token punctuation">::</span><span class="token class-name">Owned</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; went in. The Cow is owned with this message: &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">1 went in. The Cow is borrowed with this message: Remainder is 1
2 went in. The Cow is owned with this message: Remainder is 2
3 went in. The Cow is borrowed with this message: Remainder is 0
4 went in. The Cow is borrowed with this message: Remainder is 1
5 went in. The Cow is owned with this message: Remainder is 2
6 went in. The Cow is borrowed with this message: Remainder is 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Cow</code>还有一些其他的方法，比如<code>into_owned</code> 或者 <code>into_borrowed</code>，这样如果你需要的话，你可以改变它。</p>
<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><p>类型别名的意思是 “给某个类型一个新的名字”。类型别名非常简单。通常，当您有一个很长的类型，而又不想每次都写它时，您就会使用它们。当您想给一个类型起一个更好的名字，便于记忆时，也可以使用它。下面是两个类型别名的例子。</p>
<p>这里是一个不难的类型，但是你想让你的代码更容易被其他人(或者你)理解。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token class-name">CharacterVec</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>这是一种非常难读的类型:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// this return type is extremely long</span>
<span class="token keyword">fn</span> <span class="token function-definition function">returns</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token class-name">Take</span><span class="token operator">&lt;</span><span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token class-name">Skip</span><span class="token operator">&lt;</span><span class="token namespace">std<span class="token punctuation">::</span>slice<span class="token punctuation">::</span></span><span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以你可以改成这样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token class-name">SkipFourTakeFive</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token class-name">Take</span><span class="token operator">&lt;</span><span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token class-name">Skip</span><span class="token operator">&lt;</span><span class="token namespace">std<span class="token punctuation">::</span>slice<span class="token punctuation">::</span></span><span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">returns</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">SkipFourTakeFive</span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，你也可以导入元素，让类型更短:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Take</span><span class="token punctuation">,</span> <span class="token class-name">Skip</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>slice<span class="token punctuation">::</span></span><span class="token class-name">Iter</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">returns</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Take</span><span class="token operator">&lt;</span><span class="token class-name">Skip</span><span class="token operator">&lt;</span><span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以你可以根据自己的喜好来决定在你的代码中什么是最好看的。</p>
<p>请注意，这并没有创建一个实际的新类型。它只是一个代替现有类型的名称。所以如果你写了 <code>type File = String;</code>，编译器只会看到 <code>String</code>。所以这将打印出 <code>true</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token class-name">File</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_file <span class="token operator">==</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么如果你想要一个实际的新类型呢？</p>
<p>如果你想要一个新的文件类型，而编译器看到的是<code>File</code>，你可以把它放在一个结构中。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">File</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// File is a wrapper around String</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在这样就不行了，因为它们是两种不同的类型。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">File</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// File is a wrapper around String</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_file <span class="token operator">==</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ⚠️ cannot compare File with String</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你想比较里面的String，可以用my_file.0:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">File</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I am file contents"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_file<span class="token number">.0</span> <span class="token operator">==</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// my_file.0 is a String, so this prints true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="在函数中导入和重命名"><a href="#在函数中导入和重命名" class="headerlink" title="在函数中导入和重命名"></a>在函数中导入和重命名</h3><p>通常你会在程序的顶部写上<code>use</code>，像这样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Cell</span><span class="token punctuation">,</span> <span class="token class-name">RefCell</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但我们看到，你可以在任何地方这样做，特别是在函数中使用名称较长的enum。下面是一个例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">MapDirection</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">North</span><span class="token punctuation">,</span>
    <span class="token class-name">NorthEast</span><span class="token punctuation">,</span>
    <span class="token class-name">East</span><span class="token punctuation">,</span>
    <span class="token class-name">SouthEast</span><span class="token punctuation">,</span>
    <span class="token class-name">South</span><span class="token punctuation">,</span>
    <span class="token class-name">SouthWest</span><span class="token punctuation">,</span>
    <span class="token class-name">West</span><span class="token punctuation">,</span>
    <span class="token class-name">NorthWest</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">give_direction</span><span class="token punctuation">(</span>direction<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MapDirection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> direction <span class="token punctuation">&#123;</span>
        <span class="token class-name">MapDirection</span><span class="token punctuation">::</span><span class="token class-name">North</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You are heading north."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">MapDirection</span><span class="token punctuation">::</span><span class="token class-name">NorthEast</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You are heading northeast."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// So much more left to type...</span>
        <span class="token comment">// ⚠️ because we didn't write every possible variant</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在我们要在函数里面导入MapDirection。也就是说，在函数里面你可以直接写<code>North</code>等。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">MapDirection</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">North</span><span class="token punctuation">,</span>
    <span class="token class-name">NorthEast</span><span class="token punctuation">,</span>
    <span class="token class-name">East</span><span class="token punctuation">,</span>
    <span class="token class-name">SouthEast</span><span class="token punctuation">,</span>
    <span class="token class-name">South</span><span class="token punctuation">,</span>
    <span class="token class-name">SouthWest</span><span class="token punctuation">,</span>
    <span class="token class-name">West</span><span class="token punctuation">,</span>
    <span class="token class-name">NorthWest</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">give_direction</span><span class="token punctuation">(</span>direction<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">MapDirection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">MapDirection</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span> <span class="token comment">// Import everything in MapDirection</span>
    <span class="token keyword">let</span> m <span class="token operator">=</span> <span class="token string">"You are heading"</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> direction <span class="token punctuation">&#123;</span>
        <span class="token class-name">North</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; north."</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">NorthEast</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; northeast."</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// This is a bit better</span>
        <span class="token comment">// ⚠️</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们已经看到<code>::*</code>的意思是 “导入::之后的所有内容”。在我们的例子中，这意味着<code>North</code>，<code>NorthEast</code>……一直到<code>NorthWest</code>。当你导入别人的代码时，你也可以这样做，但如果代码非常大，你可能会有问题。如果它有一些元素和你的代码是一样的呢？所以一般情况下最好不要一直使用<code>::*</code>，除非你有把握。很多时候你在别人的代码里看到一个叫<code>prelude</code>的部分，里面有你可能需要的所有主要元素。那么你通常会这样使用:<code>name::prelude::*</code>。 我们将在 <code>modules</code> 和 <code>crates</code> 的章节中更多地讨论这个问题。</p>
<p>您也可以使用 <code>as</code> 来更改名称。例如，也许你正在使用别人的代码，而你不能改变枚举中的名称。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">FileState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CannotAccessFile</span><span class="token punctuation">,</span>
    <span class="token class-name">FileOpenedAndReady</span><span class="token punctuation">,</span>
    <span class="token class-name">NoSuchFileExists</span><span class="token punctuation">,</span>
    <span class="token class-name">SimilarFileNameInNextDirectory</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么你就可以</p>
<ol>
<li>导入所有的东西</li>
<li>更改名称</li>
</ol>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">FileState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CannotAccessFile</span><span class="token punctuation">,</span>
    <span class="token class-name">FileOpenedAndReady</span><span class="token punctuation">,</span>
    <span class="token class-name">NoSuchFileExists</span><span class="token punctuation">,</span>
    <span class="token class-name">SimilarFileNameInNextDirectory</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">give_filestate</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">FileState</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">FileState</span><span class="token punctuation">::</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">CannotAccessFile</span> <span class="token keyword">as</span> <span class="token class-name">NoAccess</span><span class="token punctuation">,</span>
        <span class="token class-name">FileOpenedAndReady</span> <span class="token keyword">as</span> <span class="token class-name">Good</span><span class="token punctuation">,</span>
        <span class="token class-name">NoSuchFileExists</span> <span class="token keyword">as</span> <span class="token class-name">NoFile</span><span class="token punctuation">,</span>
        <span class="token class-name">SimilarFileNameInNextDirectory</span> <span class="token keyword">as</span> <span class="token class-name">OtherDirectory</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> input <span class="token punctuation">&#123;</span>
        <span class="token class-name">NoAccess</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Can't access file."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Good</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Here is your file"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">NoFile</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Sorry, there is no file by that name."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">OtherDirectory</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Please check the other directory."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在你可以写<code>OtherDirectory</code>而不是<code>FileState::SimilarFileNameInNextDirectory</code>。</p>
<h2 id="todo-宏"><a href="#todo-宏" class="headerlink" title="todo!宏"></a>todo!宏</h2><p>有时你想粗略写点写代码帮助你想象你的元素。例如，想象一个简单的项目，用书籍做一些事情。下面是你写的时候的想法:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Book</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Okay, first I need a book struct.</span>
               <span class="token comment">// Nothing in there yet - will add later</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">BookType</span> <span class="token punctuation">&#123;</span> <span class="token comment">// A book can be hardcover or softcover, so add an enum</span>
    <span class="token class-name">HardCover</span><span class="token punctuation">,</span>
    <span class="token class-name">SoftCover</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">get_book</span><span class="token punctuation">(</span>book<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Book</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// ⚠️ get_book should take a &amp;Book and return an Option&lt;String></span>

<span class="token keyword">fn</span> <span class="token function-definition function">delete_book</span><span class="token punctuation">(</span>book<span class="token punctuation">:</span> <span class="token class-name">Book</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// delete_book should take a Book and return a Result...</span>
                                                    <span class="token comment">// TODO: impl block and make these functions methods...</span>
<span class="token keyword">fn</span> <span class="token function-definition function">check_book_type</span><span class="token punctuation">(</span>book_type<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BookType</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Let's make sure the match statement works</span>
    <span class="token keyword">match</span> book_type <span class="token punctuation">&#123;</span>
        <span class="token class-name">BookType</span><span class="token punctuation">::</span><span class="token class-name">HardCover</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's hardcover"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">BookType</span><span class="token punctuation">::</span><span class="token class-name">SoftCover</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's softcover"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> book_type <span class="token operator">=</span> <span class="token class-name">BookType</span><span class="token punctuation">::</span><span class="token class-name">HardCover</span><span class="token punctuation">;</span>
    <span class="token function">check_book_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>book_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Okay, let's check this function!</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但Rust对<code>get_book</code>和<code>delete_book</code>不满意。它说</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0308]: mismatched types
  --&gt; src\main.rs:32:29
   |
32 | fn get_book(book: &amp;Book) -&gt; Option&lt;String&gt; &#123;&#125;
   |    --------                 ^^^^^^^^^^^^^^ expected enum &#96;std::option::Option&#96;, found &#96;()&#96;
   |    |
   |    implicitly returns &#96;()&#96; as its body has no tail or &#96;return&#96; expression
   |
   &#x3D; note:   expected enum &#96;std::option::Option&lt;std::string::String&gt;&#96;
           found unit type &#96;()&#96;

error[E0308]: mismatched types
  --&gt; src\main.rs:34:31
   |
34 | fn delete_book(book: Book) -&gt; Result&lt;(), String&gt; &#123;&#125;
   |    -----------                ^^^^^^^^^^^^^^^^^^ expected enum &#96;std::result::Result&#96;, found &#96;()&#96;
   |    |
   |    implicitly returns &#96;()&#96; as its body has no tail or &#96;return&#96; expression
   |
   &#x3D; note:   expected enum &#96;std::result::Result&lt;(), std::string::String&gt;&#96;
           found unit type &#96;()&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是你现在不关心<code>get_book</code>和<code>delete_book</code>。这时你可以使用<code>todo!()</code>。如果你把这个加到函数中，Rust不会抱怨，而且会编译。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Book</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">get_book</span><span class="token punctuation">(</span>book<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Book</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// todo means "I will do it later, please be quiet"</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">delete_book</span><span class="token punctuation">(</span>book<span class="token punctuation">:</span> <span class="token class-name">Book</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在代码编译，你可以看到<code>check_book_type</code>的结果:<code>It&#39;s hardcover</code>。</p>
<p>但是要小心，因为它只是编译–你不能使用函数。如果你调用里面有<code>todo!()</code>的函数，它就会崩溃。</p>
<p>另外，<code>todo!()</code>函数仍然需要真实的输入和输出类型。如果你只写这个，它将无法编译。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Book</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">get_book</span><span class="token punctuation">(</span>book<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Book</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">WorldsBestType</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ⚠️</span>
    <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它会说</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0412]: cannot find type &#96;WorldsBestType&#96; in this scope
  --&gt; src\main.rs:32:29
   |
32 | fn get_book(book: &amp;Book) -&gt; WorldsBestType &#123;
   |                             ^^^^^^^^^^^^^^ not found in this scope<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>todo!()</code>其实和另一个宏一样。<code>unimplemented!()</code>. 程序员们经常使用 <code>unimplemented!()</code>，但打字时太长了，所以他们创建了 <code>todo!()</code>，它比较短。</p>
<h2 id="Rc"><a href="#Rc" class="headerlink" title="Rc"></a>Rc</h2><p>Rc的意思是 “reference counter”(引用计数器)。你知道在Rust中，每个变量只能有一个所有者。这就是为什么这个不能工作的原因:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">takes_a_string</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It is: &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">also_takes_a_string</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It is: &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> user_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"User MacUserson"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">takes_a_string</span><span class="token punctuation">(</span>user_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">also_takes_a_string</span><span class="token punctuation">(</span>user_name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>takes_a_string</code>取了<code>user_name</code>之后，你就不能再使用了。这里没有问题:你可以直接给它<code>user_name.clone()</code>。但有时一个变量是一个结构的一部分，也许你不能克隆这个结构。或者<code>String</code>真的很长，你不想克隆它。这些都是<code>Rc</code>的一些原因，它让你拥有多个所有者。<code>Rc</code>就像一个优秀的办公人员。<code>Rc</code>写下谁拥有所有权，以及有多少个。然后一旦所有者的数量下降到0，这个变量就可以消失了。</p>
<p>下面是如何使用<code>Rc</code>。首先想象两个结构:一个叫 <code>City</code>，另一个叫 <code>CityData</code>。<code>City</code>有一个城市的信息，而<code>CityData</code>把所有的城市都放在<code>Vec</code>中。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    city_history<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">CityData</span> <span class="token punctuation">&#123;</span>
    names<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    histories<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> calgary <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Calgary"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        population<span class="token punctuation">:</span> <span class="token number">1_200_000</span><span class="token punctuation">,</span>
           <span class="token comment">// Pretend that this string is very very long</span>
        city_history<span class="token punctuation">:</span> <span class="token string">"Calgary began as a fort called Fort Calgary that..."</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> canada_cities <span class="token operator">=</span> <span class="token class-name">CityData</span> <span class="token punctuation">&#123;</span>
        names<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>calgary<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// This is using calgary.name, which is short</span>
        histories<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>calgary<span class="token punctuation">.</span>city_history<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// But this String is very long</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Calgary's history is: &#123;&#125;"</span><span class="token punctuation">,</span> calgary<span class="token punctuation">.</span>city_history<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，这是不可能的，因为<code>canada_cities</code>现在拥有数据，而<code>calgary</code>没有。它说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0382]: borrow of moved value: &#96;calgary.city_history&#96;
  --&gt; src\main.rs:27:42
   |
24 |         histories: vec![calgary.city_history], &#x2F;&#x2F; But this String is very long
   |                         -------------------- value moved here
...
27 |     println!(&quot;Calgary&#39;s history is: &#123;&#125;&quot;, calgary.city_history);  &#x2F;&#x2F; ⚠️
   |                                          ^^^^^^^^^^^^^^^^^^^^ value borrowed here after move
   |
   &#x3D; note: move occurs because &#96;calgary.city_history&#96; has type &#96;std::string::String&#96;, which does not implement the &#96;Copy&#96; trait<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以克隆名称:<code>names: vec![calgary.name.clone()]</code>，但是我们不想克隆<code>city_history</code>，因为它很长。所以我们可以用一个<code>Rc</code>。</p>
<p>增加<code>use</code>的声明。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后用<code>Rc</code>把<code>String</code>包围起来:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    city_history<span class="token punctuation">:</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">CityData</span> <span class="token punctuation">&#123;</span>
    names<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    histories<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>要添加一个新的引用，你必须<code>clone</code> <code>Rc</code>。但是等一下，我们不是想避免使用<code>.clone()</code>吗？不完全是:我们不想克隆整个String。但是一个<code>Rc</code>的克隆只是克隆了指针–它基本上是免费的。这就像在一盒书上贴上一个名字贴纸，以表明有两个人拥有它，而不是做一盒全新的书。</p>
<p>你可以用<code>item.clone()</code>或者用<code>Rc::clone(&amp;item)</code>来克隆一个叫<code>item</code>的<code>Rc</code>。所以calgary.city_history有两个所有者。<br> 我们可以用<code>Rc::strong_count(&amp;item)</code>查询拥有者数量。另外我们再增加一个新的所有者。现在我们的代码是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    city_history<span class="token punctuation">:</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// String inside an Rc</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">CityData</span> <span class="token punctuation">&#123;</span>
    names<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    histories<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">,</span> <span class="token comment">// A Vec of Strings inside Rcs</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> calgary <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Calgary"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        population<span class="token punctuation">:</span> <span class="token number">1_200_000</span><span class="token punctuation">,</span>
           <span class="token comment">// Pretend that this string is very very long</span>
        city_history<span class="token punctuation">:</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Calgary began as a fort called Fort Calgary that..."</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Rc::new() to make the Rc</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> canada_cities <span class="token operator">=</span> <span class="token class-name">CityData</span> <span class="token punctuation">&#123;</span>
        names<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>calgary<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>
        histories<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>calgary<span class="token punctuation">.</span>city_history<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// .clone() to increase the count</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Calgary's history is: &#123;&#125;"</span><span class="token punctuation">,</span> calgary<span class="token punctuation">.</span>city_history<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>calgary<span class="token punctuation">.</span>city_history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> new_owner <span class="token operator">=</span> calgary<span class="token punctuation">.</span>city_history<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就打印出了<code>2</code>。而<code>new_owner</code>现在是<code>Rc&lt;String&gt;</code>。现在如果我们用<code>println!(&quot;&#123;&#125;&quot;, Rc::strong_count(&amp;calgary.city_history));</code>，我们得到<code>3</code>。</p>
<p>那么，如果有强指针，是否有弱指针呢？是的，有。弱指针是有用的，因为如果两个<code>Rc</code>互相指向对方，它们就不会死。这就是所谓的 “引用循环”。如果第1项对第2项有一个Rc，而第2项对第1项有一个Rc，它们不能到0，在这种情况下，你要使用弱引用。那么<code>Rc</code>就会对引用进行计数，但如果只有弱引用，那么它就会死掉。你使用<code>Rc::downgrade(&amp;item)</code>而不是<code>Rc::clone(&amp;item)</code>来创建弱引用。另外，你用<code>Rc::weak_count(&amp;item)</code>来查看弱引用数。</p>
<h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>如果你使用多个线程，你可以同时做很多事情。现代计算机有一个以上的核心，所以它们可以同时做多件事情，Rust让你使用它们。Rust使用的线程被称为 “OS线程”。OS线程意味着操作系统在不同的核上创建线程。(其他一些语言使用 “green threads”，功能较少)</p>
<p>你用<code>std::thread::spawn</code>创建线程，然后用一个闭包来告诉它该怎么做。线程很有趣，因为它们同时运行，你可以测试它，看看会发生什么。下面是一个简单的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你运行这个，每次都会不一样。有时会打印，有时不会打印(这也取决于你的电脑速度)。这是因为有时<code>main()</code>在线程完成之前就完成了。而当<code>main()</code>完成后，程序就结束了。这在<code>for</code>循环中更容易看到。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span> <span class="token comment">// set up ten threads</span>
        <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   <span class="token comment">// Now the threads start.</span>
<span class="token punctuation">&#125;</span>       <span class="token comment">// How many can finish before main() ends here?</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通常在<code>main</code>结束之前，大约会打印出四条线程，但总是不一样。如果你的电脑速度比较快，那么可能就不会打印了。另外，有时线程会崩溃。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">thread &#39;thread &#39;I am printing something
thread &#39;&lt;unnamed&gt;&lt;unnamed&gt;thread &#39;&#39; panicked at &#39;&lt;unnamed&gt;I am printing something
&#39; panicked at &#39;thread &#39;&lt;unnamed&gt;cannot access stdout during shutdown&#39; panicked at &#39;&lt;unnamed&gt;thread &#39;cannot access stdout during
shutdown<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是在程序关闭时，线程试图做一些正确的事情时出现的错误。</p>
<p>你可以给电脑做一些事情，这样它就不会马上关闭了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
        <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1_000_000</span> <span class="token punctuation">&#123;</span> <span class="token comment">// make the program declare "let x = 9" one million times</span>
                            <span class="token comment">// It has to finish this before it can exit the main function</span>
        <span class="token keyword">let</span> _x <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但这是一个让线程有时间完成的愚蠢方法。更好的方法是将线程绑定到一个变量上。如果你加上 <code>let</code>，你就能创建一个 <code>JoinHandle</code>。你可以在<code>spawn</code>的签名中看到这一点:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt;
where
    F: FnOnce() -&gt; T,
    F: Send + &#39;static,
    T: Send + &#39;static,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(<code>f</code>是闭包–我们将在后面学习如何将闭包放入我们的函数中)</p>
<p>所以现在我们每次都有<code>JoinHandle</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>handle</code>现在是<code>JoinHandle</code>。我们怎么处理它呢？我们使用一个叫做 <code>.join()</code> 的方法。这个方法的意思是 “等待所有线程完成”(它等待线程加入它)。所以现在只要写<code>handle.join()</code>，它就会等待每个线程完成。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for the threads to finish</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们就来了解一下三种类型的闭包。这三种类型是</p>
<ul>
<li><code>FnOnce</code>: 取整个值</li>
<li><code>FnMut</code>: 取一个可变引用</li>
<li><code>Fn</code>: 取一个普通引用</li>
</ul>
<p>如果可以的话，闭包会尽量使用<code>Fn</code>。但如果它需要改变值，它将使用 <code>FnMut</code>，而如果它需要取整个值，它将使用 <code>FnOnce</code>。<code>FnOnce</code>是个好名字，因为它解释了它的作用:它取一次值，然后就不能再取了。</p>
<p>下面是一个例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I will go into the closure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>String</code>不是<code>Copy</code>，所以<code>my_closure()</code>是<code>Fn</code>: 它拿到一个引用</p>
<p>如果我们改变<code>my_string</code>，它变成<code>FnMut</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"I will go into the closure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        my_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">" now"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">I will go into the closure now
I will go into the closure now now<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>而如果按值获取，则是<code>FnOnce</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_closure <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        my_vec
            <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// into_iter takes ownership</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token comment">// turn it into u8</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// multiply by 2</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// collect into a Vec</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> new_vec <span class="token operator">=</span> <span class="token function">my_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们是按值取的，所以我们不能多跑<code>my_closure()</code>次。这就是名字的由来。</p>
<p>那么现在回到线程。让我们试着从外部引入一个值:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Can I go inside the thread?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说这个不行。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0373]: closure may outlive the current function, but it borrows &#96;my_string&#96;, which is owned by the current function
  --&gt; src\main.rs:28:37
   |
28 |     let handle &#x3D; std::thread::spawn(|| &#123;
   |                                     ^^ may outlive borrowed value &#96;my_string&#96;
29 |         println!(&quot;&#123;&#125;&quot;, my_string);
   |                        --------- &#96;my_string&#96; is borrowed here
   |
note: function requires argument type to outlive &#96;&#39;static&#96;
  --&gt; src\main.rs:28:18
   |
28 |       let handle &#x3D; std::thread::spawn(|| &#123;
   |  __________________^
29 | |         println!(&quot;&#123;&#125;&quot;, my_string);
30 | |     &#125;);
   | |______^
help: to force the closure to take ownership of &#96;my_string&#96; (and any other referenced variables), use the &#96;move&#96; keyword
   |
28 |     let handle &#x3D; std::thread::spawn(move || &#123;
   |                                     ^^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这条信息很长，但很有用:它说到<code>use the `move` keyword</code>。问题是我们可以在线程使用<code>my_string</code>时对它做任何事情，但线程并不拥有它。这将是不安全的。</p>
<p>让我们试试其他行不通的东西。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Can I go inside the thread?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// now my_string is being used as a reference</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">drop</span><span class="token punctuation">(</span>my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ⚠️ We try to drop it here. But the thread still needs it.</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以你要用<code>move</code>来取值，现在安全了:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Can I go inside the thread?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">drop</span><span class="token punctuation">(</span>my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ⚠️ we can't drop, because handle has it. So this won't work</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我们把<code>std::mem::drop</code>删掉，现在就可以了。<code>handle</code>取<code>my_string</code>，我们的代码就安全了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Can I go inside the thread?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以只要记住:如果你在线程中需要一个来自线程外的值，你需要使用<code>move</code>。</p>
<h2 id="函数中的闭包"><a href="#函数中的闭包" class="headerlink" title="函数中的闭包"></a>函数中的闭包</h2><p>闭包是伟大的。那么我们如何把它们放到自己的函数中呢？</p>
<p>你可以创建自己的函数来接受闭包，但是在函数里面就不那么自由了，你必须决定类型。在函数外部，一个闭包可以在<code>Fn</code>、<code>FnMut</code>和<code>FnOnce</code>之间自行决定，但在函数内部你必须选择一个。最好的理解方式是看几个函数签名。<br> 这里是<code>.all()</code>的那个。我们记得，它检查一个迭代器，看看所有的东西是否是<code>true</code>(取决于你决定是<code>true</code>还是<code>false</code>)。它的部分签名是这样说的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">all</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span>    <span class="token comment">// 🚧</span>
<span class="token keyword">where</span>
    <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>fn all&lt;F&gt;</code>:这告诉你有一个通用类型<code>F</code>。一个闭包总是泛型，因为每次都是不同的类型。</p>
<p><code>(&amp;mut self, f: F)</code>:<code>&amp;mut self</code>告诉你这是一个方法。<code>f: F</code>通常你看到的是一个闭包:这是变量名和类型。 当然，<code>f</code>和<code>F</code>并没有什么特别之处，它们可以是不同的名字。如果你愿意，你可以写<code>my_closure: Closure</code>–这并不重要。但在签名中，你几乎总是看到<code>f: F</code>。</p>
<p>接下来是关于闭包的部分:<code>F: FnMut(Self::Item) -&gt; bool</code>。在这里，它决定了闭包是 <code>FnMut</code>，所以它可以改变值。它改变了<code>Self::Item</code>的值，这是它所取的迭代器。而且它必须返回 <code>true</code> 或 <code>false</code>。</p>
<p>这里是一个更简单的签名，有一个闭包。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">do_something</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>    <span class="token comment">// 🚧</span>
<span class="token keyword">where</span>
    <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这只是说它接受一个闭包，取值(<code>FnOnce</code>=取值)，而不返回任何东西。所以现在我们可以调用这个什么都不取的闭包，做我们喜欢做的事情。我们将创建一个 <code>Vec</code>，然后对它进行迭代，只是为了展示我们现在可以做什么。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">do_something</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>
<span class="token keyword">where</span>
    <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">do_something</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> some_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        some_vec
            <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is: &#123;&#125;"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一个更真实的例子，我们将再次创建一个 <code>City</code> 结构体。这次 <code>City</code> 结构体有更多关于年份和人口的数据。它有一个 <code>Vec&lt;u32&gt;</code> 来表示所有的年份，还有一个 <code>Vec&lt;u32&gt;</code> 来表示所有的人口。</p>
<p><code>City</code>有两个函数:<code>new()</code>用于创建一个新的<code>City</code>, <code>.city_data()</code>有个闭包. 当我们使用 <code>.city_data()</code> 时，它给我们提供了年份和人口以及一个闭包，所以我们可以对数据做我们想做的事情。闭包类型是 <code>FnMut</code>，所以我们可以改变数据。它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    years<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">,</span>
    populations<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> years<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">,</span> populations<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            years<span class="token punctuation">,</span>
            populations<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">city_data</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token comment">// We bring in self, but only f is generic F. f is the closure</span>

    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// The closure takes mutable vectors of u32</span>
                                                <span class="token comment">// which are the year and population data</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>years<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>populations<span class="token punctuation">)</span> <span class="token comment">// Finally this is the actual function. It says</span>
                                                  <span class="token comment">// "use a closure on self.years and self.populations"</span>
                                                  <span class="token comment">// We can do whatever we want with the closure</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> years <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token number">1372</span><span class="token punctuation">,</span> <span class="token number">1834</span><span class="token punctuation">,</span> <span class="token number">1851</span><span class="token punctuation">,</span> <span class="token number">1881</span><span class="token punctuation">,</span> <span class="token number">1897</span><span class="token punctuation">,</span> <span class="token number">1925</span><span class="token punctuation">,</span> <span class="token number">1959</span><span class="token punctuation">,</span> <span class="token number">1989</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">2010</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> populations <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token number">3_250</span><span class="token punctuation">,</span> <span class="token number">15_300</span><span class="token punctuation">,</span> <span class="token number">24_000</span><span class="token punctuation">,</span> <span class="token number">45_900</span><span class="token punctuation">,</span> <span class="token number">58_800</span><span class="token punctuation">,</span> <span class="token number">119_800</span><span class="token punctuation">,</span> <span class="token number">283_071</span><span class="token punctuation">,</span> <span class="token number">478_974</span><span class="token punctuation">,</span> <span class="token number">400_378</span><span class="token punctuation">,</span> <span class="token number">401_694</span><span class="token punctuation">,</span>
        <span class="token number">406_703</span><span class="token punctuation">,</span> <span class="token number">437_619</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Now we can create our city</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> tallinn <span class="token operator">=</span> <span class="token class-name">City</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Tallinn"</span><span class="token punctuation">,</span> years<span class="token punctuation">,</span> populations<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now we have a .city_data() method that has a closure. We can do anything we want.</span>

    <span class="token comment">// First let's put the data for 5 years together and print it.</span>
    tallinn<span class="token punctuation">.</span><span class="token function">city_data</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>city_years<span class="token punctuation">,</span> city_populations<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// We can call the input anything we want</span>
        <span class="token keyword">let</span> new_vec <span class="token operator">=</span> city_years
            <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>city_populations<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Zip the two together</span>
            <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                           <span class="token comment">// but only take the first 5</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Tell Rust to decide the type inside the tuple</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now let's add some data for the year 2030</span>
    tallinn<span class="token punctuation">.</span><span class="token function">city_data</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token punctuation">,</span> y<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// This time we just call the input x and y</span>
        x<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2030</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        y<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">500_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We don't want the 1834 data anymore</span>
    tallinn<span class="token punctuation">.</span><span class="token function">city_data</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token punctuation">,</span> y<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> position_option <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>x <span class="token operator">==</span> <span class="token number">1834</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span> <span class="token operator">=</span> position_option <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span>
                <span class="token string">"Going to delete &#123;&#125; at position &#123;:?&#125; now."</span><span class="token punctuation">,</span>
                x<span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token punctuation">,</span> position
            <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Confirm that we delete the right item</span>
            x<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
            y<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"Years left are &#123;:?&#125;\nPopulations left are &#123;:?&#125;"</span><span class="token punctuation">,</span>
        tallinn<span class="token punctuation">.</span>years<span class="token punctuation">,</span> tallinn<span class="token punctuation">.</span>populations
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出我们调用<code>.city_data().</code>的所有时间的结果:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[(1372, 3250), (1834, 15300), (1851, 24000), (1881, 45900), (1897, 58800)]
Going to delete 1834 at position 1 now.
Years left are [1372, 1851, 1881, 1897, 1925, 1959, 1989, 2000, 2005, 2010, 2020, 2030]
Populations left are [3250, 24000, 45900, 58800, 119800, 283071, 478974, 400378, 401694, 406703, 437619, 500000]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="impl-Trait"><a href="#impl-Trait" class="headerlink" title="impl Trait"></a>impl Trait</h2><p><code>impl Trait</code>与泛型类似。你还记得，泛型使用一个类型 <code>T</code>(或任何其他名称)，然后在程序编译时决定。首先我们来看一个具体的类型:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">gives_higher_i32</span><span class="token punctuation">(</span>one<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> two<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> higher <span class="token operator">=</span> <span class="token keyword">if</span> one <span class="token operator">></span> two <span class="token punctuation">&#123;</span> one <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> two <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is higher."</span><span class="token punctuation">,</span> higher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">gives_higher_i32</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:<code>10 is higher.</code>.</p>
<p>但是这个只接受<code>i32</code>，所以现在我们要把它做成通用的。我们需要比较，我们需要用<code>&#123;&#125;</code>打印，所以我们的类型T需要<code>PartialOrd</code>和<code>Display</code>。记住，这意味着 “只接受已经实现<code>PartialOrd</code>和<code>Display</code>的类型”。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">gives_higher_i32</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span> <span class="token operator">+</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>one<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> two<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> higher <span class="token operator">=</span> <span class="token keyword">if</span> one <span class="token operator">></span> two <span class="token punctuation">&#123;</span> one <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> two <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; is higher."</span><span class="token punctuation">,</span> higher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">gives_higher_i32</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们来看看<code>impl Trait</code>，它也是类似的。我们可以引入一个类型 <code>impl Trait</code>，而不是 <code>T</code>。然后它将带入一个实现该特性的类型。这几乎是一样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">prints_it</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">Into</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Takes anything that can turn into a String and has Display</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You can print many things, including &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">"Tuon"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> string_name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Tuon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_it</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_it</span><span class="token punctuation">(</span>string_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然而，更有趣的是，我们可以返回 <code>impl Trait</code>，这让我们可以返回闭包，因为它们的函数签名是trait。你可以在有它们的方法的签名中看到这一点。例如，这是 <code>.map()</code> 的签名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">map</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token operator">></span>     <span class="token comment">// 🚧</span>
    <span class="token keyword">where</span>
        <span class="token keyword">Self</span><span class="token punctuation">:</span> <span class="token class-name">Sized</span><span class="token punctuation">,</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">B</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>fn map&lt;B, F&gt;(self, f: F)</code>的意思是，它需要两个通用类型。<code>F</code>是指从实现<code>.map()</code>的容器中取一个元素的函数，<code>B</code>是该函数的返回类型。然后在<code>where</code>之后，我们看到的是trait bound。(“trait bound”的意思是 “它必须有这个trait”。)一个是<code>Sized</code>，接下来是闭包签名。它必须是一个 <code>FnMut</code>，并在 <code>Self::Item</code> 上做闭包，也就是你给它的迭代器。然后它返回<code>B</code>。</p>
<p>所以我们可以用同样的方法来返回一个闭包。要返回一个闭包，使用 <code>impl</code>，然后使用闭包签名。一旦你返回它，你就可以像函数一样使用它。下面是一个函数的小例子，它根据你输入的数字给你一个闭包。如果你输入的是 2 或 40，那么它就会将其相乘，否则就会给你相同的数字。因为它是一个闭包函数，我们可以做任何我们想做的事情，所以我们也打印一条信息。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">returns_a_closure</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> input <span class="token punctuation">&#123;</span>
        <span class="token number">2</span> <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> number<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            number <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Your number is &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            number
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token number">40</span> <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token keyword">mut</span> number<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            number <span class="token operator">*=</span> <span class="token number">40</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Your number is &#123;&#125;"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            number
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>number<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Sorry, it's the same: &#123;&#125;."</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            number
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">// Make three closures</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> give_two <span class="token operator">=</span> <span class="token function">returns_a_closure</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> give_forty <span class="token operator">=</span> <span class="token function">returns_a_closure</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> give_fifty <span class="token operator">=</span> <span class="token function">returns_a_closure</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">give_two</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">give_forty</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">give_fifty</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面是一个比较长的例子。让我们想象一下，在一个游戏中，你的角色面对的是晚上比较强的怪物。我们可以创建一个叫<code>TimeOfDay</code>的枚举来记录一天的情况。你的角色叫西蒙，有一个叫<code>character_fear</code>的数字，也就是<code>f64</code>。它晚上上升，白天下降。我们将创建一个<code>change_fear</code>函数，改变他的恐惧，但也做其他事情，如写消息。它大概是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">TimeOfDay</span> <span class="token punctuation">&#123;</span> <span class="token comment">// just a simple enum</span>
    <span class="token class-name">Dawn</span><span class="token punctuation">,</span>
    <span class="token class-name">Day</span><span class="token punctuation">,</span>
    <span class="token class-name">Sunset</span><span class="token punctuation">,</span>
    <span class="token class-name">Night</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">change_fear</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TimeOfDay</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">FnMut</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">&#123;</span> <span class="token comment">// The function takes a TimeOfDay. It returns a closure.</span>
                                                             <span class="token comment">// We use impl FnMut(64) -> f64 to say that it needs to</span>
                                                             <span class="token comment">// change the value, and also gives the same type back.</span>
    <span class="token keyword">use</span> <span class="token class-name">TimeOfDay</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span> <span class="token comment">// So we only have to write Dawn, Day, Sunset, Night</span>
                      <span class="token comment">// Instead of TimeOfDay::Dawn, TimeOfDay::Day, etc.</span>
    <span class="token keyword">match</span> input <span class="token punctuation">&#123;</span>
        <span class="token class-name">Dawn</span> <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// This is the variable character_fear that we give it later</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The morning sun has vanquished the horrible night. You no longer feel afraid."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Your fear is now &#123;&#125;"</span><span class="token punctuation">,</span> x <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            x <span class="token operator">*</span> <span class="token number">0.5</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token class-name">Day</span> <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"What a nice day. Maybe put your feet up and rest a bit."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Your fear is now &#123;&#125;"</span><span class="token punctuation">,</span> x <span class="token operator">*</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            x <span class="token operator">*</span> <span class="token number">0.2</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token class-name">Sunset</span> <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The sun is almost down! This is no good."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Your fear is now &#123;&#125;"</span><span class="token punctuation">,</span> x <span class="token operator">*</span> <span class="token number">1.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            x <span class="token operator">*</span> <span class="token number">1.4</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token class-name">Night</span> <span class="token operator">=></span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"What a horrible night to have a curse."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Your fear is now &#123;&#125;"</span><span class="token punctuation">,</span> x <span class="token operator">*</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            x <span class="token operator">*</span> <span class="token number">5.0</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">TimeOfDay</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> character_fear <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span> <span class="token comment">// Start Simon with 10</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> daytime <span class="token operator">=</span> <span class="token function">change_fear</span><span class="token punctuation">(</span><span class="token class-name">Day</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make four closures here to call every time we want to change Simon's fear.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sunset <span class="token operator">=</span> <span class="token function">change_fear</span><span class="token punctuation">(</span><span class="token class-name">Sunset</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> night <span class="token operator">=</span> <span class="token function">change_fear</span><span class="token punctuation">(</span><span class="token class-name">Night</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> morning <span class="token operator">=</span> <span class="token function">change_fear</span><span class="token punctuation">(</span><span class="token class-name">Dawn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    character_fear <span class="token operator">=</span> <span class="token function">daytime</span><span class="token punctuation">(</span>character_fear<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call the closures on Simon's fear. They give a message and change the fear number.</span>
                                              <span class="token comment">// In real life we would have a Character struct and use it as a method instead,</span>
                                              <span class="token comment">// like this: character_fear.daytime()</span>
    character_fear <span class="token operator">=</span> <span class="token function">sunset</span><span class="token punctuation">(</span>character_fear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    character_fear <span class="token operator">=</span> <span class="token function">night</span><span class="token punctuation">(</span>character_fear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    character_fear <span class="token operator">=</span> <span class="token function">morning</span><span class="token punctuation">(</span>character_fear<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">What a nice day. Maybe put your feet up and rest a bit.
Your fear is now 2
The sun is almost down! This is no good.
Your fear is now 2.8
What a horrible night to have a curse.
Your fear is now 14
The morning sun has vanquished the horrible night. You no longer feel afraid.
Your fear is now 7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Arc"><a href="#Arc" class="headerlink" title="Arc"></a>Arc</h2><p>你还记得我们用<code>Rc</code>来给一个变量一个以上的所有者。如果我们在一个线程中做同样的事情，我们需要一个 <code>Arc</code>。<code>Arc</code>的意思是 “atomic reference counter”(原子引用计数器)。原子的意思是它使用计算机的处理器，所以每次只写一次数据。这一点很重要，因为如果两个线程同时写入数据，你会得到错误的结果。例如，想象一下，如果你能在Rust中做到这一点。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Thread 1</span>
    x <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Thread 2</span>
    x <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>如果线程1和线程2一起启动，也许就会出现这种情况。</p>
<ul>
<li>线程1看到10，写下11，然后线程2看到11，写下12 然后线程2看到11，写入12。到目前为止没有问题。</li>
<li>线程1看到12。同时，线程2看到12。线程一看到13，写下13 线程2也写了13 现在我们有13个，但应该是14个 Now we have 13, but it should be 14. 这是个大问题。</li>
</ul>
<p><code>Arc</code>使用处理器来确保这种情况不会发生，所以当你有线程时必须使用这种方法。不过不建议单线程上用<code>Arc</code>，因为<code>Rc</code>更快一些。</p>
<p>不过你不能只用一个<code>Arc</code>来改变数据。所以你用一个<code>Mutex</code>把数据包起来，然后用一个<code>Arc</code>把<code>Mutex</code>包起来。</p>
<p>所以我们用一个<code>Mutex</code>在一个<code>Arc</code>里面来改变一个数字的值。首先我们设置一个线程。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The thread is working!"</span><span class="token punctuation">)</span> <span class="token comment">// Just testing the thread</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make the thread wait here until it is done</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Exiting the program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>到目前为止，这个只打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The thread is working!
Exiting the program<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>很好，现在让我们把它放在<code>for</code>的循环中，进行<code>0..5</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The thread is working!"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Exiting the program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这也是可行的。我们得到以下结果:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">The thread is working!
The thread is working!
The thread is working!
The thread is working!
The thread is working!
Exiting the program<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们再加一个线程。每个线程都会做同样的事情。你可以看到，这些线程是在同一时间工作的。有时会先打印<code>Thread 1 is working!</code>，但其他时候<code>Thread 2 is working!</code>先打印。这就是所谓的<strong>并发</strong>，也就是 “一起运行”的意思。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> thread1 <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Thread 1 is working!"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> thread2 <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Thread 2 is working!"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Exiting the program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Thread 1 is working!
Thread 1 is working!
Thread 1 is working!
Thread 1 is working!
Thread 1 is working!
Thread 2 is working!
Thread 2 is working!
Thread 2 is working!
Thread 2 is working!
Thread 2 is working!
Exiting the program<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们要改变<code>my_number</code>的数值。现在它是一个<code>i32</code>。我们将把它改为 <code>Arc&lt;Mutex&lt;i32&gt;&gt;</code>:一个可以改变的 <code>i32</code>，由 <code>Arc</code> 保护。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>现在我们有了这个，我们可以克隆它。每个克隆可以进入不同的线程。我们有两个线程，所以我们将做两个克隆。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> my_number1 <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This clone goes into Thread 1</span>
<span class="token keyword">let</span> my_number2 <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This clone goes into Thread 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在，我们已经将安全克隆连接到<code>my_number</code>，我们可以将它们<code>move</code>到其他线程中，没有问题。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> my_number1 <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_number2 <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> thread1 <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Only the clone goes into Thread 1</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>my_number1<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Lock the Mutex, change the value</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> thread2 <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Only the clone goes into Thread 2</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>my_number2<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    thread1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Value is: &#123;:?&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Exiting the program"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Value is: Mutex &#123; data: 20 &#125;
Exiting the program<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以这是一个成功的案例。</p>
<p>然后我们可以将两个线程连接在一起，形成一个<code>for</code>循环，并使代码更小。</p>
<p>我们需要保存句柄，这样我们就可以在循环外对每个线程调用<code>.join()</code>。如果我们在循环内这样做，它将等待第一个线程完成后再启动新的线程。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> handle_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// JoinHandles will go in here</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">2</span> <span class="token punctuation">&#123;</span> <span class="token comment">// do this twice</span>
        <span class="token keyword">let</span> my_number_clone <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make the clone before starting the thread</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Put the clone in</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
                <span class="token operator">*</span>my_number_clone<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handle_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// save the handle so we can call join on it outside of the loop</span>
                                 <span class="token comment">// If we don't push it in the vec, it will just die here</span>
    <span class="token punctuation">&#125;</span>

    handle_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>handle<span class="token closure-punctuation punctuation">|</span></span> handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// call join on all handles</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后这个打印<code>Mutex &#123; data: 20 &#125;</code>。</p>
<p>这看起来很复杂，但<code>Arc&lt;Mutex&lt;SomeType&gt;&gt;&gt;</code>在Rust中使用的频率很高，所以它变得很自然。另外，你也可以随时写你的代码，让它更干净。这里是同样的代码，多了一条<code>use</code>语句和两个函数。这些函数并没有做任何新的事情，但是它们把一些代码从<code>main()</code>中移出。如果你很难读懂的话，可以尝试重写这样的代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span>spawn<span class="token punctuation">;</span> <span class="token comment">// Now we just write spawn</span>

<span class="token keyword">fn</span> <span class="token function-definition function">make_arc</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Just a function to make a Mutex in an Arc</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">new_clone</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Just a function so we can write new_clone</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Now main() is easier to read</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> handle_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// each handle will go in here</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token function">make_arc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">2</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> my_number_clone <span class="token operator">=</span> <span class="token function">new_clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> value_inside <span class="token operator">=</span> my_number_clone<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>value_inside <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handle_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// the handle is done, so put it in the vector</span>
    <span class="token punctuation">&#125;</span>

    handle_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>handle<span class="token closure-punctuation punctuation">|</span></span> handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make each one wait</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h2><p>A channel is an easy way to use many threads that send to one place.它们相当流行，因为它们很容易组合在一起。你可以在Rust中用<code>std::sync::mpsc</code>创建一个channel。<code>mpsc</code>的意思是 “多个生产者，单个消费者”，所以 “many threads sending to one place”。要启动一个通道，你可以使用 <code>channel()</code>。这将创建一个 <code>Sender</code> 和一个 <code>Receiver</code>，它们被绑在一起。你可以在函数签名中看到这一点。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">channel</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以你要选择一个发送者的名字和一个接收者的名字。通常你会看到像<code>let (sender, receiver) = channel();</code>这样的开头。因为它是泛型，如果你只写这个，Rust不会知道类型。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0282]: type annotations needed for &#96;(std::sync::mpsc::Sender&lt;T&gt;, std::sync::mpsc::Receiver&lt;T&gt;)&#96;
  --&gt; src\main.rs:30:30
   |
30 |     let (sender, receiver) &#x3D; channel();
   |         ------------------   ^^^^^^^ cannot infer type for type parameter &#96;T&#96; declared on the function &#96;channel&#96;
   |         |
   |         consider giving this pattern the explicit type &#96;(std::sync::mpsc::Sender&lt;T&gt;, std::sync::mpsc::Receiver&lt;T&gt;)&#96;, where
the type parameter &#96;T&#96; is specified<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它建议为<code>Sender</code>和<code>Receiver</code>添加一个类型。如果你愿意的话，可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>channel<span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">,</span> <span class="token class-name">Receiver</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Added Sender and Receiver here</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但你不必这样做: 一旦你开始使用<code>Sender</code>和<code>Receiver</code>，Rust就能猜到类型。</p>
<p>所以我们来看一下最简单的使用通道的方法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// recv = receive, not "rec v"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在编译器知道类型了。<code>sender</code>是<code>Result&lt;(), SendError&lt;i32&gt;&gt;</code>，<code>receiver</code>是<code>Result&lt;i32, RecvError&gt;</code>。所以你可以用<code>.unwrap()</code>来看看发送是否有效，或者使用更好的错误处理。我们加上<code>.unwrap()</code>，也加上<code>println!</code>，看看得到什么。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以打印出<code>5</code>。</p>
<p><code>channel</code>就像<code>Arc</code>一样，因为你可以克隆它，并将克隆的内容发送到其他线程中。让我们创建两个线程，并将值发送到<code>receiver</code>。这段代码可以工作，但它并不完全是我们想要的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sender_clone <span class="token operator">=</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// move sender in</span>
        sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Send a &amp;str this time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// move sender_clone in</span>
        sender_clone<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"And here is another &amp;str"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>两个线程开始发送，然后我们<code>println!</code>。它可能会打印 <code>Send a &amp;str this time</code> 或 <code>And here is another &amp;str</code>，这取决于哪个线程先完成。让我们创建一个join句柄来等待它们完成。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sender_clone <span class="token operator">=</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> handle_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Put our handles in here</span>

    handle_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// push this into the vec</span>
        sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Send a &amp;str this time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// and push this into the vec</span>
        sender_clone<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"And here is another &amp;str"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> handle_vec <span class="token punctuation">&#123;</span> <span class="token comment">// now handle_vec has 2 items. Let's print them</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&quot;Send a &amp;str this time&quot;
&quot;And here is another &amp;str&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>现在我们不打印，我们创建一个<code>results_vec</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sender_clone <span class="token operator">=</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> handle_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> results_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    handle_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Send a &amp;str this time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        sender_clone<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"And here is another &amp;str"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> handle_vec <span class="token punctuation">&#123;</span>
        results_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> results_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在结果在我们的vec中:<code>[&quot;Send a &amp;str this time&quot;, &quot;And here is another &amp;str&quot;]</code>。</p>
<p>现在让我们假设我们有很多工作要做，并且想要使用线程。我们有一个大的VEC，里面有1000个元素，都是0，我们想把每个0都变成1，我们将使用10个线程，每个线程将做十分之一的工作。我们将创建一个新的VEC，并使用<code>.extend()</code>来收集结果。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span>channel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> hugevec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> newvec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> sender_clone <span class="token operator">=</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> work<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>hugevec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new vec to put the work in. 1/10th the size</span>
        work<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hugevec<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">..</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// first part gets 0..100, next gets 100..200, etc.</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// make a handle</span>

            <span class="token keyword">for</span> number <span class="token keyword">in</span> work<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// do the actual work</span>
                <span class="token operator">*</span>number <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            sender_clone<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// use the sender_clone to send the work to the receiver</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// stop the thread until it's done</span>
        newvec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push the results from receiver.recv() into the vec</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Now we have a Vec&lt;Vec&lt;u8>>. To put it together we can use .flatten()</span>
    <span class="token keyword">let</span> newvec <span class="token operator">=</span> newvec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it's one vec of 1000 u8 numbers</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你打印这个，你可以看到1000个1。</p>
<h2 id="阅读Rust文档"><a href="#阅读Rust文档" class="headerlink" title="阅读Rust文档"></a>阅读Rust文档</h2><p>知道如何阅读Rust中的文档是很重要的，这样你就可以理解其他人写的东西。这里有一些Rust文档中需要知道的事情。</p>
<h3 id="assert-eq"><a href="#assert-eq" class="headerlink" title="assert_eq!"></a>assert_eq!</h3><p>你在做测试的时候看到<code>assert_eq!</code>是用的。你把两个元素放在函数里面，如果它们不相等，程序就会崩溃。下面是一个简单的例子，我们需要一个偶数。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">prints_number</span><span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">prints_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>input <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// number must be equal.</span>
                              <span class="token comment">// If number % 2 is not 0, it panics</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The number is not odd. It is &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也许你没有任何计划在你的代码中使用<code>assert_eq!</code>，但它在Rust文档中随处可见。这是因为在一个文档中，你需要很大的空间来<code>println!</code>一切。另外，你会需要<code>Display</code>或<code>Debug</code>来打印你想打印的东西。这就是为什么文档中到处都有<code>assert_eq!</code>的原因。下面是这里的一个例子<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/vec/struct.Vec.html">https://doc.rust-lang.org/std/vec/struct.Vec.html</a>，展示了如何使用Vec。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    vec<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token operator">&amp;</span>vec <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这些例子中，你可以只把<code>assert_eq!(a, b)</code>看成是在说 “a是b”。现在看看右边带有注释的同一个例子。注释显示了它的实际含义。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "The vec length is 2"</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "vec[0] is 1"</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "When you use .pop(), you get Some()"</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "The vec length is now 1"</span>

    vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Vec[0] is 7"</span>

    vec<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token operator">&amp;</span>vec <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>vec<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "The vec now has [7, 1, 2, 3]"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>Rust 文档的顶部栏是搜索栏。它在你输入时显示结果。当你往下翻时，你不能再看到搜索栏，但如果你按键盘上的<strong>s</strong>键，你可以再次搜索。所以在任何地方按<strong>s</strong>键可以让你马上搜索。</p>
<h3 id="src-按钮"><a href="#src-按钮" class="headerlink" title="[src] 按钮"></a>[src] 按钮</h3><p>通常一个方法、结构体等的代码不会是完整的。这是因为你通常不需要看到完整的源码就能知道它是如何工作的，而完整的代码可能会让人困惑。但如果你想知道更多，你可以点击[src]就可以看到所有的内容。例如，在<code>String</code>的页面上，你可以看到<code>.with_capacity()</code>的这个签名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_capacity</span><span class="token punctuation">(</span>capacity<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>好了，你输入一个数字，它给你一个<code>String</code>。这很简单，但也许我们很好奇，想看更多。如果你点击[src]你可以看到这个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_capacity</span><span class="token punctuation">(</span>capacity<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> <span class="token punctuation">&#123;</span> vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>有趣的是，现在你可以看到，字符串是<code>Vec</code>的一种。而实际上一个<code>String</code>是一个<code>u8</code>字节的向量，这很有意思。你不需要知道，就可以使用<code>with_capacity</code>的方法，你只有点击[src]才能看到。所以如果文档没有太多细节，而你又想知道更多的话，点击[src]是个好主意。</p>
<h3 id="trait信息"><a href="#trait信息" class="headerlink" title="trait信息"></a>trait信息</h3><p>trait文档的重要部分是左边的 “Required Methods”。如果你看到 “Required Methods”，可能意味着你必须自己编写方法。例如，对于 <code>Iterator</code>，你需要写 <code>.next()</code> 方法。而对于<code>From</code>，你需要写<code>.from()</code>方法。但是有些trait只需要一个<strong>属性</strong>就可以实现，比如我们在<code>#[derive(Debug)]</code>中看到的。<code>Debug</code>需要<code>.fmt()</code>方法，但通常你只需要使用<code>#[derive(Debug)]</code>，除非你想自己做。这就是为什么在<code>std::fmt::Debug</code>的页面上说 “一般来说，你应该直接派生出一个Debug实现”。</p>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><p>你以前见过<code>#[derive(Debug)]</code>这样的代码:这种类型的代码叫做<em>属性</em>。这些属性是给编译器提供信息的小段代码。它们不容易创建，但使用起来非常方便。如果你只用<code>#</code>写一个属性，那么它将影响下一行的代码。但如果你用<code>#!</code>来写，那么它将影响自己空间里的一切。</p>
<p>下面是一些你会经常看到的属性。</p>
<p><code>#[allow(dead_code)]</code> 和 <code>#[allow(unused_variables)]</code>. 如果你写了不用的代码，Rust仍然会编译，但会让你知道。例如，这里是一个结构体，里面什么都没有，只有一个变量。我们不使用它们中的任何一个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">JustAStruct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_char <span class="token operator">=</span> <span class="token char string">'ん'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你这样写，Rust会提醒你，你没有使用它们。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">warning: unused variable: &#96;some_char&#96;
 --&gt; src\main.rs:4:9
  |
4 |     let some_char &#x3D; &#39;ん&#39;;
  |         ^^^^^^^^^ help: if this is intentional, prefix it with an underscore: &#96;_some_char&#96;
  |
  &#x3D; note: &#96;#[warn(unused_variables)]&#96; on by default

warning: struct is never constructed: &#96;JustAStruct&#96;
 --&gt; src\main.rs:1:8
  |
1 | struct JustAStruct &#123;&#125;
  |        ^^^^^^^^^^^
  |
  &#x3D; note: &#96;#[warn(dead_code)]&#96; on by default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们知道，可以在名字前写一个<code>_</code>，让编译器安静下来。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">_JustAStruct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> _some_char <span class="token operator">=</span> <span class="token char string">'ん'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但你也可以使用属性。你会注意到在消息中，它使用了<code>#[warn(unused_variables)]</code>和<code>#[warn(dead_code)]</code>。在我们的代码中，<code>JustAStruct</code>是死代码，而<code>some_char</code>是一个未使用的变量。<code>warn</code>的反义词是<code>allow</code>，所以我们可以这样写，它不会说什么。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#![allow(dead_code)]</span>
<span class="token attribute attr-name">#![allow(unused_variables)]</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct1</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Create five structs</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct2</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct3</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct4</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct5</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> char1 <span class="token operator">=</span> <span class="token char string">'ん'</span><span class="token punctuation">;</span> <span class="token comment">// and four variables. We don't use any of them but the compiler is quiet</span>
    <span class="token keyword">let</span> char2 <span class="token operator">=</span> <span class="token char string">';'</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> some_str <span class="token operator">=</span> <span class="token string">"I'm just a regular &amp;str"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> some_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token string">"am"</span><span class="token punctuation">,</span> <span class="token string">"just"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"vec"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，处理死代码和未使用的变量是很重要的。但有时你希望编译器安静一段时间。或者您可能需要展示一些代码或教人们Rust，但又不想用编译器的信息来迷惑他们。</p>
<p><code>#[derive(TraitName)]</code>让你可以为你创建的结构和枚举派生一些trait。这适用于许多可以自动派生的常见trait。有些像 <code>Display</code> 这样的特性不能自动衍生，因为对于 <code>Display</code>，你必须选择如何显示。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token attribute attr-name">#[derive(Display)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">HoldsAString</span> <span class="token punctuation">&#123;</span>
    the_string<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">HoldsAString</span> <span class="token punctuation">&#123;</span>
        the_string<span class="token punctuation">:</span> <span class="token string">"Here I am!"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>错误信息会告诉你:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error: cannot find derive macro &#96;Display&#96; in this scope
 --&gt; src\main.rs:2:10
  |
2 | #[derive(Display)]
  |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是对于可以自动推导出的trait，你可以随心所欲的放进去。让我们给<code>HoldsAString</code>在一行中加入七个trait，只是为了好玩，尽管它只需要一个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, PartialEq, Eq, Ord, PartialOrd, Hash, Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">HoldsAString</span> <span class="token punctuation">&#123;</span>
    the_string<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">HoldsAString</span> <span class="token punctuation">&#123;</span>
        the_string<span class="token punctuation">:</span> <span class="token string">"Here I am!"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外，如果(也只有在)它的字段都是<code>Copy</code>的情况下，你可以创建一个<code>Copy</code>结构。<code>HoldsAString</code>有<code>String</code>，它不是<code>Copy</code>，所以你不能对它使用<code>#[derive(Copy)]</code>。但是对于这个结构你可以:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Clone, Copy)]</span> <span class="token comment">// You also need Clone to use Copy</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">NumberAndBool</span> <span class="token punctuation">&#123;</span>
    number<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token comment">// i32 is Copy</span>
    true_or_false<span class="token punctuation">:</span> <span class="token keyword">bool</span> <span class="token comment">// bool is also Copy. So no problem</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">does_nothing</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">NumberAndBool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> number_and_bool <span class="token operator">=</span> <span class="token class-name">NumberAndBool</span> <span class="token punctuation">&#123;</span>
        number<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
        true_or_false<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token function">does_nothing</span><span class="token punctuation">(</span>number_and_bool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">does_nothing</span><span class="token punctuation">(</span>number_and_bool<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If it didn't have copy, this would make an error</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><code>#[cfg()]</code>的意思是配置，告诉编译器是否运行代码。它通常是这样的:<code>#[cfg(test)]</code>。你在写测试函数的时候用这个，这样它就知道除非你在测试，否则不要运行它们。那么你可以在你的代码附近有测试，但编译器不会运行它们，除非你告诉它。</p>
<p>还有一个使用<code>cfg</code>的例子是<code>#[cfg(target_os = &quot;windows&quot;)]</code>。有了它，你可以告诉编译器只在Windows，或Linux，或其他某个平台运行代码。</p>
<p><code>#![no_std]</code>是一个有趣的属性，它告诉Rust不要引入标准库。这意味着你没有<code>Vec</code>，<code>String</code>，以及标准库中的其他任何东西。你会在那些没有多少内存或空间的小型设备的代码中看到这个。</p>
<p>你可以看到更多的属性<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/reference/attributes.html">这里</a>。</p>
<h2 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h2><p><code>Box</code> 是 Rust 中一个非常方便的类型。当你使用<code>Box</code>时，你可以把一个类型放在堆上而不是栈上。要创建一个新的 <code>Box</code>，只需使用 <code>Box::new()</code> 并将元素放在里面即可。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">just_takes_a_variable</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Takes anything and drops it.</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// This is an i32</span>
    <span class="token function">just_takes_a_variable</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">just_takes_a_variable</span><span class="token punctuation">(</span>my_number<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Using this function twice is no problem, because it's Copy</span>

    <span class="token keyword">let</span> my_box <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is a Box&lt;i32></span>
    <span class="token function">just_takes_a_variable</span><span class="token punctuation">(</span>my_box<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Without .clone() the second function would make an error</span>
    <span class="token function">just_takes_a_variable</span><span class="token punctuation">(</span>my_box<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// because Box is not Copy</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一开始很难想象在哪里使用它，但你在Rust中经常使用它。你记得<code>&amp;</code>是用于<code>str</code>的，因为编译器不知道<code>str</code>的大小:它可以是任何长度。但是<code>&amp;</code>的引用总是相同的长度，所以编译器可以使用它。<code>Box</code>也是类似的。另外，你也可以在<code>Box</code>上使用<code>*</code>来获取值，就像使用<code>&amp;</code>一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_box <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is a Box&lt;i32></span>
    <span class="token keyword">let</span> an_integer <span class="token operator">=</span> <span class="token operator">*</span>my_box<span class="token punctuation">;</span> <span class="token comment">// This is an i32</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_box<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> an_integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就是为什么Box被称为 “智能指针”的原因，因为它就像<code>&amp;</code>的引用(指针的一种)，但可以做更多的事情。</p>
<p>你也可以使用Box来创建里面有相同结构的结构体。这些结构被称为<em>递归</em>，这意味着在Struct A里面也许是另一个Struct A，有时你可以使用Box来创建链表，尽管这在Rust中并不十分流行。但如果你想创建一个递归结构，你可以使用<code>Box</code>。如果你试着不用 <code>Box</code> 会发生什么:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">&#123;</span>
    item<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// ⚠️</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这个简单的<code>List</code>有一项，可能是<code>Some&lt;List&gt;</code>(另一个列表)，也可能是<code>None</code>。因为你可以选择<code>None</code>，所以它不会永远递归。但是编译器还是不知道大小。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0072]: recursive type &#96;List&#96; has infinite size
  --&gt; src\main.rs:16:1
   |
16 | struct List &#123;
   | ^^^^^^^^^^^ recursive type has infinite size
17 |     item: Option&lt;List&gt;,
   |     ------------------ recursive without indirection
   |
   &#x3D; help: insert indirection (e.g., a &#96;Box&#96;, &#96;Rc&#96;, or &#96;&amp;&#96;) at some point to make &#96;List&#96; representable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，它甚至建议尝试<code>Box</code>。所以我们用<code>Box</code>把List包裹起来。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">&#123;</span>
    item<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在编译器用<code>List</code>就可以了，因为所有的东西都在<code>Box</code>后面，而且它知道<code>Box</code>的大小。那么一个非常简单的列表可能是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">&#123;</span>
    item<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">List</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">List</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span> <span class="token punctuation">&#123;</span>
            item<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">List</span> <span class="token punctuation">&#123;</span> item<span class="token punctuation">:</span> <span class="token class-name">None</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>即使没有数据也有点复杂，Rust并不怎么使用这种类型的模式。这是因为Rust对借用和所有权有严格的规定，你知道的。但如果你想启动一个这样的列表(链表)，<code>Box</code>可以帮助你。</p>
<p><code>Box</code>还可以让你在上面使用<code>std::mem::drop</code>，因为它在堆上。这有时会很方便。</p>
<h2 id="Box-around-traits"><a href="#Box-around-traits" class="headerlink" title="Box around traits"></a>Box around traits</h2><p><code>Box</code>对于返回trait非常有用。你可以像这个例子一样用泛型函数写trait:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">DoesntImplementDisplay</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">displays_it</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个只能接受<code>Display</code>的东西，所以它不能接受我们的<code>DoesntImplementDisplay</code>结构。但是它可以接受很多其他的东西，比如<code>String</code>。</p>
<p>你也看到了，我们可以使用 <code>impl Trait</code> 来返回其他的trait，或者闭包。<code>Box</code>也可以用类似的方式使用。你可以使用 <code>Box</code>，否则编译器将不知道值的大小。这个例子表明，trait可以用在任何大小的东西上:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#![allow(dead_code)]</span> <span class="token comment">// Tell the compiler to be quiet</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span>size_of<span class="token punctuation">;</span> <span class="token comment">// This gives the size of a type</span>

<span class="token keyword">trait</span> <span class="token class-name">JustATrait</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// We will implement this on everything</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">EnumOfNumbers</span> <span class="token punctuation">&#123;</span>
    <span class="token constant">I8</span><span class="token punctuation">(</span><span class="token keyword">i8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">AnotherI8</span><span class="token punctuation">(</span><span class="token keyword">i8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">OneMoreI8</span><span class="token punctuation">(</span><span class="token keyword">i8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">JustATrait</span> <span class="token keyword">for</span> <span class="token class-name">EnumOfNumbers</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">StructOfNumbers</span> <span class="token punctuation">&#123;</span>
    an_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    another_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    one_more_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">JustATrait</span> <span class="token keyword">for</span> <span class="token class-name">StructOfNumbers</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">EnumOfOtherTypes</span> <span class="token punctuation">&#123;</span>
    <span class="token constant">I8</span><span class="token punctuation">(</span><span class="token keyword">i8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">AnotherI8</span><span class="token punctuation">(</span><span class="token keyword">i8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">JustATrait</span> <span class="token keyword">for</span> <span class="token class-name">EnumOfOtherTypes</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">StructOfOtherTypes</span> <span class="token punctuation">&#123;</span>
    an_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    another_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    a_collection<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">JustATrait</span> <span class="token keyword">for</span> <span class="token class-name">StructOfOtherTypes</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">ArrayAndI8</span> <span class="token punctuation">&#123;</span>
    array<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">i8</span><span class="token punctuation">;</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// This one will be very large</span>
    an_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    in_u8<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">impl</span> <span class="token class-name">JustATrait</span> <span class="token keyword">for</span> <span class="token class-name">ArrayAndI8</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span>
        <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">EnumOfNumbers</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">StructOfNumbers</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">EnumOfOtherTypes</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">StructOfOtherTypes</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">ArrayAndI8</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当我们打印这些东西的size的时候，我们得到<code>2, 3, 32, 32, 1002</code>。所以如果你要这样做的话，会给出一个错误:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">returns_just_a_trait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">JustATrait</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_enum <span class="token operator">=</span> <span class="token class-name">EnumOfNumbers</span><span class="token punctuation">::</span><span class="token constant">I8</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    some_enum
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0746]: return type cannot have an unboxed trait object
  --&gt; src\main.rs:53:30
   |
53 | fn returns_just_a_trait() -&gt; JustATrait &#123;
   |                              ^^^^^^^^^^ doesn&#39;t have a size known at compile-time<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而这是真的，因为size可以是2，3，32，1002，或者其他任何东西。所以我们把它放在一个<code>Box</code>中。在这里我们还要加上<code>dyn</code>这个关键词。<code>dyn</code>这个词告诉你，你说的是一个trait，而不是一个结构体或其他任何东西。</p>
<p>所以你可以把函数改成这样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">fn</span> <span class="token function-definition function">returns_just_a_trait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">JustATrait</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_enum <span class="token operator">=</span> <span class="token class-name">EnumOfNumbers</span><span class="token punctuation">::</span><span class="token constant">I8</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>some_enum<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在它工作了，因为在堆栈上只是一个<code>Box</code>，我们知道<code>Box</code>的大小。</p>
<p>你会经常看到这种形式<code>Box&lt;dyn Error&gt;</code>，因为有时你可能会有多个可能的错误。</p>
<p>我们可以快速创建两个错误类型来显示这一点。要创建一个正式的错误类型，你必须为它实现<code>std::error::Error</code>。这部分很容易:只要写出 impl <code>std::error::Error &#123;&#125;</code>。但错误还需要<code>Debug</code>和<code>Display</code>，这样才能给出问题的信息。<code>Debug</code>只要加上<code>#[derive(Debug)]</code>就行，很容易，但<code>Display</code>需要<code>.fmt()</code>方法。我们之前做过一次。</p>
<p>代码是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ErrorOne</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Error</span> <span class="token keyword">for</span> <span class="token class-name">ErrorOne</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Now it is an error type with Debug. Time for Display:</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">ErrorOne</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"You got the first error!"</span><span class="token punctuation">)</span> <span class="token comment">// All it does is write this message</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token attribute attr-name">#[derive(Debug)]</span> <span class="token comment">// Do the same thing with ErrorTwo</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ErrorTwo</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Error</span> <span class="token keyword">for</span> <span class="token class-name">ErrorTwo</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">ErrorTwo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"You got the second error!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Make a function that just returns a String or an error</span>
<span class="token keyword">fn</span> <span class="token function-definition function">returns_errors</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Error</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token comment">// With Box&lt;dyn Error> you can return anything that has the Error trait</span>

    <span class="token keyword">match</span> input <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">ErrorOne</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Don't forget to put it in a box</span>
        <span class="token number">1</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">ErrorTwo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token string">"Looks fine to me"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// This is the success type</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> vec_of_u8s <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0_u8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Three numbers to try out</span>

    <span class="token keyword">for</span> number <span class="token keyword">in</span> vec_of_u8s <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> <span class="token function">returns_errors</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You got the first error!
You got the second error!
Looks fine to me<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果我们没有<code>Box&lt;dyn Error&gt;</code>，写了这个，我们就有问题了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">returns_errors</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">match</span> input <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ErrorOne</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">1</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ErrorTwo</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token string">"Looks fine to me"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它会告诉你。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">21  | fn returns_errors(input: u8) -&gt; Result&lt;String, Error&gt; &#123;
    |                                 ^^^^^^^^^^^^^^^^^^^^^ doesn&#39;t have a size known at compile-time<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这并不奇怪，因为我们知道，一个trait可以作用于很多东西，而且它们各自有不同的大小。</p>
<h2 id="默认值和构建者模式"><a href="#默认值和构建者模式" class="headerlink" title="默认值和构建者模式"></a>默认值和构建者模式</h2><p>你可以实现 <code>Default</code> trait，给你认为最常见的 <code>struct</code> 或 <code>enum</code> 赋值。构建器模式可以很好地与之配合，让用户在需要时轻松地进行修改。首先我们来看看<code>Default</code>。实际上，Rust中的大多数通用类型已经有<code>Default</code>。它们并不奇怪。0, “”(空字符串), <code>false</code>, 等等。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> default_i8<span class="token punctuation">:</span> <span class="token keyword">i8</span> <span class="token operator">=</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> default_str<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> default_bool<span class="token punctuation">:</span> <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"'&#123;&#125;', '&#123;&#125;', '&#123;&#125;'"</span><span class="token punctuation">,</span> default_i8<span class="token punctuation">,</span> default_str<span class="token punctuation">,</span> default_bool<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印<code>&#39;0&#39;, &#39;&#39;, &#39;false&#39;</code>。</p>
<p>所以<code>Default</code>就像<code>new</code>函数一样，除了你不需要输入任何东西。首先我们要创建一个<code>struct</code>，它还没有实现<code>Default</code>。它有一个<code>new</code>函数，我们用它来创建一个名为Billy的角色，并提供一些统计信息。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">LifeState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Alive</span><span class="token punctuation">,</span>
    <span class="token class-name">Dead</span><span class="token punctuation">,</span>
    <span class="token class-name">NeverAlive</span><span class="token punctuation">,</span>
    <span class="token class-name">Uncertain</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> alive<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">,</span>
            age<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            weight<span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token keyword">if</span> alive <span class="token punctuation">&#123;</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Dead</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> character_1 <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但也许在我们的世界里，我们希望大部分角色都叫比利，年龄15岁，身高170，体重70，还活着。我们可以实现<code>Default</code>，这样我们就可以直接写<code>Character::default()</code>。它看起来是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">LifeState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Alive</span><span class="token punctuation">,</span>
    <span class="token class-name">Dead</span><span class="token punctuation">,</span>
    <span class="token class-name">NeverAlive</span><span class="token punctuation">,</span>
    <span class="token class-name">Uncertain</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> alive<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">,</span>
            age<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            weight<span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token keyword">if</span> alive <span class="token punctuation">&#123;</span>
                <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Dead</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Default</span> <span class="token keyword">for</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
            weight<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> character_1 <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"The character &#123;:?&#125; is &#123;:?&#125; years old."</span><span class="token punctuation">,</span>
        character_1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> character_1<span class="token punctuation">.</span>age
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打印出<code>The character &quot;Billy&quot; is 15 years old.</code>，简单多了!</p>
<p>现在我们来看建造者模式。我们会有很多Billy，所以我们会保留默认的。但是很多其他角色只会有一点不同。构建器模式让我们可以链接非常小的方法，每次改变一个值。这里是一个<code>Character</code>的方法:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">height</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 🚧</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>一定要注意，它取的是<code>mut self</code>。我们之前看到过一次，它不是一个可变引用(<code>&amp;mut self</code>)。它占用了<code>Self</code>的所有权，有了<code>mut</code>，它将是可变的，即使它之前不是可变的。这是因为<code>.height()</code>拥有完全的所有权，别人不能碰它，所以它是安全的，可变。它只是改变<code>self.height</code>，然后返回<code>Self</code>(就是<code>Character</code>)。</p>
<p>所以我们有三个这样的构建方法。它们几乎是一样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">height</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 🚧</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">weight</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> weight<span class="token punctuation">;</span>
    <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">name</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每一个都会改变一个变量，并回馈给<code>Self</code>:这就是你在构建器模式中看到的。所以现在我们类似这样写来创建一个角色:<code>let character_1 = Character::default().height(180).weight(60).name(&quot;Bobby&quot;);</code>。如果你正在构建一个库给别人使用，这可以让他们很容易。对最终用户来说很容易，因为它几乎看起来像自然的英语。”给我一个默认角色，身高为180，体重为60，名字为Bobby.” 到目前为止，我们的代码看起来是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">LifeState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Alive</span><span class="token punctuation">,</span>
    <span class="token class-name">Dead</span><span class="token punctuation">,</span>
    <span class="token class-name">NeverAlive</span><span class="token punctuation">,</span>
    <span class="token class-name">Uncertain</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> alive<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">,</span>
            age<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            weight<span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token keyword">if</span> alive <span class="token punctuation">&#123;</span>
                <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Dead</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">height</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">weight</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> weight<span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">name</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Default</span> <span class="token keyword">for</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
            weight<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> character_1 <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">weight</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Bobby"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> character_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后一个要添加的方法通常叫<code>.build()</code>。这个方法是一种最终检查。当你给用户提供一个像<code>.height()</code>这样的方法时，你可以确保他们只输入一个<code>u32()</code>，但是如果他们输入5000的身高怎么办？这在你正在做的游戏中可能就不对了。我们最后将使用一个名为<code>.build()</code>的方法，返回一个<code>Result</code>。在它里面我们将检查用户输入是否正常，如果正常，我们将返回一个 <code>Ok(Self)</code>。</p>
<p>不过首先我们要改变<code>.new()</code>方法。我们不希望用户再自由创建任何一种角色。所以我们将把<code>impl Default</code>的值移到<code>.new()</code>。而现在<code>.new()</code>不接受任何输入。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 🚧</span>
    <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
        weight<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
        lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这意味着我们不再需要<code>impl Default</code>了，因为<code>.new()</code>有所有的默认值。所以我们可以删除<code>impl Default</code>。</p>
<p>现在我们的代码是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">LifeState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Alive</span><span class="token punctuation">,</span>
    <span class="token class-name">Dead</span><span class="token punctuation">,</span>
    <span class="token class-name">NeverAlive</span><span class="token punctuation">,</span>
    <span class="token class-name">Uncertain</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
            weight<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">height</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">weight</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> weight<span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">name</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> character_1 <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">weight</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Bobby"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> character_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出来的结果是一样的:<code>Character &#123; name: &quot;Bobby&quot;, age: 15, height: 180, weight: 60, lifestate: Alive &#125;</code>。</p>
<p>我们几乎已经准备好写<code>.build()</code>方法了，但是有一个问题:如何让用户使用它？现在用户可以写<code>let x = Character::new().height(76767);</code>，然后得到一个<code>Character</code>。有很多方法可以做到这一点，也许你能想出自己的方法。但是我们会在<code>Character</code>中增加一个<code>can_use: bool</code>的值。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>       <span class="token comment">// 🚧</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">,</span>
    can_use<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span> <span class="token comment">// Set whether the user can use the character</span>
<span class="token punctuation">&#125;</span>

\\ <span class="token class-name">Cut</span> other code

    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
            weight<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span><span class="token punctuation">,</span>
            can_use<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// .new() always gives a good character, so it's true</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而对于其他的方法，比如<code>.height()</code>，我们会将<code>can_use</code>设置为<code>false</code>。只有<code>.build()</code>会再次设置为<code>true</code>，所以现在用户要用<code>.build()</code>做最后的检查。我们要确保<code>height</code>不高于200，<code>weight</code>不高于300。另外，在我们的游戏中，有一个不好的字叫<code>smurf</code>，我们不希望任何角色使用它。</p>
<p>我们的<code>.build()</code>方法是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 🚧</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&lt;</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>weight <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"smurf"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>can_use <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"Could not create character. Characters must have:
1) Height below 200
2) Weight below 300
3) A name that is not Smurf (that is a bad word)"</span>
            <span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>!self.name.to_lowercase().contains(&quot;smurf&quot;)</code> 确保用户不会写出类似 “SMURF”或 “IamSmurf”的字样。它让整个 <code>String</code> 都变成小写(小字母)，并检查 <code>.contains()</code> 而不是 <code>==</code>。而前面的<code>!</code>表示 “不是”。</p>
<p>如果一切正常，我们就把<code>can_use</code>设置为<code>true</code>，然后把<code>Ok</code>里面的字符给用户。</p>
<p>现在我们的代码已经完成了，我们将创建三个不工作的角色，和一个工作的角色。最后的代码是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">,</span>
    can_use<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span> <span class="token comment">// Here is the new value</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">LifeState</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Alive</span><span class="token punctuation">,</span>
    <span class="token class-name">Dead</span><span class="token punctuation">,</span>
    <span class="token class-name">NeverAlive</span><span class="token punctuation">,</span>
    <span class="token class-name">Uncertain</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">170</span><span class="token punctuation">,</span>
            weight<span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
            lifestate<span class="token punctuation">:</span> <span class="token class-name">LifeState</span><span class="token punctuation">::</span><span class="token class-name">Alive</span><span class="token punctuation">,</span>
            can_use<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// .new() makes a fine character, so it is true</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">height</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>can_use <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Now the user can't use the character</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">weight</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> weight<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> weight<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>can_use <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">name</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>can_use <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&lt;</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>weight <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"smurf"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>can_use <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   <span class="token comment">// Everything is okay, so set to true</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>               <span class="token comment">// and return the character</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"Could not create character. Characters must have:
1) Height below 200
2) Weight below 300
3) A name that is not Smurf (that is a bad word)"</span>
                <span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> character_with_smurf <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Lol I am Smurf!!"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This one contains "smurf" - not okay</span>
    <span class="token keyword">let</span> character_too_tall <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Too tall - not okay</span>
    <span class="token keyword">let</span> character_too_heavy <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">weight</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Too heavy - not okay</span>
    <span class="token keyword">let</span> okay_character <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Billybrobby"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">weight</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// This character is okay. Name is fine, height and weight are fine</span>

    <span class="token comment">// Now they are not Character, they are Result&lt;Character, String>. So let's put them in a Vec so we can see them:</span>
    <span class="token keyword">let</span> character_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>character_with_smurf<span class="token punctuation">,</span> character_too_tall<span class="token punctuation">,</span> character_too_heavy<span class="token punctuation">,</span> okay_character<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> character <span class="token keyword">in</span> character_vec <span class="token punctuation">&#123;</span> <span class="token comment">// Now we will print the character if it's Ok, and print the error if it's Err</span>
        <span class="token keyword">match</span> character <span class="token punctuation">&#123;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>character_info<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> character_info<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>err_info<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> err_info<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Then add one more line</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Could not create character. Characters must have:
1) Height below 200
2) Weight below 300
3) A name that is not Smurf (that is a bad word)

Could not create character. Characters must have:
1) Height below 200
2) Weight below 300
3) A name that is not Smurf (that is a bad word)

Could not create character. Characters must have:
1) Height below 200
2) Weight below 300
3) A name that is not Smurf (that is a bad word)

Character &#123; name: &quot;Billybrobby&quot;, age: 15, height: 180, weight: 100, lifestate: Alive, can_use: true &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="Deref和DerefMut"><a href="#Deref和DerefMut" class="headerlink" title="Deref和DerefMut"></a>Deref和DerefMut</h2><p><code>Deref</code>是让你用<code>*</code>来解引用某些东西的trait。我们知道，一个引用和一个值是不一样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// This is an i32</span>
    <span class="token keyword">let</span> reference <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// This is a &amp;i32</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> value <span class="token operator">==</span> reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而Rust连<code>false</code>都不给，因为它甚至不会比较两者。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: can&#39;t compare &#96;&#123;integer&#125;&#96; with &#96;&amp;&#123;integer&#125;&#96;
 --&gt; src\main.rs:4:26
  |
4 |     println!(&quot;&#123;&#125;&quot;, value &#x3D;&#x3D; reference);
  |                          ^^ no implementation for &#96;&#123;integer&#125; &#x3D;&#x3D; &amp;&#123;integer&#125;&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，这里的解法是使用<code>*</code>。所以这将打印出<code>true</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> reference <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> value <span class="token operator">==</span> <span class="token operator">*</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>现在让我们想象一下一个简单的类型，它只是容纳一个数字。它就像一个<code>Box</code>，我们有一些想法为它提供一些额外的功能。但如果我们只是给它一个数字，<br> 它就不能做那么多了。</p>
<p>我们不能像使用<code>Box</code>那样使用<code>*</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token operator">*</span>my_number <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>错误信息是:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0614]: type &#96;HoldsANumber&#96; cannot be dereferenced
  --&gt; src\main.rs:24:22
   |
24 |     println!(&quot;&#123;:?&#125;&quot;, *my_number + 20);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们当然可以做到这一点。<code>println!(&quot;&#123;:?&#125;&quot;, my_number.0 + 20);</code>. 但是这样的话，我们就是在20的基础上再单独加一个<code>u8</code>。如果我们能把它们加在一起就更好了。<code>cannot be dereferenced</code>这个消息给了我们一个线索:我们需要实现<code>Deref</code>。实现<code>Deref</code>的简单东西有时被称为 “智能指针”。一个智能指针可以指向它的元素，有它的信息，并且可以使用它的方法。因为现在我们可以添加<code>my_number.0</code>，这是一个<code>u8</code>，但我们不能用<code>HoldsANumber</code>做其他的事情:到目前为止，它只有<code>Debug</code>。</p>
<p>有趣的是:<code>String</code>其实是<code>&amp;str</code>的智能指针，<code>Vec</code>是数组(或其他类型)的智能指针。所以我们其实从一开始就在使用智能指针。</p>
<p>实现<code>Deref</code>并不难，标准库中的例子也很简单。<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/ops/trait.Deref.html">下面是标准库中的示例代码</a>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">DerefExample</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    value<span class="token punctuation">:</span> <span class="token class-name">T</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">DerefExample</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>value
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token class-name">DerefExample</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">:</span> <span class="token char string">'a'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">,</span> <span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>所以我们按照这个来，现在我们的<code>Deref</code>是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token comment">// Remember, this is the "associated type": the type that goes together.</span>
                      <span class="token comment">// You have to use the right type Target = (the type you want to return)</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Rust calls .deref() when you use *. We just defined Target as a u8 so this is easy to understand</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>   <span class="token comment">// We chose &amp;self.0 because it's a tuple struct. In a named struct it would be something like "&amp;self.number"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在我们可以用<code>*</code>来做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token operator">*</span>my_number <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，这样就可以打印出<code>40</code>，我们不需要写<code>my_number.0</code>。这意味着我们得到了 <code>u8</code> 的方法，我们可以为 <code>HoldsANumber</code> 写出我们自己的方法。我们将添加自己的简单方法，并使用我们从<code>u8</code>中得到的另一个方法，称为<code>.checked_sub()</code>。<code>.checked_sub()</code>方法是一个安全的减法，它能返回一个<code>Option</code>。如果它能做减法，那么它就会在<code>Some</code>里面给你，如果它不能做减法，那么它就会给出一个<code>None</code>。记住，<code>u8</code>不能是负数，所以还是<code>.checked_sub()</code>比较安全，这样就不会崩溃了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">prints_the_number_times_two</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">.</span><span class="token function">checked_sub</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This method comes from u8</span>
    my_number<span class="token punctuation">.</span><span class="token function">prints_the_number_times_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is our own method</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">None
40<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们也可以实现<code>DerefMut</code>，这样我们就可以通过<code>*</code>来改变数值。它看起来几乎是一样的。在实现<code>DerefMut</code>之前，你需要先实现<code>Deref</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Deref</span><span class="token punctuation">,</span> <span class="token class-name">DerefMut</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">prints_the_number_times_two</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">u8</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">DerefMut</span> <span class="token keyword">for</span> <span class="token class-name">HoldsANumber</span> <span class="token punctuation">&#123;</span> <span class="token comment">// You don't need type Target = u8; here because it already knows thanks to Deref</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Everything else is the same except it says mut everywhere</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_number <span class="token operator">=</span> <span class="token class-name">HoldsANumber</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>my_number <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token comment">// DerefMut lets us do this</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_number<span class="token punctuation">.</span><span class="token function">checked_sub</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_number<span class="token punctuation">.</span><span class="token function">prints_the_number_times_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以你可以看到，<code>Deref</code>给你的类型提供了强大的力量。</p>
<p>这也是为什么标准库说:<code>Deref should only be implemented for smart pointers to avoid confusion</code>。这是因为对于一个复杂的类型，你可以用 <code>Deref</code> 做一些奇怪的事情。让我们想象一个非常混乱的例子来理解它们的含义。我们将从一个游戏的 <code>Character</code> 结构开始。一个新的<code>Character</code>需要一些数据，比如智力和力量。所以这里是我们的第一个角色。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    strength<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    dexterity<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    health<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    intelligence<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    wisdom<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    charm<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>
        name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        strength<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        dexterity<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        health<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        intelligence<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        wisdom<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        charm<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        hit_points<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
        alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">,</span>
            strength<span class="token punctuation">,</span>
            dexterity<span class="token punctuation">,</span>
            health<span class="token punctuation">,</span>
            intelligence<span class="token punctuation">,</span>
            wisdom<span class="token punctuation">,</span>
            charm<span class="token punctuation">,</span>
            hit_points<span class="token punctuation">,</span>
            alignment<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">Alignment</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Good</span><span class="token punctuation">,</span>
    <span class="token class-name">Neutral</span><span class="token punctuation">,</span>
    <span class="token class-name">Evil</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> billy <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">Alignment</span><span class="token punctuation">::</span><span class="token class-name">Good</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在让我们想象一下，我们要把人物的hit points放在一个大的vec里。也许我们会把怪物数据也放进去，把它放在一起。由于 <code>hit_points</code> 是一个 <code>i8</code>，我们实现了 <code>Deref</code>，所以我们可以对它进行各种计算。但是看看现在我们的<code>main()</code>函数中，它看起来多么奇怪。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>

<span class="token comment">// All the other code is the same until after the enum Alignment</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    strength<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    dexterity<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    health<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    intelligence<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    wisdom<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    charm<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    hit_points<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
    alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>
        name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        strength<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        dexterity<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        health<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        intelligence<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        wisdom<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        charm<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
        hit_points<span class="token punctuation">:</span> <span class="token keyword">i8</span><span class="token punctuation">,</span>
        alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">,</span>
            strength<span class="token punctuation">,</span>
            dexterity<span class="token punctuation">,</span>
            health<span class="token punctuation">,</span>
            intelligence<span class="token punctuation">,</span>
            wisdom<span class="token punctuation">,</span>
            charm<span class="token punctuation">,</span>
            hit_points<span class="token punctuation">,</span>
            alignment<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">Alignment</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Good</span><span class="token punctuation">,</span>
    <span class="token class-name">Neutral</span><span class="token punctuation">,</span>
    <span class="token class-name">Evil</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span> <span class="token comment">// impl Deref for Character. Now we can do any integer math we want!</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">i8</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>hit_points
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> billy <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">Alignment</span><span class="token punctuation">::</span><span class="token class-name">Good</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create two characters, billy and brandy</span>
    <span class="token keyword">let</span> brandy <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Brandy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">Alignment</span><span class="token punctuation">::</span><span class="token class-name">Good</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> hit_points_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Put our hit points data in here</span>
    hit_points_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">*</span>billy<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Push *billy?</span>
    hit_points_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">*</span>brandy<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Push *brandy?</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> hit_points_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这只打印了<code>[5, 5]</code>。我们的代码现在让人读起来感觉非常奇怪。我们可以在<code>main()</code>上面看到<code>Deref</code>，然后弄清楚<code>*billy</code>的意思是<code>i8</code>，但是如果有很多代码呢？可能我们的代码有2000行，突然要弄清楚为什么要<code>.push()</code> <code>*billy</code>。<code>Character</code>当然不仅仅是<code>i8</code>的智能指针。</p>
<p>当然，写<code>hit_points_vec.push(*billy)</code>并不违法，但这让代码看起来非常奇怪。也许一个简单的<code>.get_hp()</code>方法会好得多，或者另一个存放角色的结构体。然后你可以迭代并推送每个角色的 <code>hit_points</code>。<code>Deref</code>提供了很多功能，但最好确保代码的逻辑性。</p>
<h2 id="Crate和模块"><a href="#Crate和模块" class="headerlink" title="Crate和模块"></a>Crate和模块</h2><p>每次你在 Rust 中写代码时，你都是在 <code>crate</code> 中写的。<code>crate</code>是一个或多个文件，一起为你的代码服务。在你写的文件里面，你也可以创建一个<code>mod</code>。<code>mod</code>是存放函数、结构等的空间。因为这些原因被使用:</p>
<ul>
<li>构建你的代码:它可以帮助你思考代码的总体结构。当你的代码越来越大时，这一点可能很重要。</li>
<li>阅读你的代码:人们可以更容易理解你的代码。例如，<code>std::collections::HashMap</code>这个名字告诉你，它在<code>std</code>的模块<code>collections</code>里面。这给了你一个提示，也许<code>collections</code>里面还有更多的集合类型，你可以尝试一下。</li>
<li>私密性:所有的东西一开始都是私有的。这样可以让你不让用户直接使用函数。</li>
</ul>
<p>要创建一个<code>mod</code>，只需要写<code>mod</code>，然后用<code>&#123;&#125;</code>开始一个代码块。我们将创建一个名为<code>print_things</code>的mod，它有一些打印相关的功能。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">print_things</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">prints_one_thing</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Print anything that implements Display</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，我们把<code>use std::fmt::Display;</code>写在<code>print_things</code>里面，因为它是一个独立的空间。如果你把<code>use std::fmt::Display;</code>写在<code>main()</code>里面也没用。而且，我们现在也不能从<code>main()</code>里面调用。如果在<code>fn</code>前面没有<code>pub</code>这个关键字，它就会保持私密性。让我们试着在没有<code>pub</code>的情况下调用它。这里有一种写法。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>print_things<span class="token punctuation">::</span></span><span class="token function">prints_one_thing</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p><code>crate</code>的意思是 “在这个项目里”，但对于我们简单的例子来说，它和 “在这个文件里面”是一样的。接着是<code>print_things</code>这个mod，最后是<code>prints_one_thing()</code>函数。你可以每次都写这个，也可以写<code>use</code>来导入。现在我们可以看到说它是私有的错误:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">print_things</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">prints_one_thing</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>print_things<span class="token punctuation">::</span></span>prints_one_thing<span class="token punctuation">;</span>

    <span class="token function">prints_one_thing</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_one_thing</span><span class="token punctuation">(</span><span class="token string">"Trying to print a string..."</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是错误的。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0603]: function &#96;prints_one_thing&#96; is private
  --&gt; src\main.rs:10:30
   |
10 |     use crate::print_things::prints_one_thing;
   |                              ^^^^^^^^^^^^^^^^ private function
   |
note: the function &#96;prints_one_thing&#96; is defined here
  --&gt; src\main.rs:4:5
   |
4  |     fn prints_one_thing&lt;T: Display&gt;(input: T) &#123;
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很容易理解，函数<code>print_one_thing</code>是私有的。它还用<code>src\main.rs:4:5</code>告诉我们在哪里可以找到这个函数。这很有帮助，因为你不仅可以在一个文件中写<code>mod</code>，还可以在很多文件中写<code>mod</code>。</p>
<p>现在我们只需要写<code>pub fn</code>而不是<code>fn</code>，一切就都可以了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">print_things</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">prints_one_thing</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>print_things<span class="token punctuation">::</span></span>prints_one_thing<span class="token punctuation">;</span>

    <span class="token function">prints_one_thing</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">prints_one_thing</span><span class="token punctuation">(</span><span class="token string">"Trying to print a string..."</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">6
Trying to print a string...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>pub</code>对结构体、枚举、trait或模块有什么作用？<code>pub</code>对它们来说是这样的:</p>
<ul>
<li><code>pub</code>对于一个结构: 它使结构公开，但成员不是公开的。要想让一个成员公开，你也要为每个成员写<code>pub</code>。</li>
<li><code>pub</code> 对于一个枚举或trait:所有的东西都变成了公共的。这是有意义的，因为traits是关于给某项赋予相同的行为。而枚举是关于元素之间的选择，你需要看到所有的元素才能选择它们。</li>
<li><code>pub</code>对于一个模块来说:一个顶层的模块会是<code>pub</code>，因为如果它不是pub，那么根本没有人可以碰里面的任何东西。但是模块里面的模块需要使用<code>pub</code>才能成为公共的。</li>
</ul>
<p>我们在<code>print_things</code>里面放一个名为<code>Billy</code>的结构体。这个结构体几乎都会是public的，但也不尽然。这个结构是公共的，所以它会说<code>pub struct Billy</code>。里面会有一个 <code>name</code> 和 <code>times_to_print</code>。<code>name</code>不会是公共的，因为我们只想让用户创建名为<code>&quot;Billy&quot;.to_string()</code>的结构。但是用户可以选择打印的次数，所以这将是公开的。它的是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">print_things</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Display</span><span class="token punctuation">,</span> <span class="token class-name">Debug</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[derive(Debug)]</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Billy</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Billy is public</span>
        name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// but name is private.</span>
        <span class="token keyword">pub</span> times_to_print<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">impl</span> <span class="token class-name">Billy</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>times_to_print<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span> <span class="token comment">// That means the user needs to use new to create a Billy. The user can only change the number of times_to_print</span>
            <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
                name<span class="token punctuation">:</span> <span class="token string">"Billy"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// We choose the name - the user can't</span>
                times_to_print<span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">print_billy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// This function prints a Billy</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>times_to_print <span class="token punctuation">&#123;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">prints_one_thing</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>print_things<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span> <span class="token comment">// Now we use *. This imports everything from print_things</span>

    <span class="token keyword">let</span> my_billy <span class="token operator">=</span> <span class="token class-name">Billy</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_billy<span class="token punctuation">.</span><span class="token function">print_billy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&quot;Billy&quot;
&quot;Billy&quot;
&quot;Billy&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>对了，导入一切的<code>*</code>叫做 “glob运算符”。Glob的意思是 “全局”，所以它意味着一切。</p>
<p>在<code>mod</code>里面你可以创建其他mod。一个子 mod(mod里的mod)总是可以使用父 mod 内部的任何东西。你可以在下一个例子中看到这一点，我们在 <code>mod province</code> 里面有一个 <code>mod city</code>，而<code>mod province</code>在 <code>mod country</code> 里面。</p>
<p>你可以这样想:即使你在一个国家，你可能不在一个省。而即使你在一个省，你也可能不在一个市。但如果你在一个城市，你就在这个城市的省份和它的国家。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">country</span> <span class="token punctuation">&#123;</span> <span class="token comment">// The main mod doesn't need pub</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Note: this function isn't public</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"We are in the country of &#123;&#125;"</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">province</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Make this mod public</span>

        <span class="token keyword">fn</span> <span class="token function-definition function">print_province</span><span class="token punctuation">(</span>province<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Note: this function isn't public</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"in the province of &#123;&#125;"</span><span class="token punctuation">,</span> province<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">city</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Make this mod public</span>
            <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">print_city</span><span class="token punctuation">(</span>country<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> province<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> city<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// This function is public though</span>
                <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>country<span class="token punctuation">::</span></span><span class="token function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>country<span class="token punctuation">::</span>province<span class="token punctuation">::</span></span><span class="token function">print_province</span><span class="token punctuation">(</span>province<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"in the city of &#123;&#125;"</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>country<span class="token punctuation">::</span>province<span class="token punctuation">::</span>city<span class="token punctuation">::</span></span><span class="token function">print_city</span><span class="token punctuation">(</span><span class="token string">"Canada"</span><span class="token punctuation">,</span> <span class="token string">"New Brunswick"</span><span class="token punctuation">,</span> <span class="token string">"Moncton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有趣的是，<code>print_city</code>可以访问<code>print_province</code>和<code>print_country</code>。这是因为<code>mod city</code>在其他mod里面。它不需要<code>pub</code>在<code>print_province</code>前面才能使用。这也是有道理的:一个城市不需要做什么，它本来就在一个省里，在一个国家里。</p>
<p>你可能注意到，<code>crate::country::province::print_province(province);</code>非常长。当我们在一个模块里面的时候，我们可以用<code>super</code>从上面引入元素。其实super这个词本身就是”上面”的意思，比如 “上级”。在我们的例子中，我们只用了一次函数，但是如果你用的比较多的话，那么最好是导入。如果它能让你的代码更容易阅读，那也是个好主意，即使你只用了一次函数。现在的代码几乎是一样的，但更容易阅读一些。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">country</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"We are in the country of &#123;&#125;"</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">province</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">print_province</span><span class="token punctuation">(</span>province<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"in the province of &#123;&#125;"</span><span class="token punctuation">,</span> province<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">city</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>super<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span> <span class="token comment">// use everything in "above above": that means mod country</span>
            <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>        <span class="token comment">// use everything in "above": that means mod province</span>

            <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">print_city</span><span class="token punctuation">(</span>country<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> province<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> city<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">print_country</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">print_province</span><span class="token punctuation">(</span>province<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"in the city of &#123;&#125;"</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>country<span class="token punctuation">::</span>province<span class="token punctuation">::</span>city<span class="token punctuation">::</span></span>print_city<span class="token punctuation">;</span> <span class="token comment">// bring in the function</span>

    <span class="token function">print_city</span><span class="token punctuation">(</span><span class="token string">"Canada"</span><span class="token punctuation">,</span> <span class="token string">"New Brunswick"</span><span class="token punctuation">,</span> <span class="token string">"Moncton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_city</span><span class="token punctuation">(</span><span class="token string">"Korea"</span><span class="token punctuation">,</span> <span class="token string">"Gyeonggi-do"</span><span class="token punctuation">,</span> <span class="token string">"Gwangju"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it's less work to use it again</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>测试是一门很好的学科，现在我们了解了模块。在Rust中测试你的代码是非常容易的，因为你可以在你的代码旁边写测试。</p>
<p>开始测试的最简单的方法是在一个函数上面添加<code>#[test]</code>。下面是一个简单的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">two_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>但如果你试图在playground中运行它，它给出了一个错误。<code>error[E0601]: `main` function not found in crate `playground</code>. 这是因为你不使用 _Run_ 来进行测试，你使用 _Test_ 。另外，你不使用 <code>main()</code> 函数进行测试 - 它们在外面运行。要在Playground中运行这个，点击 _RUN_ 旁边的<code>···</code>，然后把它改为 _Test_ 。现在如果你点击它，它将运行测试。(如果你已经安装了 Rust，你将输入 <code>cargo test</code> 来做这个测试)</p>
<p>这里是输出:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test
test two_is_two ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>让我们把<code>assert_eq!(2, 2)</code>改成<code>assert_eq!(2, 3)</code>，看看会有什么结果。当测试失败时，你会得到更多的信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test
test two_is_two ... FAILED

failures:

---- two_is_two stdout ----
thread &#39;two_is_two&#39; panicked at &#39;assertion failed: &#96;(left &#x3D;&#x3D; right)&#96;
  left: &#96;2&#96;,
 right: &#96;3&#96;&#39;, src&#x2F;lib.rs:3:5
note: run with &#96;RUST_BACKTRACE&#x3D;1&#96; environment variable to display a backtrace


failures:
    two_is_two

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>assert_eq!(left, right)</code>是Rust中测试一个函数的主要方法。如果它不工作，它将显示不同的值:左边有2，但右边有3。</p>
<p><code>RUST_BACKTRACE=1</code>是什么意思？这是计算机上的一个设置，可以提供更多关于错误的信息。幸好playground也有:点击<code>STABLE</code>旁边的<code>···</code>，然后设置回溯为<code>ENABLED</code>。如果你这样做，它会给你<em>很多</em>的信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test
test two_is_two ... FAILED

failures:

---- two_is_two stdout ----
thread &#39;two_is_two&#39; panicked at &#39;assertion failed: 2 &#x3D;&#x3D; 3&#39;, src&#x2F;lib.rs:3:5
stack backtrace:
   0: backtrace::backtrace::libunwind::trace
             at &#x2F;cargo&#x2F;registry&#x2F;src&#x2F;github.com-1ecc6299db9ec823&#x2F;backtrace-0.3.46&#x2F;src&#x2F;backtrace&#x2F;libunwind.rs:86
   1: backtrace::backtrace::trace_unsynchronized
             at &#x2F;cargo&#x2F;registry&#x2F;src&#x2F;github.com-1ecc6299db9ec823&#x2F;backtrace-0.3.46&#x2F;src&#x2F;backtrace&#x2F;mod.rs:66
   2: std::sys_common::backtrace::_print_fmt
             at src&#x2F;libstd&#x2F;sys_common&#x2F;backtrace.rs:78
   3: &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt
             at src&#x2F;libstd&#x2F;sys_common&#x2F;backtrace.rs:59
   4: core::fmt::write
             at src&#x2F;libcore&#x2F;fmt&#x2F;mod.rs:1076
   5: std::io::Write::write_fmt
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libstd&#x2F;io&#x2F;mod.rs:1537
   6: std::io::impls::&lt;impl std::io::Write for alloc::boxed::Box&lt;W&gt;&gt;::write_fmt
             at src&#x2F;libstd&#x2F;io&#x2F;impls.rs:176
   7: std::sys_common::backtrace::_print
             at src&#x2F;libstd&#x2F;sys_common&#x2F;backtrace.rs:62
   8: std::sys_common::backtrace::print
             at src&#x2F;libstd&#x2F;sys_common&#x2F;backtrace.rs:49
   9: std::panicking::default_hook::&#123;&#123;closure&#125;&#125;
             at src&#x2F;libstd&#x2F;panicking.rs:198
  10: std::panicking::default_hook
             at src&#x2F;libstd&#x2F;panicking.rs:215
  11: std::panicking::rust_panic_with_hook
             at src&#x2F;libstd&#x2F;panicking.rs:486
  12: std::panicking::begin_panic
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libstd&#x2F;panicking.rs:410
  13: playground::two_is_two
             at src&#x2F;lib.rs:3
  14: playground::two_is_two::&#123;&#123;closure&#125;&#125;
             at src&#x2F;lib.rs:2
  15: core::ops::function::FnOnce::call_once
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libcore&#x2F;ops&#x2F;function.rs:232
  16: &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::FnOnce&lt;A&gt;&gt;::call_once
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;liballoc&#x2F;boxed.rs:1076
  17: &lt;std::panic::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libstd&#x2F;panic.rs:318
  18: std::panicking::try::do_call
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libstd&#x2F;panicking.rs:297
  19: std::panicking::try
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libstd&#x2F;panicking.rs:274
  20: std::panic::catch_unwind
             at &#x2F;rustc&#x2F;c367798cfd3817ca6ae908ce675d1d99242af148&#x2F;src&#x2F;libstd&#x2F;panic.rs:394
  21: test::run_test_in_process
             at src&#x2F;libtest&#x2F;lib.rs:541
  22: test::run_test::run_test_inner::&#123;&#123;closure&#125;&#125;
             at src&#x2F;libtest&#x2F;lib.rs:450
note: Some details are omitted, run with &#96;RUST_BACKTRACE&#x3D;full&#96; for a verbose backtrace.


failures:
    two_is_two

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>除非你真的找不到问题所在，否则你不需要使用回溯。但幸运的是你也不需要全部理解。 如果你继续阅读，你最终会看到第13行，那里写着<code>playground</code>–那是它谈论你的代码的地方。其他的都是关于Rust为了运行你的程序,在其他库中所做的事情。但是这两行告诉你，它看的是playground的第2行和第3行，这是一个提示，要检查那里。这里是那个部分:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">13: playground::two_is_two
           at src&#x2F;lib.rs:3
14: playground::two_is_two::&#123;&#123;closure&#125;&#125;
           at src&#x2F;lib.rs:2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我们再把backtrace关闭，回到常规测试。现在我们要写一些其他函数，并使用测试函数来测试它们。这里有几个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i8</span> <span class="token punctuation">&#123;</span>
    <span class="token number">2</span>
<span class="token punctuation">&#125;</span>
# <span class="token punctuation">[</span>test<span class="token punctuation">]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">it_returns_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">return_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">return_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i8</span> <span class="token punctuation">&#123;</span>
    <span class="token number">4</span> <span class="token operator">+</span> <span class="token function">return_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
# <span class="token punctuation">[</span>test<span class="token punctuation">]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">it_returns_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">return_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在，都能运行:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 2 tests
test it_returns_two ... ok
test it_returns_six ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这不是太难。</p>
<p>通常你会想把你的测试放在自己的模块中。要做到这一点，请使用相同的 <code>mod</code> 关键字，并在其上方添加 <code>#[cfg(test)]</code>(记住:<code>cfg</code> 的意思是 “配置”)。你还要在每个测试上面继续写<code>#[test]</code>。这是因为以后当你安装Rust时，你可以做更复杂的测试。你将可以运行一个测试，或者所有的测试，或者运行几个测试。另外别忘了写<code>use super::*;</code>，因为测试模块需要使用上面的函数。现在它看起来会是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">return_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i8</span> <span class="token punctuation">&#123;</span>
    <span class="token number">2</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">return_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i8</span> <span class="token punctuation">&#123;</span>
    <span class="token number">4</span> <span class="token operator">+</span> <span class="token function">return_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

# <span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_returns_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">return_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_returns_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">return_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="测试驱动的开发"><a href="#测试驱动的开发" class="headerlink" title="测试驱动的开发"></a>测试驱动的开发</h3><p>在阅读Rust或其他语言时，你可能会看到 “测试驱动开发”这个词。这是编写程序的一种方式，有些人喜欢它，而有些人则喜欢其他的方式。”测试驱动开发”的意思是 “先写测试，再写代码”。当你这样做的时候，你会有很多关于你想要你的代码做的所有事情测试代码。然后你开始写代码，并运行测试，看看你是否做对了。然后，当你添加和重写代码时，如果有什么地方出了问题，测试代码会一直在那里向你展示。这在Rust中是非常容易的，因为编译器给出了很多待修复内容的信息。让我们写一个测试驱动开发的小例子，看看它是什么样子的。</p>
<p>让我们想象一个接受用户输入的计算器。它可以加(+)，也可以减(-)。如果用户写 “5+6”，它应该返回11，如果用户写 “5+6-7”，它应该返回4，以此类推。所以我们先从测试函数开始。你也可以看到，测试中的函数名通常都相当长。这是因为你可能会运行很多测试，你想了解哪些测试失败了。</p>
<p>我们想象一下，一个名为<code>math()</code>的函数就可以完成所有的工作。它将返回一个 <code>i32</code>(我们不会使用浮点数)。因为它需要返回一些东西，所以我们每次都只返回 <code>6</code>。然后我们将写三个测试函数。当然，它们都会失败。现在的代码是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">math</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token number">6</span>
<span class="token punctuation">&#125;</span>

# <span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_plus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 + 1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_two_is_minus_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - 2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_minus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span>"<span class="token number">1</span> <span class="token operator">-</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它给了我们这个信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 3 tests
test tests::one_minus_minus_one_is_two ... FAILED
test tests::one_minus_two_is_minus_one ... FAILED
test tests::one_plus_one_is_two ... FAILED<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>以及<code>thread &#39;tests::one_plus_one_is_two&#39; panicked at &#39;assertion failed: `(left == right)` </code>的所有信息。我们不需要在这里全部打印出来。</p>
<p>现在要考虑如何创建计算器。我们将接受任何数字，以及符号<code>+-</code>。我们将允许空格，但不允许其他任何东西。所以，让我们从包含所有数值的<code>const</code>开始。然后我们将使用 <code>.chars()</code> 按字符进行迭代，并使用 <code>.all()</code> 确保它们都在里面。</p>
<p>然后，我们将添加一个会崩溃的测试。要做到这一点，添加 <code>#[should_panic]</code> 属性:现在如果它崩溃，测试将成功。</p>
<p>现在代码看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">"1234567890+- "</span><span class="token punctuation">;</span> <span class="token comment">// Don't forget the space at the end</span>

<span class="token keyword">fn</span> <span class="token function-definition function">math</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token boolean">false</span> <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>character<span class="token closure-punctuation punctuation">|</span></span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Please only input numbers, +-, or spaces"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token number">6</span> <span class="token comment">// we still return a 6 for now</span>
<span class="token punctuation">&#125;</span>

# <span class="token punctuation">[</span><span class="token function">cfg</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_plus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 + 1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_two_is_minus_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - 2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_minus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - -1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic]</span>  <span class="token comment">// Here is our new test - it should panic</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">panics_when_characters_not_right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"7 + seven"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在，当我们运行测试时，我们得到这样的结果。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 4 tests
test tests::one_minus_two_is_minus_one ... FAILED
test tests::one_minus_minus_one_is_two ... FAILED
test tests::panics_when_characters_not_right ... ok
test tests::one_plus_one_is_two ... FAILED<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一个成功了! 我们的<code>math()</code>函数现在只能接受好的输入了。</p>
<p>下一步是编写实际的计算器。这就是先有测试的有趣之处:实际的代码要晚很多。首先，我们将把计算器的逻辑放在一起。我们要做到以下几点。</p>
<ul>
<li>所有的空位都应该被删除。这在<code>.filter()</code>中很容易实现。</li>
<li>所有输入应该变成一个<code>Vec</code>。<code>+</code>不需要成为输入，但是当程序看到<code>+</code>时，应该知道这个数字已经完成了。例如，输入<code>+</code>应该这样做:<ol>
<li>看到<code>1</code>，把它推到一个空字符串中。</li>
<li>看到另一个1，把它推入字符串中(现在是 “11”)。</li>
<li>看到一个<code>+</code>，知道这个数字已经结束。它会把字符串推入vec中，然后清空字符串。</li>
</ol>
</li>
<li>程序必须计算出<code>-</code>的数量。奇数(1，3，5…)表示减法，偶数(2，4，6…)表示加法。所以 “1–9”应该是10，而不是-8。</li>
<li>程序应该删除最后一个数字后面的任何东西。<code>5+5+++++----</code>是由<code>OKAY_CHARACTERS</code>中的所有字符组成的，但它应该变成<code>5+5</code>。<code>.trim_end_matches()</code>就很简单了，你把<code>&amp;str</code>末尾符合的东西都去掉。</li>
</ul>
<p>顺便说一下，<code>.trim_end_matches()</code>和<code>.trim_start_matches()</code>曾经是<code>trim_right_matches()</code>和<code>trim_left_matches()</code>。但后来人们注意到有些语言是从右到左(波斯语、希伯来语等)，所以左右都是错的。你可能还能在一些代码中看到旧的名字，但它们是一样的)。)</p>
<p>首先我们只想通过所有的测试。通过测试后，我们就可以 “重构”了。重构的意思是让代码变得更好，通常是通过结构、枚举和方法等方式。下面是我们使测试通过的代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">const</span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">"1234567890+- "</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">math</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token boolean">false</span> <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>character<span class="token closure-punctuation punctuation">|</span></span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Please only input numbers, +-, or spaces"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> input <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">trim_end_matches</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"+-"</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Remove + and - at the end, and all spaces</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> result_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Results go in here</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> push_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is the string we push in every time. We will keep reusing it in the loop.</span>
    <span class="token keyword">for</span> character <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> character <span class="token punctuation">&#123;</span>
            <span class="token char string">'+'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>push_string<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// If the string is empty, we don't want to push "" into result_vec</span>
                    result_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>push_string<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// But if it's not empty, it will be a number. Push it into the vec</span>
                    push_string<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Then clear the string</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token char string">'-'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// If we get a -,</span>
                <span class="token keyword">if</span> push_string<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token operator">||</span> push_string<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// check to see if it's empty or has a -</span>
                    push_string<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span> <span class="token comment">// if so, then push it in</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// otherwise, it will contain a number</span>
                result_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>push_string<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// so push the number into result_vec, clear it and then push -</span>
                push_string<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                push_string<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            number <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// number here means "anything else that matches". We selected the name here</span>
                <span class="token keyword">if</span> push_string<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// We might have some - characters to push in first</span>
                    result_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>push_string<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    push_string<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    push_string<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// But if we don't, that means we can push the number in</span>
                    push_string<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    result_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>push_string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Push one last time after the loop is over. Don't need to .clone() because we don't use it anymore</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Now it's time to do math. Start with a total</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> adds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// true = add, false = subtract</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> math_iter <span class="token operator">=</span> result_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">=</span> math_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Iter through the items</span>
        <span class="token keyword">if</span> entry<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// If it has a - character, check if it's even or odd</span>
            <span class="token keyword">if</span> entry<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
                adds <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// Go to the next item</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> adds <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">&#123;</span>
            total <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If there is no '-', it must be a number. So we are safe to unwrap</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            total <span class="token operator">-=</span> entry<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            adds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// After subtracting, reset adds to true.</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    total <span class="token comment">// Finally, return the total</span>
<span class="token punctuation">&#125;</span>
   <span class="token comment">/// We'll add a few more tests just to make sure</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_plus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 + 1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_two_is_minus_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - 2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_minus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - -1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">nine_plus_nine_minus_nine_minus_nine_is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"9+9-9-9"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is a new test</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">eight_minus_nine_plus_nine_is_eight_even_with_characters_on_the_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"8  - 9     +9-----+++++"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is a new test</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">panics_when_characters_not_right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"7 + seven"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在测试通过了!</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 6 tests
test tests::one_minus_minus_one_is_two ... ok
test tests::nine_plus_nine_minus_nine_minus_nine_is_zero ... ok
test tests::one_minus_two_is_minus_one ... ok
test tests::eight_minus_nine_plus_nine_is_eight_even_with_characters_on_the_end ... ok
test tests::one_plus_one_is_two ... ok
test tests::panics_when_characters_not_right ... ok

test result: ok. 6 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，在测试驱动的开发中，有一个来回的过程。它是这样的。</p>
<ul>
<li>首先你要写出所有你能想到的测试</li>
<li>然后你开始写代码。</li>
<li>当你写代码的时候，你会有其他测试的想法。</li>
<li>你添加测试，你的测试随着你的发展而增长。你的测试越多，你的代码被检查的次数就越多。</li>
</ul>
<p>当然，测试并不能检查所有的东西，认为 “通过所有测试=代码是完美的”是错误的。但是，测试对于你修改代码的时候是非常好的。如果你以后修改了代码，然后运行测试，如果其中一个测试不成功，你就会知道该怎么修复。</p>
<p>现在我们可以重写(重构)一下代码。一个好的方法是用clippy开始。如果你安装了Rust，那么你可以输入<code>cargo clippy</code>，如果你使用的是Playground，那么点击<code>TOOLS</code>，选择Clippy。Clippy会查看你的代码，并给你提示，让你的代码更简单。我们的代码没有任何错误，但它可以更好。</p>
<p>Clippy会告诉我们两件事。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">warning: this loop could be written as a &#96;for&#96; loop
  --&gt; src&#x2F;lib.rs:44:5
   |
44 |     while let Some(entry) &#x3D; math_iter.next() &#123; &#x2F;&#x2F; Iter through the items
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: &#96;for entry in math_iter&#96;
   |
   &#x3D; note: &#96;#[warn(clippy::while_let_on_iterator)]&#96; on by default
   &#x3D; help: for further information visit https:&#x2F;&#x2F;rust-lang.github.io&#x2F;rust-clippy&#x2F;master&#x2F;index.html#while_let_on_iterator

warning: equality checks against true are unnecessary
  --&gt; src&#x2F;lib.rs:53:12
   |
53 |         if adds &#x3D;&#x3D; true &#123;
   |            ^^^^^^^^^^^^ help: try simplifying it as shown: &#96;adds&#96;
   |
   &#x3D; note: &#96;#[warn(clippy::bool_comparison)]&#96; on by default
   &#x3D; help: for further information visit https:&#x2F;&#x2F;rust-lang.github.io&#x2F;rust-clippy&#x2F;master&#x2F;index.html#bool_comparison<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是真的:<code>for entry in math_iter</code>比<code>while let Some(entry) = math_iter.next()</code>简单得多。而<code>for</code>循环实际上是一个迭代器，所以我们没有任何理由写<code>.iter()</code>。谢谢你，clippy! 而且我们也不需要做<code>math_iter</code>:我们可以直接写<code>for entry in result_vec</code>。</p>
<p>而第二点也是真的:<code>if adds == true</code>可以直接写成<code>if adds</code>(因为<code>adds</code>=<code>true</code>)。</p>
<p>现在我们将开始一些真正的重构。我们将创建一个 <code>Calculator</code> 结构体，而不是单独的变量。这将拥有我们使用的所有变量。我们将改变两个名字以使其更加清晰。<code>result_vec</code>将变成<code>results</code>，<code>push_string</code>将变成<code>current_input</code>(current的意思是 “现在”)。而到目前为止，它只有一种方法:new。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    results<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    current_input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    total<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    adds<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            results<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            current_input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            total<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            adds<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在我们的代码其实比较长，但更容易读懂。比如，<code>if adds</code>现在是<code>if calculator.adds</code>，这就跟读英文完全一样。它的样子是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    results<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    current_input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    total<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    adds<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            results<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            current_input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            total<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            adds<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">"1234567890+- "</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">math</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token boolean">false</span> <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>character<span class="token closure-punctuation punctuation">|</span></span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Please only input numbers, +-, or spaces"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> input <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">trim_end_matches</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"+-"</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> calculator <span class="token operator">=</span> <span class="token class-name">Calculator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> character <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> character <span class="token punctuation">&#123;</span>
            <span class="token char string">'+'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token char string">'-'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token operator">||</span> calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            number <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> entry <span class="token keyword">in</span> calculator<span class="token punctuation">.</span>results <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> entry<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> entry<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
                calculator<span class="token punctuation">.</span>adds <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> calculator<span class="token punctuation">.</span>adds <span class="token punctuation">&#123;</span>
            calculator<span class="token punctuation">.</span>total <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            calculator<span class="token punctuation">.</span>total <span class="token operator">-=</span> entry<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            calculator<span class="token punctuation">.</span>adds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    calculator<span class="token punctuation">.</span>total
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_plus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 + 1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_two_is_minus_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - 2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_minus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - -1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">nine_plus_nine_minus_nine_minus_nine_is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"9+9-9-9"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">eight_minus_nine_plus_nine_is_eight_even_with_characters_on_the_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"8  - 9     +9-----+++++"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">panics_when_characters_not_right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"7 + seven"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后我们增加两个新方法。一个叫做 <code>.clear()</code>，清除 <code>current_input()</code>。另一个叫做 <code>push_char()</code>，把输入推到 <code>current_input()</code> 上。这是我们重构后的代码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    results<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>
    current_input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    total<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    adds<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            results<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            current_input<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            total<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            adds<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">clear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">push_char</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> character<span class="token punctuation">:</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">"1234567890+- "</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">math</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token boolean">false</span> <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>character<span class="token closure-punctuation punctuation">|</span></span> <span class="token constant">OKAY_CHARACTERS</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Please only input numbers, +-, or spaces"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> input <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">trim_end_matches</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"+-"</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> calculator <span class="token operator">=</span> <span class="token class-name">Calculator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> character <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> character <span class="token punctuation">&#123;</span>
            <span class="token char string">'+'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    calculator<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token char string">'-'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token operator">||</span> calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span><span class="token function">push_char</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                calculator<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                calculator<span class="token punctuation">.</span><span class="token function">push_char</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            number <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    calculator<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    calculator<span class="token punctuation">.</span><span class="token function">push_char</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    calculator<span class="token punctuation">.</span><span class="token function">push_char</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    calculator<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>current_input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> entry <span class="token keyword">in</span> calculator<span class="token punctuation">.</span>results <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> entry<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> entry<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
                calculator<span class="token punctuation">.</span>adds <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> calculator<span class="token punctuation">.</span>adds <span class="token punctuation">&#123;</span>
            calculator<span class="token punctuation">.</span>total <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            calculator<span class="token punctuation">.</span>total <span class="token operator">-=</span> entry<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            calculator<span class="token punctuation">.</span>adds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    calculator<span class="token punctuation">.</span>total
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_plus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 + 1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_two_is_minus_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - 2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">one_minus_minus_one_is_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"1 - -1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">nine_plus_nine_minus_nine_minus_nine_is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"9+9-9-9"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">eight_minus_nine_plus_nine_is_eight_even_with_characters_on_the_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"8  - 9     +9-----+++++"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">panics_when_characters_not_right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">math</span><span class="token punctuation">(</span><span class="token string">"7 + seven"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在大概已经够好了。我们可以写更多的方法，但是像<code>calculator.results.push(calculator.current_input.clone());</code>这样的行已经很清楚了。重构最好是在你完成后还能轻松阅读代码的时候。你不希望只是为了让代码变短而重构:例如，<code>clc.clr()</code>就比<code>calculator.clear()</code>差很多。</p>
<h2 id="外部crate"><a href="#外部crate" class="headerlink" title="外部crate"></a>外部crate</h2><p>外部crate的意思是 “别人的crate”。</p>
<p>在本节中，你<em>差不多</em>需要安装Rust，但我们仍然可以只使用Playground。现在我们要学习如何导入别人写的crate。这在Rust中很重要，原因有二。</p>
<ul>
<li>导入其他的crate很容易，并且…</li>
<li>Rust标准库是相当小的。</li>
</ul>
<p>这意味着，在Rust中，很多基本功能都需要用到外部Crate，这很正常。我们的想法是，如果使用外部Crate很方便，那么你可以选择最好的一个。也许一个人会为一个功能创建一个crate，然后其他人会创建一个更好的crate。</p>
<p>在本书中，我们只看最流行的crate，也就是每个使用Rust的人都知道的crate。</p>
<p>要开始学习外部Crate，我们将从最常见的Crate开始。<code>rand</code>.</p>
<h3 id="rand"><a href="#rand" class="headerlink" title="rand"></a>rand</h3><p>你有没有注意到，我们还没有使用任何随机数？那是因为随机数不在标准库中。但是有很多crate “几乎是标准库”，因为大家都在使用它们。在任何情况下，带入一个 crate 是非常容易的。如果你的电脑上有Rust，有一个叫<code>Cargo.toml</code>的文件，里面有这些信息。<code>Cargo.toml</code>文件在你启动时是这样的。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[package]
name &#x3D; &quot;rust_book&quot;
version &#x3D; &quot;0.1.0&quot;
authors &#x3D; [&quot;David MacLeod&quot;]
edition &#x3D; &quot;2018&quot;

# See more keys and their definitions at https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;cargo&#x2F;reference&#x2F;manifest.html

[dependencies]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在，如果你想添加<code>rand</code> crate，在<code>crates.io</code>上搜索它，这是所有crate的去处。这将带你到<code>https://crates.io/crates/rand</code>。当你点击那个，你可以看到一个屏幕，上面写着<code>Cargo.toml   rand = &quot;0.7.3&quot;</code>。你所要做的就是在[dependencies]下添加这样的内容:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[package]
name &#x3D; &quot;rust_book&quot;
version &#x3D; &quot;0.1.0&quot;
authors &#x3D; [&quot;David MacLeod&quot;]
edition &#x3D; &quot;2018&quot;

# See more keys and their definitions at https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;cargo&#x2F;reference&#x2F;manifest.html

[dependencies]
rand &#x3D; &quot;0.7.3&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后Cargo会帮你完成剩下的工作。然后你就可以在<code>rand</code>文档网站上开始编写像<a target="_blank" rel="noopener" href="https://docs.rs/rand/0.7.3/rand/">本例代码</a>这样的代码。要想进入文档，你可以点击<a target="_blank" rel="noopener" href="https://crates.io/crates/rand">crates.io上的页面</a>中的<code>docs</code>按钮。</p>
<p>关于Cargo的介绍就到这里了:我们现在使用的还只是playground。幸运的是，playground已经安装了前100个crate。所以你还不需要写进<code>Cargo.toml</code>。在playground上，你可以想象，它有一个这样的长长的列表，有100个crate。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[dependencies]
rand &#x3D; &quot;0.7.3&quot;
some_other_crate &#x3D; &quot;0.1.0&quot;
another_nice_crate &#x3D; &quot;1.7&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>也就是说，如果要使用<code>rand</code>，你可以直接这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> rand<span class="token punctuation">;</span> <span class="token comment">// This means the whole crate rand</span>
          <span class="token comment">// On your computer you can't just write this;</span>
          <span class="token comment">// you need to write in the Cargo.toml file first</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> random_u16 <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">random</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> random_u16<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每次都会打印不同的<code>u16</code>号码，比如<code>42266 52873 56528 46927 6867</code>。</p>
<p><code>rand</code>中的主要功能是<code>random</code>和<code>thread_rng</code>(rng的意思是 “随机数发生器”)。而实际上如果你看<code>random</code>，它说:”这只是<code>thread_rng().gen()</code>的一个快捷方式”。所以其实是<code>thread_rng</code>基本做完了一切。</p>
<p>下面是一个简单的例子，从1到10的数字。为了得到这些数字，我们在1到11之间使用<code>.gen_range()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>thread_rng<span class="token punctuation">,</span> <span class="token class-name">Rng</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Or just use rand::*; if we are lazy</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> number_maker <span class="token operator">=</span> <span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> number_maker<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出<code>7 2 4 8 6</code>这样的东西。</p>
<p>用随机数我们可以做一些有趣的事情，比如为游戏创建角色。我们将使用<code>rand</code>和其他一些我们知道的东西来创建它们。在这个游戏中，我们的角色有六种状态，用一个d6来表示他们。d6是一个立方体，当你投掷它时，它能给出1、2、3、4、5或6。每个角色都会掷三次d6，所以每个统计都在3到18之间。</p>
<p>但是有时候如果你的角色有一些低的东西，比如3或4，那就不公平了。比如说你的力量是3，你就不能拿东西。所以还有一种方法是用d6四次。你掷四次，然后扔掉最低的数字。所以如果你掷3，3，1，6，那么你保留3，3，6=12。我们也会把这个方法做出来，所以游戏的主人可以决定。</p>
<p>这是我们简单的角色创建器。我们为数据统计创建了一个<code>Character</code>结构，甚至还实现了<code>Display</code>来按照我们想要的方式打印。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>thread_rng<span class="token punctuation">,</span> <span class="token class-name">Rng</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Or just use rand::*; if we are lazy</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span> <span class="token comment">// Going to impl Display for our character</span>


<span class="token keyword">struct</span> <span class="token type-definition class-name">Character</span> <span class="token punctuation">&#123;</span>
    strength<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    dexterity<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>    <span class="token comment">// This means "body quickness"</span>
    constitution<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token comment">// This means "health"</span>
    intelligence<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    wisdom<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    charisma<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token comment">// This means "popularity with people"</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u8</span> <span class="token punctuation">&#123;</span> <span class="token comment">// A "die" is the thing you throw to get the number</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> generator <span class="token operator">=</span> <span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create our random number generator</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// This is the total</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span> <span class="token punctuation">&#123;</span>
        stat <span class="token operator">+=</span> generator<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Add each time</span>
    <span class="token punctuation">&#125;</span>
    stat <span class="token comment">// Return the total</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u8</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> generator <span class="token operator">=</span> <span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> results <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// First put the numbers in a vec</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">4</span> <span class="token punctuation">&#123;</span>
        results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    results<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now a result like [4, 3, 2, 6] becomes [2, 3, 4, 6]</span>
    results<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now it would be [3, 4, 6]</span>
    results<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Return this result</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>three_dice<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span> <span class="token comment">// true for three dice, false for four</span>
        <span class="token keyword">match</span> three_dice <span class="token punctuation">&#123;</span>
            <span class="token boolean">true</span> <span class="token operator">=></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
                strength<span class="token punctuation">:</span> <span class="token function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                dexterity<span class="token punctuation">:</span> <span class="token function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                constitution<span class="token punctuation">:</span> <span class="token function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                intelligence<span class="token punctuation">:</span> <span class="token function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                wisdom<span class="token punctuation">:</span> <span class="token function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                charisma<span class="token punctuation">:</span> <span class="token function">three_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span> <span class="token operator">=></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
                strength<span class="token punctuation">:</span> <span class="token function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                dexterity<span class="token punctuation">:</span> <span class="token function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                constitution<span class="token punctuation">:</span> <span class="token function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                intelligence<span class="token punctuation">:</span> <span class="token function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                wisdom<span class="token punctuation">:</span> <span class="token function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                charisma<span class="token punctuation">:</span> <span class="token function">four_die_six</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">display</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// We can do this because we implemented Display below</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Character</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Just follow the code for in https://doc.rust-lang.org/std/fmt/trait.Display.html and change it a bit</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>
            f<span class="token punctuation">,</span>
            <span class="token string">"Your character has these stats:
strength: &#123;&#125;
dexterity: &#123;&#125;
constitution: &#123;&#125;
intelligence: &#123;&#125;
wisdom: &#123;&#125;
charisma: &#123;&#125;"</span><span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>strength<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>dexterity<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>constitution<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>intelligence<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>wisdom<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>charisma
        <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>



<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> weak_billy <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> strong_billy <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    weak_billy<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    strong_billy<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它会打印出这样的东西。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Your</span> character has these stats<span class="token punctuation">:</span>
strength<span class="token punctuation">:</span> <span class="token number">9</span>
dexterity<span class="token punctuation">:</span> <span class="token number">15</span>
constitution<span class="token punctuation">:</span> <span class="token number">15</span>
intelligence<span class="token punctuation">:</span> <span class="token number">8</span>
wisdom<span class="token punctuation">:</span> <span class="token number">11</span>
charisma<span class="token punctuation">:</span> <span class="token number">9</span>

<span class="token class-name">Your</span> character has these stats<span class="token punctuation">:</span>
strength<span class="token punctuation">:</span> <span class="token number">9</span>
dexterity<span class="token punctuation">:</span> <span class="token number">13</span>
constitution<span class="token punctuation">:</span> <span class="token number">14</span>
intelligence<span class="token punctuation">:</span> <span class="token number">16</span>
wisdom<span class="token punctuation">:</span> <span class="token number">16</span>
charisma<span class="token punctuation">:</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有四个骰子的角色通常在大多数事情上都会好一点。</p>
<h3 id="rayon"><a href="#rayon" class="headerlink" title="rayon"></a>rayon</h3><p><code>rayon</code> 是一个流行的crate，它可以让你加快 Rust 代码的速度。它之所以受欢迎，是因为它无需像 <code>thread::spawn</code> 这样的东西就能创建线程。换句话说，它之所以受欢迎是因为它既有效又容易编写。比如说</p>
<ul>
<li><code>.iter()</code>, <code>.iter_mut()</code>, <code>into_iter()</code>在rayon中是这样写的:</li>
<li><code>.par_iter()</code>, <code>.par_iter_mut()</code>, <code>par_into_iter()</code>. 所以你只要加上<code>par_</code>，你的代码就会变得快很多。(par的意思是 “并行”)</li>
</ul>
<p>其他方法也一样:<code>.chars()</code>就是<code>.par_chars()</code>，以此类推。</p>
<p>这里举个例子，一段简单的代码，却让计算机做了很多工作。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">200_000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>number<span class="token operator">+=</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>my_vec<span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">..</span><span class="token number">5005</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它创建了一个有20万项的向量:每一项都是0，然后调用<code>.enumerate()</code>来获取每个数字的索引，并将0改为索引号。它的打印时间太长，所以我们只打印5000到5004项。这在Rust中还是非常快的，但如果你愿意，你可以用Rayon让它更快。代码几乎是一样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">rayon<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span> <span class="token comment">// Import rayon</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">200_000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">par_iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>number<span class="token operator">+=</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add par_ to iter_mut</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>my_vec<span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">..</span><span class="token number">5005</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>就这样了。<code>rayon</code>还有很多其他的方法来定制你想做的事情，但最简单的就是 “添加<code>_par</code>，让你的程序更快”。</p>
<h3 id="serde"><a href="#serde" class="headerlink" title="serde"></a>serde</h3><p><code>serde</code>是一个流行的crate，它可以让在JSON、YAML等格式间相互转换。最常见的使用方法是通过创建一个<code>struct</code>，上面有两个属性。<a target="_blank" rel="noopener" href="https://serde.rs/">它看起来是这样的</a>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span> <span class="token punctuation">&#123;</span>
    x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Serialize</code>和<code>Deserialize</code>trait是使转换变得简单的原因。(这也是<code>serde</code>这个名字的由来)如果你的结构体上有这两个trait，那么你只需要调用一个方法就可以把它转化为JSON或其他任何东西。</p>
<h3 id="regex"><a href="#regex" class="headerlink" title="regex"></a>regex</h3><p><a target="_blank" rel="noopener" href="https://crates.io/crates/regex">regex</a> crate 可以让你使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Regular_expression">正则表达式</a> 搜索文本。有了它，你可以通过一次搜索得到诸如 <code>colour</code>, <code>color</code>, <code>colours</code> 和 <code>colors</code> 的匹配信息。正则表达式是另一门语言，如果你想使用它们，也必须学会。</p>
<h3 id="chrono"><a href="#chrono" class="headerlink" title="chrono"></a>chrono</h3><p><a target="_blank" rel="noopener" href="https://crates.io/crates/chrono">chrono</a>是为那些需要更多时间功能的人准备的主要crate。我们现在来看一下标准库，它有时间的功能，但是如果你需要更多的功能，那么这个crate是一个不错的选择。</p>
<h2 id="标准库之旅"><a href="#标准库之旅" class="headerlink" title="标准库之旅"></a>标准库之旅</h2><p>现在你已经知道了很多Rust的知识，你将能够理解标准库里面的大部分东西。它里面的代码已经不是那么可怕了。让我们来看看它里面一些我们还没有学过的部分。本篇游记将介绍标准库的大部分部分，你不需要安装Rust。我们将重温很多我们已经知道的内容，这样我们就可以更深入地学习它们。</p>
<h3 id="数组-1"><a href="#数组-1" class="headerlink" title="数组"></a>数组</h3><p>关于数组需要注意的一点是，它们没有实现<code>Iterator.</code>。这意味着，如果你有一个数组，你不能使用<code>for</code>。但是你可以对它们使用 <code>.iter()</code> 这样的方法。或者你可以使用<code>&amp;</code>来得到一个片断。实际上，如果你尝试使用<code>for</code>，编译器会准确地告诉你。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ⚠️</span>
    <span class="token keyword">let</span> my_cities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Beirut"</span><span class="token punctuation">,</span> <span class="token string">"Tel Aviv"</span><span class="token punctuation">,</span> <span class="token string">"Nicosia"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> city <span class="token keyword">in</span> my_cities <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>消息是:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: &#96;[&amp;str; 3]&#96; is not an iterator
 --&gt; src\main.rs:5:17
  |
  |                 ^^^^^^^^^ borrow the array with &#96;&amp;&#96; or call &#96;.iter()&#96; on it to iterate over it<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以让我们试试这两种方法。它们的结果是一样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_cities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Beirut"</span><span class="token punctuation">,</span> <span class="token string">"Tel Aviv"</span><span class="token punctuation">,</span> <span class="token string">"Nicosia"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> city <span class="token keyword">in</span> <span class="token operator">&amp;</span>my_cities <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> city <span class="token keyword">in</span> my_cities<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Beirut
Tel Aviv
Nicosia
Beirut
Tel Aviv
Nicosia<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>如果你想从一个数组中获取变量，你可以把它们的名字放在 <code>[]</code> 中来解构它。这与在 <code>match</code> 语句中使用元组或从结构体中获取变量是一样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_cities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Beirut"</span><span class="token punctuation">,</span> <span class="token string">"Tel Aviv"</span><span class="token punctuation">,</span> <span class="token string">"Nicosia"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>city1<span class="token punctuation">,</span> city2<span class="token punctuation">,</span> city3<span class="token punctuation">]</span> <span class="token operator">=</span> my_cities<span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> city1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打印出<code>Beirut</code>.</p>
<h3 id="char"><a href="#char" class="headerlink" title="char"></a>char</h3><p>您可以使用<code>.escape_unicode()</code>的方法来获取<code>char</code>的Unicode号码。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> korean_word <span class="token operator">=</span> <span class="token string">"청춘예찬"</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> character <span class="token keyword">in</span> korean_word<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> character<span class="token punctuation">.</span><span class="token function">escape_unicode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>这将打印出 <code>u&#123;ccad&#125; u&#123;cd98&#125; u&#123;c608&#125; u&#123;cc2c&#125;</code>。</p>
<p>你可以使用 <code>From</code> trait从 <code>u8</code> 中得到一个字符，但对于 <code>u32</code>，你使用 <code>TryFrom</code>，因为它可能无法工作。<code>u32</code>中的数字比Unicode中的字符多很多。我们可以通过一个简单的演示来了解。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>convert<span class="token punctuation">::</span></span><span class="token class-name">TryFrom</span><span class="token punctuation">;</span> <span class="token comment">// You need to bring TryFrom in to use it</span>
<span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>      <span class="token comment">// We will use random numbers too</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_character <span class="token operator">=</span> <span class="token keyword">char</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This one is easy - no need for TryFrom</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> some_character<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> random_generator <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// This will try 40,000 times to make a char from a u32.</span>
    <span class="token comment">// The range is 0 (std::u32::MIN) to u32's highest number (std::u32::MAX). If it doesn't work, we will give it '-'.</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">40_000</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> bigger_character <span class="token operator">=</span> <span class="token keyword">char</span><span class="token punctuation">::</span><span class="token function">try_from</span><span class="token punctuation">(</span>random_generator<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u32</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token char string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> bigger_character<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>几乎每次都会生成一个<code>-</code>。这是你会看到的那种输出的一部分。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">------------------------------------------------------------------------𤒰---------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-------------------------------------------------------------춗--------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------
------------򇍜----------------------------------------------------<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，你要用<code>TryFrom</code>是件好事。</p>
<p>另外，从2020年8月底开始，你现在可以从<code>char</code>中得到一个<code>String</code>。(<code>String</code>实现了<code>From&lt;char&gt;</code>)只要写<code>String::from()</code>，然后在里面放一个<code>char</code>。</p>
<h3 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h3><p>这些类型的数学方法有很多，另外还有一些其他的方法。下面是一些最有用的。</p>
<p><code>.checked_add()</code>, <code>.checked_sub()</code>, <code>.checked_mul()</code>, <code>.checked_div()</code>. 如果你认为你可能会得到一个不适合类型的数字，这些都是不错的方法。它们会返回一个 <code>Option</code>，这样你就可以安全地检查你的数学计算是否正常，而不会让程序崩溃。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> some_number <span class="token operator">=</span> <span class="token number">200_u8</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> other_number <span class="token operator">=</span> <span class="token number">200_u8</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> some_number<span class="token punctuation">.</span><span class="token function">checked_add</span><span class="token punctuation">(</span>other_number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> some_number<span class="token punctuation">.</span><span class="token function">checked_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">None
Some(201)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>你会注意到，在整数的页面上，经常说<code>rhs</code>。这意味着 “右手”，也就是你做一些数学运算时的右手。比如在<code>5 + 6</code>中，<code>5</code>在左边，<code>6</code>在右边，所以<code>6</code>就是<code>rhs</code>。这个不是关键词，但是你会经常看到，所以知道就好。</p>
<p>说到这里，我们来学习一下如何实现<code>Add</code>。在你实现了<code>Add</code>之后，你可以在你创建的类型上使用<code>+</code>。你需要自己实现<code>Add</code>，因为add可以意味着很多东西。这是标准库页面中的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Add</span><span class="token punctuation">;</span> <span class="token comment">// first bring in Add</span>

<span class="token attribute attr-name">#[derive(Debug, Copy, Clone, PartialEq)]</span> <span class="token comment">// PartialEq is probably the most important part here. You want to be able to compare numbers</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span> <span class="token punctuation">&#123;</span>
    x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Add</span> <span class="token keyword">for</span> <span class="token class-name">Point</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">;</span> <span class="token comment">// Remember, this is called an "associated type": a "type that goes together".</span>
                        <span class="token comment">// In this case it's just another Point</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            x<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>x <span class="token operator">+</span> other<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
            y<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>y <span class="token operator">+</span> other<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在让我们为自己的类型实现<code>Add</code>。让我们想象一下，我们想把两个国家加在一起，这样我们就可以比较它们的经济。它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fmt<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Add</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Country</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    gdp<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token comment">// This is the size of the economy</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> population<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> gdp<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            population<span class="token punctuation">,</span>
            gdp<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Add</span> <span class="token keyword">for</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            name<span class="token punctuation">:</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; and &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> other<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// We will add the names together,</span>
            population<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>population <span class="token operator">+</span> other<span class="token punctuation">.</span>population<span class="token punctuation">,</span> <span class="token comment">// and the population,</span>
            gdp<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>gdp <span class="token operator">+</span> other<span class="token punctuation">.</span>gdp<span class="token punctuation">,</span>   <span class="token comment">// and the GDP</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Country</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>
            f<span class="token punctuation">,</span>
            <span class="token string">"In &#123;&#125; are &#123;&#125; people and a GDP of $&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token comment">// Then we can print them all with just &#123;&#125;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>population<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>gdp
        <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> nauru <span class="token operator">=</span> <span class="token class-name">Country</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Nauru"</span><span class="token punctuation">,</span> <span class="token number">10_670</span><span class="token punctuation">,</span> <span class="token number">160_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> vanuatu <span class="token operator">=</span> <span class="token class-name">Country</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Vanuatu"</span><span class="token punctuation">,</span> <span class="token number">307_815</span><span class="token punctuation">,</span> <span class="token number">820_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> micronesia <span class="token operator">=</span> <span class="token class-name">Country</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Micronesia"</span><span class="token punctuation">,</span> <span class="token number">104_468</span><span class="token punctuation">,</span> <span class="token number">367_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We could have given Country a &amp;str instead of a String for the name. But we would have to write lifetimes everywhere</span>
    <span class="token comment">// and that would be too much for a small example. Better to just clone them when we call println!.</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> nauru<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> nauru<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> vanuatu<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> nauru <span class="token operator">+</span> vanuatu <span class="token operator">+</span> micronesia<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">In Nauru are 10670 people and a GDP of $160000000
In Nauru and Vanuatu are 318485 people and a GDP of $980000000
In Nauru and Vanuatu and Micronesia are 422953 people and a GDP of $1347000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>以后在这段代码中，我们可以把<code>.fmt()</code>改成更容易阅读的数字显示。</p>
<p>另外三个叫<code>Sub</code>、<code>Mul</code>和<code>Div</code>，实现起来基本一样。<code>+=</code>、<code>-=</code>、<code>*=</code>和<code>/=</code>，只要加上<code>Assign</code>:<code>AddAssign</code>、<code>SubAssign</code>、<code>MulAssign</code>和<code>DivAssign</code>即可。你可以看到完整的列表<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/ops/index.html#structs">这里</a>，因为还有很多。例如 <code>%</code> 被称为 <code>Rem</code>, <code>-</code> 被称为 <code>Neg</code>, 等等。</p>
<h3 id="浮点数-1"><a href="#浮点数-1" class="headerlink" title="浮点数"></a>浮点数</h3><p><code>f32</code>和<code>f64</code>有非常多的方法，你在做数学计算的时候会用到。我们不看这些，但这里有一些你可能会用到的方法。它们分别是 <code>.floor()</code>, <code>.ceil()</code>, <code>.round()</code>, 和 <code>.trunc()</code>. 所有这些方法都返回一个 <code>f32</code> 或 <code>f64</code>，它像一个整数，小数点后面是 <code>0</code>。它们是这样做的。</p>
<ul>
<li><code>.floor()</code>: 给你下一个最低的整数.</li>
<li><code>.ceil()</code>: 给你下一个最高的整数。</li>
<li><code>.round()</code>: 如果小数部分大于等于0.5，返回数值加1;如果小数部分小于0.5，返回相同数值。这就是所谓的四舍五入，因为它给你一个 “舍入”的数字(一个数字的简短形式)。</li>
<li><code>.trunc()</code>:只是把小数点号后的部分截掉。Truncate是 “截断”的意思。</li>
</ul>
<p>这里有一个简单的函数来打印它们。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">four_operations</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
<span class="token string">"For the number &#123;&#125;:
floor: &#123;&#125;
ceiling: &#123;&#125;
rounded: &#123;&#125;
truncated: &#123;&#125;\n"</span><span class="token punctuation">,</span>
        input<span class="token punctuation">,</span>
        input<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        input<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        input<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        input<span class="token punctuation">.</span><span class="token function">trunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">four_operations</span><span class="token punctuation">(</span><span class="token number">9.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">four_operations</span><span class="token punctuation">(</span><span class="token number">100.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">four_operations</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">four_operations</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">19.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">For the number 9.1:
floor: 9
ceiling: 10
rounded: 9 &#x2F;&#x2F; because less than 9.5
truncated: 9

For the number 100.7:
floor: 100
ceiling: 101
rounded: 101 &#x2F;&#x2F; because more than 100.5
truncated: 100

For the number -1.1:
floor: -2
ceiling: -1
rounded: -1
truncated: -1

For the number -19.9:
floor: -20
ceiling: -19
rounded: -20
truncated: -19<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>f32</code> 和 <code>f64</code> 有一个叫做 <code>.max()</code> 和 <code>.min()</code> 的方法，可以得到两个数字中较大或较小的数字。(对于其他类型，你可以直接使用<code>std::cmp::max</code>和<code>std::cmp::min</code>。)下面是用<code>.fold()</code>来得到最高或最低数的方法。你又可以看到，<code>.fold()</code>不仅仅是用来加数字的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8.0_f64</span><span class="token punctuation">,</span> <span class="token number">7.6</span><span class="token punctuation">,</span> <span class="token number">9.4</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">22.0</span><span class="token punctuation">,</span> <span class="token number">77.345</span><span class="token punctuation">,</span> <span class="token number">10.22</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7.77</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> maximum <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>current_number<span class="token punctuation">,</span> next_number<span class="token closure-punctuation punctuation">|</span></span> current_number<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">*</span>next_number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Note: start with the lowest possible number for an f64.</span>
    <span class="token keyword">let</span> minimum <span class="token operator">=</span> my_vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>current_number<span class="token punctuation">,</span> next_number<span class="token closure-punctuation punctuation">|</span></span> current_number<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">*</span>next_number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// And here start with the highest possible number</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> minimum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h3><p>在 Rust 中，如果你愿意，你可以把 <code>bool</code> 变成一个整数，因为这样做是安全的。但你不能反过来做。如你所见，<code>true</code>变成了1，<code>false</code>变成了0。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> true_false <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; &#123;&#125;"</span><span class="token punctuation">,</span> true_false<span class="token number">.0</span> <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> true_false<span class="token number">.1</span> <span class="token keyword">as</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出<code>1 0</code>。如果你告诉编译器类型，也可以使用 <code>.into()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> true_false<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">i128</span><span class="token punctuation">,</span> <span class="token keyword">u16</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; &#123;&#125;"</span><span class="token punctuation">,</span> true_false<span class="token number">.0</span><span class="token punctuation">,</span> true_false<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印的是一样的东西。</p>
<h3 id="Vec"><a href="#Vec" class="headerlink" title="Vec"></a>Vec</h3><p>Vec有很多方法我们还没有看。先说说<code>.sort()</code>。<code>.sort()</code>一点都不奇怪。它使用<code>&amp;mut self</code>来对一个向量进行排序。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样打印出来的是<code>[0, 0, 0, 0, 0, 80, 90, 100]</code>。但还有一种更有趣的排序方式叫<code>.sort_unstable()</code>，它通常更快。它之所以更快，是因为它不在乎排序前后相同数字的先后顺序。在常规的<code>.sort()</code>中，你知道最后的<code>0, 0, 0, 0, 0</code>会在<code>.sort()</code>之后的顺序相同。但是<code>.sort_unstable()</code>可能会把最后一个0移到索引0，然后把第三个最后的0移到索引2，等等。</p>
<p><code>.dedup()</code>的意思是 “去重复”。它将删除一个向量中相同的元素，但只有当它们彼此相邻时才会删除。接下来这段代码不会只打印<code>&quot;sun&quot;, &quot;moon&quot;</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"sun"</span><span class="token punctuation">,</span> <span class="token string">"sun"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">,</span> <span class="token string">"sun"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">dedup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>它只是把另一个 “sun”旁边的 “sun”去掉，然后把一个 “moon”旁边的 “moon”去掉，再把另一个 “moon”旁边的 “moon”去掉。结果是 <code>[&quot;sun&quot;, &quot;moon&quot;, &quot;sun&quot;, &quot;moon&quot;]</code>.</p>
<p>如果你想把每个重复的东西都去掉，就先<code>.sort()</code>:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"sun"</span><span class="token punctuation">,</span> <span class="token string">"sun"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">,</span> <span class="token string">"sun"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">,</span> <span class="token string">"moon"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_vec<span class="token punctuation">.</span><span class="token function">dedup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> my_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果:<code>[&quot;moon&quot;, &quot;sun&quot;]</code>.</p>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p>你会记得，<code>String</code>有点像<code>Vec</code>。它很像<code>Vec</code>，你可以调用很多相同的方法。比如说，你可以用<code>String::with_capacity()</code>创建一个。如果你总是要用<code>.push()</code>推一个<code>char</code>，或者用<code>.push_str()</code>推一个<code>&amp;str</code>，你就要这样。下面是一个<code>String</code>的例子，它有太多的内存分配。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> push_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> capacity_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// capacity starts at 0</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">100_000</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Do this 100,000 times</span>
        <span class="token keyword">if</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> capacity_counter <span class="token punctuation">&#123;</span> <span class="token comment">// First check if capacity is different now</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If it is, print it</span>
            capacity_counter <span class="token operator">=</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// then update the counter</span>
        <span class="token punctuation">&#125;</span>
        push_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"I'm getting pushed into the string!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// and push this in every time</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">35
70
140
280
560
1120
2240
4480
8960
17920
35840
71680
143360
286720
573440
1146880
2293760
4587520<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们不得不重新分配(把所有东西复制过来)18次。但既然我们知道了最终的容量，我们可以马上设置容量，不需要重新分配:只设置一次<code>String</code>容量就够了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> push_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">4587520</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We know the exact number. Some different big number could work too</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> capacity_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">100_000</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> capacity_counter <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            capacity_counter <span class="token operator">=</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        push_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"I'm getting pushed into the string!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而这个打印<code>4587520</code>。完美的! 我们再也不用分配了。</p>
<p>当然，实际长度肯定比这个小。如果你试了100001次，101000次等等，还是会说<code>4587520</code>。这是因为每次的容量都是之前的2倍。不过我们可以用<code>.shrink_to_fit()</code>来缩小它(和<code>Vec</code>一样)。我们的<code>String</code>已经非常大了，我们不想再给它增加任何东西，所以我们可以把它缩小一点。但是只有在你有把握的情况下才可以这样做:下面是原因。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> push_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">4587520</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> capacity_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">100_000</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> capacity_counter <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            capacity_counter <span class="token operator">=</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        push_string<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"I'm getting pushed into the string!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    push_string<span class="token punctuation">.</span><span class="token function">shrink_to_fit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    push_string<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    push_string<span class="token punctuation">.</span><span class="token function">shrink_to_fit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> push_string<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">4587520
3500000
7000000
3500001<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以首先我们的大小是<code>4587520</code>，但我们没有全部使用。我们用了<code>.shrink_to_fit()</code>，然后把大小降到了<code>3500000</code>。但是我们忘记了我们需要推上一个 <code>a</code>。当我们这样做的时候，Rust 看到我们需要更多的空间，给了我们双倍的空间:现在是 <code>7000000</code>。Whoops! 所以我们又调用了<code>.shrink_to_fit()</code>，现在又回到了<code>3500001</code>。</p>
<p><code>.pop()</code>对<code>String</code>有用，就像对<code>Vec</code>一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">".daer ot drah tib elttil a si gnirts sihT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> pop_result <span class="token operator">=</span> my_string<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> pop_result <span class="token punctuation">&#123;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>character<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> character<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">break</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这打印的是<code>This string is a little bit hard to read.</code>，因为它是从最后一个字符开始的。</p>
<p><code>.retain()</code>是一个使用闭包的方法，这对<code>String</code>来说是罕见的。就像在迭代器上的<code>.filter()</code>一样。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Age: 20 Height: 194 Weight: 80"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    my_string<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>character<span class="token closure-punctuation punctuation">|</span></span> character<span class="token punctuation">.</span><span class="token function">is_alphabetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> character <span class="token operator">==</span> <span class="token char string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Keep if a letter or a space</span>
    <span class="token macro property">dbg!</span><span class="token punctuation">(</span>my_string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Let's use dbg!() for fun this time instead of println!</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src\main.rs:4] my_string &#x3D; &quot;Age  Height  Weight &quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="OsString和CString"><a href="#OsString和CString" class="headerlink" title="OsString和CString"></a>OsString和CString</h3><p><code>std::ffi</code>是<code>std</code>的一部分，它帮助你将Rust与其他语言或操作系统一起使用。它有<code>OsString</code>和<code>CString</code>这样的类型，它们就像操作系统的<code>String</code>或语言C的<code>String</code>一样，它们各自也有自己的<code>&amp;str</code>类型:<code>OsStr</code>和<code>CStr</code>。<code>ffi</code>的意思是 “foreign function interface”(外部函数接口)。</p>
<p>当你必须与一个没有Unicode的操作系统一起工作时，你可以使用<code>OsString</code>。所有的Rust字符串都是unicode，但不是每个操作系统支持。下面是标准库中关于为什么我们有<code>OsString</code>的简单英文解释。</p>
<ul>
<li>Unix系统(Linux等)上的字符串可能是很多没有0的字节组合在一起。而且有时你会把它们读成Unicode UTF-8。</li>
<li>Windows上的字符串可能是由随机的16位值组成的，没有0。有时你会把它们读成Unicode UTF-16。</li>
<li>在Rust中，字符串总是有效的UTF-8，其中可能包含0。</li>
</ul>
<p>所以，<code>OsString</code>被设计为支持它们读取。</p>
<p>你可以用一个<code>OsString</code>做所有常规的事情，比如<code>OsString::from(&quot;Write something here&quot;)</code>。它还有一个有趣的方法，叫做 <code>.into_string()</code>，试图把它变成一个常规的 <code>String</code>。它返回一个 <code>Result</code>，但 <code>Err</code> 部分只是原来的 <code>OsString</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">into_string</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OsString</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以如果不行的话，那你就把它找回来。你不能调用<code>.unwrap()</code>，因为它会崩溃，但是你可以使用<code>match</code>来找回<code>OsString</code>。我们通过调用不存在的方法来测试一下。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ffi<span class="token punctuation">::</span></span><span class="token class-name">OsString</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ⚠️</span>
    <span class="token keyword">let</span> os_string <span class="token operator">=</span> <span class="token class-name">OsString</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"This string works for your OS too."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> os_string<span class="token punctuation">.</span><span class="token function">into_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token operator">=></span> valid<span class="token punctuation">.</span><span class="token function">thth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// Compiler: "What's .thth()??"</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>not_valid<span class="token punctuation">)</span> <span class="token operator">=></span> not_valid<span class="token punctuation">.</span><span class="token function">occg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// Compiler: "What's .occg()??"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后编译器准确地告诉我们我们想知道的东西。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0599]: no method named &#96;thth&#96; found for struct &#96;std::string::String&#96; in the current scope
 --&gt; src&#x2F;main.rs:6:28
  |
6 |         Ok(valid) &#x3D;&gt; valid.thth(),
  |                            ^^^^ method not found in &#96;std::string::String&#96;

error[E0599]: no method named &#96;occg&#96; found for struct &#96;std::ffi::OsString&#96; in the current scope
 --&gt; src&#x2F;main.rs:7:37
  |
7 |         Err(not_valid) &#x3D;&gt; not_valid.occg(),
  |                                     ^^^^ method not found in &#96;std::ffi::OsString&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以看到，<code>valid</code>的类型是<code>String</code>，<code>not_valid</code>的类型是<code>OsString</code>。</p>
<h3 id="Mem"><a href="#Mem" class="headerlink" title="Mem"></a>Mem</h3><p><code>std::mem</code>有一些非常有趣的方法。我们已经看到了一些，比如<code>.size_of()</code>、<code>.size_of_val()</code>和<code>.drop()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of_val</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> some_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"You can drop a String because it's on the heap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">drop</span><span class="token punctuation">(</span>some_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// some_string.clear();   If we did this it would panic</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">4
200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>下面是<code>mem</code>中的一些其他方法。</p>
<p><code>swap()</code>: 用这个方法你可以交换两个变量之间的值。你可以通过为每个变量创建一个可变引用来做。当你有两个东西想交换，而Rust因为借用规则不让你交换时，这很有帮助。或者只是当你想快速切换两个东西的时候。</p>
<p>这里有一个例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>mem<span class="token punctuation">,</span> fmt<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Ring</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Create a ring from Lord of the Rings</span>
    owner<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    former_owner<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    seeker<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// seeker means "person looking for it"</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Ring</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>owner<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> former_owner<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> seeker<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
            owner<span class="token punctuation">:</span> owner<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            former_owner<span class="token punctuation">:</span> former_owner<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            seeker<span class="token punctuation">:</span> seeker<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Ring</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Display to show who has it and who wants it</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; has the ring, &#123;&#125; used to have it, and &#123;&#125; wants it"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>owner<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>former_owner<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>seeker<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> one_ring <span class="token operator">=</span> <span class="token class-name">Ring</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Frodo"</span><span class="token punctuation">,</span> <span class="token string">"Gollum"</span><span class="token punctuation">,</span> <span class="token string">"Sauron"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> one_ring<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> one_ring<span class="token punctuation">.</span>owner<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> one_ring<span class="token punctuation">.</span>former_owner<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Gollum got the ring back for a second</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> one_ring<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Frodo has the ring, Gollum used to have it, and Sauron wants it
Gollum has the ring, Frodo used to have it, and Sauron wants it<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>replace()</code>:这个就像swap一样，其实里面也用了swap，你可以看到。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">replace</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>dest<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> src<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    src
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以它只是做了一个交换，然后返回另一个元素。有了这个，你就用你放进去的其他东西来替换这个值。因为它返回的是旧的值，所以你应该用<code>let</code>来使用它。下面是一个简单的例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">City</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">change_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> old_name <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"The city once called &#123;&#125; is now called &#123;&#125;."</span><span class="token punctuation">,</span>
            old_name<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> capital_city <span class="token operator">=</span> <span class="token class-name">City</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"Constantinople"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    capital_city<span class="token punctuation">.</span><span class="token function">change_name</span><span class="token punctuation">(</span><span class="token string">"Istanbul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就会打印出<code>The city once called Constantinople is now called Istanbul.</code>。</p>
<p>有一个函数叫<code>.take()</code>，和<code>.replace()</code>一样，但它在元素中留下了默认值。<br> 你会记得，默认值通常是0、””之类的东西。这里是签名。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 🚧</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">take</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>dest<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Default</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以你可以做这样的事情。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> number_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    number_vec<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>number<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> taker <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">take</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        new_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>taker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;\n&#123;:?&#125;"</span><span class="token punctuation">,</span> number_vec<span class="token punctuation">,</span> new_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，它将所有数字都替换为0:没有删除任何索引。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[0, 0, 0, 0, 0, 0]
[8, 7, 0, 2, 49, 9999]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>当然，对于你自己的类型，你可以把<code>Default</code>实现成任何你想要的类型。我们来看一个例子，我们有一个<code>Bank</code>和一个<code>Robber</code>。每次他抢了<code>Bank</code>，他就会在桌子上拿到钱。但是办公桌可以随时从后面拿钱，所以它永远有50。我们将为此自制一个类型，所以它将永远有50。下面是它的工作原理。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Deref</span><span class="token punctuation">,</span> <span class="token class-name">DerefMut</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// We will use this to get the power of u32</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Bank</span> <span class="token punctuation">&#123;</span>
    money_inside<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    money_at_desk<span class="token punctuation">:</span> <span class="token class-name">DeskMoney</span><span class="token punctuation">,</span> <span class="token comment">// This is our "smart pointer" type. It has its own default, but it will use u32</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">DeskMoney</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Default</span> <span class="token keyword">for</span> <span class="token class-name">DeskMoney</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment">// default is always 50, not 0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">DeskMoney</span> <span class="token punctuation">&#123;</span> <span class="token comment">// With this we can access the u32 using *</span>
    <span class="token keyword">type</span> <span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">DerefMut</span> <span class="token keyword">for</span> <span class="token class-name">DeskMoney</span> <span class="token punctuation">&#123;</span> <span class="token comment">// And with this we can add, subtract, etc.</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Bank</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check_money</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"There is $&#123;&#125; in the back and $&#123;&#125; at the desk.\n"</span><span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>money_inside<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>money_at_desk <span class="token comment">// Use * so we can just print the u32</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Robber</span> <span class="token punctuation">&#123;</span>
    money_in_pocket<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Robber</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check_money</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The robber has $&#123;&#125; right now.\n"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>money_in_pocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">rob_bank</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> bank<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Bank</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> new_money <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">take</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> bank<span class="token punctuation">.</span>money_at_desk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Here it takes the money, and leaves 50 because that is the default</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>money_in_pocket <span class="token operator">+=</span> <span class="token operator">*</span>new_money<span class="token punctuation">;</span> <span class="token comment">// Use * because we can only add u32. DeskMoney can't add</span>
        bank<span class="token punctuation">.</span>money_inside <span class="token operator">-=</span> <span class="token operator">*</span>new_money<span class="token punctuation">;</span>    <span class="token comment">// Same here</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"She robbed the bank. She now has $&#123;&#125;!\n"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>money_in_pocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> bank_of_klezkavania <span class="token operator">=</span> <span class="token class-name">Bank</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Set up our bank</span>
        money_inside<span class="token punctuation">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
        money_at_desk<span class="token punctuation">:</span> <span class="token class-name">DeskMoney</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    bank_of_klezkavania<span class="token punctuation">.</span><span class="token function">check_money</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> robber <span class="token operator">=</span> <span class="token class-name">Robber</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Set up our robber</span>
        money_in_pocket<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    robber<span class="token punctuation">.</span><span class="token function">check_money</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    robber<span class="token punctuation">.</span><span class="token function">rob_bank</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> bank_of_klezkavania<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Rob, then check money</span>
    robber<span class="token punctuation">.</span><span class="token function">check_money</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bank_of_klezkavania<span class="token punctuation">.</span><span class="token function">check_money</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    robber<span class="token punctuation">.</span><span class="token function">rob_bank</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> bank_of_klezkavania<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Do it again</span>
    robber<span class="token punctuation">.</span><span class="token function">check_money</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bank_of_klezkavania<span class="token punctuation">.</span><span class="token function">check_money</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">There is $5000 in the back and $50 at the desk.

The robber has $50 right now.

She robbed the bank. She now has $100!

The robber has $100 right now.

There is $4950 in the back and $50 at the desk.

She robbed the bank. She now has $150!

The robber has $150 right now.

There is $4900 in the back and $50 at the desk.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到桌子上总是有50美元。</p>
<h3 id="Prelude"><a href="#Prelude" class="headerlink" title="Prelude"></a>Prelude</h3><p>标准库也有一个prelude，这就是为什么你不用写<code>use std::vec::Vec</code>这样的东西来创建一个<code>Vec</code>。你可以<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/prelude/index.html#prelude-contents">在这里</a>看到所有这些元素，并且大致了解:</p>
<ul>
<li><code>std::marker::&#123;Copy, Send, Sized, Sync, Unpin&#125;</code>. 你以前没有见过<code>Unpin</code>，因为几乎每一种类型都会用到它(比如<code>Sized</code>，也很常见)。”Pin”的意思是不让东西动。在这种情况下，<code>Pin</code>意味着它在内存中不能移动，但大多数元素都有<code>Unpin</code>，所以你可以移动。这就是为什么像<code>std::mem::replace</code>这样的函数能用，因为它们没有被钉住。</li>
<li><code>std::ops::&#123;Drop, Fn, FnMut, FnOnce&#125;</code>.</li>
<li><code>std::mem::drop</code></li>
<li><code>std::boxed::Box</code>.</li>
<li><code>std::borrow::ToOwned</code>. 你之前用<code>Cow</code>看到过一点，它可以把借来的内容变成自己的。它使用<code>.to_owned()</code>来实现这个功能。你也可以在<code>&amp;str</code>上使用<code>.to_owned()</code>，得到一个<code>String</code>，对于其他借来的值也是一样。</li>
<li><code>std::clone::Clone</code></li>
<li><code>std::cmp::&#123;PartialEq, PartialOrd, Eq, Ord&#125;</code>.</li>
<li><code>std::convert::&#123;AsRef, AsMut, Into, From&#125;</code>.</li>
<li><code>std::default::Default</code>.</li>
<li><code>std::iter::&#123;Iterator, Extend, IntoIterator, DoubleEndedIterator, ExactSizeIterator&#125;</code>. 我们之前用<code>.rev()</code>来做迭代器:这实际上是做了一个<code>DoubleEndedIterator</code>。<code>ExactSizeIterator</code>只是类似于<code>0..10</code>的东西:它已经知道自己的<code>.len()</code>是10。其他迭代器不知道它们的长度是肯定的。</li>
<li><code>std::option::Option::&#123;self, Some, None&#125;</code>.</li>
<li><code>std::result::Result::&#123;self, Ok, Err&#125;</code>.</li>
<li><code>std::string::&#123;String, ToString&#125;</code>.</li>
<li><code>std::vec::Vec</code>.</li>
</ul>
<p>如果你因为某些原因不想要这个prelude怎么办？就加属性<code>#![no_implicit_prelude]</code>。我们来试一试，看编译器的抱怨。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token attribute attr-name">#![no_implicit_prelude]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"This won't work"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> my_vec<span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在Rust根本不知道你想做什么。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error: cannot find macro &#96;println&#96; in this scope
 --&gt; src&#x2F;main.rs:5:5
  |
5 |     println!(&quot;&#123;:?&#125;, &#123;&#125;&quot;, my_vec, my_string);
  |     ^^^^^^^

error: cannot find macro &#96;vec&#96; in this scope
 --&gt; src&#x2F;main.rs:3:18
  |
3 |     let my_vec &#x3D; vec![8, 9, 10];
  |                  ^^^

error[E0433]: failed to resolve: use of undeclared type or module &#96;String&#96;
 --&gt; src&#x2F;main.rs:4:21
  |
4 |     let my_string &#x3D; String::from(&quot;This won&#39;t work&quot;);
  |                     ^^^^^^ use of undeclared type or module &#96;String&#96;

error: aborting due to 3 previous errors<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此，对于这个简单的代码，你需要告诉Rust使用<code>extern</code>(外部)crate，叫做<code>std</code>，然后是你想要的元素。这里是我们要做的一切，只是为了创建一个Vec和一个String，并打印它。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#![no_implicit_prelude]</span>

<span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">std</span><span class="token punctuation">;</span> <span class="token comment">// Now you have to tell Rust that you want to use a crate called std</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>vec<span class="token punctuation">;</span> <span class="token comment">// We need the vec macro</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>string<span class="token punctuation">::</span></span><span class="token class-name">String</span><span class="token punctuation">;</span> <span class="token comment">// and string</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>convert<span class="token punctuation">::</span></span><span class="token class-name">From</span><span class="token punctuation">;</span> <span class="token comment">// and this to convert from a &amp;str to the String</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>println<span class="token punctuation">;</span> <span class="token comment">// and this to print</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"This won't work"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> my_vec<span class="token punctuation">,</span> my_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在终于成功了，打印出<code>[8, 9, 10], This won&#39;t work</code>。所以你可以明白为什么Rust要用prelude了。但如果你愿意，你不需要使用它。而且你甚至可以使用<code>#![no_std]</code>(我们曾经看到过)，用于你连堆栈内存这种东西都用不上的时候。但大多数时候，你根本不用考虑不用prelude或<code>std</code>。</p>
<p>那么为什么之前我们没有看到<code>extern</code>这个关键字呢？是因为你已经不需要它了。以前，当带入外部crate时，你必须使用它。所以以前要使用<code>rand</code>，你必须要写成:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">rand</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后用 <code>use</code> 语句来表示你想使用的修改、trait等。但现在Rust编译器已经不需要这些帮助了–你只需要使用<code>use</code>，rust就知道在哪里可以找到它。所以你几乎再也不需要<code>extern crate</code>了，但在其他人的Rust代码中，你可能仍然会在顶部看到它。</p>
<h3 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h3><p><code>std::time</code>是你可以找到时间函数的地方。(如果你想要更多的功能，<code>chrono</code>这样的crate也可以。)最简单的功能就是用<code>Instant::now()</code>获取系统时间即可。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Instant</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你打印出来，你会得到这样的东西。<code>Instant &#123; tv_sec: 2738771, tv_nsec: 685628140 &#125;</code>. 这说的是秒和纳秒，但用处不大。比如你看2738771秒(写于8月)，就是31.70天。这和月份、日子没有任何关系。但是<code>Instant</code>的页面告诉我们，它本身不应该有用。它说它是 “不透明的，只有和Duration一起才有用”。Opaque的意思是 “你搞不清楚”，而Duration的意思是 “过了多少时间”。所以它只有在做比较时间这样的事情时才有用。</p>
<p>如果你看左边的trait，其中一个是<code>Sub&lt;Instant&gt;</code>。也就是说我们可以用<code>-</code>来减去一个。而当我们点击[src]看它的作用时，它说。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Sub</span><span class="token operator">&lt;</span><span class="token class-name">Instant</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Instant</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">sub</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token class-name">Instant</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Duration</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">duration_since</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此，它需要一个<code>Instant</code>，并使用<code>.duration_since()</code>给出一个<code>Duration</code>。让我们试着打印一下。我们将创建两个相邻的 <code>Instant::now()</code>，然后让程序忙活一会儿，再创建一个 <code>Instant::now()</code>。然后我们再创建一个<code>Instant::now()</code>. 最后，我们来看看用了多长时间。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Instant</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> time1 <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> time2 <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// These two are right next to each other</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
        new_string<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token char string">'წ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make Rust push this Georgian letter onto the String</span>
        <span class="token keyword">if</span> new_string<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">100_000</span> <span class="token punctuation">&#123;</span> <span class="token comment">//  until it is 100,000 bytes long</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> time3 <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> time2 <span class="token operator">-</span> time1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> time3 <span class="token operator">-</span> time1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出这样的东西。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">1.025µs
683.378µs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以，这只是1微秒多与683毫秒。我们可以看到，Rust确实花了一些时间来做。</p>
<p>不过我们可以用一个<code>Instant</code>做一件有趣的事情。<br> 我们可以把它变成<code>String</code>与<code>format!(&quot;&#123;:?&#125;&quot;, Instant::now());</code>。它的样子是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Instant</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> time1 <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> time1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就会打印出类似<code>Instant &#123; tv_sec: 2740773, tv_nsec: 632821036 &#125;</code>的东西。这是没有用的，但是如果我们使用 <code>.iter()</code> 和 <code>.rev()</code> 以及 <code>.skip(2)</code>，我们可以跳过最后的 <code>&#125;</code> 和 <code> </code>。我们可以用它来创建一个随机数发生器。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Instant</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">bad_random_number</span><span class="token punctuation">(</span>digits<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> digits <span class="token operator">></span> <span class="token number">9</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Random number can only be up to 9 digits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    output
        <span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>digits<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>character<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> character<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">bad_random_number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bad_random_number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bad_random_number</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bad_random_number</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就会打印出类似这样的内容:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">6
4
967
180<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数被称为<code>bad_random_number</code>，因为它不是一个很好的随机数生成器。Rust有更好的crate，可以用比<code>rand</code>更少的代码做出随机数，比如<code>fastrand</code>。但这是一个很好的例子，你可以利用你的想象力用<code>Instant</code>来做一些事情。</p>
<p>当你有一个线程时，你可以使用<code>std::thread::sleep</code>使它停止一段时间。当你这样做时，你必须给它一个duration。你不必创建多个线程来做这件事，因为每个程序至少在一个线程上。<code>sleep</code>虽然需要一个<code>Duration</code>，所以它可以知道要睡多久。你可以这样选单位:<code>Duration::from_millis()</code>, <code>Duration::from_secs</code>, 等等。这里举一个例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span>sleep<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> three_seconds <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I must sleep now."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span>three_seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Did I miss anything?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将只打印</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">I must sleep now.
Did I miss anything?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但线程在三秒钟内什么也不做。当你有很多线程需要经常尝试一些事情时，比如连接，你通常会使用<code>.sleep()</code>。你不希望线程在一秒钟内使用你的处理器尝试10万次，而你只是想让它有时检查一下。所以，你就可以设置一个<code>Duration</code>，它就会在每次醒来的时候尝试做它的任务。</p>
<h3 id="其他宏"><a href="#其他宏" class="headerlink" title="其他宏"></a>其他宏</h3><p>我们再来看看其他一些宏。</p>
<p><code>unreachable!()</code></p>
<p>这个宏有点像<code>todo!()</code>，除了它是针对你永远不会用的代码。也许你在一个枚举中有一个<code>match</code>，你知道它永远不会选择其中的一个分支，所以代码永远无法达到那个分支。如果是这样，你可以写<code>unreachable!()</code>，这样编译器就知道可以忽略这部分。</p>
<p>例如，假设你有一个程序，当你选择一个地方居住时，它会写一些东西。在乌克兰，除了切尔诺贝利，其他地方都不错。你的程序不让任何人选择切尔诺贝利，因为它现在不是一个好地方。但是这个枚举是很早以前在别人的代码里做的，你无法更改。所以在<code>match</code>的分支中，你可以用这个宏。它是这样的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">UkrainePlaces</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Kiev</span><span class="token punctuation">,</span>
    <span class="token class-name">Kharkiv</span><span class="token punctuation">,</span>
    <span class="token class-name">Chernobyl</span><span class="token punctuation">,</span> <span class="token comment">// Pretend we can't change the enum - Chernobyl will always be here</span>
    <span class="token class-name">Odesa</span><span class="token punctuation">,</span>
    <span class="token class-name">Dnipro</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">choose_city</span><span class="token punctuation">(</span>place<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">UkrainePlaces</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token class-name">UkrainePlaces</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> place <span class="token punctuation">&#123;</span>
        <span class="token class-name">Kiev</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You will live in Kiev"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Kharkiv</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You will live in Kharkiv"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Chernobyl</span> <span class="token operator">=></span> <span class="token macro property">unreachable!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Odesa</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You will live in Odesa"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Dnipro</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You will live in Dnipro"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> user_input <span class="token operator">=</span> <span class="token class-name">UkrainePlaces</span><span class="token punctuation">::</span><span class="token class-name">Kiev</span><span class="token punctuation">;</span> <span class="token comment">// Pretend the user input is made from some other function. The user can't choose Chernobyl, no matter what</span>
    <span class="token function">choose_city</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印出 <code>You will live in Kiev</code>。</p>
<p><code>unreachable!()</code>对你来说也很好读，因为它提醒你代码的某些部分是不可访问的。不过你必须确定代码确实是不可访问的。如果编译器调用<code>unreachable!()</code>，程序就会崩溃。</p>
<p>此外，如果你曾经有不可达的代码，而编译器知道，它会告诉你。下面是一个简单的例子:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> true_or_false <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> true_or_false <span class="token punctuation">&#123;</span>
        <span class="token boolean">true</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's false"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"It's true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Whoops, we wrote true again</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它会说</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">warning: unreachable pattern
 --&gt; src&#x2F;main.rs:7:9
  |
7 |         true &#x3D;&gt; println!(&quot;It&#39;s true&quot;),
  |         ^^^^
  |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是<code>unreachable!()</code>是用于编译器无法知道的时候，就像我们另一个例子。</p>
<p><code>column!</code>, <code>line!</code>, <code>file!</code>, <code>module_path!</code></p>
<p>这四个宏有点像<code>dbg!()</code>，因为你只是把它们放进代码去给你调试信息。但是它们不需要任何变量–你只需要用它们和括号一起使用，而没有其他的东西。它们放到一起很容易学:</p>
<ul>
<li><code>column!()</code>给你写的那一列</li>
<li><code>line!()</code>给你写的那行字，然后是</li>
<li><code>module_path!()</code>给你模块的位置。</li>
</ul>
<p>接下来的代码在一个简单的例子中展示了这三者。我们将假装有更多的代码(mod里面的mod)，因为这就是我们要使用这些宏的原因。你可以想象一个大的Rust程序,它有许多mod和文件。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">something</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">third_mod</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">print_a_country</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span>
                <span class="token string">"The last country is &#123;&#125; inside the module &#123;&#125;"</span><span class="token punctuation">,</span>
                input<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token macro property">module_path!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token namespace">something<span class="token punctuation">::</span>third_mod<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> country_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token string">"Portugal"</span><span class="token punctuation">,</span> <span class="token string">"Czechia"</span><span class="token punctuation">,</span> <span class="token string">"Finland"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// do some stuff</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"On line &#123;&#125; we got the country &#123;&#125;"</span><span class="token punctuation">,</span>
        <span class="token macro property">line!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        country_vec<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// do some more stuff</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"The next country is &#123;&#125; on line &#123;&#125; and column &#123;&#125;."</span><span class="token punctuation">,</span>
        country_vec<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token macro property">line!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token macro property">column!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// lots more code</span>

    <span class="token function">print_a_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> country_vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它打印的是这样的。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">On line 20 we got the country Finland
The next country is Czechia on line 29 and column 9.
The last country is Portugal inside the module rust_book::something::third_mod<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p><code>cfg!</code></p>
<p>我们知道，你可以使用 <code>#[cfg(test)]</code> 和 <code>#[cfg(windows)]</code> 这样的属性来告诉编译器在某些情况下该怎么做。当你有<code>test</code>时，当你在测试模式下运行Rust时，它会运行代码(如果是在电脑上，你输入<code>cargo test</code>)。而当你使用<code>windows</code>时，如果用户使用的是Windows，它就会运行代码。但也许你只是想根据不同操作系统对依赖系统的代码做很小的修改。这时候这个宏就很有用了。它返回一个<code>bool</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> helpful_message <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">cfg!</span><span class="token punctuation">(</span>windows<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token string">"backslash"</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token string">"slash"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">"...then in your hard drive, type the directory name followed by a &#123;&#125;. Then you..."</span><span class="token punctuation">,</span>
        helpful_message
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将以不同的方式打印，取决于你的系统。Rust Playground在Linux上运行，所以会打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">...then in your hard drive, type the directory name followed by a slash. Then you...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>cfg!()</code>适用于任何一种配置。下面是一个例子，当你在测试中使用一个函数时，它的运行方式会有所不同。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[cfg(test)]</span> <span class="token comment">// cfg! will know to look for the word test</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">testing</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">check_if_five</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token function">bring_number</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This bring_number() function should return 5</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">bring_number</span><span class="token punctuation">(</span>should_run<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u32</span> <span class="token punctuation">&#123;</span> <span class="token comment">// This function takes a bool as to whether it should run</span>
    <span class="token keyword">if</span> <span class="token macro property">cfg!</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> should_run <span class="token punctuation">&#123;</span> <span class="token comment">// if it should run and has the configuration test, return 5</span>
        <span class="token number">5</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> should_run <span class="token punctuation">&#123;</span> <span class="token comment">// if it's not a test but it should run, print something. When you run a test it ignores println! statements</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Returning 5. This is not a test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token number">5</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"This shouldn't run, returning 0."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// otherwise return 0</span>
        <span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">bring_number</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bring_number</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在根据配置的不同，它的运行方式也会不同。如果你只是运行程序，它会给你这样的结果:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Returning 5. This is not a test
This shouldn&#39;t run, returning 0.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但如果你在测试模式下运行它(<code>cargo test</code>，用于电脑上的Rust)，它实际上会运行测试。因为在这种情况下，测试总是返回5，所以它会通过。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test
test testing::check_if_five ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="编写宏"><a href="#编写宏" class="headerlink" title="编写宏"></a>编写宏</h2><p>编写宏是非常复杂的。你可能永远都不需要写宏，但有时你可能会想写，因为它们非常方便。写宏很有趣，因为它们几乎是不同的语言。要写一个宏，你实际上是用另一个叫<code>macro_rules!</code>的宏。然后你添加你的宏名称，并打开一个<code>&#123;&#125;</code>块。里面有点像<code>match</code>语句。</p>
<p>这里有一个只取<code>()</code>，然后返回6:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> give_six <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token number">6</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> six <span class="token operator">=</span> <span class="token macro property">give_six!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> six<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但这和<code>match</code>语句是不一样的，因为宏实际上不会编译任何东西。它只是接受一个输入并给出一个输出。然后编译器会检查它是否有意义。这就是为什么宏就像 “写代码的代码”。你会记得，一个真正的<code>match</code>语句需要给出相同的类型，所以这不会工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ⚠️</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> my_number <span class="token punctuation">&#123;</span>
        <span class="token number">10</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You got a ten"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=></span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它会抱怨你在一种情况下要返回<code>()</code>，在另一种情况下要返回<code>i32</code>。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0308]: &#96;match&#96; arms have incompatible types
 --&gt; src\main.rs:5:14
  |
3 | &#x2F;     match my_number &#123;
4 | |         10 &#x3D;&gt; println!(&quot;You got a ten&quot;),
  | |               ------------------------- this is found to be of type &#96;()&#96;
5 | |         _ &#x3D;&gt; 10,
  | |              ^^ expected &#96;()&#96;, found integer
6 | |     &#125;
  | |_____- &#96;match&#96; arms have incompatible types<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但宏并不关心，因为它只是给出一个输出。它不是一个编译器–它是代码前的代码。所以你可以这样做:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> six_or_print <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token number">6</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You didn't give me 6."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_number <span class="token operator">=</span> <span class="token macro property">six_or_print!</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">six_or_print!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个就好办了，打印的是<code>You didn&#39;t give me 6.</code>。你也可以看到，这不是匹配分支，因为没有<code>_</code>行。我们只能给它<code>(6)</code>，或者<code>()</code>，其他的都会出错。而我们给它的<code>6</code>甚至不是<code>i32</code>，只是一个输入6。其实你可以设置任何东西作为宏的输入，因为它只是看输入，看得到什么。比如说:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> might_print <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token class-name">THis</span> is strange input 하하はは哈哈 but it still works<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You guessed the secret message!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You didn't guess it"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">might_print!</span><span class="token punctuation">(</span><span class="token class-name">THis</span> is strange input 하하はは哈哈 but it still works<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">might_print!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这个奇怪的宏只响应两件事。<code>()</code>和<code>(THis is strange input 하하はは哈哈 but it still works)</code>. 没有其他的东西。它打印的是:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You guessed the secret message!
You didn&#39;t guess it<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以宏不完全是Rust语法。但是宏也可以理解你给它的不同类型的输入。拿这个例子来说。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> might_print <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You gave me: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">might_print!</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印<code>You gave me: 6</code>。<code>$input:expr</code>部分很重要。它的意思是 “对于一个表达式，给它起一个变量名$input”。在宏中，变量以<code>$</code>开头。在这个宏中，如果你给它一个表达式，它就会打印出来。我们再来试一试。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> might_print <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You gave me: &#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now we'll use &#123;:?&#125; because we will give it different kinds of expressions</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">might_print!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// give it a ()</span>
    <span class="token macro property">might_print!</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// give it a 6</span>
    <span class="token macro property">might_print!</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// give it a vec</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You gave me: ()
You gave me: 6
You gave me: [8, 9, 7, 10]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>另外注意，我们写了<code>&#123;:?&#125;</code>，但它不会检查<code>&amp;input</code>是否实现了<code>Debug</code>。它只会写代码，并尝试让它编译，如果没有，那么它就会给出一个错误。</p>
<p>那么除了<code>expr</code>，宏还能看到什么呢？它们是 <code>block | expr | ident | item | lifetime | literal  | meta | pat | path | stmt | tt | ty | vis</code>. 这就是复杂的部分。你可以在<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/beta/reference/macros-by-example.html">这里</a>看到它们各自的意思，这里说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">item: an Item
block: a BlockExpression
stmt: a Statement without the trailing semicolon (except for item statements that require semicolons)
pat: a Pattern
expr: an Expression
ty: a Type
ident: an IDENTIFIER_OR_KEYWORD
path: a TypePath style path
tt: a TokenTree (a single token or tokens in matching delimiters (), [], or &#123;&#125;)
meta: an Attr, the contents of an attribute
lifetime: a LIFETIME_TOKEN
vis: a possibly empty Visibility qualifier
literal: matches -?LiteralExpression<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外有一个很好的网站叫cheats.rs，在<a target="_blank" rel="noopener" href="https://cheats.rs/#macros-attributes">这里</a>解释了它们，并且每个都给出了例子。</p>
<p>然而，对于大多数宏，你只会用到 <code>expr</code>、<code>ident</code> 和 <code>tt</code>。<code>ident</code> 表示标识符，用于变量或函数名称。<code>tt</code>表示token树，和任何类型的输入。让我们尝试用这两个词创建一个简单的宏。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> check <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token variable">$input1</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">ident</span><span class="token punctuation">,</span> <span class="token variable">$input2</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">"Is &#123;:?&#125; equal to &#123;:?&#125;? &#123;:?&#125;"</span><span class="token punctuation">,</span>
            <span class="token variable">$input1</span><span class="token punctuation">,</span>
            <span class="token variable">$input2</span><span class="token punctuation">,</span>
            <span class="token variable">$input1</span> <span class="token operator">==</span> <span class="token variable">$input2</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> my_vec <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">check!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">check!</span><span class="token punctuation">(</span>my_vec<span class="token punctuation">,</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">check!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这将取一个<code>ident</code>(像一个变量名)和一个表达式，看看它们是否相同。它的打印结果是</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Is 6 equal to 6? true
Is [7, 8, 9] equal to [7, 8, 9]? true
Is 6 equal to 10? false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>而这里有一个宏，输入<code>tt</code>，然后把它打印出来。它先用一个叫<code>stringify!</code>的宏创建一个字符串。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> print_anything <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token macro property">stringify!</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">print_anything!</span><span class="token punctuation">(</span>ththdoetd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">print_anything!</span><span class="token punctuation">(</span>87575oehq75onth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ththdoetd
87575oehq75onth<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但是如果我们给它一些带有空格、逗号等的东西，它就不会打印。它会认为我们给了它不止一个元素或额外的信息，所以它会感到困惑。</p>
<p>这就是宏开始变得困难的地方。</p>
<p>要一次给宏提供多个元素，我们必须使用不同的语法。不要用<code>$input</code>，而是<code>$($input1),*</code>。这意味着零或更多(这是 * 的意思)，用逗号分隔。如果你想要一个或多个，请使用 <code>+</code> 而不是 <code>*</code>。</p>
<p>现在我们的宏看起来是这样的。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> print_anything <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$input1</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token macro property">stringify!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$input1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">print_anything!</span><span class="token punctuation">(</span>ththdoetd<span class="token punctuation">,</span> rcofe<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">print_anything!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">print_anything!</span><span class="token punctuation">(</span>87575oehq75onth<span class="token punctuation">,</span> ntohe<span class="token punctuation">,</span> 987987o<span class="token punctuation">,</span> <span class="token number">097</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以它接受任何用逗号隔开的token树，并使用 <code>stringify!</code> 把它变成一个字符串。然后打印出来。它的打印结果是:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ththdoetd, rcofe

87575oehq75onth, ntohe, 987987o, 097<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果我们使用<code>+</code>而不是<code>*</code>，它会给出一个错误，因为有一次我们没有给它输入。所以<code>*</code>是一个比较安全的选择。</p>
<p>所以现在我们可以开始看到宏的威力了。在接下来的这个例子中，我们实际上可以创建我们自己的函数:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> make_a_function <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">ident</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// First you give it one name for the function, then it checks everything else</span>
        <span class="token keyword">fn</span> <span class="token variable">$name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token macro property">stringify!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// It makes everything else into a string</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">make_a_function!</span><span class="token punctuation">(</span>print_it<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We want a function called print_it() that prints everything else we give it</span>
    <span class="token function">print_it</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">make_a_function!</span><span class="token punctuation">(</span>say_its_nice<span class="token punctuation">,</span> this<span class="token punctuation">,</span> is<span class="token punctuation">,</span> really<span class="token punctuation">,</span> nice<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Same here but we change the function name</span>
    <span class="token function">say_its_nice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">5, 5, 6, I
this, is, really, nice<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>所以现在我们可以开始了解其他的宏了。你可以看到，我们已经使用的一些宏非常简单。这里是我们用来写入文件的<code>write!</code>的那个:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> write <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token variable">$dst</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token variable">$dst</span><span class="token punctuation">.</span><span class="token function">write_fmt</span><span class="token punctuation">(</span><span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>要使用它，你就输入这个:</p>
<ul>
<li>一个表达式(<code>expr</code>) 得到变量名<code>$dst</code>.</li>
<li>之后的一切。如果它写的是<code>$arg:tt</code>，那么它只会取1个，但是因为它写的是<code>$($arg:tt)*</code>，所以它取0，1，或者任意多个。</li>
</ul>
<p>然后它取<code>$dst</code>，并对它使用了一个叫做<code>write_fmt</code>的方法。在这里面，它使用了另一个叫做<code>format_args!</code>的宏，它接受所有的<code>$($arg)*</code>，或者我们输入的所有参数。</p>
<p>现在我们来看一下<code>todo!</code>这个宏。当你想让程序编译但还没有写出你的代码时，就会用到这个宏。它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> todo <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"not yet implemented"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"not yet implemented: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">format_args!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个有两个选项:你可以输入<code>()</code>，也可以输入一些token树(<code>tt</code>)。</p>
<ul>
<li>如果你输入<code>()</code>，它只是<code>panic!</code>，并加上一个信息。所以其实你可以直接写<code>panic!(&quot;not yet implemented&quot;)</code>，而不是<code>todo!</code>，这也是一样的。</li>
<li>如果你输入一些参数，它会尝试打印它们。你可以看到里面有同样的<code>format_args!</code>宏，它的工作原理和<code>println!</code>一样。</li>
</ul>
<p>所以，如果你写了这个，它也会工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">not_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> reason <span class="token operator">=</span> <span class="token string">"lack of time"</span><span class="token punctuation">;</span>
    <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token string">"Not done yet because of &#123;&#125;. Check back in &#123;&#125; hours"</span><span class="token punctuation">,</span> reason<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">not_done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">thread &#39;main&#39; panicked at &#39;not yet implemented: Not done yet because of lack of time. Check back in 8 hours&#39;, src&#x2F;main.rs:4:5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>在一个宏里面，你甚至可以调用同一个宏。这里有一个。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> my_macro <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Let's print this."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">my_macro!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">my_macro!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">my_macro!</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">my_macro!</span><span class="token punctuation">(</span>toheteh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">my_macro!</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">my_macro!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个可以取<code>()</code>，也可以取一个表达式，也可以取很多表达式。但是不管你放什么表达式，它都会忽略所有的表达式，只是在<code>()</code>上调用<code>my_macro!</code>。所以输出的只是<code>Let&#39;s print this</code>，四次。</p>
<p>在<code>dbg!</code>宏中也可以看到同样的情况，也是调用自己。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> dbg <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;:&#123;&#125;]"</span><span class="token punctuation">,</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">file!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">line!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//$crate means the crate that it's in.</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Use of `match` here is intentional because it affects the lifetimes</span>
        <span class="token comment">// of temporaries - https://stackoverflow.com/a/48732525/1063961</span>
        <span class="token keyword">match</span> <span class="token variable">$val</span> <span class="token punctuation">&#123;</span>
            tmp <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;:&#123;&#125;] &#123;&#125; = &#123;:#?&#125;"</span><span class="token punctuation">,</span>
                    <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">file!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">line!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">stringify!</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tmp
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token comment">// Trailing comma with single argument is ignored</span>
    <span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">dbg!</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">+</span> $<span class="token punctuation">(</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$crate</span><span class="token punctuation">::</span><span class="token macro property">dbg!</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(<code>eprintln!</code>与<code>println!</code>相同，只打印到<code>io::stderr</code>而不是<code>io::stdout</code>。还有<code>eprint!</code>不增加一行)。)</p>
<p>所以我们可以自己去试一试。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">dbg!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这与第一分支相匹配，所以它会用<code>file!</code>和<code>line!</code>宏打印文件名和行名。它打印的是<code>[src/main.rs:2]</code>。</p>
<p>我们用这个来试试。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">dbg!</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这将匹配下一个分支，因为它是一个表达式。然后它将调用输入<code>tmp</code>并使用这个代码。<code> $crate::eprintln!(&quot;[&#123;&#125;:&#123;&#125;] &#123;&#125; = &#123;:#?&#125;&quot;, $crate::file!(), $crate::line!(), $crate::stringify!($val), &amp;tmp);</code>. 所以它会用<code>file!</code>和<code>line!</code>来打印，然后把<code>$val</code>做成<code>String</code>，用<code>&#123;:#?&#125;</code>来漂亮的打印<code>tmp</code>。所以对于我们的输入，它会这样写。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[src&#x2F;main.rs:2] vec![8, 9, 10] &#x3D; [
    8,
    9,
    10,
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>剩下的部分，即使你多加了一个逗号，它也只是自己调用<code>dbg!</code>。</p>
<p>正如你所看到的，宏是非常复杂的！通常你只想让一个宏自动完成一些简单函数不能很好完成的事情。学习宏的最好方法是看其他宏的例子。没有多少人能够快速写出宏而不出问题。所以不要认为你需要知道宏的一切，才能知道如何在Rust中写。但如果你读了其他宏，并稍加修改，你就可以很容易地借用它们的力量。然后你可能会开始适应写自己的宏。</p>
<h1 id="第2部分-电脑上的Rust"><a href="#第2部分-电脑上的Rust" class="headerlink" title="第2部分 - 电脑上的Rust"></a>第2部分 - 电脑上的Rust</h1><p>你看到了，我们几乎可以使用Playground学习Rust中的任何东西。但如果你到目前为止已经学了这么多，现在你可能会想要在你的电脑上使用Rust。总有一些事情是你不能用Playground做的，比如使用文件或代码在多个文件中。其他如输入和flags也需要在电脑上安装Rust。但最重要的是，在你的电脑上有了Rust，你可以使用Crate。我们已经了解了crate，但在playground中你只能使用最流行的crate。但在你的电脑上，你可以在程序中使用任何crate。</p>
<h2 id="cargo"><a href="#cargo" class="headerlink" title="cargo"></a>cargo</h2><p><code>rustc</code>的意思是Rust编译器，实际的编译工作由它完成。一个rust文件的结尾是<code>.rs</code>。但大多数人不会写出类似 <code>rustc main.rs</code> 的东西来编译。他们使用的是名为 <code>cargo</code> 的东西，它是 Rust 的主包管理器。</p>
<p>关于这个名字的一个说明: 之所以叫<code>cargo</code>，是因为当你把crate放在一起时，你会得到cargo。Crate就是你在船上或卡车上看到的木箱，但你记住，每个Rust项目也叫Crate。那么当你把它们放在一起时，你就会得到整个cargo。</p>
<p>当你使用cargo来运行一个项目时，你可以看到这一点。让我们用 <code>rand</code> 试试简单的东西:我们只是在八个字母之间随机选择。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span>seq<span class="token punctuation">::</span></span><span class="token class-name">SliceRandom</span><span class="token punctuation">;</span> <span class="token comment">// Use this for .choose over slices</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">let</span> my_letters <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token char string">'a'</span><span class="token punctuation">,</span> <span class="token char string">'b'</span><span class="token punctuation">,</span> <span class="token char string">'c'</span><span class="token punctuation">,</span> <span class="token char string">'d'</span><span class="token punctuation">,</span> <span class="token char string">'e'</span><span class="token punctuation">,</span> <span class="token char string">'f'</span><span class="token punctuation">,</span> <span class="token char string">'g'</span><span class="token punctuation">,</span> <span class="token char string">'h'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">6</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> my_letters<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> rng<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就会打印出<code>b c g h e a</code>这样的东西。但我们想先看看<code>cargo</code>的作用。要使用 <code>cargo</code> 并运行我们的程序，通常我们输入 <code>cargo run</code>。这样就可以构建我们的程序，并为我们运行它。当它开始编译的时候，会做这样的事情:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">   Compiling getrandom v0.1.14
   Compiling cfg-if v0.1.10
   Compiling ppv-lite86 v0.2.8
   Compiling rand_core v0.5.1
   Compiling rand_chacha v0.2.2
   Compiling rand v0.7.3
   Compiling rust_book v0.1.0 (C:\Users\mithr\OneDrive\Documents\Rust\rust_book)
    Finished dev [unoptimized + debuginfo] target(s) in 13.13s
     Running &#96;C:\Users\mithr\OneDrive\Documents\Rust\rust_book\target\debug\rust_book.exe&#96;
g f c f h b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以看起来不只是引入了<code>rand</code>，还引入了一些其他的crate。这是因为我们的crate需要<code>rand</code>，但<code>rand</code>也有一些代码也需要其他crate。所以<code>cargo</code>会找到我们需要的所有crate，并把它们放在一起。在我们的案例中，只有7个，但在非常大的项目中，你可能会有200个或更多的crate要引入。</p>
<p>这就是你可以看到Rust的权衡的地方。Rust的速度非常快，因为它提前编译。它通过查看代码，看你写的代码到底做了什么。例如，你可能会写这样的泛型代码:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">print_and_return_thing</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Display</span><span class="token operator">></span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You gave me &#123;&#125; and now I will give it back."</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    input
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> my_name <span class="token operator">=</span> <span class="token function">print_and_return_thing</span><span class="token punctuation">(</span><span class="token string">"Windy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> small_number <span class="token operator">=</span> <span class="token function">print_and_return_thing</span><span class="token punctuation">(</span><span class="token number">9.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数可以用任何实现了<code>Display</code>的作为参数，所以我们给它一个<code>&amp;str</code>，接下来给它一个<code>f64</code>，这对我们来说是没有问题的。但是编译器不看泛型，因为它不想在运行时做任何事情。它想把一个能运行的程序尽可能快地组装起来。所以当它看第一部分的<code>&quot;Windy&quot;</code>时，它没有看到<code>fn print_and_return_thing&lt;T: Display&gt;(input: T) -&gt; T</code>，它看到的是<code>fn print_and_return_thing(input: &amp;str) -&gt; &amp;str</code>这样的东西。而接下来它看到的是<code>fn print_and_return_thing(input: f64) -&gt; f64</code>。所有关于trait的检查等等都是在编译时完成的。这就是为什么泛型需要更长的时间来编译，因为它需要弄清楚它们，并使之具体化。</p>
<p>还有一点:Rust 2020正在努力处理编译时间问题，因为这部分需要的时间最长。每一个版本的Rust在编译时都会快一点，而且还有一些其他的计划来加快它的速度。但与此同时，以下是你应该知道的:</p>
<ul>
<li><code>cargo build</code>会构建你的程序，这样你就可以运行它了。</li>
<li><code>cargo run</code>将建立你的程序并运行它。</li>
<li><code>cargo build --release</code>和<code>cargo run --release</code>发布模式下有同样的效果。什么是发布模式？当你的代码最终完成后就可以用发布模式了。Rust会花更多的时间来编译，但它这样做是因为它使用了它所知道的一切，来使编译出的程序运行更快。Release模式实际上比常规模式<em>快的多</em>，常规模式被称为debug模式。那是因为它的编译速度更快，而且有更多的调试信息。常规的<code>cargo build</code>叫做 “debug build”，<code>cargo build --release</code>叫做 “release build”。</li>
<li><code>cargo check</code>是一种检查代码的方式。它就像编译一样，只不过它不会真正地创建你的程序。这是一个很好的检查你的代码的方法，因为它不像<code>build</code>或<code>run</code>那样需要很长时间。</li>
</ul>
<p>对了，命令中的<code>--release</code>部分叫做<code>flag</code>。这意味着命令中的额外信息。</p>
<p>其他一些你需要知道的事情是:</p>
<ul>
<li><code>cargo new</code>. 这样做是为了创建一个新的Rust项目。<code>new</code>之后，写上项目的名称，<code>cargo</code>将会创建所有你需要的文件和文件夹。</li>
<li><code>cargo clean</code>. 当你把crate添加到<code>Cargo.toml</code>时，电脑会下载所有需要的文件，它们会占用很多空间。如果你不想再让它们在你的电脑上，输入<code>cargo clean</code>。</li>
</ul>
<p>关于编译器还有一点:只有当你第一次使用<code>cargo build</code>或<code>cargo run</code>时，它才会花费最多的时间。之后它就会记住，它又会快速编译。但如果你使用 <code>cargo clean</code>，然后运行 <code>cargo build</code>，它将不得不再慢慢地编译一次。</p>
<h2 id="接受用户输入"><a href="#接受用户输入" class="headerlink" title="接受用户输入"></a>接受用户输入</h2><p>一个简单的方法是用<code>std::io::stdin</code>来接受用户的输入。这意味着 “标准输入”，也就是来自键盘的输入。用<code>stdin()</code>可以获得用户的输入，但是接下来你就会想用<code>.read_line()</code>把它放到<code>&amp;mut String</code>中。下面是一个简单的例子，但它既能工作，也不能工作:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Please type something, or x to escape:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> input_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> input_string <span class="token operator">!=</span> <span class="token string">"x"</span> <span class="token punctuation">&#123;</span> <span class="token comment">// This is the part that doesn't work right</span>
        input_string<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// First clear the String. Otherwise it will keep adding to it</span>
        <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token function">stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> input_string<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get the stdin from the user, and put it in read_string</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You wrote &#123;&#125;"</span><span class="token punctuation">,</span> input_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"See you later!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面是一个输出输出的样子。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Please type something, or x to escape:
something
You wrote something

Something else
You wrote Something else

x
You wrote x

x
You wrote x

x
You wrote x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它接受我们的输入，然后把它还给我们，它甚至知道我们输入了<code>x</code>。但它并没有退出程序。唯一的办法是关闭窗口，或者输入ctrl和c。让我们把<code>println!</code>中的<code>&#123;&#125;</code>改为<code>&#123;:?&#125;</code>，以获得更多的信息(如果你喜欢那个宏，也可以使用<code>dbg!(&amp;input_string)</code>)。现在它说</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Please type something, or x to escape:
something
You wrote &quot;something\r\n&quot;
Something else
You wrote &quot;Something else\r\n&quot;
x
You wrote &quot;x\r\n&quot;
x
You wrote &quot;x\r\n&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>这是因为键盘输入其实不只是<code>something</code>，而是<code>something</code>和<code>Enter</code>键。有一个简单的方法可以解决这个问题，叫做<code>.trim()</code>，它可以把所有的空白都去掉。顺便说一下，<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/reference/whitespace.html">这些字符</a>都是空白字符。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">U+0009 (horizontal tab, &#39;\t&#39;)
U+000A (line feed, &#39;\n&#39;)
U+000B (vertical tab)
U+000C (form feed)
U+000D (carriage return, &#39;\r&#39;)
U+0020 (space, &#39; &#39;)
U+0085 (next line)
U+200E (left-to-right mark)
U+200F (right-to-left mark)
U+2028 (line separator)
U+2029 (paragraph separator)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以把<code>x\r\n</code>变成只剩<code>x</code>了。现在它可以工作了:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Please type something, or x to escape:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> input_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> input_string<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"x"</span> <span class="token punctuation">&#123;</span>
        input_string<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token function">stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> input_string<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You wrote &#123;&#125;"</span><span class="token punctuation">,</span> input_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"See you later!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在可以打印了:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Please type something, or x to escape:
something
You wrote something

Something
You wrote Something

x
You wrote x

See you later!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>还有一种用户输入叫<code>std::env::Args</code>(env是环境的意思)。<code>Args</code>是用户启动程序时输入的内容。其实在一个程序中总是至少有一个<code>Arg</code>。我们写一个程序，只用<code>std::env::args()</code>来打印它们，看看它们是什么。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果我们写<code>cargo run</code>，那么它的打印结果是这样的:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Args &#123; inner: [&quot;target\\debug\\rust_book.exe&quot;] &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>让我们给它更多的输入，看看它的作用。我们输入 <code>cargo run but with some extra words</code> 。 它给我们:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Args &#123; inner: [&quot;target\\debug\\rust_book.exe&quot;, &quot;but&quot;, &quot;with&quot;, &quot;some&quot;, &quot;extra&quot;, &quot;words&quot;] &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>有意思。而当我们查看<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/env/struct.Args.html">Args的页面</a>时，我们看到它实现了<code>IntoIterator</code>。这意味着我们可以.用所有我们知道的关于迭代器的方法来读取和改变它。让我们试试这个:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span>args<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> entry <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You entered: &#123;&#125;"</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在它说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You entered: target\debug\rust_book.exe
You entered: but
You entered: with
You entered: some
You entered: extra
You entered: words<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以看到，第一个参数总是程序名，所以你经常会想跳过它，比如这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span>args<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    input<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>item<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"You wrote &#123;&#125;, which in capital letters is &#123;&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">to_uppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这将打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">You wrote but, which in capital letters is BUT
You wrote with, which in capital letters is WITH
You wrote some, which in capital letters is SOME
You wrote extra, which in capital letters is EXTRA
You wrote words, which in capital letters is WORDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Args</code>的一个常见用途是用于用户设置。你可以确保用户写出你需要的输入，只有在正确的情况下才运行程序。这里有一个小程序，可以让字母变大(大写)或变小(小写)。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span>args<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> keywords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"capital"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"lowercase"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// User needs to write one of these after cargo run</span>
    <span class="token keyword">let</span> input_vec <span class="token operator">=</span> <span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Make a vec of all the args</span>

    <span class="token keyword">if</span> input_vec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> keywords<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// It must be at least 3 in length, and the user needs to write either "capital" or "lowercase".</span>
                                                                                <span class="token comment">// We use .to_lowercase() so the user can write "Capital" or "CAPITAL", etc.</span>
        <span class="token keyword">if</span> input_vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"capital"</span> <span class="token punctuation">&#123;</span>
            input_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>word<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> word<span class="token punctuation">.</span><span class="token function">to_uppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            input_vec<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>word<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> word<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">r#"Please write either "capital" or "lowercase" and then some input."#</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面是它给出的一些例子。</p>
<p>输入: <code>cargo run please make capitals</code>:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Please write either &quot;capital&quot; or &quot;lowercase&quot; and then some input.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入:<code>cargo run capital</code>:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Please write either &quot;capital&quot; or &quot;lowercase&quot; and then some input.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入:<code>cargo run capital I think I understand now</code>:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">I
THINK
I
UNDERSTAND
NOW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入:<code>cargo run LOWERCASE Does this work too?</code></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">does
this
work
too?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>除了<code>Args</code>中用户给出的<code>std::env</code>，还有<code>Vars</code>是系统变量。这些都是用户没有输入的程序的基本设置。你可以用<code>std::env::vars()</code>把它们都看成一个<code>(String, String)</code>。这个有非常多，比如说:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> <span class="token namespace">std<span class="token punctuation">::</span>env<span class="token punctuation">::</span></span><span class="token function">vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行这段代码，就能显示出你的用户会话的所有信息。它将显示这样的信息:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">(&quot;CARGO&quot;, &quot;&#x2F;playground&#x2F;.rustup&#x2F;toolchains&#x2F;stable-x86_64-unknown-linux-gnu&#x2F;bin&#x2F;cargo&quot;)
(&quot;CARGO_HOME&quot;, &quot;&#x2F;playground&#x2F;.cargo&quot;)
(&quot;CARGO_MANIFEST_DIR&quot;, &quot;&#x2F;playground&quot;)
(&quot;CARGO_PKG_AUTHORS&quot;, &quot;The Rust Playground&quot;)
(&quot;CARGO_PKG_DESCRIPTION&quot;, &quot;&quot;)
(&quot;CARGO_PKG_HOMEPAGE&quot;, &quot;&quot;)
(&quot;CARGO_PKG_NAME&quot;, &quot;playground&quot;)
(&quot;CARGO_PKG_REPOSITORY&quot;, &quot;&quot;)
(&quot;CARGO_PKG_VERSION&quot;, &quot;0.0.1&quot;)
(&quot;CARGO_PKG_VERSION_MAJOR&quot;, &quot;0&quot;)
(&quot;CARGO_PKG_VERSION_MINOR&quot;, &quot;0&quot;)
(&quot;CARGO_PKG_VERSION_PATCH&quot;, &quot;1&quot;)
(&quot;CARGO_PKG_VERSION_PRE&quot;, &quot;&quot;)
(&quot;DEBIAN_FRONTEND&quot;, &quot;noninteractive&quot;)
(&quot;HOME&quot;, &quot;&#x2F;playground&quot;)
(&quot;HOSTNAME&quot;, &quot;f94c15b8134b&quot;)
(&quot;LD_LIBRARY_PATH&quot;, &quot;&#x2F;playground&#x2F;target&#x2F;debug&#x2F;build&#x2F;backtrace-sys-3ec4c973f371c302&#x2F;out:&#x2F;playground&#x2F;target&#x2F;debug&#x2F;build&#x2F;libsqlite3-sys-fbddfbb9b241dacb&#x2F;out:&#x2F;playground&#x2F;target&#x2F;debug&#x2F;build&#x2F;ring-cadba5e583648abb&#x2F;out:&#x2F;playground&#x2F;target&#x2F;debug&#x2F;deps:&#x2F;playground&#x2F;target&#x2F;debug:&#x2F;playground&#x2F;.rustup&#x2F;toolchains&#x2F;stable-x86_64-unknown-linux-gnu&#x2F;lib&#x2F;rustlib&#x2F;x86_64-unknown-linux-gnu&#x2F;lib:&#x2F;playground&#x2F;.rustup&#x2F;toolchains&#x2F;stable-x86_64-unknown-linux-gnu&#x2F;lib&quot;)
(&quot;PATH&quot;, &quot;&#x2F;playground&#x2F;.cargo&#x2F;bin:&#x2F;playground&#x2F;.cargo&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;)
(&quot;PLAYGROUND_EDITION&quot;, &quot;2018&quot;)
(&quot;PLAYGROUND_TIMEOUT&quot;, &quot;10&quot;)
(&quot;PWD&quot;, &quot;&#x2F;playground&quot;)
(&quot;RUSTUP_HOME&quot;, &quot;&#x2F;playground&#x2F;.rustup&quot;)
(&quot;RUSTUP_TOOLCHAIN&quot;, &quot;stable-x86_64-unknown-linux-gnu&quot;)
(&quot;RUST_RECURSION_COUNT&quot;, &quot;1&quot;)
(&quot;SHLVL&quot;, &quot;1&quot;)
(&quot;SSL_CERT_DIR&quot;, &quot;&#x2F;usr&#x2F;lib&#x2F;ssl&#x2F;certs&quot;)
(&quot;SSL_CERT_FILE&quot;, &quot;&#x2F;usr&#x2F;lib&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt&quot;)
(&quot;USER&quot;, &quot;playground&quot;)
(&quot;_&quot;, &quot;&#x2F;usr&#x2F;bin&#x2F;timeout&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以如果你需要这些信息，<code>Vars</code>就是你想要的。</p>
<p>最简单的方法是使用<code>env!</code>宏来获取单个<code>Var</code>。你只要把变量的名字放在里面就可以了。<br> 它将给你一个<code>&amp;str</code>。但如果变量是错误的，它将不会工作，所以如果你不确定，然后使用<code>option_env!</code>代替。如果我们在Playground上写这个:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token macro property">env!</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token macro property">option_env!</span><span class="token punctuation">(</span><span class="token string">"ROOT"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token string">"Didn't work"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token macro property">option_env!</span><span class="token punctuation">(</span><span class="token string">"CARGO"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token string">"Didn't work"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们得到输出:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">playground
Didn&#39;t work
&#x2F;playground&#x2F;.rustup&#x2F;toolchains&#x2F;stable-x86_64-unknown-linux-gnu&#x2F;bin&#x2F;cargo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>所以<code>option_env!</code>永远是比较安全的宏。如果你真的想让程序在找不到环境变量时崩溃，那么<code>env!</code>会更好。</p>
<h2 id="使用文件"><a href="#使用文件" class="headerlink" title="使用文件"></a>使用文件</h2><p>现在我们在电脑上使用Rust，我们可以开始处理文件了。你会注意到，现在我们会开始在代码中越来越多的看到<code>Result</code>。这是因为一旦你开始处理文件和类似的事情，很多事情都会出错。一个文件可能不在那里，或者计算机无法读取它。</p>
<p>你可能还记得，如果你想使用<code>?</code>运算符，调用它的函数必须返回一个<code>Result</code>。如果你记不住错误类型，你可以什么都不给它，让编译器告诉你。让我们用一个试图用<code>.parse()</code>创建一个数字的函数来试试。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">fn</span> <span class="token function-definition function">give_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"88"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译器告诉我们到底该怎么做。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0308]: mismatched types
 --&gt; src\main.rs:4:5
  |
3 | fn give_number(input: &amp;str) -&gt; Result&lt;i32, ()&gt; &#123;
  |                                --------------- expected &#96;std::result::Result&lt;i32, ()&gt;&#96; because of return type
4 |     input.parse::&lt;i32&gt;()
  |     ^^^^^^^^^^^^^^^^^^^^ expected &#96;()&#96;, found struct &#96;std::num::ParseIntError&#96;
  |
  &#x3D; note: expected enum &#96;std::result::Result&lt;_, ()&gt;&#96;
             found enum &#96;std::result::Result&lt;_, std::num::ParseIntError&gt;&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>太好了！所以我们只需要把回车改成这样。现在它能工作了:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>num<span class="token punctuation">::</span></span><span class="token class-name">ParseIntError</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">give_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"88"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一个不能用，但是第二个可以用。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Ok(88)
Ok(5)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以现在我们想用<code>?</code>，如果能用就直接给我们数值，如果不能用就给错误。但是如何在<code>fn main()</code>中做到这一点呢？如果我们尝试在main中使用<code>?</code>，那就不行了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>num<span class="token punctuation">::</span></span><span class="token class-name">ParseIntError</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">give_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"88"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它说:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">error[E0277]: the &#96;?&#96; operator can only be used in a function that returns &#96;Result&#96; or &#96;Option&#96; (or another type that implements &#96;std::ops::Try&#96;)
  --&gt; src\main.rs:8:22
   |
7  | &#x2F; fn main() &#123;
8  | |     println!(&quot;&#123;:?&#125;&quot;, give_number(&quot;88&quot;)?);
   | |                      ^^^^^^^^^^^^^^^^^^ cannot use the &#96;?&#96; operator in a function that returns &#96;()&#96;
9  | |     println!(&quot;&#123;:?&#125;&quot;, give_number(&quot;5&quot;)?);
10 | | &#125;
   | |_- this function should return &#96;Result&#96; or &#96;Option&#96; to accept &#96;?&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但实际上<code>main()</code>可以返回一个<code>Result</code>，就像其他函数一样。如果我们的函数能工作，我们不想返回任何东西(main()并没有给其他任何东西)。而如果它不工作，我们将错误返回。所以我们可以这样写:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>num<span class="token punctuation">::</span></span><span class="token class-name">ParseIntError</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">give_number</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    input<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ParseIntError</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"88"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token function">give_number</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不要忘了最后的<code>Ok(())</code>:这在Rust中是很常见的，它的意思是<code>Ok</code>，里面是<code>()</code>，也就是我们的返回值。现在它打印出来了:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">88
5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>只用<code>.parse()</code>的时候不是很有用，但是用文件就很有用。这是因为<code>?</code>也为我们改变了错误类型。下面是用简单英语写的<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/macro.try.html">?运算符页面</a>:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">If you get an &#96;Err&#96;, it will get the inner error. Then &#96;?&#96; does a conversion using &#96;From&#96;. With that it can change specialized errors to more general ones. The error it gets is then returned.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>另外，Rust在使用<code>File</code>s和类似的东西时，有一个方便的<code>Result</code>类型。它叫做<code>std::io::Result</code>，当你在使用<code>?</code>对文件进行打开和操作时，通常在<code>main()</code>中看到的就是这个。这其实是一个类型别名。它的样子是这样的:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">type Result&lt;T&gt; &#x3D; Result&lt;T, Error&gt;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以这是一个<code>Result&lt;T, Error&gt;</code>，但我们只需要写出<code>Result&lt;T&gt;</code>部分。</p>
<p>现在让我们第一次尝试使用文件。<code>std::fs</code>是处理文件的方法所在，有了<code>std::io::Write</code>，你就可以写。有了它，我们就可以用<code>.write_all()</code>来写进文件。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"myfilename.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// Create a file with this name.</span>
                                                        <span class="token comment">// CAREFUL! If you have a file with this name already,</span>
                                                        <span class="token comment">// it will delete it and make a new one.</span>
    file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"Let's put this in the file"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>     <span class="token comment">// Don't forget the b in front of ". That's because files take bytes.</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后如果你打开新文件<code>myfilename.txt</code>，会看到内容<code>Let&#39;s put this in the file</code>。</p>
<p>不过我们不需要写两行，因为我们有<code>?</code>操作符。如果有效，它就会传递我们想要的结果，有点像在迭代器上很多方法一样。这时候<code>?</code>就变得非常方便了。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"myfilename.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"Let's put this in the file"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这是说 “请尝试创建一个文件，然后检查是否成功。如果成功了，那就使用<code>.write_all()</code>，然后检查是否成功。”</p>
<p>而事实上，也有一个函数可以同时完成这两件事。它的名字叫<code>std::fs::write</code>。在它里面，你给它你想要的文件名，以及你想要放在里面的内容。再次强调，小心! 如果有相同的名字，它就会删除已经存在的文件。另外，它让你写一个<code>&amp;str</code>，前面不写<code>b</code>，因为这个:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">write</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">Path</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token class-name">P</span><span class="token punctuation">,</span> contents<span class="token punctuation">:</span> <span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>AsRef&lt;[u8]&gt;</code>就是为什么你可以给它任何一个。</p>
<p>很简单的:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">,</span> 
<span class="token string">"Calvin: Dad, how come old photographs are always black and white? Didn't they have color film back then?
Dad: Sure they did. In fact, those photographs *are* in color. It's just the *world* was black and white then.
Calvin: Really?
Dad: Yep. The world didn't turn color until sometimes in the 1930s..."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这就是我们要用的文件。这是一个名叫Calvin的漫画人物和他爸爸的对话，他爸爸对他的问题并不认真。有了这个，每次我们都可以创建一个文件来使用。</p>
<p>打开一个文件和创建一个文件一样简单。你只要用<code>open()</code>代替<code>create()</code>就可以了。之后(如果它找到了你的文件)，你就可以做<code>read_to_string()</code>这样的事情。要做到这一点，你可以创建一个可变的 <code>String</code>，然后把文件读到那里。它看起来像这样:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Read</span><span class="token punctuation">;</span> <span class="token comment">// this is to use the function .read_to_string()</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
     <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">,</span> 
<span class="token string">"Calvin: Dad, how come old photographs are always black and white? Didn't they have color film back then?
Dad: Sure they did. In fact, those photographs *are* in color. It's just the *world* was black and white then.
Calvin: Really?
Dad: Yep. The world didn't turn color until sometimes in the 1930s..."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>


    <span class="token keyword">let</span> <span class="token keyword">mut</span> calvin_file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// Open the file we just made</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> calvin_string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This String will hold it</span>
    calvin_file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> calvin_string<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// Read the file into it</span>

    calvin_string<span class="token punctuation">.</span><span class="token function">split_whitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>word<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span> word<span class="token punctuation">.</span><span class="token function">to_uppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Do things with the String now</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>会打印:</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token constant">CALVIN</span><span class="token punctuation">:</span> <span class="token constant">DAD</span><span class="token punctuation">,</span> <span class="token constant">HOW</span> <span class="token constant">COME</span> <span class="token constant">OLD</span> <span class="token constant">PHOTOGRAPHS</span> <span class="token constant">ARE</span> <span class="token constant">ALWAYS</span> <span class="token constant">BLACK</span> <span class="token constant">AND</span> <span class="token constant">WHITE</span><span class="token operator">?</span> <span class="token constant">DIDN</span><span class="token lifetime-annotation symbol">'T</span> <span class="token constant">THEY</span> <span class="token constant">HAVE</span> <span class="token constant">COLOR</span> <span class="token constant">FILM</span> <span class="token constant">BACK</span> <span class="token constant">THEN</span><span class="token operator">?</span> <span class="token constant">DAD</span><span class="token punctuation">:</span> <span class="token constant">SURE</span> <span class="token constant">THEY</span> <span class="token constant">DID</span><span class="token punctuation">.</span> <span class="token constant">IN</span> 
<span class="token constant">FACT</span><span class="token punctuation">,</span> <span class="token constant">THOSE</span> <span class="token constant">PHOTOGRAPHS</span> <span class="token operator">*</span><span class="token constant">ARE</span><span class="token operator">*</span> <span class="token constant">IN</span> <span class="token constant">COLOR</span><span class="token punctuation">.</span> <span class="token constant">IT</span><span class="token lifetime-annotation symbol">'S</span> <span class="token constant">JUST</span> <span class="token constant">THE</span> <span class="token operator">*</span><span class="token constant">WORLD</span><span class="token operator">*</span> <span class="token constant">WAS</span> <span class="token constant">BLACK</span> <span class="token constant">AND</span> <span class="token constant">WHITE</span> <span class="token constant">THEN</span><span class="token punctuation">.</span> <span class="token constant">CALVIN</span><span class="token punctuation">:</span> <span class="token constant">REALLY</span><span class="token operator">?</span> <span class="token constant">DAD</span><span class="token punctuation">:</span> <span class="token constant">YEP</span><span class="token punctuation">.</span> <span class="token constant">THE</span> <span class="token constant">WORLD</span> <span class="token constant">DIDN</span><span class="token lifetime-annotation symbol">'T</span> <span class="token constant">TURN</span> <span class="token constant">COLOR</span> <span class="token constant">UNTIL</span> <span class="token constant">SOMETIMES</span> <span class="token constant">IN</span> <span class="token constant">THE</span> 1930S<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>好吧，如果我们想创建一个文件，但如果已经有另一个同名的文件就不做了怎么办？也许你不想为了创建一个新的文件而删除已经存在的其他文件。要做到这一点，有一个结构叫<code>OpenOptions</code>。其实，我们一直在用<code>OpenOptions</code>，却不知道。看看<code>File::open</code>的源码吧。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">open</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">Path</span><span class="token operator">>></span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token class-name">P</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">File</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>有意思，这好像是我们学过的建造者模式。<code>File::create</code>也是如此。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">create</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">Path</span><span class="token operator">>></span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token class-name">P</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">File</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">truncate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果你去<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/fs/struct.OpenOptions.html">OpenOptions的页面</a>，你可以看到所有可以选择的方法。大多数采取<code>bool</code>。</p>
<ul>
<li><code>append()</code>: 意思是 “添加到已经存在的内容中，而不是删除”。</li>
<li><code>create()</code>: 这让 <code>OpenOptions</code> 创建一个文件。</li>
<li><code>create_new()</code>: 意思是只有在文件不存在的情况下才会创建文件。</li>
<li><code>read()</code>: 如果你想让它读取文件，就把这个设置为 <code>true</code>。</li>
<li><code>truncate()</code>: 如果你想在打开文件时把文件内容剪为0(删除内容)，就把这个设置为true。</li>
<li><code>write()</code>: 这可以让它写入一个文件。</li>
</ul>
<p>然后在最后你用<code>.open()</code>加上文件名，就会得到一个<code>Result</code>。我们来看一个例子。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// ⚠️</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">OpenOptions</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
     <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">,</span> 
<span class="token string">"Calvin: Dad, how come old photographs are always black and white? Didn't they have color film back then?
Dad: Sure they did. In fact, those photographs *are* in color. It's just the *world* was black and white then.
Calvin: Really?
Dad: Yep. The world didn't turn color until sometimes in the 1930s..."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> calvin_file <span class="token operator">=</span> <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create_new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先我们用<code>new</code>做了一个<code>OpenOptions</code>(总是以<code>new</code>开头)。然后我们给它的能力是<code>write</code>。之后我们把<code>create_new()</code>设置为<code>true</code>，然后试着打开我们做的文件。打不开，这是我们想要的。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Error: Os &#123; code: 80, kind: AlreadyExists, message: &quot;The file exists.&quot; &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>让我们尝试使用<code>.append()</code>，这样我们就可以向一个文件写入。为了写入文件，我们可以使用 <code>.write_all()</code>，这是一个尝试写入你给它的一切内容的方法。</p>
<p>另外，我们将使用 <code>write!</code> 宏来做同样的事情。你会记得这个宏，我们在为结构体做<code>impl Display</code>的时候用到过。这次我们是在文件上使用它，而不是在缓冲区上。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">OpenOptions</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">,</span> 
<span class="token string">"Calvin: Dad, how come old photographs are always black and white? Didn't they have color film back then?
Dad: Sure they did. In fact, those photographs *are* in color. It's just the *world* was black and white then.
Calvin: Really?
Dad: Yep. The world didn't turn color until sometimes in the 1930s..."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> calvin_file <span class="token operator">=</span> <span class="token class-name">OpenOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// Now we can write without deleting it</span>
        <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    calvin_file<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span><span class="token string">b"And it was a pretty grainy color for a while too.\n"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">write!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> calvin_file<span class="token punctuation">,</span> <span class="token string">"That's really weird.\n"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">write!</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> calvin_file<span class="token punctuation">,</span> <span class="token string">"Well, truth is stranger than fiction."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token string">"calvin_with_dad.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Calvin: Dad, how come old photographs are always black and white? Didn&#39;t they have color film back then?
Dad: Sure they did. In fact, those photographs *are* in color. It&#39;s just the *world* was black and white then.
Calvin: Really?
Dad: Yep. The world didn&#39;t turn color until sometimes in the 1930s...And it was a pretty grainy color for a while too.
That&#39;s really weird.
Well, truth is stranger than fiction.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="cargo文档"><a href="#cargo文档" class="headerlink" title="cargo文档"></a>cargo文档</h2><p>你可能已经注意到，Rust文档看起来总是几乎一样。在左边你可以看到<code>struct</code>和<code>trait</code>，代码例子在右边等等。这是因为你只要输入<code>cargo doc</code>就可以自动创建文档。</p>
<p>即使是创建一个什么都不做的项目，也可以帮助你了解Rust中的特性。例如，这里有两个几乎什么都不做的结构体，以及一个也什么都不做的<code>fn main()</code>。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">DoesNothing</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">PrintThing</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">PrintThing</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">prints_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>但如果你输入<code>cargo doc --open</code>，你可以看到比你想象中更多的信息。首先它给你显示的是这样的:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Crate rust_book

Structs
DoesNothing
PrintThing

Functions
main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是如果你点击其中的一个结构，会让你看到很多你没有想到的trait。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Struct rust_book::DoesNothing
[+] Show declaration
Auto Trait Implementations
impl RefUnwindSafe for DoesNothing
impl Send for DoesNothing
impl Sync for DoesNothing
impl Unpin for DoesNothing
impl UnwindSafe for DoesNothing
Blanket Implementations
impl&lt;T&gt; Any for T
where
    T: &#39;static + ?Sized,
[src]
[+]
impl&lt;T&gt; Borrow&lt;T&gt; for T
where
    T: ?Sized,
[src]
[+]
impl&lt;T&gt; BorrowMut&lt;T&gt; for T
where
    T: ?Sized,
[src]
[+]
impl&lt;T&gt; From&lt;T&gt; for T
[src]
[+]
impl&lt;T, U&gt; Into&lt;U&gt; for T
where
    U: From&lt;T&gt;,
[src]
[+]
impl&lt;T, U&gt; TryFrom&lt;U&gt; for T
where
    U: Into&lt;T&gt;,
[src]
[+]
impl&lt;T, U&gt; TryInto&lt;U&gt; for T
where
    U: TryFrom&lt;T&gt;,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是因为Rust自动为每个类型实现的所有trait。</p>
<p>那么如果我们添加一些文档注释，当你输入<code>cargo doc</code>的时候就可以看到。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// This is a struct that does nothing</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">DoesNothing</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">/// This struct only has one method.</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">PrintThing</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">/// It just prints the same message.</span>
<span class="token keyword">impl</span> <span class="token class-name">PrintThing</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">prints_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"I am printing something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>现在会打印:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Crate rust_book
Structs
DoesNothing This is a struct that does nothing
PrintThing  This struct only has one method.
Functions
main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当你使用很多别人的crate时，<code>cargo doc</code>是非常好的。因为这些crate都在不同的网站上，可能需要一些时间来搜索所有的crate。但如果你使用<code>cargo doc</code>，你就会把它们都放在你硬盘的同一个地方。</p>
<h2 id="结束了吗？"><a href="#结束了吗？" class="headerlink" title="结束了吗？"></a>结束了吗？</h2><p>简单英语学Rust就这样结束了。但是我还在这里，如果你有什么问题可以告诉我。欢迎<a target="_blank" rel="noopener" href="https://twitter.com/mithridates">在Twitter上联系我</a>或者添加一个pull request、issue等。如果有些地方不容易理解，你也可以告诉我。简单英语学Rust需要非常容易理解，所以请告诉我英语太难的地方。当然，Rust本身也可能是很难理解的，但我们至少可以确保英语是容易的。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Kabirz</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kabirz.github.io/2021/03/24/rust_cn/">https://kabirz.github.io/2021/03/24/rust_cn/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Kabirz</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/rust/">
                                    <span class="chip bg-color">rust</span>
                                </a>
                            
                                <a href="/tags/%E7%BC%96%E7%A8%8B/">
                                    <span class="chip bg-color">编程</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2021/03/24/rust_cn/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="轻松入门学习rust">
                        
                        <span class="card-title">轻松入门学习rust</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/rust/">
                        <span class="chip bg-color">rust</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                本篇&nbsp;<i class="far fa-dot-circle"></i>
            </div>
            <div class="card">
                <a href="/2021/03/24/rust_cn/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="轻松入门学习rust">
                        
                        <span class="card-title">轻松入门学习rust</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/rust/">
                        <span class="chip bg-color">rust</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">Kabirz</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/kabirz" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:jxwazxzhp@126.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
